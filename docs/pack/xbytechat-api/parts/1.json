{
  "name": "xbytechat-api",
  "part": 1,
  "of": 11,
  "generatedAt": "2025-09-05 11:57:45 +00:00",
  "files": [
    {
      "path": "xbytechat-api/appsettings.Development.json",
      "sha256": "e7423551487a7dabac49286e4ab3fe2e37da412ab608a74d1ba38738ba45946e",
      "language": "json",
      "size": 1993,
      "content": "{\n  \"ConnectionStrings\": {\n    \"DefaultConnection\": \"Host=localhost;Port=5432;Database=xplorebyte_db;Username=postgres;Password=xplore2025\"\n    // \"DefaultConnection\": \"Host=db.lxsqynuvccxyhltureew.supabase.co;Port=5432;Database=postgres;Username=postgres;Password=M_Eys9K@r/#PACt;SSL Mode=Require;Trust Server Certificate=true;\",\n    // \"DefaultConnection\": \"Host=ep-sweet-bar-aa16yopw-pooler.westus3.azure.neon.tech; Database=neondb; Username=neondb_owner; Password=npg_LW6vslyGz4YA; SSL Mode=VerifyFull; Channel Binding=Require;\"\n\n  },\n  \"Cors\": {\n    \"AllowedOrigins\": [\n      \"http://localhost:3000\",\n      \"https://lively-field-0de5b8a00.1.azurestaticapps.net\",\n      \"http://localhost:7113\",\n      \"https://localhost:7114\"\n    ]\n  },\n  \"JwtSettings\": {\n    \"Issuer\": \"xbytechat-api\",\n    \"Audience\": \"xbytechat-client\",\n    \"SecretKey\": \"dev-sevictcret-key-only-cliff-0a-for-tevictsting\"\n  },\n  \"WhatsApp\": {\n    \"ApiToken\": \"EAAIo1fBYKV8BO6tGEYsdH461nPYdyJzlMorCAHYtiasvUorEYUcGCaRdzy0IMhh1D6h1ZBYHLbNWbvF2FrvlaviZCwhZCPeGKE2t62BTp77Ha1IwGvNlEeagFiZBiU7LrkMw11fOPng2PgDphl2vp3DTyZBtICJkhy6ikPGvylZA5aM2oWLoIBS6zZB6vOygIFLmgFKoC7lqYPpP8JydDJI9bVN6Kx73CZAtGS9abjGxnHAZD\",\n    \"PhoneNumberId\": \"673199269218077\",\n    \"MetaToken\": \"xbytechat-secret-token\",\n    \"WABA_ID\": \"744548247936621\",\n    \"ApiBaseUrl\": \"https://077903ad22d3.ngrok-free.app\"\n  },\n  \"Tracking\": {\n    \"BaseUrl\": \"https://app.example.com\", // dev: your ngrok or localhost (don’t commit ngrok)\n    \"Secret\": \"replace-with-64+char-random-secret\" // use a long random string\n  },\n  \"FlowClickTokens\": {\n    \"Secret\": \"use-a-very-long-random-string-here\",\n    \"BaseUrl\": \"https://app.yourdomain.com\",\n    \"TtlHours\": 72\n  }\n\n}\n\n\n\n//{\n//  \"Logging\": {\n//    \"LogLevel\": {\n//      \"Default\": \"Information\",\n//      \"Microsoft.AspNetCore\": \"Warning\"\n//    }\n//  },\n//  \"Cors\": {\n//    \"AllowedOrigins\": [\n//      \"https://victorious-cliff-0ae029a00.1.azurestaticapps.net\",\n//      \"http://localhost:3000\"\n\n//    ]\n//  }\n//}\n"
    },
    {
      "path": "xbytechat-api/appsettings.json",
      "sha256": "3605f15f64388c8f79be26c7bedc649f8855d84dbe54b44fda145e1eada0be53",
      "language": "json",
      "size": 2352,
      "content": "{\n  \"Logging\": {\n    \"LogLevel\": {\n      \"Default\": \"Information\",\n      \"Microsoft.AspNetCore\": \"Warning\",\n      \"Microsoft.Hosting.Lifetime\": \"Information\"\n    }\n  },\n  \"AllowedHosts\": \"*\",\n  \"JwtSettings\": {\n    \"Issuer\": \"xbytechat-api\",\n    \"Audience\": \"xbytechat-client\",\n    \"ExpiryMinutes\": 60\n    // Leave SecretKey blank here\n  },\n  \"WhatsApp\": {\n    // Put only non-secret defaults here (e.g. API base URL)\n    \"ApiUrl\": \"https://graph.facebook.com/v23.0/601884673011340/messages\",\n    \"WABA_ID\": \"744548247936621\"\n  },\n  \"Cors\": {\n    \"AllowedOrigins\": []\n    // you override this per environment\n  },\n  \"ConnectionStrings\": {\n    // leave empty; override via environment or Key Vault\n    \"DefaultConnection\": \"\"\n  },\n  \"Tracking\": {\n    \"BaseUrl\": \"https://077903ad22d3.ngrok-free.app\", // dev: your ngrok or localhost (don’t commit ngrok)\n    \"Secret\": \"replace-with-64+char-random-secret\" // use a long random string\n  }\n}\n\n\n//{\n//  \"Logging\": {\n//    \"LogLevel\": {\n//      \"Default\": \"Information\",\n//      \"Microsoft.AspNetCore\": \"Warning\",\n//      \"Microsoft.Hosting.Lifetime\": \"Information\" // this lines is used to display log in output window\n//    }\n//  },\n//  \"AllowedHosts\": \"*\",\n//  \"WhatsApp\": {\n//    \"ApiUrl\": \"https://graph.facebook.com/v22.0/601884673011340/messages\",\n//    \"ApiToken\": \"EAAIo1fBYKV8BO6tGEYsdH461nPYdyJzlMorCAHYtiasvUorEYUcGCaRdzy0IMhh1D6h1ZBYHLbNWbvF2FrvlaviZCwhZCPeGKE2t62BTp77Ha1IwGvNlEeagFiZBiU7LrkMw11fOPng2PgDphl2vp3DTyZBtICJkhy6ikPGvylZA5aM2oWLoIBS6zZB6vOygIFLmgFKoC7lqYPpP8JydDJI9bVN6Kx73CZAtGS9abjGxnHAZD\",\n//    \"PhoneNumberId\": \"601884673011340\",\n//    \"MetaToken\": \"xbytechat-secret-token\",\n//    \"WABA_ID\": \"999432368375320\"\n\n//  },\n//  \"ConnectionStrings\": {\n//    \"DefaultConnection\": \"Host=localhost;Port=5432;Database=xplorebyte_db;Username=postgres;Password=xplore2025\",\n//    \"postgresql\": null, //postgres:[YOUR-PASSWORD]@db.lxsqynuvccxyhltureew.supabase.co:5432/postgres\n//    \"DefaultConnection\": \"Host=db.lxsqynuvccxyhltureew.supabase.co;Port=5432;Database=postgres;Username=postgres;Password=M_Eys9K@r/#PACt;SSL Mode=Require;Trust Server Certificate=true;\"\n\n//  },\n//  \"JwtSettings\": {\n//    \"SecretKey\": \"your_super_secret_key_here_1234567890\", // 🔒 make it strong\n//    \"Issuer\": \"xbytechat-api\",\n//    \"Audience\": \"xbytechat-client\",\n//    \"ExpiryMinutes\": 60\n//  }\n\n\n\n//}\n"
    },
    {
      "path": "xbytechat-api/AuthModule/Controllers/AuthController.cs",
      "sha256": "ce71246c74ec02c0bea6716f2f97e3cec601650c44bd545fd698c7b1935f1e65",
      "language": "csharp",
      "size": 9518,
      "content": "using Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing System.Security.Claims;\nusing xbytechat.api.AuthModule.DTOs;\nusing xbytechat.api.AuthModule.Services;\nusing xbytechat.api.Features.BusinessModule.DTOs;\n\nnamespace xbytechat.api.AuthModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    public class AuthController : ControllerBase\n    {\n        private readonly IAuthService _authService;\n\n        public AuthController(IAuthService authService)\n        {\n            _authService = authService;\n        }\n\n        // ✅ Login → return { token } (NO cookies)\n        [AllowAnonymous]\n        [HttpPost(\"login\")]\n        public async Task<IActionResult> Login([FromBody] UserLoginDto dto)\n        {\n            var result = await _authService.LoginAsync(dto);\n            if (!result.Success || string.IsNullOrWhiteSpace(result.Token))\n                return Unauthorized(new { success = false, message = result.Message });\n\n            return Ok(new { token = result.Token });\n        }\n\n        // (Optional) Refresh token endpoint if you still issue refresh tokens.\n        // Returns tokens in body (NO cookies).\n        [AllowAnonymous]\n        [HttpPost(\"refresh-token\")]\n        public async Task<IActionResult> RefreshToken([FromBody] RefreshTokenRequest request)\n        {\n            var result = await _authService.RefreshTokenAsync(request.RefreshToken);\n            if (!result.Success) return Unauthorized(new { success = false, message = result.Message });\n\n            dynamic data = result.Data!;\n            return Ok(new\n            {\n                accessToken = data.accessToken,\n                refreshToken = data.refreshToken\n            });\n        }\n        // ✅ Signup\n        [HttpPost(\"business-user-signup\")]\n        public async Task<IActionResult> Signup([FromBody] SignupBusinessDto dto)\n        {\n            if (!ModelState.IsValid)\n            {\n                var errors = ModelState.Values\n                    .SelectMany(v => v.Errors)\n                    .Select(e => e.ErrorMessage)\n                    .ToList();\n\n                return BadRequest(new\n                {\n                    success = false,\n                    message = \"❌ Validation failed.\",\n                    errors\n                });\n            }\n\n            var result = await _authService.SignupAsync(dto);\n            return result.Success ? Ok(result) : BadRequest(result);\n        }\n\n        // ✅ Logout (stateless JWT): nothing server-side to do\n        [Authorize]\n        [HttpPost(\"logout\")]\n        public IActionResult Logout() => Ok(new { success = true, message = \"Logged out\" });\n\n        // ✅ (Optional) lightweight session echo from claims (works with Bearer)\n        [Authorize]\n        [HttpGet(\"session\")]\n        public IActionResult GetSession()\n        {\n            var user = HttpContext.User;\n            if (user?.Identity is not { IsAuthenticated: true }) return BadRequest(\"Invalid session\");\n\n            var email = user.FindFirst(ClaimTypes.Email)?.Value ?? \"unknown\";\n            var role = user.FindFirst(ClaimTypes.Role)?.Value\n                       ?? user.FindFirst(\"role\")?.Value\n                       ?? \"unknown\";\n            var plan = user.FindFirst(\"plan\")?.Value ?? \"basic\";\n            var biz = user.FindFirst(\"businessId\")?.Value;\n\n            return Ok(new { isAuthenticated = true, role, email, plan, businessId = biz });\n        }\n\n        [Authorize]\n        [HttpGet(\"features\")]\n        public async Task<IActionResult> GetFeatureAccess()\n        {\n            var result = await _authService.GetFeatureAccessForUserAsync(User);\n            return Ok(result.Features);\n        }\n    }\n}\n\n\n//using Microsoft.AspNetCore.Authorization;\n//using Microsoft.AspNetCore.Mvc;\n//using xbytechat.api.AuthModule.DTOs;\n//using xbytechat.api.AuthModule.Services;\n//using xbytechat.api.Features.BusinessModule.DTOs;\n//using System.Security.Claims;\n//using xbytechat.api.Helpers;\n//using xbytechat.api.Features.FeatureAccessModule.Services;\n//using xbytechat.api.Features.FeatureAccess;\n//namespace xbytechat.api.AuthModule.Controllers\n//{\n//    [ApiController]\n//    [Route(\"api/[controller]\")]\n//    public class AuthController : ControllerBase\n//    {\n//        private readonly IAuthService _authService;\n//        private readonly IFeatureAccessService _featureAccessService;\n//        public AuthController(IAuthService authService, IFeatureAccessService featureAccessService)\n//        {\n//            _authService = authService;\n//            _featureAccessService = featureAccessService;\n//        }\n\n//        // ✅ Login\n//        [AllowAnonymous]\n//        [HttpPost(\"login\")]\n//        public async Task<IActionResult> Login([FromBody] UserLoginDto dto)\n//        {\n//            var result = await _authService.LoginAsync(dto);\n\n//            if (!result.Success || string.IsNullOrWhiteSpace(result.Token))\n//                return Unauthorized(result);\n\n//            JwtCookieHelper.SetJwtCookie(HttpContext, \"xbyte_token\", result.Token);\n\n//            if (!string.IsNullOrEmpty(result.RefreshToken))\n//            {\n//                JwtCookieHelper.SetRefreshTokenCookie(HttpContext, \"xbyte_refresh\", result.RefreshToken);\n//            }\n\n//            return Ok(new\n//            {\n//                success = true,\n//                message = result.Message,\n//                data = result.Data\n//            });\n//        }\n\n//        // ✅ Refresh Token\n//        // ✅ Refresh Token with cookie update\n//        [AllowAnonymous]\n//        [HttpPost(\"refresh-token\")]\n//        public async Task<IActionResult> RefreshToken([FromBody] RefreshTokenRequest request)\n//        {\n//            var result = await _authService.RefreshTokenAsync(request.RefreshToken);\n\n//            if (!result.Success)\n//                return Unauthorized(result);\n\n//            dynamic data = result.Data;\n//            var newAccessToken = data?.accessToken?.ToString();\n//            var newRefreshToken = data?.refreshToken?.ToString();\n\n//            // ✅ Set new JWT token in cookie\n//            if (!string.IsNullOrEmpty(newAccessToken))\n//                JwtCookieHelper.SetJwtCookie(HttpContext, \"xbyte_token\", newAccessToken);\n\n//            // ✅ Set new refresh token in cookie (rotated)\n//            if (!string.IsNullOrEmpty(newRefreshToken))\n//                JwtCookieHelper.SetRefreshTokenCookie(HttpContext, \"xbyte_refresh\", newRefreshToken);\n\n//            return Ok(new\n//            {\n//                success = true,\n//                message = result.Message\n//            });\n//        }\n\n//        // ✅ Logout\n//        [HttpPost(\"logout\")]\n//        public IActionResult Logout()\n//        {\n//            JwtCookieHelper.ClearJwtCookie(HttpContext, \"xbyte_token\");\n//            return Ok(new\n//            {\n//                success = true,\n//                message = \"🚪 Logged out successfully\"\n//            });\n//        }\n\n//        // ✅ Signup\n//        [HttpPost(\"business-user-signup\")]\n//        public async Task<IActionResult> Signup([FromBody] SignupBusinessDto dto)\n//        {\n//            if (!ModelState.IsValid)\n//            {\n//                var errors = ModelState.Values\n//                    .SelectMany(v => v.Errors)\n//                    .Select(e => e.ErrorMessage)\n//                    .ToList();\n\n//                return BadRequest(new\n//                {\n//                    success = false,\n//                    message = \"❌ Validation failed.\",\n//                    errors\n//                });\n//            }\n\n//            var result = await _authService.SignupAsync(dto);\n//            return result.Success ? Ok(result) : BadRequest(result);\n//        }\n\n//        // 🔁 Resend confirmation\n//        [HttpPost(\"resend-confirmation\")]\n//        public async Task<IActionResult> ResendConfirmation([FromBody] ResendConfirmationDto dto)\n//        {\n//            var result = await _authService.ResendConfirmationAsync(dto);\n//            return result.Success ? Ok(result) : BadRequest(result);\n//        }\n\n//        // 🔐 Reset password\n//        [HttpPost(\"reset-password\")]\n//        public async Task<IActionResult> ResetPassword([FromBody] ResetPasswordDto dto)\n//        {\n//            var result = await _authService.ResetPasswordAsync(dto);\n//            return result.Success ? Ok(result) : BadRequest(result);\n//        }\n//        [Authorize]\n//        [HttpGet(\"features\")]\n//        public async Task<IActionResult> GetFeatureAccess()\n//        {\n//            var result = await _authService.GetFeatureAccessForUserAsync(User);\n//            return Ok(result.Features);\n//        }\n//        // ✅ Session Info\n//        [Authorize]\n//        [HttpGet(\"session\")]\n//        public IActionResult GetSession()\n//        {\n//            var identity = HttpContext.User.Identity as ClaimsIdentity;\n//            if (identity == null || !identity.IsAuthenticated)\n//                return BadRequest(\"Invalid session\");\n\n//            var email = identity.FindFirst(ClaimTypes.Email)?.Value ?? \"unknown\";\n//            var role = identity.FindFirst(ClaimTypes.Role)?.Value ?? \"unknown\";\n//            var plan = identity.FindFirst(\"Plan\")?.Value ?? \"basic\";\n\n//            return Ok(new\n//            {\n//                isAuthenticated = true,\n//                role = role,\n//                email = email,\n//                plan = plan\n//            });\n//        }\n\n\n//    }\n\n//}\n"
    },
    {
      "path": "xbytechat-api/AuthModule/Controllers/TestJwtController.cs",
      "sha256": "c407c3fdf8977cffcb0cd6131f617087ede160fd75646be61000b68f7a455a22",
      "language": "csharp",
      "size": 2087,
      "content": "using Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Helpers;\n\nnamespace xbytechat.api.AuthModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/auth/test\")]\n    public class TestJwtController : ControllerBase\n    {\n        [Authorize]\n        [HttpGet(\"get-logged-in\")]\n        public IActionResult GetLoggedInUserInfo()\n        {\n            var userId = UserContextHelper.GetUserId(User);\n            var businessId = UserContextHelper.GetBusinessId(User);\n            var role = UserContextHelper.GetRole(User);\n            var plan = UserContextHelper.GetPlan(User);\n            var companyName = UserContextHelper.GetCompanyName(User);\n\n            return Ok(new\n            {\n                success = true,\n                message = \"🔐 JWT is valid. Here's your decoded info:\",\n                data = new\n                {\n                    userId,\n                    businessId,\n                    role,\n                    plan,\n                    companyName\n                }\n            });\n        }\n\n        [HttpGet(\"get-current-user\")]\n        public IActionResult GetCurrentUser()\n        {\n            if (User?.Identity?.IsAuthenticated != true)\n            {\n                return Unauthorized(new { success = false, message = \"❌ Not authenticated\" });\n            }\n\n            var userId = User.FindFirst(\"sub\")?.Value;\n            var email = User.FindFirst(\"email\")?.Value;\n            var role = User.FindFirst(\"role\")?.Value;\n            var businessId = User.FindFirst(\"businessId\")?.Value;\n            var plan = User.FindFirst(\"plan\")?.Value;\n            var permissions = User.FindFirst(\"permissions\")?.Value;\n\n            return Ok(new\n            {\n                success = true,\n                message = \"✅ Token is valid\",\n                user = new\n                {\n                    userId,\n                    email,\n                    role,\n                    businessId,\n                    plan,\n                    permissions\n                }\n            });\n        }\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/AuthModule/DTOs/FeatureAccessDto.cs",
      "sha256": "2cd5dd1900f770fb91216632561ec241edda181aa0f8f394ca384f8ce04f70b0",
      "language": "csharp",
      "size": 220,
      "content": "// 📁 xbytechat.api/AuthModule/DTOs/FeatureAccessDto.cs\nnamespace xbytechat.api.AuthModule.DTOs\n{\n    public class FeatureAccessDto\n    {\n        public Dictionary<string, bool> Features { get; set; } = new();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/AuthModule/DTOs/RefreshTokenRequest.cs",
      "sha256": "5f68342bebd5c2664561285523bcabe509a7ffe5fe9c995eeeaf821aba238e2d",
      "language": "csharp",
      "size": 142,
      "content": "namespace xbytechat.api.AuthModule.DTOs\n{\n    public class RefreshTokenRequest\n    {\n        public string RefreshToken { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/AuthModule/DTOs/ResendConfirmationDto.cs",
      "sha256": "c390da7f0aa2324928025edc1a4ce1c65e079357cb2219fade8cdc4153734982",
      "language": "csharp",
      "size": 226,
      "content": "using System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.AuthModule.DTOs\n{\n    public class ResendConfirmationDto\n    {\n        [Required]\n        [EmailAddress]\n        public string Email { get; set; }\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/AuthModule/DTOs/ResetPasswordDto.cs",
      "sha256": "33b22ea5acec9376aef19d7c09ff580b689f7a6bc04ea1d6f214dd9b203de0c4",
      "language": "csharp",
      "size": 374,
      "content": "using System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.AuthModule.DTOs\n{\n    public class ResetPasswordDto\n    {\n        [Required]\n        [EmailAddress]\n        public string Email { get; set; }\n\n        [Required]\n        [MinLength(6, ErrorMessage = \"Password must be at least 6 characters long.\")]\n        public string NewPassword { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/AuthModule/DTOs/UserDto.cs",
      "sha256": "47384e5d11fcdfb564f639c3937db6f3aa97f5963366ecb7af4dc37e6a311ff1",
      "language": "csharp",
      "size": 587,
      "content": "namespace xbytechat.api.AuthModule.DTOs\n{\n    public class UserDto\n    {\n        public Guid Id { get; set; }\n        public string Name { get; set; }\n        public string Email { get; set; }\n        public string Role { get; set; }\n        public string Status { get; set; }\n        public DateTime CreatedAt { get; set; }\n\n        // ✅ Extra fields\n        public Guid BusinessId { get; set; }\n        public string CompanyName { get; set; }\n        public string Plan { get; set; }\n        public string AccessToken { get; set; }\n\n        public Guid? PlanId { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/AuthModule/DTOs/UserLoginDto.cs",
      "sha256": "d0b1140af88b221c2cb7dbd58223d5803643620b16d27f016aba26ed9b816482",
      "language": "csharp",
      "size": 281,
      "content": "using System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.AuthModule.DTOs\n{\n    public class UserLoginDto\n    {\n        [Required]\n        [EmailAddress]\n        public string Email { get; set; }\n\n        [Required]\n        public string Password { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/AuthModule/Models/User.cs",
      "sha256": "25f82a426c60ebda55385071a527cb10389e2f164415031be0a718cc4dc8f768",
      "language": "csharp",
      "size": 1761,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.ComponentModel.DataAnnotations;\nusing xbytechat.api.Features.CampaignTracking.Models;\nusing xbytechat.api.Features.AccessControl.Models;\nusing xbytechat.api.Features.MessageManagement.DTOs;\nusing xbytechat.api.Features.BusinessModule.Models; // 🆕 Required for navigation\n\nnamespace xbytechat.api.AuthModule.Models\n{\n    public class User\n    {\n        public Guid Id { get; set; }\n\n        // 🔗 FK to Business\n        public Guid? BusinessId { get; set; }\n        public Business Business { get; set; }\n\n        // 👤 User Info\n        [Required]\n        public string Name { get; set; }\n\n        [Required]\n        [EmailAddress]\n        public string Email { get; set; }\n\n        [Required]\n        public string PasswordHash { get; set; }\n\n        // 🛡️ Role System\n        // 🛡️ Role System (FK + Navigation)\n        public Guid? RoleId { get; set; }\n        public Role Role { get; set; }// admin / business / agent / staff\n\n        // ✅ Status Management\n        public string Status { get; set; } = \"Pending\"; // Active / Hold / Rejected / Pending\n\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n\n        // 🗑️ Soft Delete Role \n        public bool IsDeleted { get; set; } = false;\n        public DateTime? DeletedAt { get; set; }\n\n        public List<CampaignSendLog> SendLogs { get; set; }\n        public ICollection<MessageStatusLog> MessageStatusLogs { get; set; }\n\n        // 🆕 Permission Navigation\n        public ICollection<UserPermission> UserPermissions { get; set; } // 💡 Enables .WithMany(u => u.UserPermissions)\n        public string? RefreshToken { get; set; }\n        public DateTime? RefreshTokenExpiry { get; set; }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/AuthModule/Models/WhatsAppTemplate.cs",
      "sha256": "58c48102ea525733b401f28523a39a8358c4235f1bc7fad9bf667c08f942b1b9",
      "language": "csharp",
      "size": 1820,
      "content": "using Microsoft.EntityFrameworkCore;\nusing System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.AuthModule.Models\n{\n    [Index(nameof(BusinessId), nameof(Provider))]\n    [Index(nameof(BusinessId), nameof(Name))]\n    [Index(nameof(BusinessId), nameof(Name), nameof(Language), nameof(Provider), IsUnique = true)]\n    public class WhatsAppTemplate\n    {\n        [Key] public Guid Id { get; set; } = Guid.NewGuid();\n\n        public Guid BusinessId { get; set; }\n\n        [MaxLength(40)]\n        public string Provider { get; set; } = \"meta_cloud\";   // \"meta_cloud\" | \"pinnacle\" | etc.\n\n        [MaxLength(120)]\n        public string? ExternalId { get; set; }                // Meta template id if available\n\n        [MaxLength(160)]\n        public string Name { get; set; } = \"\";\n\n        [MaxLength(16)]\n        public string Language { get; set; } = \"en_US\";\n\n        [MaxLength(32)]\n        public string Status { get; set; } = \"APPROVED\";       // APPROVED/ACTIVE/REJECTED/PENDING\n\n        [MaxLength(40)]\n        public string? Category { get; set; }                  // e.g. MARKETING, UTILITY\n\n        public string Body { get; set; } = \"\";\n\n        public bool HasImageHeader { get; set; } = false;\n\n        public int PlaceholderCount { get; set; } = 0;\n\n        // JSON blobs (use TEXT in PG)\n        public string ButtonsJson { get; set; } = \"[]\";        // serialized List<ButtonMetadataDto>\n        public string RawJson { get; set; } = \"{}\";            // provider raw item (for audit/debug)\n\n        public DateTime LastSyncedAt { get; set; } = DateTime.UtcNow;\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n        public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;\n\n        public bool IsActive { get; set; } = true;             // soft-disable if deprecated\n    }\n}"
    },
    {
      "path": "xbytechat-api/AuthModule/Roles/UserRoles.cs",
      "sha256": "5a91bb09b9b5fc0f5fe14cf1b9727c0c8a8de225c71455452a14d491125209c5",
      "language": "csharp",
      "size": 507,
      "content": "namespace xbytechat.api.AuthModule.Roles\n{\n    public static class UserRoles\n    {\n        public const string Admin = \"admin\";         // xByte Admin\n        public const string Business = \"business\";   // Tenant Admin\n        public const string Staff = \"staff\";         // CRM Staff (future)\n        public const string Agent = \"agent\";         // WhatsApp/chat agent\n        public const string CRM = \"crm\";             // CRM-only user (future)\n        public const string Partner = \"partner\";\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/AuthModule/Services/AuthService.cs",
      "sha256": "f2b6fda822da5be77741a756e1eff53c493510fc5dcc46d65794d77a26ce63b0",
      "language": "csharp",
      "size": 50624,
      "content": "using System.Security.Cryptography;\nusing System.Text;\nusing xbytechat.api.AuthModule.DTOs;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Repositories.Interfaces;\nusing xbytechat.api.Features.AccessControl.Services;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.AspNetCore.Http;\nusing xbytechat.api.Features.BusinessModule.DTOs;\nusing xbytechat.api.Features.BusinessModule.Models;\nusing xbytechat.api.Features.BusinessModule.Services;\nusing xbytechat.api.Features.FeatureAccessModule.Models;\nusing System.Security.Claims;\nusing System.IdentityModel.Tokens.Jwt;\nusing Microsoft.Extensions.Logging;\n\nnamespace xbytechat.api.AuthModule.Services\n{\n    public class AuthService : IAuthService\n    {\n        private readonly IGenericRepository<User> _userRepo;\n        private readonly IBusinessService _businessService;\n        private readonly IJwtTokenService _jwtTokenService;\n        private readonly IAccessControlService _accessControlService;\n        private readonly IHttpContextAccessor _httpContextAccessor;\n        private readonly ILogger<AuthService> _logger;\n        private readonly AppDbContext _dbContext;\n        public AuthService(\n            IGenericRepository<User> userRepo,\n            IBusinessService businessService,\n            IJwtTokenService jwtTokenService,\n            IAccessControlService accessControlService,\n            IHttpContextAccessor httpContextAccessor,\n            ILogger<AuthService> logger,\n            AppDbContext dbContext)\n        {\n            _userRepo = userRepo;\n            _businessService = businessService;\n            _jwtTokenService = jwtTokenService;\n            _accessControlService = accessControlService;\n            _httpContextAccessor = httpContextAccessor;\n            _logger = logger;\n            _dbContext = dbContext;\n        }\n\n        // 🔑 Production-grade Login\n        //public async Task<ResponseResult> LoginAsync(UserLoginDto dto)\n        //{\n        //    _logger.LogInformation(\"🔑 Login attempt for email: {Email}\", dto.Email);\n        //    var hashedPassword = HashPassword(dto.Password);\n\n        //    var user = await _userRepo\n        //        .AsQueryable()\n        //        .Where(u => u.Email == dto.Email && u.PasswordHash == hashedPassword && !u.IsDeleted)\n        //        .Include(u => u.Role)\n        //        .FirstOrDefaultAsync();\n\n        //    if (user == null)\n        //    {\n        //        _logger.LogWarning(\"❌ Login failed: Invalid email or password for {Email}\", dto.Email);\n        //        return ResponseResult.ErrorInfo(\"❌ Invalid email or password\");\n        //    }\n\n        //    var roleName = user.Role?.Name?.Trim().ToLower() ?? \"unknown\";\n        //    var isAdminType = roleName == \"admin\" || roleName == \"superadmin\" || roleName == \"partner\" || roleName == \"reseller\";\n        //    _logger.LogInformation(\"User role detected: {Role} (AdminType: {IsAdminType})\", roleName, isAdminType);\n\n        //    if (user.BusinessId == null && !isAdminType)\n        //    {\n        //        _logger.LogWarning(\"❌ Login denied for {Email}: No BusinessId and not admin\", dto.Email);\n        //        return ResponseResult.ErrorInfo(\"❌ Your account approval is pending. Please contact your administrator or support.\");\n        //    }\n\n        //    Business business = null;\n        //    if (user.BusinessId != null)\n        //    {\n        //        business = await _businessService\n        //            .Query()\n        //            .Include(b => b.BusinessPlanInfo)\n        //            .FirstOrDefaultAsync(b => b.Id == user.BusinessId.Value);\n\n        //        if (business == null)\n        //        {\n        //            _logger.LogError(\"❌ Login error: Business not found for user {UserId}\", user.Id);\n        //            return ResponseResult.ErrorInfo(\"❌ Associated business not found.\");\n        //        }\n\n        //        if (business.Status == Business.StatusType.Pending)\n        //        {\n        //            _logger.LogWarning(\"⏳ Login blocked: Business under review (BusinessId: {BusinessId})\", business.Id);\n        //            return ResponseResult.ErrorInfo(\"⏳ Your business is under review. Please wait for approval.\");\n        //        }\n        //    }\n\n        //    var permissions = await _accessControlService.GetPermissionsAsync(user.Id);\n\n        //    string planName;\n        //    string companyName;\n        //    string businessId = user.BusinessId?.ToString() ?? \"\";\n\n        //    if (isAdminType)\n        //    {\n        //        planName = roleName;\n        //        companyName = \"xByte Admin\";\n        //        businessId = \"\";\n        //        _logger.LogInformation(\"Admin/superadmin login. Plan set as role: {Plan}\", planName);\n        //    }\n        //    else\n        //    {\n        //        planName = business?.BusinessPlanInfo?.Plan.ToString() ?? \"\";\n        //        companyName = business?.CompanyName ?? \"\";\n        //        _logger.LogInformation(\"Business login. Plan: {Plan}, Company: {Company}\", planName, companyName);\n        //    }\n\n        //    var claims = new List<Claim>\n        //    {\n        //        new Claim(JwtRegisteredClaimNames.Sub, user.Id.ToString()),\n        //        new Claim(JwtRegisteredClaimNames.Email, user.Email ?? \"\"),\n        //        new Claim(\"name\", user.Name ?? \"\"),\n        //        new Claim(ClaimTypes.Role, roleName),\n        //        new Claim(\"role\", roleName),\n        //        new Claim(\"status\", user.Status ?? \"unknown\"),\n        //        new Claim(\"plan\", planName ?? \"\"),\n        //        new Claim(\"businessId\", businessId),\n        //        new Claim(\"companyName\", companyName ?? \"\")\n        //    };\n\n        //    if (permissions?.Any() == true)\n        //    {\n        //        claims.AddRange(permissions.Select(p => new Claim(\"perm\", p)));\n        //    }\n\n        //    var token = _jwtTokenService.GenerateToken(claims);\n\n        //    var userDto = new UserDto\n        //    {\n        //        Id = user.Id,\n        //        Name = user.Name,\n        //        Email = user.Email,\n        //        Role = roleName,\n        //        Status = user.Status,\n        //        CreatedAt = user.CreatedAt,\n        //        BusinessId = string.IsNullOrEmpty(businessId) ? Guid.Empty : Guid.Parse(businessId),\n        //        CompanyName = companyName,\n        //        Plan = planName,\n        //        AccessToken = null\n        //    };\n\n        //    _logger.LogInformation(\"✅ Login successful for {Email}, Role: {Role}, Plan: {Plan}\", dto.Email, roleName, planName);\n\n        //    return new ResponseResult\n        //    {\n        //        Success = true,\n        //        Message = \"✅ Login successful\",\n        //        Data = userDto,\n        //        Token = token\n        //    };\n        //}\n\n        // 🟢 Signup Business User\n\n        //public async Task<ResponseResult> LoginAsync(UserLoginDto dto)\n        //{\n        //    _logger.LogInformation(\"🔑 Login attempt for email: {Email}\", dto.Email);\n        //    var hashedPassword = HashPassword(dto.Password);\n\n        //    var user = await _userRepo\n        //        .AsQueryable()\n        //        .Where(u => u.Email == dto.Email && u.PasswordHash == hashedPassword && !u.IsDeleted)\n        //        .Include(u => u.Role)\n        //        .FirstOrDefaultAsync();\n\n        //    if (user == null)\n        //    {\n        //        _logger.LogWarning(\"❌ Login failed: Invalid email or password for {Email}\", dto.Email);\n        //        return ResponseResult.ErrorInfo(\"❌ Invalid email or password\");\n        //    }\n\n        //    var roleName = user.Role?.Name?.Trim().ToLower() ?? \"unknown\";\n        //    var isAdminType = roleName == \"admin\" || roleName == \"superadmin\" || roleName == \"partner\" || roleName == \"reseller\";\n        //    _logger.LogInformation(\"User role detected: {Role} (AdminType: {IsAdminType})\", roleName, isAdminType);\n\n        //    if (user.BusinessId == null && !isAdminType)\n        //    {\n        //        _logger.LogWarning(\"❌ Login denied for {Email}: No BusinessId and not admin\", dto.Email);\n        //        return ResponseResult.ErrorInfo(\"❌ Your account approval is pending. Please contact your administrator or support.\");\n        //    }\n\n        //    Business business = null;\n        //    if (user.BusinessId != null)\n        //    {\n        //        business = await _businessService\n        //            .Query()\n        //            .Include(b => b.BusinessPlanInfo)\n        //            .FirstOrDefaultAsync(b => b.Id == user.BusinessId.Value);\n\n        //        if (business == null)\n        //        {\n        //            _logger.LogError(\"❌ Login error: Business not found for user {UserId}\", user.Id);\n        //            return ResponseResult.ErrorInfo(\"❌ Associated business not found.\");\n        //        }\n\n        //        if (business.Status == Business.StatusType.Pending)\n        //        {\n        //            _logger.LogWarning(\"⏳ Login blocked: Business under review (BusinessId: {BusinessId})\", business.Id);\n        //            return ResponseResult.ErrorInfo(\"⏳ Your business is under review. Please wait for approval.\");\n        //        }\n        //    }\n\n        //    var permissions = await _accessControlService.GetPermissionsAsync(user.Id);\n\n        //    string planName;\n        //    string companyName;\n        //    string businessId = user.BusinessId?.ToString() ?? \"\";\n\n        //    if (isAdminType)\n        //    {\n        //        planName = roleName; // 'superadmin', 'admin', etc.\n        //        companyName = \"xByte Admin\";\n        //        businessId = \"\";\n        //        _logger.LogInformation(\"Admin/superadmin login. Plan set as role: {Plan}\", planName);\n        //    }\n        //    else\n        //    {\n        //        planName = business?.BusinessPlanInfo?.Plan.ToString() ?? \"\";\n        //        companyName = business?.CompanyName ?? \"\";\n        //        _logger.LogInformation(\"Business login. Plan: {Plan}, Company: {Company}\", planName, companyName);\n        //    }\n\n        //    // ✅ Generate token with full claims\n        //    var token = _jwtTokenService.GenerateToken(\n        //        user.Id.ToString(),\n        //        roleName,\n        //        user.Name ?? \"\",\n        //        user.Email ?? \"\",\n        //        user.Status ?? \"unknown\",\n        //        businessId,\n        //        companyName,\n        //        planName,\n        //        permissions ?? new List<string>()\n        //    );\n\n        //    // ✅ User info for frontend\n        //    var userDto = new UserDto\n        //    {\n        //        Id = user.Id,\n        //        Name = user.Name,\n        //        Email = user.Email,\n        //        Role = roleName,\n        //        Status = user.Status,\n        //        CreatedAt = user.CreatedAt,\n        //        BusinessId = string.IsNullOrEmpty(businessId) ? Guid.Empty : Guid.Parse(businessId),\n        //        CompanyName = companyName,\n        //        Plan = planName,\n        //        AccessToken = null\n        //    };\n\n        //    _logger.LogInformation(\"✅ Login successful for {Email}, Role: {Role}, Plan: {Plan}\", dto.Email, roleName, planName);\n\n        //    return new ResponseResult\n        //    {\n        //        Success = true,\n        //        Message = \"✅ Login successful\",\n        //        Data = userDto,\n        //        Token = token\n        //    };\n        //}\n        //public async Task<ResponseResult> LoginAsync(UserLoginDto dto)\n        //{\n        //    _logger.LogInformation(\"🔑 Login attempt for email: {Email}\", dto.Email);\n        //    var hashedPassword = HashPassword(dto.Password);\n\n        //    var user = await _userRepo\n        //        .AsQueryable()\n        //        .Where(u => u.Email == dto.Email && u.PasswordHash == hashedPassword && !u.IsDeleted)\n        //        .Include(u => u.Role)\n        //        .FirstOrDefaultAsync();\n\n        //    if (user == null)\n        //    {\n        //        _logger.LogWarning(\"❌ Login failed: Invalid email or password for {Email}\", dto.Email);\n        //        return ResponseResult.ErrorInfo(\"❌ Invalid email or password\");\n        //    }\n\n        //    var roleName = user.Role?.Name?.Trim().ToLower() ?? \"unknown\";\n        //    var isAdminType = roleName == \"admin\" || roleName == \"superadmin\" || roleName == \"partner\" || roleName == \"reseller\";\n        //    _logger.LogInformation(\"User role detected: {Role} (AdminType: {IsAdminType})\", roleName, isAdminType);\n\n        //    if (user.BusinessId == null && !isAdminType)\n        //    {\n        //        _logger.LogWarning(\"❌ Login denied for {Email}: No BusinessId and not admin\", dto.Email);\n        //        return ResponseResult.ErrorInfo(\"❌ Your account approval is pending. Please contact your administrator or support.\");\n        //    }\n\n        //    Business business = null;\n        //    if (user.BusinessId != null)\n        //    {\n        //        business = await _businessService\n        //            .Query()\n        //            .Include(b => b.BusinessPlanInfo)\n        //            .FirstOrDefaultAsync(b => b.Id == user.BusinessId.Value);\n\n        //        if (business == null)\n        //        {\n        //            _logger.LogError(\"❌ Login error: Business not found for user {UserId}\", user.Id);\n        //            return ResponseResult.ErrorInfo(\"❌ Associated business not found.\");\n        //        }\n\n        //        if (business.Status == Business.StatusType.Pending)\n        //        {\n        //            _logger.LogWarning(\"⏳ Login blocked: Business under review (BusinessId: {BusinessId})\", business.Id);\n        //            return ResponseResult.ErrorInfo(\"⏳ Your business is under review. Please wait for approval.\");\n        //        }\n        //    }\n\n        //    var permissions = await _accessControlService.GetPermissionsAsync(user.Id);\n\n        //    string planName;\n        //    string companyName;\n        //    string businessId = user.BusinessId?.ToString() ?? \"\";\n\n        //    if (isAdminType)\n        //    {\n        //        planName = roleName; // 'superadmin', 'admin', etc.\n        //        companyName = \"xByte Admin\";\n        //        businessId = \"\";\n        //        _logger.LogInformation(\"Admin/superadmin login. Plan set as role: {Plan}\", planName);\n        //    }\n        //    else\n        //    {\n        //        planName = business?.BusinessPlanInfo?.Plan.ToString() ?? \"\";\n        //        companyName = business?.CompanyName ?? \"\";\n        //        _logger.LogInformation(\"Business login. Plan: {Plan}, Company: {Company}\", planName, companyName);\n        //    }\n\n        //    // ✅ Generate token with full claims\n        //    var token = _jwtTokenService.GenerateToken(\n        //        user.Id.ToString(),\n        //        roleName,\n        //        user.Name ?? \"\",\n        //        user.Email ?? \"\",\n        //        user.Status ?? \"unknown\",\n        //        businessId,\n        //        companyName,\n        //        planName,\n        //        permissions ?? new List<string>()\n        //    );\n\n        //    // ✅ Store token in secure HttpOnly cookie\n        //    _httpContextAccessor.HttpContext.Response.Cookies.Append(\"xbyte_token\", token, new CookieOptions\n        //    {\n        //        HttpOnly = true,\n        //        Secure = true, // Set to false only for localhost if needed\n        //        SameSite = SameSiteMode.Lax,\n        //        Expires = DateTime.UtcNow.AddDays(7)\n        //    });\n\n        //    // ✅ User info for frontend\n        //    var userDto = new UserDto\n        //    {\n        //        Id = user.Id,\n        //        Name = user.Name,\n        //        Email = user.Email,\n        //        Role = roleName,\n        //        Status = user.Status,\n        //        CreatedAt = user.CreatedAt,\n        //        BusinessId = string.IsNullOrEmpty(businessId) ? Guid.Empty : Guid.Parse(businessId),\n        //        CompanyName = companyName,\n        //        Plan = planName,\n        //        AccessToken = null\n        //    };\n\n        //    _logger.LogInformation(\"✅ Login successful for {Email}, Role: {Role}, Plan: {Plan}\", dto.Email, roleName, planName);\n\n        //    return new ResponseResult\n        //    {\n        //        Success = true,\n        //        Message = \"✅ Login successful\",\n        //        Data = userDto,\n        //        Token = token\n        //    };\n        //}\n\n        #region // Below Code comeneted to replace cokkies to bearer\n\n        //public async Task<ResponseResult> LoginAsync(UserLoginDto dto)\n        //{\n        //    _logger.LogInformation(\"🔑 Login attempt for email: {Email}\", dto.Email);\n        //    var hashedPassword = HashPassword(dto.Password);\n\n        //    var user = await _userRepo\n        //        .AsQueryable()\n        //        .Where(u => u.Email == dto.Email && u.PasswordHash == hashedPassword && !u.IsDeleted)\n        //        .Include(u => u.Role)\n        //        .FirstOrDefaultAsync();\n\n        //    if (user == null)\n        //    {\n        //        _logger.LogWarning(\"❌ Login failed: Invalid email or password for {Email}\", dto.Email);\n        //        return ResponseResult.ErrorInfo(\"❌ Invalid email or password\");\n        //    }\n\n        //    var roleName = user.Role?.Name?.Trim().ToLower() ?? \"unknown\";\n        //    var isAdminType = roleName == \"admin\" || roleName == \"superadmin\" || roleName == \"partner\" || roleName == \"reseller\";\n\n        //    if (user.BusinessId == null && !isAdminType)\n        //    {\n        //        _logger.LogWarning(\"❌ Login denied for {Email}: No BusinessId and not admin\", dto.Email);\n        //        return ResponseResult.ErrorInfo(\"❌ Your account approval is pending. Please contact your administrator or support.\");\n        //    }\n\n        //    Business business = null;\n        //    if (user.BusinessId != null)\n        //    {\n        //        business = await _businessService.Query()\n        //            .Include(b => b.BusinessPlanInfo)\n        //            .FirstOrDefaultAsync(b => b.Id == user.BusinessId.Value);\n\n        //        if (business == null)\n        //        {\n        //            _logger.LogError(\"❌ Login error: Business not found for user {UserId}\", user.Id);\n        //            return ResponseResult.ErrorInfo(\"❌ Associated business not found.\");\n        //        }\n\n        //        if (business.Status == Business.StatusType.Pending)\n        //        {\n        //            _logger.LogWarning(\"⏳ Login blocked: Business under review (BusinessId: {BusinessId})\", business.Id);\n        //            return ResponseResult.ErrorInfo(\"⏳ Your business is under review. Please wait for approval.\");\n        //        }\n        //    }\n\n        //    var permissions = await _accessControlService.GetPermissionsAsync(user.Id);\n\n        //    string planName;\n        //    string companyName;\n        //    string businessId = user.BusinessId?.ToString() ?? \"\";\n\n        //    if (isAdminType)\n        //    {\n        //        planName = roleName; // e.g., 'superadmin'\n        //        companyName = \"xByte Admin\";\n        //        businessId = \"\"; // Admins are not tied to a business\n        //    }\n        //    else\n        //    {\n        //        planName = business?.BusinessPlanInfo?.Plan.ToString() ?? \"\";\n        //        companyName = business?.CompanyName ?? \"\";\n        //    }\n\n        //    // ✅ Generate JWT with lowercase claim keys\n        //    var token = _jwtTokenService.GenerateToken(\n        //        user.Id.ToString(),\n        //        roleName,\n        //        user.Name ?? \"\",\n        //        user.Email ?? \"\",\n        //        user.Status ?? \"unknown\",\n        //        businessId,\n        //        companyName,\n        //        planName,\n        //        permissions ?? new List<string>()\n        //    );\n\n        //    // ✅ Store token securely as cookie (must match JwtBearer event)\n        //    _httpContextAccessor.HttpContext.Response.Cookies.Append(\"xbyte_token\", token, \n\n        //        new CookieOptions\n        //    {\n        //        HttpOnly = true,\n        //        Secure = true,\n        //       // SameSite = SameSiteMode.Strict,\n        //        SameSite = SameSiteMode.None,\n        //        Expires = DateTime.UtcNow.AddDays(7),\n        //        Domain = \"http://localhost:3000\"\n        //    });\n\n        //    // ✅ Build user info for frontend\n        //    var userDto = new UserDto\n        //    {\n        //        Id = user.Id,\n        //        Name = user.Name,\n        //        Email = user.Email,\n        //        Role = roleName,\n        //        Status = user.Status,\n        //        CreatedAt = user.CreatedAt,\n        //        BusinessId = string.IsNullOrEmpty(businessId) ? Guid.Empty : Guid.Parse(businessId),\n        //        CompanyName = companyName,\n        //        Plan = planName,\n        //        AccessToken = null // Not needed since we're using secure cookie\n        //    };\n\n        //    _logger.LogInformation(\"✅ Login successful for {Email}, Role: {Role}, Plan: {Plan}\", dto.Email, roleName, planName);\n\n        //    return new ResponseResult\n        //    {\n        //        Success = true,\n        //        Message = \"✅ Login successful\",\n        //        Data = userDto,\n        //        Token = token\n        //    };\n        //}\n\n        #endregion\n\n        //public async Task<ResponseResult> LoginAsync(UserLoginDto dto)\n        //{\n        //    _logger.LogInformation(\"🔑 Login attempt for email: {Email}\", dto.Email);\n        //    var hashedPassword = HashPassword(dto.Password);\n\n        //    var user = await _userRepo\n        //        .AsQueryable()\n        //        .Where(u => u.Email == dto.Email && u.PasswordHash == hashedPassword && !u.IsDeleted)\n        //        .Include(u => u.Role)\n        //        .FirstOrDefaultAsync();\n\n        //    if (user == null)\n        //    {\n        //        _logger.LogWarning(\"❌ Login failed: Invalid email or password for {Email}\", dto.Email);\n        //        return ResponseResult.ErrorInfo(\"❌ Invalid email or password\");\n        //    }\n\n        //    var roleName = user.Role?.Name?.Trim().ToLower() ?? \"unknown\";\n        //    var isAdminType = roleName is \"admin\" or \"superadmin\" or \"partner\" or \"reseller\";\n\n        //    if (user.BusinessId == null && !isAdminType)\n        //    {\n        //        _logger.LogWarning(\"❌ Login denied for {Email}: No BusinessId and not admin\", dto.Email);\n        //        return ResponseResult.ErrorInfo(\"❌ Your account approval is pending. Please contact your administrator or support.\");\n        //    }\n\n        //    Business? business = null;\n        //    if (user.BusinessId != null)\n        //    {\n        //        business = await _businessService.Query()\n        //            .Include(b => b.BusinessPlanInfo)\n        //            .FirstOrDefaultAsync(b => b.Id == user.BusinessId.Value);\n\n        //        if (business == null)\n        //            return ResponseResult.ErrorInfo(\"❌ Associated business not found.\");\n\n        //        if (business.Status == Business.StatusType.Pending)\n        //            return ResponseResult.ErrorInfo(\"⏳ Your business is under review. Please wait for approval.\");\n        //    }\n\n        //    var permissions = await _accessControlService.GetPermissionsAsync(user.Id);\n\n        //    string planName;\n        //    string companyName;\n        //    string businessId = user.BusinessId?.ToString() ?? \"\";\n\n        //    if (isAdminType)\n        //    {\n        //        planName = roleName;        // admin types treated as plan in UI\n        //        companyName = \"xByte Admin\";\n        //        businessId = \"\";\n        //    }\n        //    else\n        //    {\n        //        planName = business?.BusinessPlanInfo?.Plan.ToString() ?? \"basic\";\n        //        companyName = business?.CompanyName ?? \"\";\n        //    }\n\n        //    // ✅ Generate JWT (includes role/plan/biz + ClaimTypes.Role)\n        //    var token = _jwtTokenService.GenerateToken(\n        //        user.Id.ToString(),\n        //        roleName,\n        //        user.Name ?? \"\",\n        //        user.Email ?? \"\",\n        //        user.Status ?? \"unknown\",\n        //        businessId,\n        //        companyName,\n        //        planName,\n        //        permissions ?? new List<string>()\n        //    );\n\n        //    // ❌ NO cookie writes in Bearer mode\n\n        //    var userDto = new UserDto\n        //    {\n        //        Id = user.Id,\n        //        Name = user.Name,\n        //        Email = user.Email,\n        //        Role = roleName,\n        //        Status = user.Status,\n        //        CreatedAt = user.CreatedAt,\n        //        BusinessId = string.IsNullOrEmpty(businessId) ? Guid.Empty : Guid.Parse(businessId),\n        //        CompanyName = companyName,\n        //        Plan = planName,\n        //        AccessToken = null\n        //    };\n\n        //    _logger.LogInformation(\"✅ Login successful for {Email}, Role: {Role}, Plan: {Plan}\", dto.Email, roleName, planName);\n\n        //    return new ResponseResult\n        //    {\n        //        Success = true,\n        //        Message = \"✅ Login successful\",\n        //        Data = userDto,\n        //        Token = token\n        //    };\n        //}\n\n        //public async Task<ResponseResult> LoginAsync(UserLoginDto dto)\n        //{\n        //    _logger.LogInformation(\"🔑 Login attempt for email: {Email}\", dto.Email);\n        //    var hashedPassword = HashPassword(dto.Password);\n\n        //    var user = await _userRepo\n        //        .AsQueryable()\n        //        .Where(u => u.Email == dto.Email && u.PasswordHash == hashedPassword && !u.IsDeleted)\n        //        .Include(u => u.Role)\n        //        .FirstOrDefaultAsync();\n\n        //    if (user == null)\n        //    {\n        //        _logger.LogWarning(\"❌ Login failed: Invalid email or password for {Email}\", dto.Email);\n        //        return ResponseResult.ErrorInfo(\"❌ Invalid email or password\");\n        //    }\n\n        //    var roleName = user.Role?.Name?.Trim().ToLower() ?? \"unknown\";\n        //    var isAdminType = roleName is \"admin\" or \"superadmin\" or \"partner\" or \"reseller\";\n\n        //    if (user.BusinessId == null && !isAdminType)\n        //    {\n        //        _logger.LogWarning(\"❌ Login denied for {Email}: No BusinessId and not admin\", dto.Email);\n        //        return ResponseResult.ErrorInfo(\"❌ Your account approval is pending. Please contact your administrator or support.\");\n        //    }\n\n        //    Business? business = null;\n        //    Guid? planId = null;\n        //   // string planName = string.Empty;\n        //    string companyName = string.Empty;\n        //    string businessId = user.BusinessId?.ToString() ?? string.Empty;\n\n        //    if (user.BusinessId != null)\n        //    {\n        //        business = await _businessService.Query()\n        //            .Include(b => b.Plan) // Ensure Plan navigation exists in Business model\n        //            .FirstOrDefaultAsync(b => b.Id == user.BusinessId.Value);\n\n        //        if (business == null)\n        //            return ResponseResult.ErrorInfo(\"❌ Associated business not found.\");\n\n        //        if (business.Status == Business.StatusType.Pending)\n        //            return ResponseResult.ErrorInfo(\"⏳ Your business is under review. Please wait for approval.\");\n\n        //        if (!business.PlanId.HasValue)\n        //            return ResponseResult.ErrorInfo(\"❌ No plan assigned to this business.\");\n\n        //        planId = business.PlanId;\n        //      //  planName = business.Plan?.Name ?? string.Empty;\n        //        companyName = business.CompanyName ?? string.Empty;\n        //    }\n\n        //    if (isAdminType)\n        //    {\n        //       // planName = roleName; // Admins' \"plan\" is just their role name\n        //        companyName = \"xByte Admin\";\n        //        businessId = string.Empty;\n        //        planId = null; // No plan restriction for admins\n        //    }\n\n        //    var permissions = planId.HasValue\n        //        ? await _accessControlService.GetPermissionsByPlanIdAsync(planId)\n        //        : new List<string>();\n\n        //    // ✅ Generate JWT with planId\n        //    var token = _jwtTokenService.GenerateToken(\n        //        user.Id.ToString(),\n        //        roleName,\n        //        user.Name ?? string.Empty,\n        //        user.Email ?? string.Empty,\n        //        user.Status ?? \"unknown\",\n        //        businessId,\n        //        companyName,\n        //       // planName,\n        //        permissions ?? new List<string>(),\n        //        planId?.ToString() ?? string.Empty\n        //    );\n\n        //    var userDto = new UserDto\n        //    {\n        //        Id = user.Id,\n        //        Name = user.Name,\n        //        Email = user.Email,\n        //        Role = roleName,\n        //        Status = user.Status,\n        //        CreatedAt = user.CreatedAt,\n        //        BusinessId = string.IsNullOrEmpty(businessId) ? Guid.Empty : Guid.Parse(businessId),\n        //        CompanyName = companyName,\n        //        //Plan = planName,\n        //        PlanId = planId,\n        //        AccessToken = null\n        //    };\n\n        //    _logger.LogInformation(\n        //        \"✅ Login successful for {Email}, Role: {Role}, PlanId: {PlanId}\",\n        //        dto.Email, roleName, planId\n        //    );\n\n        //    return new ResponseResult\n        //    {\n        //        Success = true,\n        //        Message = \"✅ Login successful\",\n        //        Data = userDto,\n        //        Token = token\n        //    };\n        //}\n        public async Task<ResponseResult> LoginAsync(UserLoginDto dto)\n        {\n            _logger.LogInformation(\"🔑 Login attempt for email: {Email}\", dto.Email);\n            var hashedPassword = HashPassword(dto.Password);\n\n            var user = await _userRepo\n                .AsQueryable()\n                .Where(u => u.Email == dto.Email && u.PasswordHash == hashedPassword && !u.IsDeleted)\n                .Include(u => u.Role)\n                .FirstOrDefaultAsync();\n\n            if (user == null)\n            {\n                _logger.LogWarning(\"❌ Login failed: Invalid email or password for {Email}\", dto.Email);\n                return ResponseResult.ErrorInfo(\"❌ Invalid email or password\");\n            }\n\n            var roleName = user.Role?.Name?.Trim().ToLower() ?? \"unknown\";\n            var isAdminType = roleName is \"admin\" or \"superadmin\" or \"partner\" or \"reseller\";\n\n            if (user.BusinessId == null && !isAdminType)\n            {\n                _logger.LogWarning(\"❌ Login denied for {Email}: No BusinessId and not admin\", dto.Email);\n                return ResponseResult.ErrorInfo(\"❌ Your account approval is pending. Please contact your administrator or support.\");\n            }\n\n            Business? business = null;\n            Guid? planId = null;\n            string companyName = string.Empty;\n            string businessId = user.BusinessId?.ToString() ?? string.Empty;\n\n            if (user.BusinessId != null)\n            {\n                business = await _businessService.Query()\n                    .Include(b => b.Plan)\n                    .FirstOrDefaultAsync(b => b.Id == user.BusinessId.Value);\n\n                if (business == null)\n                    return ResponseResult.ErrorInfo(\"❌ Associated business not found.\");\n\n                if (business.Status == Business.StatusType.Pending)\n                    return ResponseResult.ErrorInfo(\"⏳ Your business is under review. Please wait for approval.\");\n\n                if (!business.PlanId.HasValue)\n                    return ResponseResult.ErrorInfo(\"❌ No plan assigned to this business.\");\n\n                planId = business.PlanId;\n                companyName = business.CompanyName ?? string.Empty;\n            }\n\n            if (isAdminType)\n            {\n                // Admins don’t get plan restrictions\n                companyName = \"xByte Admin\";\n                businessId = string.Empty;\n                planId = null;\n            }\n\n            // 🔥 Compute EFFECTIVE permissions (plan ∩ role) and derive features\n            var (permCodes, featureKeys) = isAdminType\n                ? (await GetAllActivePermissions(), new List<string> { \"Dashboard\", \"Messaging\", \"CRM\", \"Campaigns\", \"Catalog\", \"AdminPanel\" })\n                : await GetEffectivePermissionsAndFeaturesAsync(user.Id);\n\n            // 🎫 Generate JWT (now includes permissions, features, plan_id)\n            var token = _jwtTokenService.GenerateToken(\n                userId: user.Id.ToString(),\n                role: roleName,\n                userName: user.Name ?? string.Empty,\n                email: user.Email ?? string.Empty,\n                status: user.Status ?? \"unknown\",\n                businessId: businessId,\n                companyName: companyName,\n                permissions: permCodes ?? new List<string>(),\n                planId: planId?.ToString() ?? string.Empty,\n                features: featureKeys,\n                hasAllAccess: isAdminType\n            );\n            try\n            {\n                var jwt = new JwtSecurityTokenHandler().ReadJwtToken(token);\n                var pid = jwt.Claims.FirstOrDefault(c => c.Type == \"plan_id\")?.Value;\n                _logger.LogInformation(\"🔎 JWT includes plan_id: {PlanId}\", pid ?? \"<null>\");\n            }\n            catch { /* ignore */ }\n            var userDto = new UserDto\n            {\n                Id = user.Id,\n                Name = user.Name,\n                Email = user.Email,\n                Role = roleName,\n                Status = user.Status,\n                CreatedAt = user.CreatedAt,\n                BusinessId = string.IsNullOrEmpty(businessId) ? Guid.Empty : Guid.Parse(businessId),\n                CompanyName = companyName,\n                PlanId = planId,\n                AccessToken = null\n            };\n\n            _logger.LogInformation(\n                \"✅ Login successful for {Email}, Role: {Role}, PlanId: {PlanId}\",\n                dto.Email, roleName, planId\n            );\n\n            return new ResponseResult\n            {\n                Success = true,\n                Message = \"✅ Login successful\",\n                Data = userDto,\n                Token = token\n            };\n        }\n        public async Task<ResponseResult> SignupAsync(SignupBusinessDto dto)\n        {\n            _logger.LogInformation(\"🟢 Signup attempt: {Email}\", dto.Email);\n            var result = await _businessService.SignupBusinessAsync(dto);\n\n            if (!result.Success)\n            {\n                _logger.LogWarning(\"❌ Signup failed for {Email}: {Msg}\", dto.Email, result.Message);\n                return ResponseResult.ErrorInfo(result.Message);\n            }\n\n            var business = await _businessService.GetBusinessByEmailAsync(dto.Email);\n\n            if (business == null)\n            {\n                _logger.LogError(\"❌ Signup succeeded but business retrieval failed for {Email}\", dto.Email);\n                return ResponseResult.ErrorInfo(\"❌ Signup succeeded but business retrieval failed.\");\n            }\n\n            try\n            {\n                // 🆕 Set BusinessAssignedTo if available\n                if (dto.CreatedByPartnerId.HasValue && business.CreatedByPartnerId == null)\n                {\n                    business.CreatedByPartnerId = dto.CreatedByPartnerId;\n                    await _businessService.UpdateBusinessAsync(business);\n                    _logger.LogInformation(\"✅ Partner assigned during signup: {PartnerId} for Business: {BusinessId}\", dto.CreatedByPartnerId, business.Id);\n                }\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"❌ Signup succeeded but assigning partner failed for {Email}\", dto.Email);\n                return ResponseResult.ErrorInfo(\"❌ Signup succeeded but assigning partner failed: \" + ex.Message);\n            }\n\n            _logger.LogInformation(\"✅ Signup successful for {Email} (BusinessId: {BusinessId})\", dto.Email, business.Id);\n            return ResponseResult.SuccessInfo(\"✅ Signup successful. Pending approval.\", new { BusinessId = business.Id });\n        }\n\n        // 🔄 Refresh JWT Token (and Rotate)\n        //public async Task<ResponseResult> RefreshTokenAsync(string refreshToken)\n        //{\n        //    _logger.LogInformation(\"🔄 RefreshToken attempt\");\n\n        //    var user = await _userRepo\n        //        .AsQueryable()\n        //        .Include(u => u.Role)\n        //        .Include(u => u.Business)\n        //            .ThenInclude(b => b.BusinessPlanInfo)\n        //        .FirstOrDefaultAsync(u => u.RefreshToken == refreshToken && u.RefreshTokenExpiry > DateTime.UtcNow);\n\n        //    if (user == null)\n        //    {\n        //        _logger.LogWarning(\"❌ Invalid or expired refresh token.\");\n        //        return ResponseResult.ErrorInfo(\"❌ Invalid or expired refresh token.\");\n        //    }\n\n        //    var permissions = await _accessControlService.GetPermissionsAsync(user.Id);\n        //    var roleName = user.Role?.Name?.Trim().ToLower() ?? \"unknown\";\n        //    var isAdminType = roleName == \"superadmin\" || roleName == \"partner\" || roleName == \"reseller\";\n\n        //    string planName;\n        //    string companyName;\n        //    string businessId = user.BusinessId?.ToString() ?? \"\";\n\n        //    if (isAdminType)\n        //    {\n        //        planName = roleName;\n        //        companyName = \"xByte Admin\";\n        //        businessId = \"\";\n        //    }\n        //    else\n        //    {\n        //        planName = user.Business?.BusinessPlanInfo?.Plan.ToString() ?? \"\";\n        //        companyName = user.Business?.CompanyName ?? \"\";\n        //    }\n\n        //    var claims = new List<Claim>\n        //    {\n        //        new Claim(JwtRegisteredClaimNames.Sub, user.Id.ToString()),\n        //        new Claim(JwtRegisteredClaimNames.Email, user.Email ?? \"\"),\n        //        new Claim(\"name\", user.Name ?? \"\"),\n        //        new Claim(ClaimTypes.Role, roleName),\n        //        new Claim(\"role\", roleName),\n        //        new Claim(\"status\", user.Status ?? \"unknown\"),\n        //        new Claim(\"plan\", planName ?? \"\"),\n        //        new Claim(\"businessId\", businessId),\n        //        new Claim(\"companyName\", companyName ?? \"\")\n        //    };\n\n        //    if (permissions?.Any() == true)\n        //    {\n        //        claims.AddRange(permissions.Select(p => new Claim(\"perm\", p)));\n        //    }\n\n        //    var token = _jwtTokenService.GenerateToken(claims);\n\n        //    // 🔁 Rotate refresh token\n        //    var newRefreshToken = Guid.NewGuid().ToString(\"N\");\n        //    user.RefreshToken = newRefreshToken;\n        //    user.RefreshTokenExpiry = DateTime.UtcNow.AddDays(30);\n        //    _userRepo.Update(user);\n\n        //    _logger.LogInformation(\"🔄 Token refreshed for user {UserId}, role {Role}\", user.Id, roleName);\n\n        //    return ResponseResult.SuccessInfo(\"🔄 Token refreshed\", new\n        //    {\n        //        accessToken = token,\n        //        refreshToken = newRefreshToken\n        //    });\n        //}\n\n        // 🔁 Resend confirmation\n\n        // 🔄 Refresh JWT Token (and Rotate)\n        public async Task<ResponseResult> RefreshTokenAsync(string refreshToken)\n        {\n            _logger.LogInformation(\"🔄 RefreshToken attempt\");\n\n            var user = await _userRepo\n                .AsQueryable()\n                .Include(u => u.Role)\n                .Include(u => u.Business)\n                    .ThenInclude(b => b.BusinessPlanInfo)\n                .FirstOrDefaultAsync(u => u.RefreshToken == refreshToken && u.RefreshTokenExpiry > DateTime.UtcNow);\n\n            if (user == null)\n            {\n                _logger.LogWarning(\"❌ Invalid or expired refresh token.\");\n                return ResponseResult.ErrorInfo(\"❌ Invalid or expired refresh token.\");\n            }\n\n            var roleName = user.Role?.Name?.Trim().ToLower() ?? \"unknown\";\n            var isAdminType = roleName is \"admin\" or \"superadmin\" or \"partner\" or \"reseller\";\n\n            string planId = user.Business?.PlanId?.ToString() ?? string.Empty;\n            string companyName = isAdminType ? \"xByte Admin\" : (user.Business?.CompanyName ?? string.Empty);\n            string businessId = isAdminType ? string.Empty : (user.BusinessId?.ToString() ?? string.Empty);\n\n            var (permCodes, featureKeys) = isAdminType\n                ? (await GetAllActivePermissions(), new List<string> { \"Dashboard\", \"Messaging\", \"CRM\", \"Campaigns\", \"Catalog\", \"AdminPanel\" })\n                : await GetEffectivePermissionsAndFeaturesAsync(user.Id);\n\n            var claims = new List<Claim>\n        {\n            new Claim(JwtRegisteredClaimNames.Sub, user.Id.ToString()),\n            new Claim(\"id\", user.Id.ToString()),\n            new Claim(ClaimTypes.NameIdentifier, user.Id.ToString()),\n            new Claim(\"email\", user.Email ?? \"\"),\n            new Claim(\"name\", user.Name ?? \"\"),\n            new Claim(\"status\", user.Status ?? \"unknown\"),\n            new Claim(\"businessId\", businessId),\n            new Claim(\"companyName\", companyName),\n            new Claim(\"permissions\", string.Join(\",\", permCodes ?? new List<string>())),\n            new Claim(\"features\", string.Join(\",\", featureKeys ?? new List<string>())),\n            new Claim(\"hasAllAccess\", isAdminType ? \"true\" : \"false\"),\n            new Claim(\"role\", roleName),\n            new Claim(ClaimTypes.Role, roleName),\n            new Claim(\"plan_id\", planId ?? string.Empty)\n        };\n\n            var token = _jwtTokenService.GenerateToken(claims);\n\n            // 🔁 Rotate refresh token\n            var newRefreshToken = Guid.NewGuid().ToString(\"N\");\n            user.RefreshToken = newRefreshToken;\n            user.RefreshTokenExpiry = DateTime.UtcNow.AddDays(30);\n            _userRepo.Update(user);\n\n            _logger.LogInformation(\"🔄 Token refreshed for user {UserId}, role {Role}\", user.Id, roleName);\n\n            return ResponseResult.SuccessInfo(\"🔄 Token refreshed\", new\n            {\n                accessToken = token,\n                refreshToken = newRefreshToken\n            });\n        }\n        public async Task<ResponseResult> ResendConfirmationAsync(ResendConfirmationDto dto)\n        {\n            _logger.LogInformation(\"🔁 Resend confirmation attempt for {Email}\", dto.Email);\n            var business = await _businessService.GetBusinessByEmailAsync(dto.Email);\n            if (business == null)\n            {\n                _logger.LogWarning(\"❌ Resend confirmation failed: No business for {Email}\", dto.Email);\n                return ResponseResult.ErrorInfo(\"❌ No business registered with this email\");\n            }\n\n            _logger.LogInformation(\"✅ Resend confirmation request processed for {Email}\", dto.Email);\n            return ResponseResult.SuccessInfo(\"📨 Confirmation request resent.\");\n        }\n        public async Task<FeatureAccessDto> GetFeatureAccessForUserAsync(ClaimsPrincipal user)\n        {\n            var role = user.FindFirstValue(\"role\")?.ToLower();\n            var dto = new FeatureAccessDto();\n\n            if (role == \"superadmin\")\n            {\n                // Grant all known frontend features\n                dto.Features = await _dbContext.FeatureAccess\n                    .Select(f => f.FeatureName)\n                    .Distinct()\n                    .ToDictionaryAsync(name => name, name => true);\n\n                return dto;\n            }\n\n            var plan = user.FindFirstValue(\"plan\")?.ToLower();\n            var businessIdStr = user.FindFirstValue(\"businessId\");\n\n            if (!Guid.TryParse(businessIdStr, out var businessId))\n                return dto;\n\n            // Plan-level or per-business override\n            var features = await _dbContext.FeatureAccess\n                .Where(f => f.BusinessId == businessId || f.Plan.ToLower() == plan)\n                .ToListAsync();\n\n            foreach (var feature in features)\n            {\n                dto.Features[feature.FeatureName] = feature.IsEnabled;\n            }\n\n            return dto;\n        }\n\n        // 🔒 Reset password\n        public async Task<ResponseResult> ResetPasswordAsync(ResetPasswordDto dto)\n        {\n            _logger.LogInformation(\"🔒 Reset password attempt for {Email}\", dto.Email);\n            var user = await _userRepo.FirstOrDefaultAsync(u => u.Email == dto.Email);\n            if (user == null)\n            {\n                _logger.LogWarning(\"❌ Reset password failed: No user for {Email}\", dto.Email);\n                return ResponseResult.ErrorInfo(\"❌ No user found with this email\");\n            }\n\n            user.PasswordHash = HashPassword(dto.NewPassword);\n            _userRepo.Update(user);\n\n            _logger.LogInformation(\"✅ Password reset successfully for {Email}\", dto.Email);\n            return ResponseResult.SuccessInfo(\"✅ Password reset successfully\");\n        }\n\n        // Utility: Hash password using SHA256\n        //private string HashPassword(string password)\n        //{\n        //    using var sha = SHA256.Create();\n        //    var bytes = Encoding.UTF8.GetBytes(password);\n        //    var hash = sha.ComputeHash(bytes);\n        //    return Convert.ToBase64String(hash);\n        //}\n        // INTERSECTION: Role ∩ Plan for the user, then map groups -> feature keys\n        //private async Task<(List<string> Perms, List<string> Features)> GetEffectivePermissionsAndFeaturesAsync(Guid userId)\n        //{\n        //    var userAndPermissions = _dbContext.Users\n        //        .Where(u => u.Id == userId)\n        //        .Join(_dbContext.Businesses,\n        //            u => u.BusinessId,\n        //            b => b.Id,\n        //            (u, b) => new { u, b })\n        //        .Join(_dbContext.PlanPermissions.Where(pp => pp.IsActive),\n        //            ub => ub.b.PlanId,\n        //            pp => pp.PlanId,\n        //            (ub, pp) => new { ub.u, pp })\n        //        .Join(_dbContext.Permissions.Where(p => p.IsActive),\n        //            ubpp => ubpp.pp.PermissionId,\n        //            p => p.Id,\n        //            (ubpp, p) => new { ubpp.u, p }); // This gives you a sequence of {user, permission} pairs\n\n        //    // Replace the final problematic Join with this Where clause\n        //    var rows = await userAndPermissions\n        //        .Where(up => _dbContext.RolePermissions\n        //            .Where(rp => rp.IsActive && !rp.IsRevoked)\n        //            .Any(rp => rp.RoleId == up.u.RoleId && rp.PermissionId == up.p.Id))\n        //        .Select(up => up.p) // Select the final permission object\n        //        .Select(p => new { p.Code, p.Group })\n        //        .Distinct()\n        //        .ToListAsync();\n\n        //    var perms = rows.Select(r => r.Code).ToList();\n\n        //    var features = rows.Select(r => r.Group)\n        //        .Where(g => !string.IsNullOrWhiteSpace(g))\n        //        .Select(GroupToFeature)\n        //        .Where(f => f != null)\n        //        .Select(f => f!)\n        //        .Distinct(StringComparer.OrdinalIgnoreCase)\n        //        .ToList();\n\n        //    return (perms, features);\n        //}\n        //// If you ever need “all perms” (e.g., for superadmins)\n        /// <summary>\n        /// \n        /// </summary>\n        /// <returns></returns>\n        /// \n        private async Task<(List<string> Perms, List<string> Features)> GetEffectivePermissionsAndFeaturesAsync(Guid userId)\n        {\n            var rows = await _dbContext.Users\n                .AsNoTracking()\n                .Where(u => u.Id == userId)\n                .Join(_dbContext.Businesses.AsNoTracking(),\n                      u => u.BusinessId,\n                      b => b.Id,\n                      (u, b) => new { u, b })\n                .Join(_dbContext.PlanPermissions.AsNoTracking().Where(pp => pp.IsActive),\n                      ub => ub.b.PlanId,\n                      pp => pp.PlanId,\n                      (ub, pp) => new { ub.u, pp })\n                .Join(_dbContext.Permissions.AsNoTracking().Where(p => p.IsActive),\n                      ubpp => ubpp.pp.PermissionId,\n                      p => p.Id,\n                      (ubpp, p) => new { ubpp.u, p })\n                // Intersect with RolePermissions via EXISTS\n                .Where(up => _dbContext.RolePermissions\n                    .AsNoTracking()\n                    .Where(rp => rp.IsActive && !rp.IsRevoked)\n                    .Any(rp => rp.RoleId == up.u.RoleId && rp.PermissionId == up.p.Id))\n                .Select(up => new { up.p.Code, up.p.Group })\n                .Distinct()\n                .ToListAsync();\n\n            var perms = rows.Select(r => r.Code).ToList();\n\n            var features = rows.Select(r => r.Group)\n                .Where(g => !string.IsNullOrWhiteSpace(g))\n                .Select(GroupToFeature)\n                .Where(f => f != null)\n                .Select(f => f!)\n                .Distinct(StringComparer.OrdinalIgnoreCase)\n                .ToList();\n\n            return (perms, features);\n        }\n\n        private async Task<List<string>> GetAllActivePermissions() =>\n            await _dbContext.Permissions\n                .Where(p => p.IsActive)\n                .Select(p => p.Code)\n                .OrderBy(c => c)\n                .ToListAsync();\n\n        private static string? GroupToFeature(string? g) => g switch\n        {\n            \"Messaging\" => \"Messaging\",\n            \"Contacts\" => \"CRM\",\n            \"Campaign\" => \"Campaigns\",\n            \"Product\" => \"Catalog\",\n            \"Dashboard\" => \"Dashboard\",\n            \"Admin\" => \"AdminPanel\",\n            _ => null\n        };\n\n        private string HashPassword(string password)\n        {\n            using var sha = SHA256.Create();\n            var bytes = Encoding.UTF8.GetBytes(password);\n            var hash = sha.ComputeHash(bytes);\n            return Convert.ToBase64String(hash);\n        }\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/AuthModule/Services/IAuthService.cs",
      "sha256": "7d563b4b118d631a798738eddf29e7637d5defe5bf5863d10d24b3e31bd897db",
      "language": "csharp",
      "size": 745,
      "content": "using System.Security.Claims;\nusing xbytechat.api.AuthModule.DTOs;\nusing xbytechat.api.Features.BusinessModule.DTOs;\nusing xbytechat.api.Helpers;\n\nnamespace xbytechat.api.AuthModule.Services\n{\n    public interface IAuthService\n    {\n        Task<ResponseResult> LoginAsync(UserLoginDto dto);\n        Task<ResponseResult> SignupAsync(SignupBusinessDto dto);                  // ✅ Add this\n        Task<ResponseResult> ResetPasswordAsync(ResetPasswordDto dto);           // ✅ Add this\n        Task<ResponseResult> ResendConfirmationAsync(ResendConfirmationDto dto); // ✅ Add this\n        Task<ResponseResult> RefreshTokenAsync(string refreshToken);\n        Task<FeatureAccessDto> GetFeatureAccessForUserAsync(ClaimsPrincipal user);\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/AuthModule/Services/IJwtTokenService.cs",
      "sha256": "6d4a732e224fe37de1184e7c79c9a3413bab6ea6cda0d29a1c3fb5a70cf9b6e7",
      "language": "csharp",
      "size": 750,
      "content": "using Microsoft.IdentityModel.Tokens;\nusing System.Collections.Generic;\nusing System.Security.Claims;\n\nnamespace xbytechat.api.AuthModule.Services\n{\n    public interface IJwtTokenService\n    {\n        string GenerateToken(\n            string userId,\n            string role,\n            string userName,\n            string email,\n            string status,\n            string businessId,\n            string companyName,\n                       List<string> permissions,\n            string planId,\n              List<string>? features = null,\n            bool hasAllAccess = false\n        );\n        string GenerateToken(IEnumerable<Claim> claims);\n        TokenValidationParameters GetValidationParameters(); // ✅ For Middleware validation\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/AuthModule/Services/JwtTokenService.cs",
      "sha256": "54b0235003a02ee3bff4006db2d37974e88962409ec7f015cbad4ad2a264491f",
      "language": "csharp",
      "size": 12625,
      "content": "using Microsoft.Extensions.Configuration;\nusing Microsoft.Extensions.Logging;\nusing Microsoft.IdentityModel.Tokens;\nusing System;\nusing System.Collections.Generic;\nusing System.IdentityModel.Tokens.Jwt;\nusing System.Linq;\nusing System.Security.Claims;\nusing System.Text;\n\nnamespace xbytechat.api.AuthModule.Services\n{\n    public class JwtTokenService : IJwtTokenService\n    {\n        private readonly IConfiguration _config;\n        private readonly ILogger<JwtTokenService> _logger;\n\n        public JwtTokenService(IConfiguration config, ILogger<JwtTokenService> logger)\n        {\n            _config = config;\n            _logger = logger;\n        }\n\n        public string GenerateToken(\n            string userId,\n            string role,\n            string userName,\n            string email,\n            string status,\n            string businessId,\n            string companyName,\n            List<string> permissions,\n            string planId,\n            List<string>? features = null,\n            bool hasAllAccess = false)\n        {\n            try\n            {\n                var permissionString = string.Join(\",\", permissions ?? new List<string>());\n                var featuresString = string.Join(\",\", features ?? new List<string>());\n\n                var claims = new List<Claim>\n{\n    new Claim(JwtRegisteredClaimNames.Sub, userId),\n    new Claim(\"id\", userId),\n    new Claim(ClaimTypes.NameIdentifier, userId),\n\n    new Claim(\"email\", email ?? \"\"),\n    new Claim(\"name\", userName ?? \"\"),\n    new Claim(\"status\", status ?? \"unknown\"),\n\n    // 🔐 Business id: add BOTH for compatibility\n    new Claim(\"BusinessId\", businessId ?? \"\"), // <-- used by our helpers/controllers\n    new Claim(\"businessId\", businessId ?? \"\"), // <-- keep for existing clients\n\n    new Claim(\"companyName\", companyName ?? \"\"),\n\n    // 🔖 Role (API + UI)\n    new Claim(\"role\", role?.ToLowerInvariant() ?? \"unknown\"),\n    new Claim(ClaimTypes.Role, role?.ToLowerInvariant() ?? \"unknown\"),\n\n    // 🧩 Plan & access\n    new Claim(\"plan_id\", planId ?? string.Empty),\n    new Claim(\"permissions\", string.Join(\",\", permissions ?? new List<string>())),\n    new Claim(\"features\", string.Join(\",\", features ?? new List<string>())),\n    new Claim(\"hasAllAccess\", hasAllAccess ? \"true\" : \"false\"),\n};\n\n\n                return GenerateToken(claims);\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"❌ Error generating token for userId: {UserId}\", userId);\n                throw;\n            }\n        }\n\n        public string GenerateToken(IEnumerable<Claim> claims)\n        {\n            try\n            {\n                var jwtSettings = _config.GetSection(\"JwtSettings\");\n\n                var secret = jwtSettings[\"SecretKey\"];\n                if (string.IsNullOrEmpty(secret))\n                {\n                    _logger.LogWarning(\"⚠️ JWT SecretKey is missing from configuration.\");\n                    throw new Exception(\"JWT SecretKey is not configured.\");\n                }\n\n                var expiry = jwtSettings[\"ExpiryMinutes\"];\n                if (!int.TryParse(expiry, out var expiryMinutes))\n                {\n                    _logger.LogWarning(\"⚠️ JWT ExpiryMinutes is invalid or missing. Defaulting to 60 minutes.\");\n                    expiryMinutes = 60;\n                }\n\n                var secretKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(secret));\n                var creds = new SigningCredentials(secretKey, SecurityAlgorithms.HmacSha256);\n\n                var expires = DateTime.UtcNow.AddMinutes(expiryMinutes);\n                var unixExp = new DateTimeOffset(expires).ToUnixTimeSeconds();\n\n                var finalClaims = claims.ToList();\n                finalClaims.Add(new Claim(JwtRegisteredClaimNames.Exp, unixExp.ToString()));\n\n                var token = new JwtSecurityToken(\n                    issuer: jwtSettings[\"Issuer\"],\n                    audience: jwtSettings[\"Audience\"],\n                    claims: finalClaims,\n                    expires: expires,\n                    signingCredentials: creds\n                );\n\n                _logger.LogInformation(\"✅ Token generated for: {Email}\", finalClaims.FirstOrDefault(c => c.Type == \"email\")?.Value);\n\n                return new JwtSecurityTokenHandler().WriteToken(token);\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"❌ Error generating JWT from claims.\");\n                throw;\n            }\n        }\n\n        public TokenValidationParameters GetValidationParameters()\n        {\n            var jwtSettings = _config.GetSection(\"JwtSettings\");\n\n            return new TokenValidationParameters\n            {\n                ValidateIssuer = true,\n                ValidateAudience = true,\n                ValidateIssuerSigningKey = true,\n                ValidateLifetime = true,\n                RequireSignedTokens = true,\n                RequireExpirationTime = true,\n                ValidIssuer = jwtSettings[\"Issuer\"],\n                ValidAudience = jwtSettings[\"Audience\"],\n                IssuerSigningKey = new SymmetricSecurityKey(\n                    Encoding.UTF8.GetBytes(jwtSettings[\"SecretKey\"])\n                ),\n                ClockSkew = TimeSpan.Zero,\n                RoleClaimType = \"role\",\n                NameClaimType = \"name\"\n            };\n        }\n    }\n}\n\n\n//using Microsoft.Extensions.Configuration;\n//using Microsoft.Extensions.Logging;\n//using Microsoft.IdentityModel.Tokens;\n//using System;\n//using System.Collections.Generic;\n//using System.IdentityModel.Tokens.Jwt;\n//using System.Linq;\n//using System.Security.Claims;\n//using System.Text;\n\n//namespace xbytechat.api.AuthModule.Services\n//{\n//    public class JwtTokenService : IJwtTokenService\n//    {\n//        private readonly IConfiguration _config;\n//        private readonly ILogger<JwtTokenService> _logger;\n\n//        public JwtTokenService(IConfiguration config, ILogger<JwtTokenService> logger)\n//        {\n//            _config = config;\n//            _logger = logger;\n//        }\n\n//        //public string GenerateToken(\n//        //    string userId,\n//        //    string role,\n//        //    string userName,\n//        //    string email,\n//        //    string status,\n//        //    string businessId,\n//        //    string companyName,\n//        //    string plan,\n//        //    List<string> permissions)\n//        //{\n//        //    try\n//        //    {\n//        //        var permissionString = string.Join(\",\", permissions ?? new List<string>());\n\n//        //        var claims = new List<Claim>\n//        //        {\n//        //            new Claim(JwtRegisteredClaimNames.Sub, userId),\n//        //            new Claim(\"id\", userId),\n//        //            new Claim(ClaimTypes.NameIdentifier, userId),\n//        //            new Claim(\"email\", email ?? \"\"),\n//        //            new Claim(\"role\", role?.ToLowerInvariant() ?? \"unknown\"),    // lowercased!\n//        //            new Claim(\"name\", userName ?? \"\"),\n//        //            new Claim(\"status\", status ?? \"unknown\"),\n//        //            new Claim(\"businessId\", businessId ?? \"\"),                   // lowercased!\n//        //            new Claim(\"companyName\", companyName ?? \"\"),\n//        //            new Claim(\"plan\", plan?.ToLowerInvariant() ?? \"basic\"),      // lowercased!\n//        //            new Claim(\"permissions\", permissionString)\n//        //        };\n\n//        //        return GenerateToken(claims);\n//        //    }\n//        //    catch (Exception ex)\n//        //    {\n//        //        _logger.LogError(ex, \"❌ Error generating token for userId: {UserId}\", userId);\n//        //        throw;\n//        //    }\n//        //}\n//        public string GenerateToken(string userId, string role,string userName,\n//                                    string email,\n//                                    string status,\n//                                    string businessId,\n//                                    string companyName,\n//                                    //string plan,\n//                                    List<string> permissions,\n//                                    string planId)\n//        {\n//            try\n//            {\n//                var permissionString = string.Join(\",\", permissions ?? new List<string>());\n\n//                var claims = new List<Claim>\n//        {\n//            new Claim(JwtRegisteredClaimNames.Sub, userId),\n//            new Claim(\"id\", userId),\n//            new Claim(ClaimTypes.NameIdentifier, userId),\n//            new Claim(\"email\", email ?? \"\"),\n//            new Claim(\"name\", userName ?? \"\"),\n//            new Claim(\"status\", status ?? \"unknown\"),\n//            new Claim(\"businessId\", businessId ?? \"\"),\n//            new Claim(\"companyName\", companyName ?? \"\"),\n//           // new Claim(\"plan\", plan?.ToLowerInvariant() ?? \"basic\"),\n//            new Claim(\"permissions\", permissionString),\n\n//            // ✅ Proper role mapping for both ASP.NET and frontend\n//            new Claim(\"role\", role?.ToLowerInvariant() ?? \"unknown\"),           // for React\n//            new Claim(ClaimTypes.Role, role?.ToLowerInvariant() ?? \"unknown\") ,  // for ASP.NET\n//            new Claim(\"plan_id\", planId ?? string.Empty)\n\n//        };\n\n//                return GenerateToken(claims);\n//            }\n//            catch (Exception ex)\n//            {\n//                _logger.LogError(ex, \"❌ Error generating token for userId: {UserId}\", userId);\n//                throw;\n//            }\n//        }\n\n//        public string GenerateToken(IEnumerable<Claim> claims)\n//        {\n//            try\n//            {\n//                var jwtSettings = _config.GetSection(\"JwtSettings\");\n\n//                var secret = jwtSettings[\"SecretKey\"];\n//                if (string.IsNullOrEmpty(secret))\n//                {\n//                    _logger.LogWarning(\"⚠️ JWT SecretKey is missing from configuration.\");\n//                    throw new Exception(\"JWT SecretKey is not configured.\");\n//                }\n\n//                var expiry = jwtSettings[\"ExpiryMinutes\"];\n//                if (!int.TryParse(expiry, out var expiryMinutes))\n//                {\n//                    _logger.LogWarning(\"⚠️ JWT ExpiryMinutes is invalid or missing. Defaulting to 60 minutes.\");\n//                    expiryMinutes = 60;\n//                }\n\n//                var secretKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(secret));\n//                var creds = new SigningCredentials(secretKey, SecurityAlgorithms.HmacSha256);\n\n//                var expires = DateTime.UtcNow.AddMinutes(expiryMinutes);\n//                var unixExp = new DateTimeOffset(expires).ToUnixTimeSeconds();\n\n//                var finalClaims = claims.ToList();\n//                finalClaims.Add(new Claim(JwtRegisteredClaimNames.Exp, unixExp.ToString()));\n\n//                var token = new JwtSecurityToken(\n//                    issuer: jwtSettings[\"Issuer\"],\n//                    audience: jwtSettings[\"Audience\"],\n//                    claims: finalClaims,\n//                    expires: expires,\n//                    signingCredentials: creds\n//                );\n\n//                _logger.LogInformation(\"✅ Token generated for: {Email}\", finalClaims.FirstOrDefault(c => c.Type == \"email\")?.Value);\n\n//                return new JwtSecurityTokenHandler().WriteToken(token);\n//            }\n//            catch (Exception ex)\n//            {\n//                _logger.LogError(ex, \"❌ Error generating JWT from claims.\");\n//                throw;\n//            }\n//        }\n\n//        public TokenValidationParameters GetValidationParameters()\n//        {\n//            var jwtSettings = _config.GetSection(\"JwtSettings\");\n\n//            return new TokenValidationParameters\n//            {\n//                ValidateIssuer = true,\n//                ValidateAudience = true,\n//                ValidateIssuerSigningKey = true,\n//                ValidateLifetime = true,\n//                RequireSignedTokens = true,\n//                RequireExpirationTime = true,\n//                ValidIssuer = jwtSettings[\"Issuer\"],\n//                ValidAudience = jwtSettings[\"Audience\"],\n//                IssuerSigningKey = new SymmetricSecurityKey(\n//                    Encoding.UTF8.GetBytes(jwtSettings[\"SecretKey\"])\n//                ),\n//                ClockSkew = TimeSpan.Zero,\n//                RoleClaimType = \"role\",   // standardized!\n//                NameClaimType = \"name\"\n//            };\n//        }\n//    }\n//}\n"
    },
    {
      "path": "xbytechat-api/Controllers/BusinessLoginController.cs",
      "sha256": "7eda997e4bb632f6a487b52c57910c7c83ca50c17597d2a02e818cb3ed2459be",
      "language": "csharp",
      "size": 1158,
      "content": "using Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.DTOs;\nusing xbytechat.api.DTOs.Tenants;\nusing xbytechat.api.Services.Interfaces;\n\nnamespace xbytechat.api.Controllers\n{\n    [ApiController]\n    [Route(\"api/tenants\")]\n    public class BusinessLoginController : ControllerBase\n    {\n        private readonly IBusinessService _tenantService;\n\n        public BusinessLoginController(IBusinessService tenantService)\n        {\n            _tenantService = tenantService;\n        }\n\n        [HttpPost(\"login\")]\n        public async Task<IActionResult> Login([FromBody] BusinessLoginRequest request)\n        {\n            try\n            {\n                var tenant = await _tenantService.LoginAsync(request);\n\n                return Ok(new\n                {\n                    tenant.Id,\n                    tenant.Email,\n                    tenant.CompanyName,\n                    //tenant.Role,\n                    //tenant.Plan,\n                    Message = \"Login successful\"\n                });\n            }\n            catch (Exception ex)\n            {\n                return Unauthorized(new { Message = ex.Message });\n            }\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Controllers/DevSeedController.cs",
      "sha256": "e42997ea8140347d4c505532f1a7a654901109f62e13ac56dc8622ae0a20b3d8",
      "language": "csharp",
      "size": 2166,
      "content": "#if DEBUG\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Hosting;\nusing Microsoft.AspNetCore.Identity;\nusing Microsoft.AspNetCore.Mvc;\nusing System.Linq;\nusing System.Threading.Tasks;\n\n[ApiController]\n[Route(\"api/dev-seed\")]\n[ApiExplorerSettings(IgnoreApi = true)]\npublic class DevSeedController : ControllerBase\n{\n    private readonly UserManager<IdentityUser> _users;\n    private readonly RoleManager<IdentityRole> _roles;\n    private readonly IWebHostEnvironment _env;\n\n    public DevSeedController(\n        UserManager<IdentityUser> users,\n        RoleManager<IdentityRole> roles,\n        IWebHostEnvironment env)\n    {\n        _users = users;\n        _roles = roles;\n        _env = env;\n    }\n\n    [AllowAnonymous]\n    [HttpPost(\"e2e-user\")]\n    public async Task<IActionResult> SeedE2E([FromBody] SeedReq req)\n    {\n        // Only allow in Development\n        if (!_env.IsDevelopment())\n            return Forbid();\n\n        var email = (req.Email ?? \"\").Trim();\n        if (string.IsNullOrWhiteSpace(email) || string.IsNullOrWhiteSpace(req.Password))\n            return BadRequest(new { message = \"email/password required\" });\n\n        // Idempotent create/update\n        var user = await _users.FindByEmailAsync(email);\n        if (user == null)\n        {\n            user = new IdentityUser { UserName = email, Email = email, EmailConfirmed = true };\n            var create = await _users.CreateAsync(user, req.Password);\n            if (!create.Succeeded)\n                return BadRequest(new { message = \"create failed\", errors = create.Errors.Select(e => e.Description) });\n        }\n\n        // Ensure role (use \"superadmin\" or a minimal CRM role your app understands)\n        var role = string.IsNullOrWhiteSpace(req.Role) ? \"superadmin\" : req.Role.Trim();\n        if (!await _roles.RoleExistsAsync(role))\n            await _roles.CreateAsync(new IdentityRole(role));\n        if (!await _users.IsInRoleAsync(user, role))\n            await _users.AddToRoleAsync(user, role);\n\n        return Ok(new { ok = true, email, role });\n    }\n\n    public record SeedReq(string Email, string Password, string Role = \"superadmin\");\n}\n#endif\n"
    },
    {
      "path": "xbytechat-api/Controllers/HealthCheckController.cs",
      "sha256": "52d69ec41e8cd4fc50bc1281507a30e39bc629677df7bbd0e1cfb876e2623086",
      "language": "csharp",
      "size": 799,
      "content": "// xbytechat-api/Controllers/HealthCheckController.cs\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing System.Reflection;\n\nnamespace xbytechat.api.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    public class HealthCheckController : ControllerBase\n    {\n        [HttpGet]\n        public IActionResult Get() => Ok(\"✅ xByteChat backend is running 🚀\");\n\n        [AllowAnonymous]\n        [HttpGet(\"ping\")]\n        public IActionResult Ping()\n        {\n            var version = Assembly.GetExecutingAssembly()?.GetName()?.Version?.ToString() ?? \"0.0.0\";\n            return Ok(new\n            {\n                status = \"ok\",\n                version,\n                serverTimeUtc = DateTime.UtcNow.ToString(\"o\")\n            });\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Controllers/MessageLogsController.cs",
      "sha256": "e36c308f0d6e42ec75e8db9797ab4ea5e68366e503e0bb04a51824491c22620a",
      "language": "csharp",
      "size": 648,
      "content": "using Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Models;\n\nnamespace xbytechat.api.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    public class MessageLogsController : ControllerBase\n    {\n        private readonly AppDbContext _db;\n\n        public MessageLogsController(AppDbContext db)\n        {\n            _db = db;\n        }\n\n        [HttpGet]\n        public async Task<IActionResult> Get()\n        {\n            var logs = await _db.MessageLogs\n                .OrderByDescending(log => log.CreatedAt)\n                .ToListAsync();\n\n            return Ok(logs);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Controllers/MessagesController.cs",
      "sha256": "c23a3ca95ebcc60cdb6a1762b7c1d9605de6427a56dd4b91332e15eecfbb4500",
      "language": "csharp",
      "size": 6940,
      "content": "using Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.DTOs.Messages;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Services.Messages.Interfaces;\n\nnamespace xbytechat.api.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    public class MessagesController : ControllerBase\n    {\n        private readonly IMessageService _messageService;\n\n        public MessagesController(IMessageService messageService)\n        {\n            _messageService = messageService;\n        }\n\n        /// ✅ SEND TEXT MESSAGE\n        [HttpPost(\"send-text\")]\n        public async Task<IActionResult> SendTextMessage([FromBody] TextMessageDto dto)\n        {\n            if (!ModelState.IsValid)\n            {\n                return BadRequest(new\n                {\n                    success = false,\n                    message = \"❌ Validation failed\",\n                    errors = ModelState.Values.SelectMany(v => v.Errors).Select(e => e.ErrorMessage)\n                });\n            }\n\n            var result = await _messageService.SendMessageAsync(dto);\n\n            return result.Success\n                ? Ok(new { success = true, message = result.Message, response = result.Data })\n                : StatusCode(500, new { success = false, message = result.Message, error = result.ErrorMessage });\n        }\n\n        /// ✅ SEND IMAGE MESSAGE\n        [HttpPost(\"send-image\")]\n        public async Task<IActionResult> SendImageMessage([FromBody] ImageMessageDto dto)\n        {\n            if (!ModelState.IsValid)\n            {\n                return BadRequest(new\n                {\n                    success = false,\n                    message = \"❌ Validation failed\",\n                    errors = ModelState.Values.SelectMany(v => v.Errors).Select(e => e.ErrorMessage)\n                });\n            }\n\n            var result = await _messageService.SendMessageAsync(dto);\n\n            return result.Success\n                ? Ok(new { success = true, message = result.Message, response = result.Data })\n                : StatusCode(500, new { success = false, message = result.Message, error = result.ErrorMessage });\n        }\n\n        /// ✅ SEND TEMPLATE MESSAGE\n        [HttpPost(\"send-template\")]\n        public async Task<IActionResult> SendTemplateMessage([FromBody] TemplateMessageDto dto)\n        {\n            if (!ModelState.IsValid)\n            {\n                return BadRequest(new\n                {\n                    success = false,\n                    message = \"❌ Validation failed\",\n                    errors = ModelState.Values.SelectMany(v => v.Errors).Select(e => e.ErrorMessage)\n                });\n            }\n\n            var result = await _messageService.SendMessageAsync(dto);\n\n            return result.Success\n                ? Ok(new { success = true, message = result.Message, response = result.Data })\n                : StatusCode(500, new { success = false, message = result.Message, error = result.ErrorMessage });\n        }\n\n        /// ✅ SEND CTA BUTTON MESSAGE (Free-form Interactive)\n        [HttpPost(\"send-cta\")]\n        public async Task<IActionResult> SendCtaMessage([FromBody] CtaMessageDto dto)\n        {\n            if (string.IsNullOrWhiteSpace(dto.RecipientPhone) || string.IsNullOrWhiteSpace(dto.BodyText) || dto.Buttons == null || dto.Buttons.Count == 0)\n            {\n                return BadRequest(new\n                {\n                    success = false,\n                    message = \"❌ Invalid request — phone, body text and buttons are required\"\n                });\n            }\n\n            // Optional tracking\n            var ipAddress = HttpContext.Connection.RemoteIpAddress?.ToString() ?? \"unknown\";\n            var userAgent = Request.Headers[\"User-Agent\"].ToString() ?? \"unknown\";\n\n            var result = await _messageService.SendInteractiveMessageAsync(dto.RecipientPhone, dto.BodyText, dto.Buttons);\n\n            return result.Success\n                ? Ok(new\n                {\n                    success = true,\n                    message = result.Message,\n                    messageId = result.MessageId,\n                    logId = result.MessageLogId,\n                    raw = result.RawResponse\n                })\n                : StatusCode(500, new\n                {\n                    success = false,\n                    message = result.Message,\n                    error = result.ErrorMessage\n                });\n        }\n\n        /// ✅ SEND BULK MESSAGES\n        //[HttpPost(\"send-bulk\")]\n        //public async Task<SendResultExtended> SendBulkMessagesAsync(BulkMessageDto dto)\n        //{\n        //    var result = new SendResultExtended\n        //    {\n        //        Success = true,\n        //        Message = \"✅ All messages processed.\",\n        //        LogId = null,\n        //        MessageId = null\n        //    };\n\n        //    try\n        //    {\n        //        foreach (var contactId in dto.ContactIds)\n        //        {\n        //            var contact = await _dbContext.Contacts\n        //                .Include(c => c.Business)\n        //                .FirstOrDefaultAsync(c => c.Id == contactId);\n\n        //            if (contact == null || string.IsNullOrWhiteSpace(contact.PhoneNumber))\n        //                continue;\n\n        //            BaseMessageDto message;\n\n        //            if (dto.MessageType.ToLower() == \"template\")\n        //            {\n        //                message = new TemplateMessageDto\n        //                {\n        //                    RecipientNumber = contact.PhoneNumber,\n        //                    MessageContent = dto.MessageTemplate,\n        //                    MessageType = \"template\",\n        //                    TemplateName = dto.TemplateName!,\n        //                    TemplateParameters = dto.TemplateParams ?? new List<string>(),\n        //                    BusinessId = contact.BusinessId\n        //                };\n        //            }\n        //            else\n        //            {\n        //                message = new TextMessageDto\n        //                {\n        //                    RecipientNumber = contact.PhoneNumber,\n        //                    MessageContent = dto.MessageTemplate,\n        //                    MessageType = \"text\",\n        //                    BusinessId = contact.BusinessId\n        //                };\n        //            }\n\n        //            await SendMessageAsync(message); // already returns SendResultExtended\n        //        }\n\n        //        return result;\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        return new SendResultExtended\n        //        {\n        //            Success = false,\n        //            Message = \"❌ Bulk send failed.\",\n        //            ErrorMessage = ex.Message\n        //        };\n        //    }\n        //}\n\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Controllers/SendMessageController.cs",
      "sha256": "f2cf8e138d7177000e595b752d8da0ab54cec8a56df32328388c4a4f58f328d9",
      "language": "csharp",
      "size": 1919,
      "content": "using Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Services;\nusing System.Threading.Tasks;\n\nnamespace xbytechat.api.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    public class WhatsAppController : ControllerBase\n    {\n        private readonly WhatsAppService _whatsAppService;\n\n        public WhatsAppController(WhatsAppService whatsAppService)\n        {\n            _whatsAppService = whatsAppService;\n        }\n\n        /// <summary>\n        /// Endpoint to send a WhatsApp message.\n        /// </summary>\n        /// <param name=\"recipientPhone\">Recipient's phone number (including country code).</param>\n        /// <param name=\"messageText\">Text message to send.</param>\n        /// <returns>Response with the result of the send operation.</returns>\n        [HttpPost(\"send\")]\n        public async Task<IActionResult> SendMessage([FromQuery] string recipientPhone, [FromQuery] string messageText)\n        {\n            if (string.IsNullOrEmpty(recipientPhone) || string.IsNullOrEmpty(messageText))\n            {\n                return BadRequest(new { success = false, message = \"Phone number and message text are required.\" });\n            }\n\n            // Call WhatsApp service to send the message\n            var result = await _whatsAppService.SendMessageAsync(recipientPhone, messageText);\n\n            if (result.Success)\n            {\n                return Ok(new\n                {\n                    success = true,\n                    message = \"✅ Message sent successfully.\",\n                    response = result.RawResponse\n                });\n            }\n            else\n            {\n                return StatusCode(500, new\n                {\n                    success = false,\n                    message = result.ErrorMessage ?? \"❌ Failed to send message.\",\n                    response = result.RawResponse\n                });\n            }\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/CRM/Controllers/ContactsController.cs",
      "sha256": "2d74dc1fdc1740f3002c6187d7dfe3031721d374c9e4e061492a35e3456508b3",
      "language": "csharp",
      "size": 8394,
      "content": "using CsvHelper.Configuration;\nusing CsvHelper;\nusing Microsoft.AspNetCore.Mvc;\nusing System.Globalization;\nusing xbytechat.api.CRM.Dtos;\nusing xbytechat.api.CRM.Interfaces;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Shared;  // <-- For GetBusinessId extension\n\nnamespace xbytechat.api.CRM.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    public class ContactsController : ControllerBase\n    {\n        private readonly IContactService _contactService;\n        private readonly ILogger<ContactsController> _logger;\n        public ContactsController(IContactService contactService, ILogger<ContactsController> logger)\n        {\n            _contactService = contactService;\n            _logger = logger;\n        }\n\n        // POST: api/contacts\n        [HttpPost(\"create\")]\n        public async Task<IActionResult> AddContact([FromBody] ContactDto dto)\n        {\n            if (!ModelState.IsValid)\n                return BadRequest(ResponseResult.ErrorInfo(\"❌ Invalid contact payload.\"));\n\n            try\n            {\n                var businessId = HttpContext.User.GetBusinessId();\n                var result = await _contactService.AddContactAsync(businessId, dto);\n\n                return result.Success\n                    ? Ok(result)\n                    : BadRequest(result); // Already ResponseResult.ErrorInfo\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"🚨 Unexpected error in AddContact\");\n                return StatusCode(500, ResponseResult.ErrorInfo(\"🚨 Server error while creating contact.\", ex.ToString()));\n            }\n        }\n\n\n\n\n        // GET: api/contacts/{id}\n        [HttpGet(\"{id}\")]\n        public async Task<IActionResult> GetContactById(Guid id)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var contact = await _contactService.GetContactByIdAsync(businessId, id);\n            if (contact == null)\n                return NotFound(ResponseResult.ErrorInfo(\"Contact not found.\"));\n            return Ok(ResponseResult.SuccessInfo(\"Contact loaded.\", contact));\n        }\n\n        // PUT: api/contacts/{id}\n        [HttpPut(\"{id}\")]\n        public async Task<IActionResult> UpdateContact(Guid id, [FromBody] ContactDto dto)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            dto.Id = id;\n            var success = await _contactService.UpdateContactAsync(businessId, dto);\n            if (!success)\n                return NotFound(ResponseResult.ErrorInfo(\"Contact not found.\"));\n            return Ok(ResponseResult.SuccessInfo(\"Contact updated.\"));\n        }\n\n        // DELETE: api/contacts/{id}\n        [HttpDelete(\"{id}\")]\n        public async Task<IActionResult> DeleteContact(Guid id)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var success = await _contactService.DeleteContactAsync(businessId, id);\n            if (!success)\n                return NotFound(ResponseResult.ErrorInfo(\"Contact not found.\"));\n            return Ok(ResponseResult.SuccessInfo(\"Contact deleted.\"));\n        }\n\n        // POST: api/contacts/parse-csv\n        [ApiExplorerSettings(IgnoreApi = true)]\n        [HttpPost(\"parse-csv\")]\n        [Consumes(\"multipart/form-data\")]\n        public async Task<IActionResult> ParseCsvToContactsAsync([FromForm] IFormFile file)\n        {\n            if (file == null || file.Length == 0)\n                return BadRequest(ResponseResult.ErrorInfo(\"CSV file is required.\"));\n\n            var businessId = HttpContext.User.GetBusinessId();\n            using var stream = file.OpenReadStream();\n\n            try\n            {\n                var parseResult = await _contactService.ParseCsvToContactsAsync(businessId, stream);\n                return Ok(ResponseResult.SuccessInfo(\"CSV parsed with detailed results.\", parseResult));\n            }\n            catch (Exception ex)\n            {\n                return BadRequest(ResponseResult.ErrorInfo(\"CSV parsing failed: \" + ex.Message));\n            }\n        }\n\n        // PATCH: /api/contacts/{id}/favorite\n        [HttpPatch(\"{id}/favorite\")]\n        public async Task<IActionResult> ToggleFavorite(Guid id)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var success = await _contactService.ToggleFavoriteAsync(businessId, id);\n            if (!success)\n                return NotFound(ResponseResult.ErrorInfo(\"Contact not found.\"));\n            return Ok(ResponseResult.SuccessInfo(\"Favorite toggled.\"));\n        }\n\n        // PATCH: /api/contacts/{id}/archive\n        [HttpPatch(\"{id}/archive\")]\n        public async Task<IActionResult> ToggleArchive(Guid id)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var success = await _contactService.ToggleArchiveAsync(businessId, id);\n            if (!success)\n                return NotFound(ResponseResult.ErrorInfo(\"Contact not found.\"));\n            return Ok(ResponseResult.SuccessInfo(\"Archive toggled.\"));\n        }\n\n        // POST: api/contacts/bulk-assign-tag\n        [HttpPost(\"bulk-assign-tag\")]\n        public async Task<IActionResult> AssignTagToContacts([FromBody] AssignTagToContactsDto dto)\n        {\n            if (dto.ContactIds == null || !dto.ContactIds.Any())\n                return BadRequest(ResponseResult.ErrorInfo(\"No contact IDs provided.\"));\n\n            var businessId = HttpContext.User.GetBusinessId();\n            await _contactService.AssignTagToContactsAsync(businessId, dto.ContactIds, dto.TagId);\n\n            return Ok(ResponseResult.SuccessInfo(\"Tag assigned to selected contacts.\"));\n        }\n\n        //[HttpGet(\"contacts\")]\n        [HttpGet]\n        public async Task<IActionResult> GetAllContacts(\n        [FromQuery] string? tab = \"all\",\n        [FromQuery] int page = 1,\n        [FromQuery] int pageSize = 25)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var pagedResult = await _contactService.GetPagedContactsAsync(businessId, tab, page, pageSize);\n            return Ok(ResponseResult.SuccessInfo(\"Contacts loaded.\", pagedResult));\n        }\n        // GET: api/contacts/all\n        [HttpGet(\"all\")]\n        public async Task<IActionResult> GetAllContactsFlat()\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var allContacts = await _contactService.GetAllContactsAsync(businessId); // This returns IEnumerable<ContactDto>\n            return Ok(allContacts); // Returns plain array!\n        }\n\n        [HttpPost(\"filter-by-tags\")]\n        public async Task<IActionResult> GetContactsByTags([FromBody] List<string> tags)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n\n            // ✅ Convert to Guid list safely\n            var tagGuids = tags\n                .Where(x => Guid.TryParse(x, out _))\n                .Select(Guid.Parse)\n                .ToList();\n\n            var contacts = await _contactService.GetContactsByTagsAsync(businessId, tagGuids);\n\n            return Ok(ResponseResult.SuccessInfo(\"Contacts filtered successfully\", contacts));\n        }\n\n        [HttpPost(\"bulk-import\")]\n        [Consumes(\"multipart/form-data\")]\n        public async Task<IActionResult> BulkImportContactsAsync(IFormFile file)\n        {\n            if (file == null || file.Length == 0)\n                return BadRequest(ResponseResult.ErrorInfo(\"CSV file is required.\"));\n\n            var businessId = HttpContext.User.GetBusinessId();\n\n            try\n            {\n                var result = await _contactService.BulkImportAsync(businessId, file.OpenReadStream());\n                return Ok(ResponseResult.SuccessInfo(\"Contacts imported successfully.\", result));\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"Bulk import failed.\");\n                return BadRequest(ResponseResult.ErrorInfo(\"Import failed: \" + ex.Message));\n            }\n        }\n       \n        [HttpGet(\"by-tags\")]\n        public async Task<IActionResult> GetContactsByTags([FromQuery] List<Guid> tagIds)\n        {\n            var businessId = User.GetBusinessId();  // Your tenant logic\n            var contacts = await _contactService.GetContactsByTagsAsync(businessId, tagIds);\n            return Ok(contacts);\n        }\n\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/CRM/Controllers/NotesController.cs",
      "sha256": "f1a804500703b68b36ff3c8de61e939660f5c9f400d5e65588af1cb135b7f87f",
      "language": "csharp",
      "size": 2925,
      "content": "using Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.CRM.Dtos;\nusing xbytechat.api.CRM.Interfaces;\nusing xbytechat.api.Helpers; \nusing xbytechat.api.Shared; \nnamespace xbytechat.api.CRM.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    public class NotesController : ControllerBase\n    {\n        private readonly INoteService _noteService;\n\n        public NotesController(INoteService noteService)\n        {\n            _noteService = noteService;\n        }\n\n        [HttpPost]\n        public async Task<IActionResult> AddNote([FromBody] NoteDto dto)\n        {\n            try\n            {\n                var businessId = HttpContext.User.GetBusinessId();\n                var result = await _noteService.AddNoteAsync(businessId, dto);\n                return Ok(ResponseResult.SuccessInfo(\"Note created.\", result));\n            }\n            catch (Exception ex)\n            {\n                return StatusCode(500, ResponseResult.ErrorInfo(\"Error creating note\", ex.Message));\n            }\n        }\n\n        [HttpGet(\"contact/{contactId}\")]\n        public async Task<IActionResult> GetNotesByContact(Guid contactId)\n        {\n            try\n            {\n                var businessId = HttpContext.User.GetBusinessId();\n                var result = await _noteService.GetNotesByContactAsync(businessId, contactId);\n                return Ok(ResponseResult.SuccessInfo(\"Notes loaded.\", result));\n            }\n            catch (Exception ex)\n            {\n                return StatusCode(500, ResponseResult.ErrorInfo(\"Error fetching notes\", ex.Message));\n            }\n        }\n\n        [HttpGet(\"{id}\")]\n        public async Task<IActionResult> GetNoteById(Guid id)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var result = await _noteService.GetNoteByIdAsync(businessId, id);\n            if (result == null)\n                return NotFound(ResponseResult.ErrorInfo(\"Note not found.\"));\n            return Ok(ResponseResult.SuccessInfo(\"Note loaded.\", result));\n        }\n\n        [HttpPut(\"{id}\")]\n        public async Task<IActionResult> UpdateNote(Guid id, [FromBody] NoteDto dto)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var success = await _noteService.UpdateNoteAsync(businessId, id, dto);\n            if (!success)\n                return NotFound(ResponseResult.ErrorInfo(\"Note not found.\"));\n            return Ok(ResponseResult.SuccessInfo(\"Note updated.\"));\n        }\n\n        [HttpDelete(\"{id}\")]\n        public async Task<IActionResult> DeleteNote(Guid id)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var success = await _noteService.DeleteNoteAsync(businessId, id);\n            if (!success)\n                return NotFound(ResponseResult.ErrorInfo(\"Note not found.\"));\n            return Ok(ResponseResult.SuccessInfo(\"Note deleted.\"));\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/CRM/Controllers/RemindersController.cs",
      "sha256": "66418c8f0a9fa94a869653029f08e5c16243f5d8e83b36b884bb9c33d8448f29",
      "language": "csharp",
      "size": 3205,
      "content": "using Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.CRM.Dtos;\nusing xbytechat.api.CRM.Interfaces;\nusing xbytechat.api.CRM.Models;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.CRM.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    public class RemindersController : ControllerBase\n    {\n        private readonly IReminderService _reminderService;\n\n        public RemindersController(IReminderService reminderService)\n        {\n            _reminderService = reminderService;\n        }\n\n        [HttpPost]\n        public async Task<IActionResult> AddReminder(ReminderDto dto)\n        {\n            try\n            {\n                var businessId = HttpContext.User.GetBusinessId();\n                if (dto == null)\n                    return BadRequest(ResponseResult.ErrorInfo(\"Reminder data is missing.\"));\n\n                var result = await _reminderService.AddReminderAsync(businessId, dto);\n                return Ok(ResponseResult.SuccessInfo(\"Reminder created.\", result));\n            }\n            catch (Exception ex)\n            {\n                return StatusCode(500, ResponseResult.ErrorInfo(\"An error occurred while adding the reminder.\", ex.Message));\n            }\n        }\n\n        [HttpGet]\n        public async Task<IActionResult> GetAllReminders()\n        {\n            try\n            {\n                var businessId = HttpContext.User.GetBusinessId();\n                var reminders = await _reminderService.GetAllRemindersAsync(businessId);\n                return Ok(ResponseResult.SuccessInfo(\"Reminders loaded.\", reminders));\n            }\n            catch (Exception ex)\n            {\n                return StatusCode(500, ResponseResult.ErrorInfo(\"An error occurred while fetching reminders.\", ex.Message));\n            }\n        }\n\n        [HttpGet(\"{id}\")]\n        public async Task<IActionResult> GetReminderById(Guid id)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var reminder = await _reminderService.GetReminderByIdAsync(businessId, id);\n            if (reminder == null)\n                return NotFound(ResponseResult.ErrorInfo(\"Reminder not found.\"));\n            return Ok(ResponseResult.SuccessInfo(\"Reminder loaded.\", reminder));\n        }\n\n        [HttpPut(\"{id}\")]\n        public async Task<IActionResult> UpdateReminder(Guid id, [FromBody] ReminderDto dto)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var success = await _reminderService.UpdateReminderAsync(businessId, id, dto);\n            if (!success)\n                return NotFound(ResponseResult.ErrorInfo(\"Reminder not found.\"));\n            return Ok(ResponseResult.SuccessInfo(\"Reminder updated.\"));\n        }\n\n        [HttpDelete(\"{id}\")]\n        public async Task<IActionResult> DeleteReminder(Guid id)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var success = await _reminderService.DeleteReminderAsync(businessId, id);\n            if (!success)\n                return NotFound(ResponseResult.ErrorInfo(\"Reminder not found.\"));\n            return Ok(ResponseResult.SuccessInfo(\"Reminder deleted.\"));\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/CRM/Controllers/TagsController.cs",
      "sha256": "987b5679067710f05ca13825f2ae57be4ee9b4452a415b3b477bb0234956c6d9",
      "language": "csharp",
      "size": 1975,
      "content": "using Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.CRM.Dtos;\nusing xbytechat.api.CRM.Interfaces;\nusing xbytechat.api.Helpers; \nusing xbytechat.api.Shared;  \n\nnamespace xbytechat.api.CRM.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    public class TagsController : ControllerBase\n    {\n        private readonly ITagService _tagService;\n\n        public TagsController(ITagService tagService)\n        {\n            _tagService = tagService;\n        }\n\n        [HttpPost]\n        public async Task<IActionResult> AddTag([FromBody] TagDto dto)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var result = await _tagService.AddTagAsync(businessId, dto);\n            return Ok(ResponseResult.SuccessInfo(\"Tag created.\", result));\n        }\n\n        [HttpPut(\"{id}\")]\n        public async Task<IActionResult> UpdateTag(Guid id, [FromBody] TagDto dto)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var success = await _tagService.UpdateTagAsync(businessId, id, dto);\n            if (!success)\n                return NotFound(ResponseResult.ErrorInfo(\"Tag not found.\"));\n            return Ok(ResponseResult.SuccessInfo(\"Tag updated.\"));\n        }\n\n        [HttpGet(\"get-tags\")]\n        public async Task<IActionResult> GetAllTags()\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var tags = await _tagService.GetAllTagsAsync(businessId);\n            return Ok(ResponseResult.SuccessInfo(\"Tags loaded.\", tags));\n        }\n\n        [HttpDelete(\"{id}\")]\n        public async Task<IActionResult> DeleteTag(Guid id)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var success = await _tagService.DeleteTagAsync(businessId, id);\n            if (!success)\n                return NotFound(ResponseResult.ErrorInfo(\"Tag not found.\"));\n            return Ok(ResponseResult.SuccessInfo(\"Tag deleted.\"));\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/CRM/Dtos/AssignTagToContactsDto.cs",
      "sha256": "69c9b7fc83bbaf32fab62812c210f204eca0b723301878252850f6527f71a7f3",
      "language": "csharp",
      "size": 189,
      "content": "namespace xbytechat.api.CRM.Dtos\n{\n    public class AssignTagToContactsDto\n    {\n        public List<Guid> ContactIds { get; set; } = new();\n        public Guid TagId { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/CRM/Dtos/BulkImportResultDto.cs",
      "sha256": "05392f5b522d34ba8069854727ab513053a529252f41be0f45e827f4df613eac",
      "language": "csharp",
      "size": 333,
      "content": "namespace xbytechat.api.CRM.Dtos\n{\n    public class BulkImportResultDto\n    {\n        public int Imported { get; set; }\n        public List<CsvImportError> Errors { get; set; } = new();\n    }\n\n    public class CsvImportErrorMsg\n    {\n        public int RowNumber { get; set; }\n        public string ErrorMessage { get; set; }\n    }\n}"
    },
    {
      "path": "xbytechat-api/CRM/Dtos/ContactDto.cs",
      "sha256": "218a964e202fd90d764b7a4deccc1466eb7d4d35cdb1472bf4a808c1304df08a",
      "language": "csharp",
      "size": 1199,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.CRM.Dtos\n{\n    public class ContactDto\n    {\n        public Guid? Id { get; set; } // Nullable for Create (used in PUT)\n\n        public string Name { get; set; } // Contact full name\n\n        public string PhoneNumber { get; set; } // WhatsApp-compatible number\n\n        public string? Email { get; set; } // Optional email address\n\n        public string? LeadSource { get; set; } // e.g., \"WhatsApp\", \"Facebook\", \"Landing Page\"\n\n        public DateTime? LastContactedAt { get; set; } // Last WhatsApp or CRM interaction\n\n        public DateTime? NextFollowUpAt { get; set; } // For scheduling reminders\n\n        public string? Notes { get; set; } // Internal notes for the contact\n\n        public DateTime? CreatedAt { get; set; } // Read-only timestamp\n\n        // ✅ NEW: Structured Tags (replaces comma-separated strings)\n        // Example: [{ id: 1, name: \"VIP\" }, { id: 2, name: \"Follow-up\" }]\n        public List<ContactTagDto> Tags { get; set; } = new();\n\n        public bool IsFavorite { get; set; } = false;\n        public bool IsArchived { get; set; } = false;\n        public string? Group { get; set; }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/CRM/Dtos/ContactDtoCsvMap.cs",
      "sha256": "5dd22482c7625ce4ada21b1595015bd0273b921d8a5ac8787486b4f2ad874570",
      "language": "csharp",
      "size": 473,
      "content": "using CsvHelper.Configuration;\n\nnamespace xbytechat.api.CRM.Dtos\n{\n    public class ContactDtoCsvMap : ClassMap<ContactDto>\n    {\n        public ContactDtoCsvMap()\n        {\n            Map(m => m.Name).Name(\"name\", \"Name\", \"full name\");\n            Map(m => m.PhoneNumber).Name(\"phone\", \"Phone\", \"mobile\", \"mobile number\");\n            Map(m => m.Email).Name(\"email\", \"Email\").Optional();\n            Map(m => m.Notes).Name(\"notes\", \"Notes\").Optional();\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/CRM/Dtos/ContactTagDto.cs",
      "sha256": "4b81638e7806bd28b702637f4d9e379725b86e63045e558d2abbdc54663b7650",
      "language": "csharp",
      "size": 272,
      "content": "namespace xbytechat.api.CRM.Dtos\n{\n    public class ContactTagDto\n    {\n        public Guid TagId { get; set; }\n        public string TagName { get; set; } = string.Empty;\n        public string? ColorHex { get; set; }\n        public string? Category { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/CRM/Dtos/CsvImportResult.cs",
      "sha256": "7e0d39bb56ef6fa9d80f69f7c37ece658407016ae68b838cd425050ed5f31680",
      "language": "csharp",
      "size": 364,
      "content": "namespace xbytechat.api.CRM.Dtos\n{\n    public class CsvImportResult<T>\n    {\n        public List<T> SuccessRecords { get; set; } = new();\n        public List<CsvImportError> Errors { get; set; } = new();\n    }\n\n    public class CsvImportError\n    {\n        public int RowNumber { get; set; }\n        public string ErrorMessage { get; set; } = string.Empty;\n    }\n}"
    },
    {
      "path": "xbytechat-api/CRM/Dtos/NoteDto.cs",
      "sha256": "a324df31b2679d4db34a15ec6a647792e8a9456a0684e01787d9baeff44f3c8f",
      "language": "csharp",
      "size": 515,
      "content": "namespace xbytechat.api.CRM.Dtos\n{\n    public class NoteDto\n    {\n        public Guid Id { get; set; }\n        public Guid? ContactId { get; set; }\n        public string Title { get; set; }\n        public string Content { get; set; }\n        public string Source { get; set; }\n        public string CreatedBy { get; set; }\n        public bool IsPinned { get; set; }\n        public bool IsInternal { get; set; }\n        public DateTime CreatedAt { get; set; }\n        public DateTime? EditedAt { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/CRM/Dtos/PagedResult.cs",
      "sha256": "8219de3f57c89361d316f109fd9372741ed6702c71d6dfbe7d7850dbf3a585b7",
      "language": "csharp",
      "size": 342,
      "content": "namespace xbytechat.api.CRM.Dtos\n{\n    public class PagedResult<T>\n    {\n        public List<T> Items { get; set; } = new();\n        public int TotalCount { get; set; }\n\n        public int Page { get; set; }\n        public int PageSize { get; set; }\n        public int TotalPages => (int)Math.Ceiling(TotalCount / (double)PageSize);\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/CRM/Dtos/ReminderDto.cs",
      "sha256": "9d68d6f7f4b48cada2f4160bc381166930f0fdfb5212ad239fe27abf981f5d0f",
      "language": "csharp",
      "size": 946,
      "content": "using System;\n\nnamespace xbytechat.api.CRM.Dtos\n{\n    public class ReminderDto\n    {\n        public Guid? Id { get; set; }  // Null when creating, present when updating\n\n        public Guid? ContactId { get; set; }\n\n        public string Title { get; set; } = default!;\n\n        public string? Description { get; set; }\n\n        public DateTime DueAt { get; set; }\n\n        public string? Status { get; set; } = \"Pending\";\n\n        public string? ReminderType { get; set; }\n\n        public int? Priority { get; set; }\n\n        public bool IsRecurring { get; set; }\n\n        public string? RecurrencePattern { get; set; }\n\n        public bool SendWhatsappNotification { get; set; }\n\n        public string? LinkedCampaign { get; set; }\n\n        public bool IsActive { get; set; } = true;\n\n        public DateTime? CreatedAt { get; set; }\n\n        public DateTime? UpdatedAt { get; set; }\n\n        public DateTime? CompletedAt { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/CRM/Dtos/TagDto.cs",
      "sha256": "c13472528bbecc527f9c37b069e6b80729380492eb7126891fe189c354298a04",
      "language": "csharp",
      "size": 512,
      "content": "namespace xbytechat.api.CRM.Dtos\n{\n    public class TagDto\n    {\n        public Guid? Id { get; set; }\n\n        public string Name { get; set; } = default!;\n\n        public string? ColorHex { get; set; }\n\n        public string? Category { get; set; }\n\n        public string? Notes { get; set; }\n\n        public bool IsSystemTag { get; set; } = false;\n\n        public bool IsActive { get; set; } = true;\n\n        public DateTime? CreatedAt { get; set; }\n\n        public DateTime? LastUsedAt { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/CRM/Interfaces/IContactService.cs",
      "sha256": "cd965fba71ad33d2cd884288f207914e0e6aa24233a777136295ed2ca86040d6",
      "language": "csharp",
      "size": 1835,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.IO;\nusing System.Threading.Tasks;\nusing xbytechat.api.CRM.Dtos;\nusing xbytechat.api.CRM.Models;\nusing xbytechat.api.Helpers;\n\nnamespace xbytechat.api.CRM.Interfaces\n{\n    /// <summary>\n    /// Defines the contract for all operations related to managing contacts.\n    /// </summary>\n    public interface IContactService\n    {\n\n        Task<ResponseResult> AddContactAsync(Guid businessId, ContactDto dto);\n        Task<ContactDto> GetContactByIdAsync(Guid businessId, Guid contactId);\n        Task<bool> UpdateContactAsync(Guid businessId, ContactDto dto);\n        Task<bool> DeleteContactAsync(Guid businessId, Guid contactId);\n        Task<CsvImportResult<ContactDto>> ParseCsvToContactsAsync(Guid businessId, Stream csvStream);\n        Task<Contact> FindOrCreateAsync(Guid businessId, string phoneNumber);\n        Task<bool> ToggleFavoriteAsync(Guid businessId, Guid contactId);\n        Task<bool> ToggleArchiveAsync(Guid businessId, Guid contactId);\n        Task<IEnumerable<ContactDto>> GetAllContactsAsync(Guid businessId, string? tab = \"all\");\n        Task AssignTagToContactsAsync(Guid businessId, List<Guid> contactIds, Guid tagId);\n        Task<PagedResult<ContactDto>> GetPagedContactsAsync(\n             Guid businessId,\n             string? tab = \"all\",\n             int page = 1,\n             int pageSize = 25,\n             string? searchTerm = null\n            );\n        // ✅ Tag-based filtering support\n        Task<IEnumerable<ContactDto>> GetContactsByTagsAsync(Guid businessId, List<Guid> tags);\n\n        Task<BulkImportResultDto> BulkImportAsync(Guid businessId, Stream csvStream);\n        // 📌 New method to support flow node → tag assignment\n        Task<bool> AssignTagsAsync(Guid businessId, string phoneNumber, List<string> tags);\n\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/CRM/Interfaces/INoteService.cs",
      "sha256": "c7f3f36ea21a7508514c9054225df94aef67048fa1290fb84f860cd103764e87",
      "language": "csharp",
      "size": 687,
      "content": "using xbytechat.api.CRM.Dtos;\n\nnamespace xbytechat.api.CRM.Interfaces\n{\n    public interface INoteService\n    {\n        // For creating new note\n        Task<NoteDto> AddNoteAsync(Guid businessId, NoteDto dto);\n\n        // List all notes for dashboard view\n        Task<IEnumerable<NoteDto>> GetNotesByContactAsync(Guid businessId, Guid contactId);\n\n        // For loading note in edit mode\n        Task<NoteDto?> GetNoteByIdAsync(Guid businessId, Guid noteId);\n        // Handles editing\n        Task<bool> UpdateNoteAsync(Guid businessId, Guid noteId, NoteDto dto);\n        // Soft delete → IsActive = false\n        Task<bool> DeleteNoteAsync(Guid businessId, Guid noteId);\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/CRM/Interfaces/IReminderService.cs",
      "sha256": "b495104def7199c6e12aa28db2fad8c0c13dc551ab0cba0f8c0797361e14d8c3",
      "language": "csharp",
      "size": 806,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing xbytechat.api.CRM.Dtos;\n\nnamespace xbytechat.api.CRM.Interfaces\n{\n    public interface IReminderService\n    {\n        //For creating new reminder\n        Task<ReminderDto> AddReminderAsync(Guid businessId, ReminderDto dto);\n\n        //List all reminders for dashboard view\n        Task<IEnumerable<ReminderDto>> GetAllRemindersAsync(Guid businessId);\n\n        //For loading reminder in edit mode\n        Task<ReminderDto?> GetReminderByIdAsync(Guid businessId, Guid reminderId);\n\n        //Handles editing\n        Task<bool> UpdateReminderAsync(Guid businessId, Guid reminderId, ReminderDto dto);\n        //Soft delete → IsActive = false\n        Task<bool> DeleteReminderAsync(Guid businessId, Guid reminderId);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/CRM/Interfaces/ITagService.cs",
      "sha256": "bf7f3ea814c33020416ac25cd9d3b6f600c58c7dc849701f93e8093bf2949681",
      "language": "csharp",
      "size": 633,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing xbytechat.api.CRM.Dtos;\n\nnamespace xbytechat.api.CRM.Interfaces\n{\n    public interface ITagService\n    {\n        Task<TagDto> AddTagAsync(Guid businessId, TagDto dto);\n\n        Task<IEnumerable<TagDto>> GetAllTagsAsync(Guid businessId);\n        Task<bool> UpdateTagAsync(Guid businessId, Guid tagId, TagDto dto);\n        Task<bool> DeleteTagAsync(Guid businessId, Guid tagId);\n       // Task AssignTagAsync(Guid businessId, string phone, string tag);\n        Task AssignTagsAsync(Guid businessId, string phoneNumber, List<string> tagNames);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/CRM/Mappers/ContactDtoCsvMap.cs",
      "sha256": "41e1be6be963984ed9a757aa1575fd03a556851cdea04c287a91c4358696e166",
      "language": "csharp",
      "size": 387,
      "content": "using CsvHelper.Configuration;\nusing xbytechat.api.CRM.Dtos;\n\npublic sealed class ContactDtoCsvMap : ClassMap<ContactDto>\n{\n    public ContactDtoCsvMap()\n    {\n        Map(m => m.Name).Name(\"Name\");\n        Map(m => m.PhoneNumber).Name(\"Phone\");\n        Map(m => m.Email).Name(\"Email\");\n        Map(m => m.LeadSource).Name(\"LeadSource\");\n        Map(m => m.Notes).Name(\"Notes\");\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/CRM/Mappers/NoteMapper.cs",
      "sha256": "e26b6156b9aca01214bd18633cce4bee5e8ce187f220ff8857ab6c496e4fb933",
      "language": "csharp",
      "size": 1238,
      "content": "using xbytechat.api.CRM.Dtos;\nusing xbytechat.api.CRM.Models;\n\nnamespace xbytechat.api.CRM.Mappers\n{\n    public static class NoteMapper\n    {\n        public static NoteDto MapToDto(Note note)\n        {\n            return new NoteDto\n            {\n                Id = note.Id,\n                ContactId = note.ContactId,\n                Title = note.Title,\n                Content = note.Content,\n                Source = note.Source,\n                CreatedBy = note.CreatedBy,\n                IsPinned = note.IsPinned,\n                IsInternal = note.IsInternal,\n                CreatedAt = note.CreatedAt,\n                EditedAt = note.EditedAt\n            };\n        }\n\n        public static Note MapToEntity(NoteDto dto, Guid businessId)\n        {\n            return new Note\n            {\n                Id = Guid.NewGuid(),\n                BusinessId = businessId,\n                ContactId = dto.ContactId,\n                Title = dto.Title,\n                Content = dto.Content,\n                Source = dto.Source,\n                CreatedBy = dto.CreatedBy,\n                IsPinned = dto.IsPinned,\n                IsInternal = dto.IsInternal,\n                CreatedAt = DateTime.UtcNow\n            };\n        }\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/CRM/Mappers/ReminderMapper.cs",
      "sha256": "53c9d6d5cbdcb101f0bfc0225af4e6afc6b29111d75fb565263bf55135999e2d",
      "language": "csharp",
      "size": 865,
      "content": "namespace xbytechat.api.CRM.Mappers\n{\n    using xbytechat.api.CRM.Models;\n    using xbytechat.api.CRM.Dtos;\n\n    public static class ReminderMapper\n    {\n        public static ReminderDto MapToDto(Reminder r)\n        {\n            return new ReminderDto\n            {\n                Id = r.Id,\n                Title = r.Title,\n                Description = r.Description,\n                DueAt = r.DueAt,\n                ReminderType = r.ReminderType,\n                Priority = r.Priority,\n                IsRecurring = r.IsRecurring,\n                RecurrencePattern = r.RecurrencePattern,\n                SendWhatsappNotification = r.SendWhatsappNotification,\n                LinkedCampaign = r.LinkedCampaign,\n                Status = r.Status,\n                CreatedAt = r.CreatedAt,\n                ContactId = r.ContactId\n            };\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/CRM/Models/Contact.cs",
      "sha256": "3d14b66f4de55b9c4de89fedbfd11849b1856950b7b87af1f6dda1771ac640da",
      "language": "csharp",
      "size": 2035,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.ComponentModel.DataAnnotations;\nusing xbytechat.api.Features.BusinessModule.Models;\n\nnamespace xbytechat.api.CRM.Models\n{\n    public class Contact\n    {\n        [Key]\n        public Guid Id { get; set; }\n\n        [Required]\n        public Guid BusinessId { get; set; }\n        public Business Business { get; set; } = null!;\n        // 🔗 FK to Business\n        [Required]\n        [MaxLength(100)]\n        public string Name { get; set; }\n\n        [Required]\n        [MaxLength(20)]\n        public string PhoneNumber { get; set; }\n\n        [MaxLength(100)]\n        public string? Email { get; set; }\n\n        [MaxLength(50)]\n        public string? LeadSource { get; set; }\n\n        [MaxLength(200)]\n        public string? Tags { get; set; } // Legacy, will be deprecated after ContactTag rollout\n\n        public DateTime? LastContactedAt { get; set; }\n        public DateTime? NextFollowUpAt { get; set; }\n\n        [MaxLength(500)]\n        public string? Notes { get; set; }\n\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n\n        // 🧩 NEW: Link to Tags\n        public ICollection<ContactTag> ContactTags { get; set; } = new List<ContactTag>();\n        // ✅ New: Navigation property for many-to-many tags\n        //public ICollection<ContactTag> TagsLink { get; set; } = new List<ContactTag>();\n\n        public DateTime? LastCTAInteraction { get; set; }\n        public string? LastCTAType { get; set; }\n        public Guid? LastClickedProductId { get; set; }\n\n        // 🚦 If true, skip automation flows (manually or programmatically paused)\n        public bool IsAutomationPaused { get; set; } = false;\n\n        // 👤 If agent assigned, automation should pause (runtime check)\n        public Guid? AssignedAgentId { get; set; }\n\n        public bool IsFavorite { get; set; } = false;\n        public bool IsArchived { get; set; } = false;\n        public string? Group { get; set; }\n        public bool IsActive { get; set; } = true;\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/CRM/Models/ContactTag.cs",
      "sha256": "422118f780b163abab39572c97ce858dcf1288cc05ae98138b8bdb3dc4329322",
      "language": "csharp",
      "size": 501,
      "content": "using System.ComponentModel.DataAnnotations;\nusing xbytechat.api.CRM.Models;\n\npublic class ContactTag\n{\n    [Key]\n    public Guid Id { get; set; }\n\n    [Required]\n    public Guid ContactId { get; set; }\n\n    public Contact Contact { get; set; }\n\n    [Required]\n    public Guid TagId { get; set; }\n\n    public Tag Tag { get; set; }\n\n    [Required]\n    public Guid BusinessId { get; set; }\n\n    public DateTime AssignedAt { get; set; } = DateTime.UtcNow;\n\n    public string? AssignedBy { get; set; }\n}\n\n"
    },
    {
      "path": "xbytechat-api/CRM/Models/Note.cs",
      "sha256": "200a2bd5f7ef4bb6ed3fa7cf3dc7403ea1b2e236a843b985dfc1c02c4fe75112",
      "language": "csharp",
      "size": 914,
      "content": "namespace xbytechat.api.CRM.Models\n{\n    public class Note\n    {\n        public Guid Id { get; set; }\n\n        // 🔗 Ownership & Association\n        public Guid? BusinessId { get; set; }\n        public Guid? ContactId { get; set; }\n\n        // 📝 Core Content\n        public string Title { get; set; } // Optional short title (for pinning or preview)\n        public string Content { get; set; }\n\n        // 🔖 Contextual Intelligence\n        public string Source { get; set; } // e.g., \"Manual\", \"Call Log\", \"WhatsApp\", \"LeadForm\"\n        public string CreatedBy { get; set; } // Store agent/user name or userId\n\n        // 📌 UX Flags\n        public bool IsPinned { get; set; } = false;\n        public bool IsInternal { get; set; } = false; // if true, only visible to team\n\n        // 🕓 Timestamps\n        public DateTime CreatedAt { get; set; }\n        public DateTime? EditedAt { get; set; }\n    }\n}"
    },
    {
      "path": "xbytechat-api/CRM/Models/Reminder.cs",
      "sha256": "bc1e21ef857422a3ea4524863c8adefe038dc7cd43c474ae463ca6ca5379a830",
      "language": "csharp",
      "size": 1719,
      "content": "using System;\n\nnamespace xbytechat.api.CRM.Models\n{\n    public class Reminder\n    {\n        public Guid Id { get; set; }\n\n        public Guid BusinessId { get; set; }   // For multi-tenant isolation\n\n        public Guid ContactId { get; set; }    // Which contact this reminder is for\n\n        public string Title { get; set; } = default!; // Main reminder title (e.g., \"Call back about invoice\")\n\n        public string? Description { get; set; } // Longer notes, optional (for internal detail)\n\n        public DateTime DueAt { get; set; }    // When reminder should notify\n\n        public string Status { get; set; } = \"Pending\"; // \"Pending\", \"Done\", \"Overdue\"\n\n        public string? ReminderType { get; set; } // e.g., \"Call\", \"Email\", \"Follow-up\", \"Meeting\"\n\n        public int? Priority { get; set; } // e.g., 1 (High), 2 (Medium), 3 (Low)\n\n        public bool IsRecurring { get; set; } = false; // For future → repeat reminder\n\n        public string? RecurrencePattern { get; set; } // e.g., \"Weekly\", \"Monthly\" (optional)\n\n        public bool SendWhatsappNotification { get; set; } = false; // Future: auto-WA message trigger\n\n        public string? LinkedCampaign { get; set; } // Optional: which campaign this reminder relates to\n\n        public bool IsActive { get; set; } = true;  // Soft delete support\n\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n\n        public DateTime? UpdatedAt { get; set; }\n\n        public DateTime? CompletedAt { get; set; } // Track when it was marked Done\n\n        public string? LastCTAType { get; set; } // e.g., Confirm, Reschedule\n        public DateTime? LastClickedAt { get; set; }\n        public bool FollowUpSent { get; set; } = false;\n\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/CRM/Models/Tag.cs",
      "sha256": "e654598a682f6c55d536da4b9e18ace295abe7d611603fd18eaf61f4a5baff54",
      "language": "csharp",
      "size": 1108,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.CRM.Models\n{\n    public class Tag\n    {\n        public Guid Id { get; set; }\n\n        public Guid BusinessId { get; set; }             // Multi-tenant isolation\n\n        public string Name { get; set; } = default!;     // e.g., \"VIP\", \"Follow-up\"\n\n        public string? ColorHex { get; set; }            // For UI tag styling (e.g., #FF5733)\n\n        public string? Category { get; set; }            // e.g., \"Priority\", \"Campaign\", \"Stage\"\n\n        public string? Notes { get; set; }               // Admin/internal notes about this tag\n\n        public bool IsSystemTag { get; set; } = false;   // Reserved tags like \"New\", \"Subscribed\"\n\n        public bool IsActive { get; set; } = true;       // For soft-deactivation (future bulk ops)\n\n        public DateTime CreatedAt { get; set; }          // For analytics / sorting\n\n        public DateTime? LastUsedAt { get; set; }        // Useful for CRM insights later\n\n        public ICollection<ContactTag> ContactTags { get; set; } = new List<ContactTag>(); // Linked contacts\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/CRM/Services/ContactService.cs",
      "sha256": "8d878c77a65acb2340d4f634b9cc4c3ca3906e9569553273b32450293c27ea6f",
      "language": "csharp",
      "size": 36933,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Globalization;\nusing System.IO;\nusing System.Linq;\nusing System.Text;\nusing System.Threading.Tasks;\nusing CsvHelper;\nusing CsvHelper.Configuration;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api;\nusing xbytechat.api.CRM.Dtos;\nusing xbytechat.api.CRM.Interfaces;\nusing xbytechat.api.CRM.Models;\nusing xbytechat.api.Helpers;\n\nnamespace xbytechat.api.CRM.Services\n{\n    public class ContactService : IContactService\n    {\n        private readonly AppDbContext _db;\n        private readonly ILogger<ContactService> _logger;\n\n        public ContactService(AppDbContext db, ILogger<ContactService> logger)\n        {\n            _db = db;\n            _logger = logger;\n        }\n\n        //public async Task<ContactDto> AddContactAsync(Guid businessId, ContactDto dto)\n        //{\n        //    _logger.LogInformation(\"AddContactAsync called for businessId={BusinessId}, Name={Name}\", businessId, dto.Name);\n\n        //    var contact = new Contact\n        //    {\n        //        Id = Guid.NewGuid(),\n        //        BusinessId = businessId,\n        //        Name = dto.Name,\n        //        PhoneNumber = dto.PhoneNumber,\n        //        Email = dto.Email,\n        //        LeadSource = dto.LeadSource,\n        //        LastContactedAt = dto.LastContactedAt?.ToUniversalTime(),\n        //        NextFollowUpAt = dto.NextFollowUpAt?.ToUniversalTime(),\n        //        Notes = dto.Notes,\n        //        CreatedAt = DateTime.UtcNow,\n        //        IsFavorite = dto.IsFavorite,\n        //        IsArchived = dto.IsArchived,\n        //        Group = dto.Group\n        //    };\n\n        //    if (dto.Tags != null && dto.Tags.Any())\n        //    {\n        //        contact.ContactTags = dto.Tags.Select(t => new ContactTag\n        //        {\n        //            Id = Guid.NewGuid(),\n        //            ContactId = contact.Id,\n        //            TagId = t.TagId,\n        //            BusinessId = businessId,\n        //            AssignedAt = DateTime.UtcNow,\n        //            AssignedBy = \"system\"\n        //        }).ToList();\n        //    }\n\n        //    _db.Contacts.Add(contact);\n\n        //    try\n        //    {\n        //        await _db.SaveChangesAsync();\n        //        _logger.LogInformation(\"Contact added: {ContactId} for businessId={BusinessId}\", contact.Id, businessId);\n        //    }\n        //    catch (DbUpdateException ex)\n        //    {\n        //        _logger.LogError(ex, \"DB error in AddContactAsync (Contact: {Contact}, BusinessId={BusinessId})\", contact, businessId);\n        //        var innerMessage = ex.InnerException?.Message ?? ex.Message;\n        //        throw new Exception(\"❌ DB save error (Contact): \" + innerMessage, ex);\n        //    }\n\n        //    return new ContactDto\n        //    {\n        //        Id = contact.Id,\n        //        Name = contact.Name,\n        //        PhoneNumber = contact.PhoneNumber,\n        //        Email = contact.Email,\n        //        LeadSource = contact.LeadSource,\n        //        LastContactedAt = contact.LastContactedAt,\n        //        NextFollowUpAt = contact.NextFollowUpAt,\n        //        Notes = contact.Notes,\n        //        CreatedAt = contact.CreatedAt,\n        //        Tags = dto.Tags ?? new List<ContactTagDto>()\n        //    };\n        //}\n\n        //public async Task<ResponseResult> AddContactAsync(Guid businessId, ContactDto dto)\n        //{\n        //    _logger.LogInformation(\"📩 AddContactAsync called for businessId={BusinessId}, Name={Name}\", businessId, dto.Name);\n\n        //    try\n        //    {\n        //        // 1. Duplicate check\n        //        if (!string.IsNullOrWhiteSpace(dto.PhoneNumber))\n        //        {\n        //            var existingContact = await _db.Contacts.FirstOrDefaultAsync(c =>\n        //                c.BusinessId == businessId && c.PhoneNumber == dto.PhoneNumber);\n\n        //            if (existingContact != null)\n        //            {\n        //                _logger.LogWarning(\"⚠️ Duplicate contact attempt for phone {Phone}\", dto.PhoneNumber);\n        //                return ResponseResult.ErrorInfo(\n        //                    $\"❌ A contact with the phone number '{dto.PhoneNumber}' already exists.\"\n        //                );\n        //            }\n        //        }\n\n        //        // 2. Build entity\n        //        var contact = new Contact\n        //        {\n        //            Id = Guid.NewGuid(),\n        //            BusinessId = businessId,\n        //            Name = dto.Name,\n        //            PhoneNumber = dto.PhoneNumber,\n        //            Email = dto.Email,\n        //            LeadSource = dto.LeadSource,\n        //            LastContactedAt = dto.LastContactedAt?.ToUniversalTime(),\n        //            NextFollowUpAt = dto.NextFollowUpAt?.ToUniversalTime(),\n        //            Notes = dto.Notes,\n        //            CreatedAt = DateTime.UtcNow,\n        //            IsFavorite = dto.IsFavorite,\n        //            IsArchived = dto.IsArchived,\n        //            Group = dto.Group\n        //        };\n\n        //        // 3. Tags mapping\n        //        if (dto.Tags != null && dto.Tags.Any())\n        //        {\n        //            contact.ContactTags = dto.Tags.Select(t => new ContactTag\n        //            {\n        //                Id = Guid.NewGuid(),\n        //                ContactId = contact.Id,\n        //                TagId = t.TagId,\n        //                BusinessId = businessId,\n        //                AssignedAt = DateTime.UtcNow,\n        //                AssignedBy = \"system\"\n        //            }).ToList();\n        //        }\n\n        //        _db.Contacts.Add(contact);\n\n        //        // 4. Save\n        //        try\n        //        {\n        //            await _db.SaveChangesAsync();\n        //            _logger.LogInformation(\"✅ Contact added successfully: {ContactId} (BusinessId={BusinessId})\", contact.Id, businessId);\n        //        }\n        //        catch (DbUpdateException ex)\n        //        {\n        //            _logger.LogError(ex, \"❌ DB error in AddContactAsync (BusinessId={BusinessId})\", businessId);\n        //            var innerMessage = ex.InnerException?.Message ?? ex.Message;\n        //            return ResponseResult.ErrorInfo(\"❌ Database save error (Contact): \" + innerMessage);\n        //        }\n\n        //        // 5. Map back to DTO\n        //        var resultDto = new ContactDto\n        //        {\n        //            Id = contact.Id,\n        //            Name = contact.Name,\n        //            PhoneNumber = contact.PhoneNumber,\n        //            Email = contact.Email,\n        //            LeadSource = contact.LeadSource,\n        //            LastContactedAt = contact.LastContactedAt,\n        //            NextFollowUpAt = contact.NextFollowUpAt,\n        //            Notes = contact.Notes,\n        //            CreatedAt = contact.CreatedAt,\n        //            IsFavorite = contact.IsFavorite,\n        //            IsArchived = contact.IsArchived,\n        //            Group = contact.Group,\n        //            Tags = dto.Tags ?? new List<ContactTagDto>()\n        //        };\n\n        //        return ResponseResult.SuccessInfo(\"✅ Contact created successfully.\", resultDto);\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        _logger.LogError(ex, \"🚨 Unexpected error in AddContactAsync (BusinessId={BusinessId})\", businessId);\n        //        return ResponseResult.ErrorInfo(\"🚨 A server error occurred while creating the contact.\", ex.Message);\n        //    }\n        //}\n\n        public async Task<ResponseResult> AddContactAsync(Guid businessId, ContactDto dto)\n        {\n            _logger.LogInformation(\"📩 AddContactAsync called for businessId={BusinessId}, Name={Name}\", businessId, dto.Name);\n\n            try\n            {\n                // 1. Normalize the phone number using your private method first.\n                var normalizedPhone = NormalizePhone(dto.PhoneNumber);\n\n                // 2. Validate the normalized number.\n                // Your NormalizePhone method returns an empty string for invalid numbers.\n                if (string.IsNullOrWhiteSpace(normalizedPhone))\n                {\n                    return ResponseResult.ErrorInfo(\"❌ Phone number is invalid. It must contain exactly 10 digits.\");\n                }\n\n                // 3. Use the clean, normalized number for the duplicate check.\n                var existingContact = await _db.Contacts.FirstOrDefaultAsync(c =>\n                    c.BusinessId == businessId && c.PhoneNumber == normalizedPhone);\n\n                if (existingContact != null)\n                {\n                    _logger.LogWarning(\"⚠️ Duplicate contact attempt for phone {Phone}\", dto.PhoneNumber);\n                    return ResponseResult.ErrorInfo(\n                        $\"❌ A contact with the phone number '{dto.PhoneNumber}' already exists.\"\n                    );\n                }\n\n                // 4. Build the new contact entity, SAVING the normalized number.\n                var contact = new Contact\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    Name = dto.Name,\n                    PhoneNumber = normalizedPhone, // Save the standardized number\n                    Email = dto.Email,\n                    LeadSource = dto.LeadSource,\n                    LastContactedAt = dto.LastContactedAt?.ToUniversalTime(),\n                    NextFollowUpAt = dto.NextFollowUpAt?.ToUniversalTime(),\n                    Notes = dto.Notes,\n                    CreatedAt = DateTime.UtcNow,\n                    IsFavorite = dto.IsFavorite,\n                    IsArchived = dto.IsArchived,\n                    Group = dto.Group\n                };\n\n                // Map tags if they are provided\n                if (dto.Tags != null && dto.Tags.Any())\n                {\n                    contact.ContactTags = dto.Tags.Select(t => new ContactTag\n                    {\n                        Id = Guid.NewGuid(),\n                        ContactId = contact.Id,\n                        TagId = t.TagId,\n                        BusinessId = businessId,\n                        AssignedAt = DateTime.UtcNow,\n                        AssignedBy = \"system\"\n                    }).ToList();\n                }\n\n                _db.Contacts.Add(contact);\n                await _db.SaveChangesAsync();\n                _logger.LogInformation(\"✅ Contact added successfully: {ContactId}\", contact.Id);\n\n                // Map the created entity back to a DTO for the response\n                var resultDto = new ContactDto\n                {\n                    Id = contact.Id,\n                    Name = contact.Name,\n                    PhoneNumber = contact.PhoneNumber,\n                    Email = contact.Email,\n                    LeadSource = contact.LeadSource,\n                    CreatedAt = contact.CreatedAt,\n                    Tags = contact.ContactTags?.Select(ct => new ContactTagDto { TagId = ct.TagId }).ToList() ?? new List<ContactTagDto>()\n                };\n\n                return ResponseResult.SuccessInfo(\"✅ Contact created successfully.\", resultDto);\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"🚨 Unexpected error in AddContactAsync for business {BusinessId}\", businessId);\n                return ResponseResult.ErrorInfo(\"🚨 A server error occurred while creating the contact.\", ex.Message);\n            }\n        }\n        public async Task<ContactDto> GetContactByIdAsync(Guid businessId, Guid contactId)\n        {\n            _logger.LogInformation(\"GetContactByIdAsync: businessId={BusinessId}, contactId={ContactId}\", businessId, contactId);\n            try\n            {\n                var contact = await _db.Contacts\n                     .Where(c => c.BusinessId == businessId && c.Id == contactId && c.IsActive)\n                    .Include(c => c.ContactTags)\n                        .ThenInclude(ct => ct.Tag)\n                    .FirstOrDefaultAsync();\n\n                if (contact == null)\n                {\n                    _logger.LogWarning(\"Contact not found: businessId={BusinessId}, contactId={ContactId}\", businessId, contactId);\n                    return null;\n                }\n\n                return new ContactDto\n                {\n                    Id = contact.Id,\n                    Name = contact.Name,\n                    PhoneNumber = contact.PhoneNumber,\n                    Email = contact.Email,\n                    LeadSource = contact.LeadSource,\n                    LastContactedAt = contact.LastContactedAt,\n                    NextFollowUpAt = contact.NextFollowUpAt,\n                    Notes = contact.Notes,\n                    CreatedAt = contact.CreatedAt,\n                    Tags = contact.ContactTags?\n                        .Where(ct => ct.Tag != null)\n                        .Select(ct => new ContactTagDto\n                        {\n                            TagId = ct.TagId,\n                            TagName = ct.Tag.Name\n                        })\n                        .ToList() ?? new List<ContactTagDto>()\n                };\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"Error fetching contact by id: businessId={BusinessId}, contactId={ContactId}\", businessId, contactId);\n                throw;\n            }\n        }\n\n        public async Task<bool> UpdateContactAsync(Guid businessId, ContactDto dto)\n        {\n            _logger.LogInformation(\"UpdateContactAsync: businessId={BusinessId}, contactId={ContactId}\", businessId, dto.Id);\n            try\n            {\n                var contact = await _db.Contacts\n                    .Include(c => c.ContactTags)\n                    .FirstOrDefaultAsync(c => c.BusinessId == businessId && c.Id == dto.Id);\n\n                if (contact == null)\n                {\n                    _logger.LogWarning(\"Contact not found for update: businessId={BusinessId}, contactId={ContactId}\", businessId, dto.Id);\n                    return false;\n                }\n\n                contact.Name = dto.Name;\n                contact.PhoneNumber = dto.PhoneNumber;\n                contact.Email = dto.Email;\n                contact.LeadSource = dto.LeadSource;\n                contact.LastContactedAt = dto.LastContactedAt?.ToUniversalTime();\n                contact.NextFollowUpAt = dto.NextFollowUpAt?.ToUniversalTime();\n                contact.Notes = dto.Notes;\n\n                await _db.SaveChangesAsync();\n                _logger.LogInformation(\"Contact updated: {ContactId}\", contact.Id);\n                return true;\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"Error updating contact: businessId={BusinessId}, contactId={ContactId}\", businessId, dto.Id);\n                throw;\n            }\n        }\n\n        public async Task<bool> DeleteContactAsync(Guid businessId, Guid contactId)\n        {\n            _logger.LogInformation(\"DeleteContactAsync: businessId={BusinessId}, contactId={ContactId}\", businessId, contactId);\n            try\n            {\n                var contact = await _db.Contacts\n                    .FirstOrDefaultAsync(c => c.BusinessId == businessId && c.Id == contactId && c.IsActive);\n\n                if (contact == null)\n                {\n                    _logger.LogWarning(\"Contact not found for delete: businessId={BusinessId}, contactId={ContactId}\", businessId, contactId);\n                    return false;\n                }\n\n                contact.IsActive = false; // 👈 Soft delete\n                await _db.SaveChangesAsync();\n                _logger.LogInformation(\"Contact soft-deleted: {ContactId}\", contactId);\n                return true;\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"Error deleting contact: businessId={BusinessId}, contactId={ContactId}\", businessId, contactId);\n                throw;\n            }\n        }\n\n        \n        public async Task<CsvImportResult<ContactDto>> ParseCsvToContactsAsync(Guid businessId, Stream csvStream)\n        {\n            _logger.LogInformation(\"ParseCsvToContactsAsync: businessId={BusinessId}\", businessId);\n\n            var result = new CsvImportResult<ContactDto>();\n\n            var config = new CsvConfiguration(CultureInfo.InvariantCulture)\n            {\n                HeaderValidated = null,\n                MissingFieldFound = null\n            };\n\n            using var reader = new StreamReader(csvStream);\n            using var csv = new CsvReader(reader, config);\n\n            // Register custom column mapping for ContactDto\n            csv.Context.RegisterClassMap<ContactDtoCsvMap>();\n\n            int rowNumber = 1;\n\n            await csv.ReadAsync();     // Move to first row\n            csv.ReadHeader();          // Read header row\n\n            while (await csv.ReadAsync())\n            {\n                rowNumber++;\n                try\n                {\n                    var record = csv.GetRecord<ContactDto>();\n                    record.CreatedAt = DateTime.UtcNow;\n\n                    result.SuccessRecords.Add(record);\n                }\n                catch (Exception ex)\n                {\n                    // Avoid ambiguity by using explicit object instantiation\n                    var error = new CsvImportError\n                    {\n                        RowNumber = rowNumber,\n                        ErrorMessage = ex.Message\n                    };\n                    result.Errors.Add(error);\n                }\n            }\n\n            _logger.LogInformation(\"CSV parsed with {SuccessCount} successes and {ErrorCount} errors.\",\n                result.SuccessRecords.Count, result.Errors.Count);\n\n            return result;\n        }\n\n        //private string NormalizePhone(string phoneNumber)\n        //{\n        //    if (string.IsNullOrWhiteSpace(phoneNumber))\n        //        return phoneNumber;\n\n        //    var digits = new string(phoneNumber.Where(char.IsDigit).ToArray());\n\n        //    // If it starts with \"91\" and length = 12 → add +\n        //    if (digits.StartsWith(\"91\") && digits.Length == 12)\n        //        return \"+\" + digits;\n\n        //    // If it starts with \"91\" and length = 10 (missing country code) → add +91\n        //    if (digits.Length == 10)\n        //        return \"+91\" + digits;\n\n        //    // If it already includes country code with + (13 digits for India)\n        //    if (digits.StartsWith(\"91\") && digits.Length == 12)\n        //        return \"+\" + digits;\n\n        //    // Fallback → return with +\n        //    if (!digits.StartsWith(\"+\"))\n        //        return \"+\" + digits;\n\n        //    return digits;\n        //}\n\n        private string NormalizePhone(string phoneNumber)\n        {\n            // 1. Handle empty or null input\n            if (string.IsNullOrWhiteSpace(phoneNumber))\n            {\n                return string.Empty;\n            }\n\n            // 2. Extract only the numeric digits from the string\n            var digits = new string(phoneNumber.Where(char.IsDigit).ToArray());\n\n            // 3. If the number starts with India's country code (91) and is 12 digits long,\n            //    strip the country code to get the core 10-digit number.\n            if (digits.StartsWith(\"91\") && digits.Length == 12)\n            {\n                digits = digits.Substring(2);\n            }\n\n            // 4. NEW: Strictly validate that the result is 10 digits long.\n            if (digits.Length != 10)\n            {\n                // If the number of digits is not exactly 10, it's invalid.\n                // Return an empty string to signal that it could not be normalized.\n                return string.Empty;\n            }\n\n            // 5. If the number is a valid 10 digits, return it in the standard +91 format.\n            return \"+91\" + digits;\n        }\n        public async Task<Contact> FindOrCreateAsync(Guid businessId, string phoneNumber)\n        {\n            var normalized = NormalizePhone(phoneNumber);\n            _logger.LogInformation(\"FindOrCreateAsync: businessId={BusinessId}, rawPhone={PhoneNumber}, normalized={Normalized}\",\n                businessId, phoneNumber, normalized);\n\n            try\n            {\n                var contact = await _db.Contacts\n                    .FirstOrDefaultAsync(c => c.BusinessId == businessId && c.PhoneNumber == normalized);\n\n                if (contact != null)\n                {\n                    _logger.LogInformation(\"Contact already exists: contactId={ContactId}\", contact.Id);\n                    return contact;\n                }\n\n                var newContact = new Contact\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    Name = \"WhatsApp User\",\n                    PhoneNumber = normalized,\n                    CreatedAt = DateTime.UtcNow\n                };\n\n                _db.Contacts.Add(newContact);\n                await _db.SaveChangesAsync();\n                _logger.LogInformation(\"Contact created: {ContactId}\", newContact.Id);\n\n                return newContact;\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"Error in FindOrCreateAsync: businessId={BusinessId}, phoneNumber={PhoneNumber}\", businessId, phoneNumber);\n                throw;\n            }\n        }\n\n        public async Task<bool> ToggleFavoriteAsync(Guid businessId, Guid contactId)\n        {\n            _logger.LogInformation(\"ToggleFavoriteAsync: businessId={BusinessId}, contactId={ContactId}\", businessId, contactId);\n            try\n            {\n                var contact = await _db.Contacts.FirstOrDefaultAsync(c => c.BusinessId == businessId && c.Id == contactId);\n                if (contact == null)\n                {\n                    _logger.LogWarning(\"Contact not found for favorite toggle: businessId={BusinessId}, contactId={ContactId}\", businessId, contactId);\n                    return false;\n                }\n\n                contact.IsFavorite = !contact.IsFavorite;\n                await _db.SaveChangesAsync();\n                _logger.LogInformation(\"Contact favorite toggled: {ContactId} -> {IsFavorite}\", contactId, contact.IsFavorite);\n                return true;\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"Error toggling favorite: businessId={BusinessId}, contactId={ContactId}\", businessId, contactId);\n                throw;\n            }\n        }\n\n        public async Task AssignTagToContactsAsync(Guid businessId, List<Guid> contactIds, Guid tagId)\n        {\n            _logger.LogInformation(\"AssignTagToContactsAsync: businessId={BusinessId}, tagId={TagId}, contactIds={ContactIds}\", businessId, tagId, contactIds);\n            try\n            {\n                var contacts = await _db.Contacts\n                    .Where(c => c.BusinessId == businessId && contactIds.Contains(c.Id))\n                    .Include(c => c.ContactTags)\n                    .ToListAsync();\n\n                foreach (var contact in contacts)\n                {\n                    bool alreadyAssigned = contact.ContactTags.Any(link => link.TagId == tagId);\n                    if (!alreadyAssigned)\n                    {\n                        contact.ContactTags.Add(new ContactTag\n                        {\n                            ContactId = contact.Id,\n                            TagId = tagId\n                        });\n                    }\n                }\n                await _db.SaveChangesAsync();\n                _logger.LogInformation(\"Tags assigned to contacts\");\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"Error assigning tag: businessId={BusinessId}, tagId={TagId}\", businessId, tagId);\n                throw;\n            }\n        }\n\n        public async Task<bool> ToggleArchiveAsync(Guid businessId, Guid contactId)\n        {\n            _logger.LogInformation(\"ToggleArchiveAsync: businessId={BusinessId}, contactId={ContactId}\", businessId, contactId);\n            try\n            {\n                var contact = await _db.Contacts.FirstOrDefaultAsync(c => c.BusinessId == businessId && c.Id == contactId);\n                if (contact == null)\n                {\n                    _logger.LogWarning(\"Contact not found for archive toggle: businessId={BusinessId}, contactId={ContactId}\", businessId, contactId);\n                    return false;\n                }\n\n                contact.IsArchived = !contact.IsArchived;\n                await _db.SaveChangesAsync();\n                _logger.LogInformation(\"Contact archive toggled: {ContactId} -> {IsArchived}\", contactId, contact.IsArchived);\n                return true;\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"Error toggling archive: businessId={BusinessId}, contactId={ContactId}\", businessId, contactId);\n                throw;\n            }\n        }\n\n        public async Task<IEnumerable<ContactDto>> GetAllContactsAsync(Guid businessId, string? tab = \"all\")\n        {\n            _logger.LogInformation(\"GetAllContactsAsync: businessId={BusinessId}, tab={Tab}\", businessId, tab);\n            try\n            {\n                var baseQuery = _db.Contacts\n                    .Where(c => c.BusinessId == businessId && c.IsActive);\n\n                if (tab == \"favourites\")\n                    baseQuery = baseQuery.Where(c => c.IsFavorite);\n                else if (tab == \"archived\")\n                    baseQuery = baseQuery.Where(c => c.IsArchived);\n                else if (tab == \"groups\")\n                    baseQuery = baseQuery.Where(c => !string.IsNullOrEmpty(c.Group));\n\n                var query = baseQuery\n                    .Include(c => c.ContactTags)\n                    .ThenInclude(ct => ct.Tag);\n\n                var contacts = await query.ToListAsync();\n\n                var result = contacts.Select(c => new ContactDto\n                {\n                    Id = c.Id,\n                    Name = c.Name,\n                    PhoneNumber = c.PhoneNumber,\n                    Email = c.Email,\n                    LeadSource = c.LeadSource,\n                    LastContactedAt = c.LastContactedAt,\n                    NextFollowUpAt = c.NextFollowUpAt,\n                    Notes = c.Notes,\n                    CreatedAt = c.CreatedAt,\n                    IsFavorite = c.IsFavorite,\n                    IsArchived = c.IsArchived,\n                    Group = c.Group,\n                    Tags = c.ContactTags?\n                        .Where(ct => ct.Tag != null)\n                        .Select(ct => new ContactTagDto\n                        {\n                            TagId = ct.TagId,\n                            TagName = ct.Tag.Name,\n                            ColorHex = ct.Tag.ColorHex,\n                            Category = ct.Tag.Category\n                        })\n                        .ToList() ?? new List<ContactTagDto>()\n                });\n\n                _logger.LogInformation(\"GetAllContactsAsync returned {Count} contacts\", contacts.Count);\n                return result;\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"Error in GetAllContactsAsync: businessId={BusinessId}\", businessId);\n                throw;\n            }\n        }\n        public async Task<PagedResult<ContactDto>> GetPagedContactsAsync(Guid businessId, string? tab, int page, int pageSize, string? searchTerm)\n        {\n            _logger.LogInformation(\"GetPagedContactsAsync: businessId={BusinessId}, tab={Tab}, page={Page}, pageSize={PageSize}\",\n                businessId, tab, page, pageSize);\n\n            if (page < 1) page = 1;\n            if (pageSize < 1) pageSize = 25;\n            if (pageSize > 100) pageSize = 100; // max limit\n\n            var baseQuery = _db.Contacts\n                .Where(c => c.BusinessId == businessId && c.IsActive);\n\n            if (tab == \"favourites\")\n                baseQuery = baseQuery.Where(c => c.IsFavorite);\n            else if (tab == \"archived\")\n                baseQuery = baseQuery.Where(c => c.IsArchived);\n            else if (tab == \"groups\")\n                baseQuery = baseQuery.Where(c => !string.IsNullOrEmpty(c.Group));\n\n            var totalCount = await baseQuery.CountAsync();\n\n            var contacts = await baseQuery\n                .Include(c => c.ContactTags)\n                    .ThenInclude(ct => ct.Tag)\n                .OrderBy(c => c.Name) // or any order preferred\n                .Skip((page - 1) * pageSize)\n                .Take(pageSize)\n                .ToListAsync();\n\n            var items = contacts.Select(c => new ContactDto\n            {\n                Id = c.Id,\n                Name = c.Name,\n                PhoneNumber = c.PhoneNumber,\n                Email = c.Email,\n                LeadSource = c.LeadSource,\n                LastContactedAt = c.LastContactedAt,\n                NextFollowUpAt = c.NextFollowUpAt,\n                Notes = c.Notes,\n                CreatedAt = c.CreatedAt,\n                IsFavorite = c.IsFavorite,\n                IsArchived = c.IsArchived,\n                Group = c.Group,\n                Tags = c.ContactTags?\n                    .Where(ct => ct.Tag != null)\n                    .Select(ct => new ContactTagDto\n                    {\n                        TagId = ct.TagId,\n                        TagName = ct.Tag.Name,\n                        ColorHex = ct.Tag.ColorHex,\n                        Category = ct.Tag.Category\n                    })\n                    .ToList() ?? new List<ContactTagDto>()\n            }).ToList();\n\n            return new PagedResult<ContactDto>\n            {\n                Items = items,\n                TotalCount = totalCount\n            };\n        }\n\n        public async Task<IEnumerable<ContactDto>> GetContactsByTagsAsync(Guid businessId, List<string> tags)\n        {\n            var contacts = await _db.Contacts\n                .Where(c => c.BusinessId == businessId && !c.IsArchived)\n                .Include(c => c.ContactTags)\n                    .ThenInclude(ct => ct.Tag)\n                .Where(c => c.ContactTags.Any(ct => tags.Contains(ct.Tag.Name))) // 🔍 Filter by tag names\n                .OrderBy(c => c.Name)\n                .Select(c => new ContactDto\n                {\n                    Id = c.Id,\n                    Name = c.Name,\n                    PhoneNumber = c.PhoneNumber,\n                    Email = c.Email,\n                    Notes = c.Notes,\n                    Tags = c.ContactTags.Select(ct => new ContactTagDto\n                    {\n                        TagId = ct.Tag.Id,\n                        TagName = ct.Tag.Name,\n                        ColorHex = ct.Tag.ColorHex,\n                        Category = ct.Tag.Category\n                    }).ToList()\n                })\n                .ToListAsync();\n\n            return contacts;\n        }\n        public async Task<BulkImportResultDto> BulkImportAsync(Guid businessId, Stream csvStream)\n        {\n            _logger.LogInformation(\"Bulk import started for businessId={BusinessId}\", businessId);\n\n            var result = new BulkImportResultDto();\n            var config = new CsvConfiguration(CultureInfo.InvariantCulture)\n            {\n                HeaderValidated = null,\n                MissingFieldFound = null\n            };\n\n            using var reader = new StreamReader(csvStream);\n            using var csv = new CsvReader(reader, config);\n            csv.Context.RegisterClassMap<ContactDtoCsvMap>();\n\n            await csv.ReadAsync();\n            csv.ReadHeader();\n\n            var contactsToAdd = new List<Contact>();\n            int row = 1;\n\n            while (await csv.ReadAsync())\n            {\n                row++;\n                try\n                {\n                    var dto = csv.GetRecord<ContactDto>();\n                    if (string.IsNullOrWhiteSpace(dto.PhoneNumber)) continue;\n\n                    var contact = new Contact\n                    {\n                        Id = Guid.NewGuid(),\n                        Name = dto.Name?.Trim() ?? \"Unnamed\",\n                        PhoneNumber = dto.PhoneNumber.Trim(),\n                        Email = dto.Email?.Trim(),\n                        Notes = dto.Notes,\n                        BusinessId = businessId,\n                        CreatedAt = DateTime.UtcNow\n                    };\n\n                    contactsToAdd.Add(contact);\n                    result.Imported++;\n                }\n                catch (Exception ex)\n                {\n                    result.Errors.Add(new CsvImportError\n                    {\n                        RowNumber = row,\n                        ErrorMessage = ex.Message\n                    });\n                }\n            }\n\n            await _db.Contacts.AddRangeAsync(contactsToAdd);\n            await _db.SaveChangesAsync();\n\n            _logger.LogInformation(\"Bulk import completed: {Imported} contacts, {Errors} errors\",\n                result.Imported, result.Errors.Count);\n\n            return result;\n        }\n        public async Task<IEnumerable<ContactDto>> GetContactsByTagsAsync(Guid businessId, List<Guid> tagIds)\n        {\n            // Step 1: Prepare base query (without Include yet)\n            var baseQuery = _db.Contacts\n                .Where(c => c.BusinessId == businessId && !c.IsArchived);\n\n            // Step 2: Apply tag filter only if tagIds are provided\n            if (tagIds?.Any() == true)\n            {\n                baseQuery = baseQuery.Where(c =>\n                    c.ContactTags.Any(ct =>\n                        tagIds.Contains(ct.TagId)\n                    )\n                );\n            }\n\n            // Step 3: Add Includes after filtering to avoid cast issue\n            var queryWithIncludes = baseQuery\n                .Include(c => c.ContactTags)\n                    .ThenInclude(ct => ct.Tag);\n\n            // Step 4: Fetch data\n            var contacts = await queryWithIncludes.ToListAsync();\n\n            // Step 5: Project to DTO\n            return contacts.Select(c => new ContactDto\n            {\n                Id = c.Id,\n                Name = c.Name,\n                PhoneNumber = c.PhoneNumber,\n                Tags = c.ContactTags.Select(ct => new ContactTagDto\n                {\n                    TagId = ct.Tag.Id,\n                    TagName = ct.Tag.Name,\n                    ColorHex = ct.Tag.ColorHex,\n                    Category = ct.Tag.Category\n                }).ToList()\n            });\n        }\n        public async Task<bool> AssignTagsAsync(Guid businessId, string phoneNumber, List<string> tags)\n        {\n            if (tags == null || tags.Count == 0)\n                return false;\n\n            // 🧠 Step 1: Find the contact by phone\n            var contact = await _db.Contacts\n                .FirstOrDefaultAsync(c => c.BusinessId == businessId && c.PhoneNumber == phoneNumber && !c.IsArchived);\n\n            if (contact == null)\n                return false;\n\n            foreach (var tagName in tags)\n            {\n                if (string.IsNullOrWhiteSpace(tagName))\n                    continue;\n\n                // ✅ Step 2: Find or create the tag (by name)\n                var tag = await _db.Tags\n                    .FirstOrDefaultAsync(t => t.BusinessId == businessId && t.Name == tagName && t.IsActive);\n\n                if (tag == null)\n                {\n                    tag = new Tag\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = businessId,\n                        Name = tagName,\n                        ColorHex = \"#8c8c8c\", // default gray if not assigned\n                        IsActive = true,\n                        CreatedAt = DateTime.UtcNow\n                    };\n                    _db.Tags.Add(tag);\n                }\n\n                // 🧪 Step 3: Check if contact already has this tag\n                var alreadyTagged = await _db.ContactTags.AnyAsync(ct =>\n                    ct.ContactId == contact.Id && ct.TagId == tag.Id);\n\n                if (!alreadyTagged)\n                {\n                    _db.ContactTags.Add(new ContactTag\n                    {\n                        Id = Guid.NewGuid(),\n                        ContactId = contact.Id,\n                        TagId = tag.Id\n                    });\n                }\n            }\n\n            await _db.SaveChangesAsync();\n            return true;\n        }\n\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/CRM/Services/IPermissionService.cs.cs",
      "sha256": "336362e66dcb2a7882cb5cd48537a7105d5c7460adea2dfe2f6e563f57d6bb1a",
      "language": "csharp",
      "size": 338,
      "content": "using xbytechat.api.Features.AccessControl.DTOs;\nusing xbytechat.api.Features.AccessControl.Models;\n\nnamespace xbytechat.api.CRM.Services\n{\n    public interface IPermissionService\n    {\n       // Task<IEnumerable<object>> GetGroupedPermissionsAsync();\n        Task<IEnumerable<GroupedPermissionDto>> GetGroupedPermissionsAsync();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/CRM/Services/NoteService.cs",
      "sha256": "b2087e02e5275e90dced5ed8e2b0c1cffcbca20c8c11ad2c68fe22cad1adb2fc",
      "language": "csharp",
      "size": 4411,
      "content": "using Microsoft.EntityFrameworkCore;\nusing xbytechat.api.CRM.Dtos;\nusing xbytechat.api.CRM.Interfaces;\nusing xbytechat.api.CRM.Mappers;\nusing xbytechat.api.CRM.Models;\nusing xbytechat.api.Features.xbTimelines.DTOs;\nusing xbytechat.api.Features.xbTimelines.Services;\n\nnamespace xbytechat.api.CRM.Services\n{\n    public class NoteService : INoteService\n    {\n        private readonly AppDbContext _db;\n        private readonly ITimelineService _timelineService; // ✅ Injected Timeline Service\n\n        // ✅ Constructor: Inject AppDbContext + TimelineService\n        public NoteService(AppDbContext db, ITimelineService timelineService)\n        {\n            _db = db;\n            _timelineService = timelineService;\n        }\n\n        // 📝 Add a new Note + Log into LeadTimeline\n        public async Task<NoteDto> AddNoteAsync(Guid businessId, NoteDto dto)\n        {\n            // 1️⃣ Map incoming DTO to Note entity\n            var note = NoteMapper.MapToEntity(dto, businessId);\n\n            // 2️⃣ Save the Note into database\n            _db.Notes.Add(note);\n            await _db.SaveChangesAsync();\n\n            // 3️⃣ Log this Note creation into LeadTimeline (only if ContactId is present)\n            if (dto.ContactId.HasValue)\n            {\n                try\n                {\n                    await _timelineService.LogNoteAddedAsync(new CRMTimelineLogDto\n                    {\n                        ContactId = dto.ContactId.Value,       // ➔ Which contact the note is related to\n                        BusinessId = businessId,               // ➔ Which business created this\n                        EventType = \"NoteAdded\",                // ➔ Timeline event type\n                        Description = $\"📝 Note added: {dto.Title ?? \"(Untitled)\"}\", // ➔ Friendly description\n                        ReferenceId = note.Id,                  // ➔ Link back to Note Id\n                        CreatedBy = dto.CreatedBy,              // ➔ Who created it\n                        Timestamp = DateTime.UtcNow             // ➔ When created\n                    });\n                }\n                catch (Exception ex)\n                {\n                    // 🛡 Timeline saving failure should not break note creation\n                    Console.WriteLine($\"⚠️ Timeline log failed for NoteId {note.Id}: {ex.Message}\");\n                }\n            }\n\n            // 4️⃣ Return the saved note as DTO\n            return NoteMapper.MapToDto(note);\n        }\n\n        // 📋 List all Notes by Contact\n        public async Task<IEnumerable<NoteDto>> GetNotesByContactAsync(Guid businessId, Guid contactId)\n        {\n            return await _db.Notes\n                .AsNoTracking()\n                .Where(n => n.BusinessId == businessId && n.ContactId == contactId)\n                .OrderByDescending(n => n.CreatedAt)\n                .Select(n => NoteMapper.MapToDto(n))\n                .ToListAsync();\n        }\n\n        // 📋 Get a single Note by Id\n        public async Task<NoteDto?> GetNoteByIdAsync(Guid businessId, Guid noteId)\n        {\n            var note = await _db.Notes\n                .AsNoTracking()\n                .FirstOrDefaultAsync(n => n.Id == noteId && n.BusinessId == businessId);\n\n            return note == null ? null : NoteMapper.MapToDto(note);\n        }\n\n        // ✏️ Update an existing Note\n        public async Task<bool> UpdateNoteAsync(Guid businessId, Guid noteId, NoteDto dto)\n        {\n            var note = await _db.Notes.FirstOrDefaultAsync(n => n.Id == noteId && n.BusinessId == businessId);\n            if (note == null) return false;\n\n            note.Title = dto.Title;\n            note.Content = dto.Content;\n            note.IsPinned = dto.IsPinned;\n            note.IsInternal = dto.IsInternal;\n            note.EditedAt = DateTime.SpecifyKind(DateTime.UtcNow, DateTimeKind.Utc); // Always UTC timestamp\n\n            await _db.SaveChangesAsync();\n            return true;\n        }\n\n        // 🗑️ Soft delete (actually remove) a Note\n        public async Task<bool> DeleteNoteAsync(Guid businessId, Guid noteId)\n        {\n            var note = await _db.Notes.FirstOrDefaultAsync(n => n.Id == noteId && n.BusinessId == businessId);\n            if (note == null) return false;\n\n            _db.Notes.Remove(note);\n            await _db.SaveChangesAsync();\n            return true;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/CRM/Services/PermissionService.cs",
      "sha256": "a3b02a9b61aceffef079138a9d8df67bb6973a51a233b2538f82bb1096a184cc",
      "language": "csharp",
      "size": 999,
      "content": "using Microsoft.EntityFrameworkCore;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing xbytechat.api.CRM.Services;\nusing xbytechat.api.Features.AccessControl.DTOs;\nusing xbytechat.api.Features.AccessControl.Models;\n\nnamespace xbytechat.api.Features.AccessControl.Services\n{\n    public class PermissionService : IPermissionService\n    {\n        private readonly AppDbContext _context;\n\n        public PermissionService(AppDbContext context)\n        {\n            _context = context;\n        }\n\n        public async Task<IEnumerable<GroupedPermissionDto>> GetGroupedPermissionsAsync()\n        {\n            return await _context.Permissions\n                .Where(p => p.IsActive)\n                .GroupBy(p => p.Group ?? \"Ungrouped\")\n                .Select(g => new GroupedPermissionDto\n                {\n                    Group = g.Key,\n                    Features = g.ToList()\n                })\n                .ToListAsync();\n        }\n       \n\n\n    }\n}"
    },
    {
      "path": "xbytechat-api/CRM/Services/ReminderService.cs",
      "sha256": "3ad4d8d834b958a925554f6aadbc8360ec657324fee3f939680f3c37df7076a0",
      "language": "csharp",
      "size": 5904,
      "content": "using Microsoft.EntityFrameworkCore;\nusing xbytechat.api.CRM.Dtos;\nusing xbytechat.api.CRM.Interfaces;\nusing xbytechat.api.CRM.Mappers;\nusing xbytechat.api.CRM.Models;\n\nnamespace xbytechat.api.CRM.Services\n{\n    public class ReminderService : IReminderService\n    {\n        private readonly AppDbContext _db;\n\n        public ReminderService(AppDbContext db)\n        {\n            _db = db;\n        }\n\n        //public async Task<ReminderDto> AddReminderAsync(Guid businessId, ReminderDto dto)\n        //{\n        //    var reminder = new Reminder\n        //    {\n        //        Id = Guid.NewGuid(),\n        //        BusinessId = businessId,\n        //        //ContactId = dto.ContactId,\n        //        Title = dto.Title,\n        //        Description = dto.Description,\n        //        DueAt = dto.DueAt,\n        //        Status = dto.Status ?? \"Pending\",\n        //        ReminderType = dto.ReminderType,\n        //        Priority = dto.Priority,\n        //        IsRecurring = dto.IsRecurring,\n        //        RecurrencePattern = dto.RecurrencePattern,\n        //        SendWhatsappNotification = dto.SendWhatsappNotification,\n        //        LinkedCampaign = dto.LinkedCampaign,\n        //        CreatedAt = DateTime.UtcNow,\n        //        IsActive = true\n        //    };\n\n        //    _db.Reminders.Add(reminder);\n        //    await _db.SaveChangesAsync();\n\n        //    return MapToDto(reminder);\n        //}\n        public async Task<ReminderDto> AddReminderAsync(Guid businessId, ReminderDto dto)\n        {\n            try\n            {\n                var reminder = new Reminder\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    ContactId = dto.ContactId ?? Guid.Empty, // add default fallback\n                    Title = dto.Title,\n                    Description = dto.Description,\n                    DueAt = DateTime.SpecifyKind(dto.DueAt, DateTimeKind.Utc),\n                    Status = dto.Status ?? \"Pending\",\n                    ReminderType = dto.ReminderType,\n                    Priority = dto.Priority,\n                    IsRecurring = dto.IsRecurring,\n                    RecurrencePattern = dto.RecurrencePattern,\n                    SendWhatsappNotification = dto.SendWhatsappNotification,\n                    LinkedCampaign = dto.LinkedCampaign,\n                    CreatedAt = DateTime.SpecifyKind(dto.DueAt, DateTimeKind.Utc),\n                    IsActive = true\n                };\n\n                _db.Reminders.Add(reminder);\n                await _db.SaveChangesAsync();\n\n                return MapToDto(reminder);\n            }\n            catch (Exception ex)\n            {\n                Console.WriteLine(\"❌ Error in AddReminderAsync: \" + ex.Message);\n                throw;\n            }\n        }\n\n        public async Task<IEnumerable<ReminderDto>> GetAllRemindersAsync(Guid businessId)\n        {\n            return await _db.Reminders\n                .AsNoTracking()\n                .Where(r => r.BusinessId == businessId && r.IsActive)\n                .OrderBy(r => r.DueAt)\n                .Select(r => ReminderMapper.MapToDto(r))\n                .ToListAsync();\n        }\n\n\n        public async Task<ReminderDto?> GetReminderByIdAsync(Guid businessId, Guid reminderId)\n        {\n            var reminder = await _db.Reminders\n                .FirstOrDefaultAsync(r => r.BusinessId == businessId && r.Id == reminderId && r.IsActive);\n\n            return reminder == null ? null : MapToDto(reminder);\n        }\n\n        public async Task<bool> UpdateReminderAsync(Guid businessId, Guid reminderId, ReminderDto dto)\n        {\n            var reminder = await _db.Reminders.FirstOrDefaultAsync(r => r.BusinessId == businessId && r.Id == reminderId && r.IsActive);\n            if (reminder == null) return false;\n\n            reminder.Title = dto.Title;\n            reminder.Description = dto.Description;\n            reminder.DueAt = DateTime.SpecifyKind(dto.DueAt, DateTimeKind.Utc);\n            reminder.Status = dto.Status ?? reminder.Status;\n            reminder.ReminderType = dto.ReminderType;\n            reminder.Priority = dto.Priority;\n            reminder.IsRecurring = dto.IsRecurring;\n            reminder.RecurrencePattern = dto.RecurrencePattern;\n            reminder.SendWhatsappNotification = dto.SendWhatsappNotification;\n            reminder.LinkedCampaign = dto.LinkedCampaign;\n            reminder.UpdatedAt = DateTime.UtcNow;\n\n            if (dto.Status?.ToLower() == \"done\")\n                reminder.CompletedAt = DateTime.UtcNow;\n\n            await _db.SaveChangesAsync();\n            return true;\n        }\n\n        public async Task<bool> DeleteReminderAsync(Guid businessId, Guid reminderId)\n        {\n            var reminder = await _db.Reminders.FirstOrDefaultAsync(r => r.BusinessId == businessId && r.Id == reminderId && r.IsActive);\n            if (reminder == null) return false;\n\n            reminder.IsActive = false;\n            await _db.SaveChangesAsync();\n            return true;\n        }\n\n        private ReminderDto MapToDto(Reminder r)\n        {\n            return new ReminderDto\n            {\n                Id = r.Id,\n                ContactId = r.ContactId,\n                Title = r.Title,\n                Description = r.Description,\n                DueAt = r.DueAt,\n                Status = r.Status,\n                ReminderType = r.ReminderType,\n                Priority = r.Priority,\n                IsRecurring = r.IsRecurring,\n                RecurrencePattern = r.RecurrencePattern,\n                SendWhatsappNotification = r.SendWhatsappNotification,\n                LinkedCampaign = r.LinkedCampaign,\n                CreatedAt = r.CreatedAt,\n                UpdatedAt = r.UpdatedAt,\n                CompletedAt = r.CompletedAt,\n                IsActive = r.IsActive\n            };\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/CRM/Services/TagService.cs",
      "sha256": "e6319aeaf570d7b97052cbcabccb0de70ab4649b141cea3a48e625b620caa0c1",
      "language": "csharp",
      "size": 8676,
      "content": "using Microsoft.EntityFrameworkCore;\nusing xbytechat.api.CRM.Dtos;\nusing xbytechat.api.CRM.Interfaces;\nusing xbytechat.api.CRM.Models;\nusing xbytechat.api.Features.xbTimelines.DTOs;\nusing xbytechat.api.Features.xbTimelines.Services;\n\nnamespace xbytechat.api.CRM.Services\n{\n    public class TagService : ITagService\n    {\n        private readonly AppDbContext _db;\n        private readonly ITimelineService _timelineService; // ✅ Injected TimelineService\n        private readonly ILogger<TagService> _logger;\n        public TagService(AppDbContext db, ITimelineService timelineService, ILogger<TagService> logger)\n        {\n            _db = db;\n            _timelineService = timelineService;\n            _logger = logger;\n        }\n\n        public async Task<TagDto> AddTagAsync(Guid businessId, TagDto dto)\n        {\n            var tag = new Tag\n            {\n                Id = Guid.NewGuid(),\n                BusinessId = businessId,\n                Name = dto.Name,\n                ColorHex = dto.ColorHex,\n                Category = dto.Category,\n                Notes = dto.Notes,\n                IsSystemTag = dto.IsSystemTag,\n                IsActive = dto.IsActive,\n                CreatedAt = DateTime.UtcNow,\n                LastUsedAt = null\n            };\n\n            _db.Tags.Add(tag);\n            await _db.SaveChangesAsync();\n\n            // ✅ After saving tag → try logging into Timeline (non-blocking)\n            try\n            {\n                await _timelineService.LogTagAppliedAsync(new CRMTimelineLogDto\n                {\n                    ContactId = Guid.Empty,    // ➡️ No specific contact, general event\n                    BusinessId = businessId,\n                    EventType = \"TagCreated\",\n                    Description = $\"🏷️ New tag created: {dto.Name}\",\n                    ReferenceId = tag.Id,\n                    CreatedBy = \"System\",\n                    Timestamp = DateTime.UtcNow,\n                    Category = \"CRM\"\n                });\n            }\n            catch (Exception ex)\n            {\n                // 🛡 Fail-safe: Do not block tag creation if timeline fails\n                Console.WriteLine($\"⚠️ Timeline log failed for TagId {tag.Id}: {ex.Message}\");\n            }\n\n            return new TagDto\n            {\n                Id = tag.Id,\n                Name = tag.Name,\n                ColorHex = tag.ColorHex,\n                Category = tag.Category,\n                Notes = tag.Notes,\n                IsSystemTag = tag.IsSystemTag,\n                IsActive = tag.IsActive,\n                CreatedAt = tag.CreatedAt,\n                LastUsedAt = tag.LastUsedAt\n            };\n        }\n\n        public async Task<IEnumerable<TagDto>> GetAllTagsAsync(Guid businessId)\n        {\n            return await _db.Tags\n                .Where(t => t.BusinessId == businessId && t.IsActive)\n                .OrderByDescending(t => t.CreatedAt)\n                .Select(t => new TagDto\n                {\n                    Id = t.Id,\n                    Name = t.Name,\n                    ColorHex = t.ColorHex,\n                    Category = t.Category,\n                    Notes = t.Notes,\n                    IsSystemTag = t.IsSystemTag,\n                    IsActive = t.IsActive,\n                    CreatedAt = t.CreatedAt,\n                    LastUsedAt = t.LastUsedAt\n                })\n                .ToListAsync();\n        }\n\n        public async Task<bool> UpdateTagAsync(Guid businessId, Guid tagId, TagDto dto)\n        {\n            var tag = await _db.Tags.FirstOrDefaultAsync(t => t.Id == tagId && t.BusinessId == businessId);\n            if (tag == null) return false;\n\n            tag.Name = dto.Name;\n            tag.ColorHex = dto.ColorHex;\n            tag.Category = dto.Category;\n            tag.Notes = dto.Notes;\n            tag.IsSystemTag = dto.IsSystemTag;\n            tag.IsActive = dto.IsActive;\n            tag.LastUsedAt = DateTime.UtcNow;\n\n            await _db.SaveChangesAsync();\n            return true;\n        }\n\n        public async Task<bool> DeleteTagAsync(Guid businessId, Guid tagId)\n        {\n            var tag = await _db.Tags.FirstOrDefaultAsync(t => t.Id == tagId && t.BusinessId == businessId);\n            if (tag == null) return false;\n\n            tag.IsActive = false;\n            await _db.SaveChangesAsync();\n            return true;\n        }\n        //public async Task AssignTagAsync(Guid businessId, string phone, string tag)\n        //{\n        //    try\n        //    {\n        //        // ✅ Step 1: Lookup contact\n        //        var contact = await _db.Contacts\n        //            .FirstOrDefaultAsync(c => c.BusinessId == businessId && c.PhoneNumber == phone);\n\n        //        if (contact == null)\n        //        {\n        //            _logger.LogWarning(\"⚠️ Contact not found for phone: {Phone}\", phone);\n        //            return;\n        //        }\n\n        //        // ✅ Step 2: Check if tag exists\n        //        var existingTag = await _db.Tags\n        //            .FirstOrDefaultAsync(t => t.BusinessId == businessId && t.Name == tag);\n\n        //        if (existingTag == null)\n        //        {\n        //            existingTag = new Tag\n        //            {\n        //                Id = Guid.NewGuid(),\n        //                BusinessId = businessId,\n        //                Name = tag,\n        //                CreatedAt = DateTime.UtcNow\n        //            };\n\n        //            await _db.Tags.AddAsync(existingTag);\n        //        }\n\n        //        // ✅ Step 3: Associate tag with contact if not already\n        //        var alreadyTagged = await _db.ContactTags\n        //            .AnyAsync(ct => ct.ContactId == contact.Id && ct.TagId == existingTag.Id);\n\n        //        if (!alreadyTagged)\n        //        {\n        //            await _db.ContactTags.AddAsync(new ContactTag\n        //            {\n        //                Id = Guid.NewGuid(),\n        //                ContactId = contact.Id,\n        //                TagId = existingTag.Id,\n        //                AssignedAt = DateTime.UtcNow\n        //            });\n\n        //            _logger.LogInformation(\"🏷 Tag '{Tag}' assigned to contact {ContactId}\", tag, contact.Id);\n        //        }\n\n        //        await _db.SaveChangesAsync();\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        _logger.LogError(ex, \"❌ Error assigning tag to contact.\");\n        //        throw;\n        //    }\n        //}\n        public async Task AssignTagsAsync(Guid businessId, string phoneNumber, List<string> tagNames)\n        {\n            if (tagNames == null || !tagNames.Any())\n                return;\n\n            // 🔍 Fetch the contact and existing tag links\n            var contact = await _db.Contacts\n             .Include(c => c.ContactTags)\n             .FirstOrDefaultAsync(c => c.BusinessId == businessId && c.PhoneNumber == phoneNumber);\n\n\n            if (contact == null) return;\n\n            var existingTagIds = contact.ContactTags.Select(t => t.TagId).ToHashSet();\n\n            // 🔍 Ensure tags exist or create them\n            var tags = await _db.Tags\n                .Where(t => t.BusinessId == businessId && tagNames.Contains(t.Name))\n                .ToListAsync();\n\n            var existingNames = tags.Select(t => t.Name).ToHashSet(StringComparer.OrdinalIgnoreCase);\n            var missingNames = tagNames.Where(t => !existingNames.Contains(t)).Distinct().ToList();\n\n            foreach (var name in missingNames)\n            {\n                var newTag = new Tag\n                {\n                    Id = Guid.NewGuid(),\n                    Name = name,\n                    BusinessId = businessId,\n                    CreatedAt = DateTime.UtcNow\n                };\n                _db.Tags.Add(newTag);\n                tags.Add(newTag);\n            }\n\n            await _db.SaveChangesAsync(); // Save new tags before linking\n\n            // ✅ Link new tags to contact\n            foreach (var tag in tags)\n            {\n                if (!existingTagIds.Contains(tag.Id))\n                {\n                    contact.ContactTags.Add(new ContactTag\n                    {\n                        Id = Guid.NewGuid(),\n                        TagId = tag.Id,\n                        ContactId = contact.Id,\n                        BusinessId = businessId,\n                        AssignedAt = DateTime.UtcNow,\n                        AssignedBy = \"automation\" // optional: set to flow name\n                    });\n                }\n            }\n\n            await _db.SaveChangesAsync();\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Data/AppDbContext.cs",
      "sha256": "614892965e88d2426c1f62167475c581059986a8e0e0630336129fd9a4e0ce8e",
      "language": "csharp",
      "size": 16003,
      "content": "using Microsoft.EntityFrameworkCore;\nusing System.Globalization;\nusing xbytechat.api.CRM.Models;\nusing xbytechat.api.Features.Catalog.Models;\nusing xbytechat.api.Models.BusinessModel;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.Features.CampaignTracking.Models;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.Features.AccessControl.Models;\nusing xbytechat.api.Features.AccessControl.Seeder;\nusing xbytechat.api.Features.AuditTrail.Models;\nusing xbytechat.api.Features.xbTimelines.Models;\nusing xbytechat_api.WhatsAppSettings.Models;\nusing xbytechat.api.Features.CTAManagement.Models;\nusing xbytechat.api.Features.Tracking.Models;\nusing xbytechat.api.Features.MessageManagement.DTOs;\nusing xbytechat.api.Features.Webhooks.Models;\nusing xbytechat.api.Features.CTAFlowBuilder.Models;\nusing xbytechat.api.Features.Inbox.Models;\nusing xbytechat.api.Features.AutoReplyBuilder.Models;\nusing xbytechat.api.Features.AutoReplyBuilder.Flows.Models;\nusing xbytechat.api.Features.BusinessModule.Models;\nusing xbytechat.api.Features.FeatureAccessModule.Models;\nusing xbytechat.api.Features.PlanManagement.Models;\nusing xbytechat.api.Features.Automation.Models;\nusing xbytechat.api.Features.CampaignTracking.Worker;\n\nnamespace xbytechat.api\n{\n    public class AppDbContext : DbContext\n    {\n        public AppDbContext(DbContextOptions<AppDbContext> options)\n            : base(options) { }\n\n        // ✅ Table Registrations\n        public DbSet<Business> Businesses { get; set; }\n        public DbSet<User> Users { get; set; }\n        public DbSet<MessageLog> MessageLogs { get; set; }\n        public DbSet<Product> Products { get; set; }\n        public DbSet<CatalogClickLog> CatalogClickLogs { get; set; }\n        public DbSet<Contact> Contacts { get; set; }\n        public DbSet<Tag> Tags { get; set; }\n        public DbSet<Reminder> Reminders { get; set; }\n        public DbSet<Note> Notes { get; set; }\n        public DbSet<LeadTimeline> LeadTimelines { get; set; }\n        public DbSet<ContactTag> ContactTags { get; set; }\n        public DbSet<Campaign> Campaigns { get; set; }\n        public DbSet<CampaignRecipient> CampaignRecipients { get; set; }\n        public DbSet<CampaignSendLog> CampaignSendLogs { get; set; }\n        public DbSet<MessageStatusLog> MessageStatusLogs { get; set; }\n\n        // 🧩 Access Control\n        public DbSet<Role> Roles { get; set; }\n        public DbSet<Permission> Permissions { get; set; }\n        public DbSet<RolePermission> RolePermissions { get; set; }\n        public DbSet<UserPermission> UserPermissions { get; set; }\n        public DbSet<AuditLog> AuditLogs { get; set; }\n        public DbSet<WhatsAppSettingEntity> WhatsAppSettings { get; set; }\n        public DbSet<BusinessPlanInfo> BusinessPlanInfos { get; set; }\n\n        public DbSet<TrackingLog> TrackingLogs { get; set; }\n        public DbSet<CTADefinition> CTADefinitions { get; set; }\n        public DbSet<CampaignButton> CampaignButtons { get; set; }\n        public DbSet<FailedWebhookLog> FailedWebhookLogs { get; set; }\n        public DbSet<WebhookSettings> WebhookSettings { get; set; }\n\n        public DbSet<CTAFlowConfig> CTAFlowConfigs { get; set; }\n        public DbSet<CTAFlowStep> CTAFlowSteps { get; set; }\n        public DbSet<FlowButtonLink> FlowButtonLinks { get; set; }\n\n        public DbSet<CampaignFlowOverride> CampaignFlowOverrides { get; set; }\n        public DbSet<FlowExecutionLog> FlowExecutionLogs { get; set; }\n        public DbSet<ContactRead> ContactReads { get; set; }\n\n        public DbSet<AutoReplyRule> AutoReplyRules { get; set; }\n        public DbSet<AutoReplyFlow> AutoReplyFlows { get; set; }\n        public DbSet<AutoReplyFlowNode> AutoReplyFlowNodes { get; set; }\n        public DbSet<AutoReplyFlowEdge> AutoReplyFlowEdges { get; set; }\n        public DbSet<AutoReplyLog> AutoReplyLogs { get; set; }\n        public DbSet<ChatSessionState> ChatSessionStates { get; set; }\n        public DbSet<Plan> Plans { get; set; }\n        public DbSet<PlanPermission> PlanPermissions { get; set; }\n        public DbSet<FeatureAccess> FeatureAccess { get; set; }\n        public DbSet<PlanFeatureMatrix> PlanFeatureMatrix { get; set; }\n        public DbSet<UserFeatureAccess> UserFeatureAccess { get; set; }\n        public DbSet<FeatureMaster> FeatureMasters { get; set; }\n        public DbSet<AutomationFlow> AutomationFlows { get; set; }\n        public DbSet<WhatsAppTemplate> WhatsAppTemplates { get; set; }\n\n        public DbSet<CampaignClickLog> CampaignClickLogs => Set<CampaignClickLog>();\n        public DbSet<CampaignClickDailyAgg> CampaignClickDailyAgg => Set<CampaignClickDailyAgg>();\n\n        protected override void OnModelCreating(ModelBuilder modelBuilder)\n        {\n            base.OnModelCreating(modelBuilder);\n\n            // ✅ Seed Role IDs (keep them consistent)\n            var superadminRoleId = Guid.Parse(\"00000000-0000-0000-0000-000000000001\");\n            var partnerRoleId = Guid.Parse(\"00000000-0000-0000-0000-000000000002\");\n            var resellerRoleId = Guid.Parse(\"00000000-0000-0000-0000-000000000003\");\n            var businessRoleId = Guid.Parse(\"00000000-0000-0000-0000-000000000004\");\n            var agentRoleId = Guid.Parse(\"00000000-0000-0000-0000-000000000005\");\n\n            // ✅ Roles\n            modelBuilder.Entity<Role>().HasData(\n                new Role { Id = superadminRoleId, Name = \"admin\", Description = \"Super Admin\", CreatedAt = DateTime.UtcNow },\n                new Role { Id = partnerRoleId, Name = \"partner\", Description = \"Business Partner\", CreatedAt = DateTime.UtcNow },\n                new Role { Id = resellerRoleId, Name = \"reseller\", Description = \"Reseller Partner\", CreatedAt = DateTime.UtcNow },\n                new Role { Id = businessRoleId, Name = \"business\", Description = \"Business Owner\", CreatedAt = DateTime.UtcNow },\n                new Role { Id = agentRoleId, Name = \"staff\", Description = \"Staff\", CreatedAt = DateTime.UtcNow }\n            );\n\n            // ✅ Permissions from RolePermissionMapping\n            var allPermissions = RolePermissionMapping.RolePermissions\n                .SelectMany(p => p.Value)\n                .Distinct()\n                .ToList();\n\n            var permissionEntities = allPermissions.Select((perm, index) => new Permission\n            {\n                Id = Guid.Parse($\"30000000-0000-0000-0000-{index.ToString(\"D12\", CultureInfo.InvariantCulture)}\"),\n                Name = perm,\n                Code = perm,\n                Description = $\"Permission for {perm}\",\n                IsActive = true,\n                CreatedAt = DateTime.UtcNow\n            }).ToList();\n            modelBuilder.Entity<Permission>().HasData(permissionEntities);\n\n            // ✅ RolePermission mappings\n            var permissionMap = permissionEntities.ToDictionary(p => p.Name, p => p.Id);\n            var roleMap = new Dictionary<string, Guid>\n            {\n                [\"admin\"] = superadminRoleId,\n                [\"partner\"] = partnerRoleId,\n                [\"reseller\"] = resellerRoleId,\n                [\"business\"] = businessRoleId,\n                [\"staff\"] = agentRoleId\n            };\n\n            var rolePermissions = RolePermissionMapping.RolePermissions\n                .SelectMany(rp => rp.Value.Select(permissionName => new RolePermission\n                {\n                    Id = Guid.NewGuid(),\n                    RoleId = roleMap[rp.Key],\n                    PermissionId = permissionMap[permissionName],\n                    IsActive = true,\n                    AssignedAt = DateTime.UtcNow\n                }))\n                .ToList();\n\n            modelBuilder.Entity<RolePermission>().HasData(rolePermissions);\n\n            // ========== 🧩 CORRECT RELATIONSHIPS ==========\n\n            // Role ↔️ RolePermission (One-to-Many)\n            modelBuilder.Entity<RolePermission>()\n                .HasOne(rp => rp.Role)\n                .WithMany(r => r.RolePermissions)\n                .HasForeignKey(rp => rp.RoleId)\n                .OnDelete(DeleteBehavior.Cascade);\n\n            // Permission ↔️ RolePermission (One-to-Many)\n            modelBuilder.Entity<RolePermission>()\n                .HasOne(rp => rp.Permission)\n                .WithMany(p => p.RolePermissions)\n                .HasForeignKey(rp => rp.PermissionId)\n                .OnDelete(DeleteBehavior.Cascade);\n\n            // User ↔️ UserPermission (One-to-Many)\n            modelBuilder.Entity<UserPermission>()\n                .HasOne(up => up.User)\n                .WithMany(u => u.UserPermissions)\n                .HasForeignKey(up => up.UserId)\n                .OnDelete(DeleteBehavior.Cascade);\n\n            // Permission ↔️ UserPermission (One-to-Many)\n            modelBuilder.Entity<UserPermission>()\n                .HasOne(up => up.Permission)\n                .WithMany(p => p.UserPermissions)\n                .HasForeignKey(up => up.PermissionId)\n                .OnDelete(DeleteBehavior.Cascade);\n\n            // ========== (Rest of your model mappings below remain the same) ==========\n\n            modelBuilder.Entity<CampaignSendLog>()\n                .HasOne(s => s.MessageLog)\n                .WithMany()\n                .HasForeignKey(s => s.MessageLogId)\n                .OnDelete(DeleteBehavior.Restrict);\n\n            modelBuilder.Entity<LeadTimeline>()\n                .HasOne(t => t.Contact)\n                .WithMany()\n                .HasForeignKey(t => t.ContactId);\n\n            modelBuilder.Entity<Campaign>()\n                .HasOne(c => c.Business)\n                .WithMany(b => b.Campaigns)\n                .HasForeignKey(c => c.BusinessId)\n                .IsRequired();\n\n            modelBuilder.Entity<CampaignRecipient>()\n                .HasOne(r => r.Campaign)\n                .WithMany(c => c.Recipients)\n                .HasForeignKey(r => r.CampaignId);\n\n            modelBuilder.Entity<CampaignRecipient>()\n                .HasOne(r => r.Contact)\n                .WithMany()\n                .HasForeignKey(r => r.ContactId);\n\n            modelBuilder.Entity<CampaignRecipient>()\n                .HasOne(r => r.Business)\n                .WithMany()\n                .HasForeignKey(r => r.BusinessId)\n                .OnDelete(DeleteBehavior.Restrict);\n\n            modelBuilder.Entity<CampaignSendLog>()\n                .HasOne(s => s.Recipient)\n                .WithMany(r => r.SendLogs)\n                .HasForeignKey(s => s.RecipientId);\n\n            modelBuilder.Entity<CampaignSendLog>()\n                .HasOne(s => s.Contact)\n                .WithMany()\n                .HasForeignKey(s => s.ContactId);\n\n            modelBuilder.Entity<CampaignSendLog>()\n                .HasOne(s => s.Campaign)\n                .WithMany(c => c.SendLogs)\n                .HasForeignKey(s => s.CampaignId)\n                .OnDelete(DeleteBehavior.Cascade);\n\n            modelBuilder.Entity<ContactTag>()\n                .HasOne(ct => ct.Contact)\n                .WithMany(c => c.ContactTags)\n                .HasForeignKey(ct => ct.ContactId)\n                .OnDelete(DeleteBehavior.Cascade);\n\n            modelBuilder.Entity<ContactTag>()\n                .HasOne(ct => ct.Tag)\n                .WithMany(t => t.ContactTags)\n                .HasForeignKey(ct => ct.TagId)\n                .OnDelete(DeleteBehavior.Cascade);\n\n            modelBuilder.Entity<Role>()\n                .HasMany(r => r.Users)\n                .WithOne(u => u.Role)\n                .HasForeignKey(u => u.RoleId)\n                .OnDelete(DeleteBehavior.Restrict);\n\n            modelBuilder.Entity<Campaign>()\n                .HasMany(c => c.MultiButtons)\n                .WithOne(b => b.Campaign)\n                .HasForeignKey(b => b.CampaignId)\n                .OnDelete(DeleteBehavior.Cascade);\n\n            modelBuilder.Entity<MessageLog>()\n                .HasOne(m => m.SourceCampaign)\n                .WithMany(c => c.MessageLogs)\n                .HasForeignKey(m => m.CampaignId)\n                .OnDelete(DeleteBehavior.Restrict);\n\n            modelBuilder.Entity<CampaignSendLog>()\n                .Property(s => s.BusinessId)\n                .IsRequired();\n\n            modelBuilder.Entity<FlowButtonLink>()\n                .HasKey(b => b.Id);\n\n            modelBuilder.Entity<Business>()\n                .HasOne(b => b.WhatsAppSettings)\n                .WithOne()\n                .HasForeignKey<WhatsAppSettingEntity>(s => s.BusinessId);\n\n            modelBuilder.Entity<ContactRead>()\n                .HasIndex(cr => new { cr.ContactId, cr.UserId })\n                .IsUnique();\n\n            modelBuilder.Entity<AutoReplyFlowNode>()\n                .OwnsOne(n => n.Position);\n\n            modelBuilder.Entity<FeatureAccess>()\n            .HasIndex(f => new { f.BusinessId, f.FeatureName })\n            .IsUnique();\n\n            modelBuilder.Entity<WhatsAppTemplate>(e =>\n            {\n                e.Property(x => x.Body).HasColumnType(\"text\");\n                e.Property(x => x.ButtonsJson).HasColumnType(\"text\");\n                e.Property(x => x.RawJson).HasColumnType(\"text\");\n            });\n            modelBuilder.Entity<CampaignClickLog>(e =>\n            {\n                e.HasIndex(x => new { x.CampaignId, x.ClickType, x.ClickedAt });\n                e.HasIndex(x => new { x.CampaignId, x.ButtonIndex });\n                e.HasIndex(x => new { x.CampaignId, x.ContactId });\n            });\n\n            modelBuilder.Entity<CampaignClickDailyAgg>(e =>\n            {\n                e.HasIndex(x => new { x.CampaignId, x.Day, x.ButtonIndex }).IsUnique();\n                e.Property(x => x.Day).HasColumnType(\"date\");\n            });\n\n            modelBuilder.Entity<MessageLog>()\n            .HasIndex(x => x.MessageId);\n            modelBuilder.Entity<MessageLog>()\n                .HasIndex(x => x.RunId);\n\n            modelBuilder.Entity<CampaignSendLog>()\n                .HasIndex(x => x.MessageId);\n            modelBuilder.Entity<CampaignSendLog>()\n                .HasIndex(x => x.RunId);\n\n            // ---------- WhatsAppSettingEntity indexes (for webhook → BusinessId resolution) ----------\n            modelBuilder.Entity<WhatsAppSettingEntity>(b =>\n            {\n                b.HasIndex(x => new { x.Provider, x.PhoneNumberId })\n                 .HasDatabaseName(\"IX_WhatsAppSettings_Provider_PhoneNumberId\");\n\n                b.HasIndex(x => new { x.Provider, x.WhatsAppBusinessNumber })\n                 .HasDatabaseName(\"IX_WhatsAppSettings_Provider_BusinessNumber\");\n\n                b.HasIndex(x => new { x.Provider, x.WabaId })\n                 .HasDatabaseName(\"IX_WhatsAppSettings_Provider_WabaId\");\n\n                // Handy for admin views / quick filters\n                b.HasIndex(x => new { x.BusinessId, x.Provider, x.IsActive })\n                 .HasDatabaseName(\"IX_WhatsAppSettings_Business_Provider_IsActive\");\n\n                b.HasIndex(x => new { x.Provider, x.WebhookCallbackUrl })\n                 .HasDatabaseName(\"IX_WhatsAppSettings_Provider_CallbackUrl\");\n\n              \n            });\n\n            // ---------- CampaignSendLog composite index (fast status reconciliation) ----------\n            modelBuilder.Entity<CampaignSendLog>(b =>\n            {\n                b.HasIndex(x => new { x.BusinessId, x.MessageId })\n                 .HasDatabaseName(\"IX_CampaignSendLogs_Business_MessageId\");\n            });\n\n            // ---------- MessageLog composite indexes (fast joins & inbound lookups) ----------\n            modelBuilder.Entity<MessageLog>(b =>\n            {\n                b.HasIndex(x => new { x.BusinessId, x.MessageId })\n                 .HasDatabaseName(\"IX_MessageLogs_Business_MessageId\");\n\n                b.HasIndex(x => new { x.BusinessId, x.RecipientNumber })\n                 .HasDatabaseName(\"IX_MessageLogs_Business_Recipient\");\n            });\n\n            modelBuilder.Entity<Contact>()\n                .HasIndex(c => new { c.BusinessId, c.PhoneNumber })\n                .IsUnique();\n\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/DTOs/Messages/BaseMessageDto.cs",
      "sha256": "9af6b10a0f81ca1fef4fa6f55228cf022cf8f574e7dc66dcee263cde3074a20d",
      "language": "csharp",
      "size": 440,
      "content": "using System;\nusing System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.DTOs.Messages\n{\n    public abstract class BaseMessageDto\n    {\n        [Required]\n        public Guid BusinessId { get; set; }\n\n        [Required]\n        [Phone]\n        public string RecipientNumber { get; set; }\n\n        public abstract string MessageContent { get; set; }\n\n        //[Required]\n        //public string MessageType { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/DTOs/Messages/BulkMessageDto.cs",
      "sha256": "c9cf233e8ad3bf868c53de4f40343b326e34c668d015097e2aa6a1221696b9c4",
      "language": "csharp",
      "size": 647,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.DTOs.Messages\n{\n    public class BulkMessageDto\n    {\n        [Required]\n        public List<Guid> ContactIds { get; set; } = new();\n\n        [Required]\n        public string MessageType { get; set; } = string.Empty; // \"text\" or \"template\"\n\n        [Required]\n        public string MessageTemplate { get; set; } = string.Empty;\n\n        public string? TemplateName { get; set; }\n\n        public List<string>? TemplateParams { get; set; }\n\n        public DateTime? ScheduledAt { get; set; } // Optional future scheduling\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/DTOs/Messages/CtaMessageDto.cs",
      "sha256": "80af1338096deb56a727a9ac543829c364442d6f67637455296e227a56abbd7b",
      "language": "csharp",
      "size": 1326,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.DTOs.Messages\n{\n    public class CtaMessageDto\n    {\n        // 🎯 Required Fields\n        public string RecipientPhone { get; set; } = string.Empty;\n        public string BodyText { get; set; } = string.Empty;\n        public List<string> Buttons { get; set; } = new();\n\n        // 🔗 Optional Source Info\n        public Guid? BusinessId { get; set; }          // Optional: Track for MessageLog\n        public Guid? CampaignId { get; set; }          // Optional: If triggered via Campaign\n        public string? SourceModule { get; set; }      // e.g., \"Catalog\", \"CRM\", \"Timeline\"\n\n        // 👤 Customer Context (Optional Enrichment)\n        public string? CustomerId { get; set; }\n        public string? CustomerName { get; set; }\n        public string? CustomerPhone { get; set; }\n\n        // 📦 Advanced (Optional but useful)\n        public string? BotId { get; set; }             // Bot which served this (optional)\n        public string? RefMessageId { get; set; }      // Link to previous message (thread)\n        public string? CTATriggeredFrom { get; set; }  // e.g., “Buy Now”, “Know More”\n\n        // ⏱️ Timestamps / Meta\n        public DateTime? ScheduledAt { get; set; }     // For future automation (optional)\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/DTOs/Messages/ImageMessageDto.cs",
      "sha256": "f5c8436e0d3055ef94a5fd88067f1497534a889f1296174babd92385a36494cf",
      "language": "csharp",
      "size": 340,
      "content": "using System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.DTOs.Messages\n{\n    public class ImageMessageDto : BaseMessageDto\n    {\n        [Required]\n        public override string MessageContent { get; set; } = string.Empty;\n\n        [Required]\n        [Url]\n        public string MediaUrl { get; set; } = string.Empty;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/DTOs/Messages/RawMessageWrapper.cs",
      "sha256": "d7ac355237d8f59f61eeeee123e9450f669ff9eb387359212b8c2c2456ac4353",
      "language": "csharp",
      "size": 220,
      "content": "// DTOs/Messages/RawMessageWrapper.cs\nusing Newtonsoft.Json.Linq;\n\npublic class RawMessageWrapper\n{\n    public string MessageType { get; set; } = string.Empty;\n    public JObject Payload { get; set; } = new JObject();\n}\n"
    },
    {
      "path": "xbytechat-api/DTOs/Messages/TemplateMessageDto.cs",
      "sha256": "06b028cea23f4720af49039d87a58cf7134087ad5744eae187c7900c0a2daa35",
      "language": "csharp",
      "size": 1033,
      "content": "using System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.DTOs.Messages\n{\n    /// <summary>\n    /// DTO for sending WhatsApp template-based messages.\n    /// </summary>\n    public class TemplateMessageDto : BaseMessageDto\n    {\n        [Required]\n        public string TemplateName { get; set; } = string.Empty;\n\n        [Required]\n        public string LanguageCode { get; set; } = \"en_US\";\n\n        public Dictionary<string, string> TemplateParameters { get; set; }\n\n        public List<ButtonPayloadDto>? ButtonParams { get; set; } // ✅ NEW\n\n        public override string MessageContent { get; set; } = \"[Template]\";\n    }\n\n    /// <summary>\n    /// DTO for each button in a WhatsApp template.\n    /// </summary>\n    public class ButtonPayloadDto\n    {\n        public string SubType { get; set; } = \"url\"; // or \"phone_number\"\n        public string Index { get; set; } = \"0\";      // 0-based index as string\n        public string Param { get; set; } = string.Empty; // dynamic value for URL or phone number\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/DTOs/Messages/TextMessageDto.cs",
      "sha256": "a899c48829d76e7fdf88be5bdafe15ab5307342c557b6431ba43c60f51a8ee11",
      "language": "csharp",
      "size": 244,
      "content": "using System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.DTOs.Messages\n{\n    public class TextMessageDto : BaseMessageDto\n    {\n        [Required]\n        public override string MessageContent { get; set; } = string.Empty;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccessControl/Attributes/HasPermissionAttribute.cs",
      "sha256": "4c0b87bd0b181823afbcc065a45376dc4c185ec94ae738d09d28afeee757d71d",
      "language": "csharp",
      "size": 3182,
      "content": "using Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Mvc.Filters;\nusing Microsoft.Extensions.DependencyInjection;\nusing System;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.AccessControl.Services;\n\nnamespace xbytechat.api.Features.AccessControl.Attributes\n{\n    public class HasPermissionAttribute : Attribute, IAsyncAuthorizationFilter\n    {\n        private readonly string _permissionCode;\n\n        public HasPermissionAttribute(string permissionCode) => _permissionCode = permissionCode;\n\n        public async Task OnAuthorizationAsync(AuthorizationFilterContext context)\n        {\n            var user = context.HttpContext.User;\n            var planIdClaim = user.FindFirst(\"plan_id\")?.Value;\n\n            if (string.IsNullOrWhiteSpace(planIdClaim) || !Guid.TryParse(planIdClaim, out var planId))\n            {\n                context.Result = new ForbidResult();\n                return;\n            }\n\n            var permissionService = context.HttpContext.RequestServices\n                .GetRequiredService<IPermissionCacheService>();\n\n            var permissions = await permissionService.GetPlanPermissionsAsync(planId);\n\n            var hasPermission = permissions.Any(p =>\n                string.Equals(p.Code, _permissionCode, StringComparison.OrdinalIgnoreCase));\n\n            if (!hasPermission)\n                context.Result = new ForbidResult();\n        }\n    }\n}\n\n\n//using Microsoft.AspNetCore.Mvc;\n//using Microsoft.AspNetCore.Mvc.Filters;\n//using Microsoft.Extensions.DependencyInjection;\n//using System;\n//using System.Linq;\n//using xbytechat.api.Features.AccessControl.Services;\n\n//namespace xbytechat.api.Features.AccessControl.Attributes\n//{\n//    public class HasPermissionAttribute : Attribute, IAuthorizationFilter\n//    {\n//        private readonly string _permissionCode;\n\n//        public HasPermissionAttribute(string permissionCode)\n//        {\n//            _permissionCode = permissionCode;\n//        }\n\n//        public void OnAuthorization(AuthorizationFilterContext context)\n//        {\n//            var user = context.HttpContext.User;\n//            var planIdClaim = user.FindFirst(\"plan_id\")?.Value;\n\n//            if (string.IsNullOrEmpty(planIdClaim))\n//            {\n//                context.Result = new ForbidResult();\n//                return;\n//            }\n\n//            if (!Guid.TryParse(planIdClaim, out var planId))\n//            {\n//                context.Result = new ForbidResult();\n//                return;\n//            }\n\n//            var permissionService = context.HttpContext.RequestServices\n//                .GetRequiredService<IPermissionCacheService>();\n\n//            // Get permissions for this plan from cache\n//            var permissions = permissionService.GetPlanPermissionsAsync(planId).Result;\n\n//            // Check if any permission matches the requested code\n//            bool hasPermission = permissions.Any(p =>\n//                string.Equals(p.Code, _permissionCode, StringComparison.OrdinalIgnoreCase));\n\n//            if (!hasPermission)\n//            {\n//                context.Result = new ForbidResult();\n//            }\n//        }\n//    }\n//}\n"
    },
    {
      "path": "xbytechat-api/Features/AccessControl/Controllers/PermissionController.cs",
      "sha256": "4e0bbb5ef2b9078ac41349c7c36d74c2d0e9211af908bc1adaef72f85e811e6d",
      "language": "csharp",
      "size": 917,
      "content": "using Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing System.Security;\nusing xbytechat.api.CRM.Services;\nusing xbytechat.api.Features.AccessControl.DTOs;\nusing xbytechat.api.Helpers;\n\nnamespace xbytechat.api.Features.AccessControl.Controllers\n{\n\n    [ApiController]\n    [Route(\"api/permission\")]\n    [Authorize]\n    public class PermissionController : Controller\n    {\n\n        private readonly IPermissionService _permissionService;\n        public PermissionController(IPermissionService permissionService)\n        {\n            _permissionService = permissionService;    \n        }\n        [HttpGet(\"Grouped\")]\n        public async Task<IActionResult> GetGroupedPermissions()\n        {\n            var grouped = await _permissionService.GetGroupedPermissionsAsync();\n            return Ok(ResponseResult.SuccessInfo(\"Permissions grouped by category\", grouped));\n        }\n\n       \n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccessControl/Controllers/PlanController.cs",
      "sha256": "baaf9607daf7830e55a133d85d70d8506feec7a2767c4fd77b5db42683e311ef",
      "language": "csharp",
      "size": 8063,
      "content": "using Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.Extensions.Logging;\nusing System;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.AccessControl.DTOs;\nusing xbytechat.api.Features.AccessControl.Services;\nusing xbytechat.api.Helpers; // ✅ For ResponseResult\n\nnamespace xbytechat.api.Features.AccessControl.Controllers\n{\n    [Route(\"api/[controller]\")]\n    [ApiController]\n    [Authorize]\n    public class PlanController : ControllerBase\n    {\n        private readonly IPlanService _planService;\n        private readonly IPermissionCacheService _permissionCacheService;\n        private readonly ILogger<PlanController> _logger;\n        public PlanController(IPlanService planService, IPermissionCacheService permissionCacheService, ILogger<PlanController> logger)\n        {\n            _planService = planService;\n            _permissionCacheService = permissionCacheService;\n            _logger = logger;\n        }\n\n        [HttpGet]\n        public async Task<IActionResult> GetPlans()\n        {\n            try\n            {\n                var plans = await _planService.GetAllPlansAsync();\n                return Ok(plans); // Return plain array\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"Failed to load plans\");\n                return BadRequest(new { message = \"Failed to load plans\", error = ex.Message });\n            }\n        }\n\n        [HttpGet(\"{planId}/permissions\")]\n        public async Task<IActionResult> GetPlanPermissions(Guid planId)\n        {\n            try\n            {\n               // var permissions = await _planService.GetPermissionsForPlanAsync(planId);\n                var permissions = await _permissionCacheService.GetPlanPermissionsAsync(planId);\n\n                return Ok(permissions);\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"Failed to load permissions for plan {PlanId}\", planId);\n                return BadRequest(new { message = \"Failed to load permissions\", error = ex.Message });\n            }\n        }\n\n        [HttpPost(\"{planId}/permissions\")]\n        [Authorize(Roles = \"superadmin,partneradmin\")]\n        public async Task<IActionResult> UpdatePlanPermissions(Guid planId, [FromBody] Guid[] permissionIds)\n        {\n            try\n            {\n                await _planService.UpdatePlanPermissionsAsync(planId, permissionIds.ToList());\n                // ✅ Clear cache after update\n                _permissionCacheService.ClearPlanPermissionsCache(planId);\n                return Ok(new { message = \"Permissions updated successfully\" });\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"Failed to update permissions for plan {PlanId}\", planId);\n                return BadRequest(new { message = \"Failed to update permissions\", error = ex.Message });\n            }\n        }\n\n        [HttpPost(\"Create\")]\n        [Authorize(Roles = \"superadmin,partneradmin,admin\")]\n        public async Task<IActionResult> CreatePlan([FromBody] CreatePlanDto dto)\n        {\n            if (string.IsNullOrWhiteSpace(dto.Code) || string.IsNullOrWhiteSpace(dto.Name))\n                return BadRequest(new { message = \"Code and Name are required\" });\n\n            try\n            {\n                var newPlanId = await _planService.CreatePlanAsync(dto);\n                return Ok(new { id = newPlanId, message = \"Plan created successfully\" });\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"Failed to create plan {PlanName}\", dto.Name);\n                return BadRequest(new { message = \"Failed to create plan\", error = ex.Message });\n            }\n        }\n\n        [HttpPut(\"{planId}\")]\n        [Authorize(Roles = \"superadmin,partneradmin,admin\")]\n        public async Task<IActionResult> UpdatePlan(Guid planId, [FromBody] UpdatePlanDto dto)\n        {\n            if (string.IsNullOrWhiteSpace(dto.Code) || string.IsNullOrWhiteSpace(dto.Name))\n                return BadRequest(new { message = \"Code and Name are required\" });\n\n            try\n            {\n                var updated = await _planService.UpdatePlanAsync(planId, dto);\n                if (!updated)\n                    return NotFound(new { message = \"Plan not found\" });\n\n                return Ok(new { message = \"Plan updated successfully\" });\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"Failed to update plan {PlanId}\", planId);\n                return BadRequest(new { message = \"Failed to update plan\", error = ex.Message });\n            }\n        }\n\n        [HttpDelete(\"{planId}\")]\n        [Authorize(Roles = \"superadmin,partneradmin\")]\n        public async Task<IActionResult> DeletePlan(Guid planId)\n        {\n            try\n            {\n                var deleted = await _planService.DeletePlanAsync(planId);\n                if (!deleted)\n                    return NotFound(new { message = \"Plan not found or already inactive\" });\n                // ✅ Clear cache when plan is deleted\n                _permissionCacheService.ClearPlanPermissionsCache(planId);\n                return Ok(new { message = \"Plan deleted successfully\" });\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"Failed to delete plan {PlanId}\", planId);\n                return BadRequest(new { message = \"Failed to delete plan\", error = ex.Message });\n            }\n        }\n        //[HttpGet(\"me/permissions\")]\n        //public async Task<IActionResult> GetMyPlanPermissions(CancellationToken ct)\n        //{\n        //    var role = User.FindFirst(\"role\")?.Value ?? string.Empty;\n\n        //    // Optional admin bypass\n        //    if (role is \"superadmin\" or \"admin\" or \"partner\" or \"reseller\")\n        //        return Ok(new { planId = (Guid?)null, permissions = new[] { \"*\" } });\n\n        //    var planIdStr = User.FindFirst(\"plan_id\")?.Value;\n        //    if (!Guid.TryParse(planIdStr, out var planId))\n        //        return Ok(new { planId = (Guid?)null, permissions = Array.Empty<string>() });\n\n        //    var permissionEntities = await _permissionCacheService.GetPlanPermissionsAsync(planId);\n        //    var codes = permissionEntities\n        //        .Where(p => p.IsActive)\n        //        .Select(p => p.Code)\n        //        .Distinct()\n        //        .ToList();\n\n        //    return Ok(new { planId, permissions = codes });\n        //}\n        [HttpGet(\"me/permissions\")]\n        public async Task<IActionResult> GetMyPlanPermissions(CancellationToken ct)\n        {\n            var role = User.FindFirst(\"role\")?.Value ?? string.Empty;\n\n            // Admin-like roles don't need a plan\n            if (role is \"superadmin\" or \"admin\" or \"partner\" or \"reseller\")\n                return Ok(new\n                {\n                    planId = (Guid?)null,\n                    plan = (PlanDto?)null,\n                    permissions = new[] { \"*\" }\n                });\n\n            var planIdStr = User.FindFirst(\"plan_id\")?.Value;\n            if (!Guid.TryParse(planIdStr, out var planId))\n                return Ok(new\n                {\n                    planId = (Guid?)null,\n                    plan = (PlanDto?)null,\n                    permissions = Array.Empty<string>()\n                });\n\n            // permissions (cached)\n            var permissionEntities = await _permissionCacheService.GetPlanPermissionsAsync(planId);\n            var codes = permissionEntities\n                .Where(p => p.IsActive)\n                .Select(p => p.Code)\n                .Distinct()\n                .ToList();\n\n            // ✅ Fetch the plan once and return it as PlanDto\n            var planDto = await _planService.GetByIdAsync(planId, ct);\n\n            return Ok(new\n            {\n                planId,\n                plan = planDto,     // PlanDto or null\n                permissions = codes\n            });\n        }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccessControl/DTOs/CreatePlanDto.cs",
      "sha256": "15d5b4b092dc0019db6a3e33fc6ea49a5bd2e02c9c4fabde02403dc9c32feb90",
      "language": "csharp",
      "size": 320,
      "content": "using System;\n\nnamespace xbytechat.api.Features.AccessControl.DTOs\n{\n    public class CreatePlanDto\n    {\n        public string Code { get; set; } // e.g. \"FREE\", \"SMART\"\n        public string Name { get; set; }\n        public string? Description { get; set; }\n        public bool IsActive { get; set; } = true;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccessControl/DTOs/GroupedPermissionDto.cs",
      "sha256": "d31e43145b8ed5908bd705af1dc96740d163615a183c30dc69b6d72097d37a76",
      "language": "csharp",
      "size": 255,
      "content": "using xbytechat.api.Features.AccessControl.Models;\n\nnamespace xbytechat.api.Features.AccessControl.DTOs\n{\n    public class GroupedPermissionDto\n    {\n        public string Group { get; set; }\n        public List<Permission> Features { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccessControl/DTOs/PermissionDto.cs",
      "sha256": "46bfdeaa2a7dfa7bdaa56ed6c991868bae5fcc8ffb88cff1cc82d329e51eb92f",
      "language": "csharp",
      "size": 353,
      "content": "namespace xbytechat.api.Features.AccessControl.DTOs\n{\n    public class PermissionDto\n    {\n        public Guid Id { get; set; }\n        public string Code { get; set; }\n        public string Name { get; set; }\n        public string? Group { get; set; }\n        public string? Description { get; set; }\n        public bool IsActive { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccessControl/DTOs/PlanDto.cs",
      "sha256": "87bcc89fbc963d131fcc246a1bde5d2d1a9198a61fac73a55b6b985644c8ee89",
      "language": "csharp",
      "size": 303,
      "content": "namespace xbytechat.api.Features.AccessControl.DTOs\n{\n    public class PlanDto\n    {\n        public Guid Id { get; set; }\n        public string Code { get; set; }\n        public string Name { get; set; }\n        public string Description { get; set; }\n        public bool IsActive { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccessControl/DTOs/RoleDto.cs",
      "sha256": "890bec8d90e7068a2c8e49c4249b761506cdb9c26b2fd5a470bf14c6013954cf",
      "language": "csharp",
      "size": 479,
      "content": "namespace xbytechat.api.Features.AccessControl.DTOs;\n\n// DTO: Role details used across layers\npublic class RoleDto\n{\n    /// <summary>Unique identifier of the role.</summary>\n    public Guid Id { get; set; }\n\n   \n    public string Role { get; set; } = default!;\n\n   \n    public string Code { get; set; } = default!;\n\n   \n    public string? Description { get; set; }\n\n    \n    public bool IsActive { get; set; }\n\n       public RoleDto() { }\n\n    // Convenience constructor\n    \n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccessControl/DTOs/UpdatePlanDto.cs",
      "sha256": "e4a09d8fd1c1ff0cb720be4ff2ba80df60e06fc54795e1e2a23fd06b16bf8956",
      "language": "csharp",
      "size": 273,
      "content": "namespace xbytechat.api.Features.AccessControl.DTOs\n{\n    public class UpdatePlanDto\n    {\n        public string Name { get; set; }\n        public string Code { get; set; }\n        public string Description { get; set; }\n        public bool IsActive { get; set; }\n    }\n\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccessControl/DTOs/UpdatePlanPermissionsRequest.cs",
      "sha256": "b62abd8813b7a4d3812bc8260d06a3770d0a34c9141d845d60ff86cf904a3378",
      "language": "csharp",
      "size": 168,
      "content": "namespace xbytechat.api.Features.AccessControl.DTOs\n{\n    public class UpdatePlanPermissionsRequest\n    {\n        public List<Guid> PermissionIds { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccessControl/DTOs/UpdateRolePermissionsDto.cs",
      "sha256": "e00530db11a422793d96b8905211218a03a8e810c601034c76b75fbba37d40db",
      "language": "csharp",
      "size": 291,
      "content": "using System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.Features.AccessControl.DTOs\n{\n    public class UpdateRolePermissionsDto\n    {\n        [Required]\n        public List<Guid> PermissionIds { get; set; } = new();\n        public bool ReplaceAll { get; set; } = true;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccessControl/Models/Permission.cs",
      "sha256": "22c58f1f832014c6129b075f027045a186874bc7c20d0f312befe1d658bb0ab4",
      "language": "csharp",
      "size": 832,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.Features.AccessControl.Models\n{\n    public class Permission\n    {\n        public Guid Id { get; set; }\n\n        public string Code { get; set; } // Unique key like \"ViewDashboard\"\n\n        public string Name { get; set; } // Friendly name like \"View Dashboard\"\n\n        public string? Group { get; set; } // Optional grouping, e.g., \"CRM\", \"Catalog\", \"Admin\"\n\n        public string? Description { get; set; }\n\n        public bool IsActive { get; set; } = true;\n\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n\n        public ICollection<RolePermission> RolePermissions { get; set; }\n\n        public ICollection<UserPermission> UserPermissions { get; set; }\n\n        public ICollection<PlanPermission> PlanPermissions { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccessControl/Models/Plan.cs",
      "sha256": "1682d96ed57c73cf2dce0b4b7194becc04837f998e9f0718b14e8a2b5ff8c5a6",
      "language": "csharp",
      "size": 704,
      "content": "using System;\nusing System.Collections.Generic;\nusing xbytechat.api.Features.BusinessModule.Models;\n\nnamespace xbytechat.api.Features.AccessControl.Models\n{\n    public class Plan\n    {\n        public Guid Id { get; set; }\n\n        public string Code { get; set; } // e.g. \"FREE\", \"SMART\", \"ADVANCED\"\n        public string Name { get; set; } // Friendly display name\n\n        public string? Description { get; set; }\n\n        public bool IsActive { get; set; } = true;\n\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n\n        public ICollection<PlanPermission> PlanPermissions { get; set; }\n        public ICollection<Business> Businesses { get; set; } = new List<Business>();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccessControl/Models/PlanPermission.cs",
      "sha256": "e6e65f0ae33c19e9d2585d73812bcf99ed207d52ac6d804a3c2bf86b3152eca7",
      "language": "csharp",
      "size": 525,
      "content": "using System;\n\nnamespace xbytechat.api.Features.AccessControl.Models\n{\n    public class PlanPermission\n    {\n        public Guid Id { get; set; }\n\n        public Guid PlanId { get; set; }\n        public Plan Plan { get; set; }\n\n        public Guid PermissionId { get; set; }\n        public Permission Permission { get; set; }\n\n        public bool IsActive { get; set; } = true;\n\n        public DateTime AssignedAt { get; set; } = DateTime.UtcNow;\n        public string? AssignedBy { get; set; } // Admin email or ID\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/AccessControl/Models/Role.cs",
      "sha256": "4c2e237e65d702febee355976cfc64209fd4cf2d98f87e7ef6de4b199dd048a4",
      "language": "csharp",
      "size": 760,
      "content": "using System;\nusing System.Collections.Generic;\nusing xbytechat.api.AuthModule.Models;\n\nnamespace xbytechat.api.Features.AccessControl.Models\n{\n    public class Role\n    {\n        public Guid Id { get; set; }\n\n        public string Name { get; set; } // e.g. SuperAdmin, PartnerAdmin, BusinessAdmin, Staff, etc.\n\n        public string? Description { get; set; }\n\n        public bool IsSystemDefined { get; set; } = false; // true for SuperAdmin, PartnerAdmin\n\n        public bool IsActive { get; set; } = true;\n\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n\n        public ICollection<RolePermission> RolePermissions { get; set; }\n        public ICollection<User> Users { get; set; } // 🧩 One-to-many relation: Role → Users\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccessControl/Models/RolePermission.cs",
      "sha256": "d9b31669bec3fbda1b95c89def9a6cc641e0dd21f5e38583b8dae4c0239b9a8a",
      "language": "csharp",
      "size": 619,
      "content": "using System;\n\nnamespace xbytechat.api.Features.AccessControl.Models\n{\n    public class RolePermission\n    {\n        public Guid Id { get; set; }\n\n        public Guid RoleId { get; set; }\n        public Role Role { get; set; }\n\n        public Guid PermissionId { get; set; }\n        public Permission Permission { get; set; }\n\n        public DateTime AssignedAt { get; set; } = DateTime.UtcNow;\n        public string? AssignedBy { get; set; } // Admin user email or ID\n\n        public bool IsActive { get; set; } = true; // ✅ Add this line\n        public bool IsRevoked { get; set; } = false; // ✅ Required\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccessControl/Models/UserPermission.cs",
      "sha256": "6b85321ec68fced21477222e85ac56594106c4654b5d99061c42bc1c46d876aa",
      "language": "csharp",
      "size": 677,
      "content": "using System;\nusing xbytechat.api.AuthModule.Models;\n\nnamespace xbytechat.api.Features.AccessControl.Models\n{\n    public class UserPermission\n    {\n        public Guid Id { get; set; }\n\n        public Guid UserId { get; set; }\n        public User User { get; set; }\n\n        public Guid PermissionId { get; set; }\n        public Permission Permission { get; set; }\n\n        public bool IsGranted { get; set; } = true; // ✅ true = allow, false = explicitly deny\n\n        public DateTime AssignedAt { get; set; } = DateTime.UtcNow;\n        public string? AssignedBy { get; set; } // Admin or system\n\n        public bool IsRevoked { get; set; } = false; // ✅ Required\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccessControl/Seeder/PermissionConstants.cs",
      "sha256": "47104d91bf08a96917121e247b83aac03fe402f24bb851d3fa4b1b9ee5375469",
      "language": "csharp",
      "size": 1126,
      "content": "namespace xbytechat.api.Features.AccessControl.Seeder\n{\n    public static class PermissionConstants\n    {\n        public static class Dashboard\n        {\n            public const string View = \"dashboard.view\";\n        }\n\n        public static class Campaigns\n        {\n            public const string View = \"campaign.view\";\n            public const string Create = \"campaign.create\";\n            public const string Delete = \"campaign.delete\";\n        }\n\n        public static class Products\n        {\n            public const string View = \"product.view\";\n            public const string Create = \"product.create\";\n            public const string Delete = \"product.delete\";\n        }\n\n        public static class CRM\n        {\n            public const string ContactsView = \"contacts.view\";\n            public const string TagsEdit = \"tags.edit\";\n        }\n\n        public static class Admin\n        {\n            public const string BusinessApprove = \"admin.business.approve\";\n            public const string ViewLogs = \"admin.logs.view\";\n        }\n\n        // 🆕 Add more modules and permissions here as needed\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccessControl/Seeder/RolePermissionMapping.cs",
      "sha256": "47f001a1b2d6404c28e73be68faf79485c10c1c0a7dab0a5346cc06fff4f049a",
      "language": "csharp",
      "size": 1302,
      "content": "namespace xbytechat.api.Features.AccessControl.Seeder\n{\n    public static class RolePermissionMapping\n    {\n        public static readonly Dictionary<string, List<string>> RolePermissions = new()\n        {\n            [\"admin\"] = new()\n            {\n                PermissionConstants.Dashboard.View,\n                PermissionConstants.Campaigns.View,\n                PermissionConstants.Campaigns.Create,\n                PermissionConstants.Campaigns.Delete,\n                PermissionConstants.Products.View,\n                PermissionConstants.Products.Create,\n                PermissionConstants.Products.Delete,\n                PermissionConstants.CRM.ContactsView,\n                PermissionConstants.CRM.TagsEdit,\n                PermissionConstants.Admin.BusinessApprove,\n                PermissionConstants.Admin.ViewLogs\n            },\n\n            [\"business\"] = new()\n            {\n                PermissionConstants.Dashboard.View,\n                PermissionConstants.Campaigns.View,\n                PermissionConstants.CRM.ContactsView,\n                PermissionConstants.Products.View\n            },\n\n            [\"staff\"] = new()\n            {\n                PermissionConstants.Dashboard.View,\n                PermissionConstants.CRM.ContactsView\n            }\n        };\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccessControl/Services/AccessControlService.cs",
      "sha256": "7715aa1fb932cf63407c3a5e5502b6c3f751e331055be04257cfd120a8671fcb",
      "language": "csharp",
      "size": 7685,
      "content": "//using Microsoft.EntityFrameworkCore;\n//using System.Collections.Generic;\n//using System.Security.Claims;\n//using System.Threading.Tasks;\n\n//using xbytechat.api.Features.AccessControl.Models;\n\n//namespace xbytechat.api.Features.AccessControl.Services\n//{\n//    public class AccessControlService : IAccessControlService\n//    {\n//        private readonly AppDbContext _context;\n\n//        public AccessControlService(AppDbContext context)\n//        {\n//            _context = context;\n//        }\n\n//        public async Task<IEnumerable<Permission>> GetAllPermissionsAsync()\n//        {\n//            return await _context.Permissions\n//                .AsNoTracking()\n//                .Where(p => p.IsActive)\n//                .ToListAsync();\n//        }\n//        //public async Task<IEnumerable<Permission>> GetPermissionsAsync(Guid userId)\n//        //{\n//        //    // First, check if the user has direct permissions\n//        //    var userPermissions = await _context.UserPermissions\n//        //        .Where(up => up.UserId == userId && up.IsGranted && !up.IsRevoked)\n//        //        .Select(up => up.Permission)\n//        //        .Where(p => p.IsActive)\n//        //        .ToListAsync();\n\n//        //    // If no direct permissions, fall back to role permissions\n//        //    if (!userPermissions.Any())\n//        //    {\n//        //        userPermissions = await _context.RolePermissions\n//        //            .Where(rp => rp.Role.Users.Any(u => u.Id == userId) && rp.IsActive && !rp.IsRevoked)\n//        //            .Select(rp => rp.Permission)\n//        //            .Where(p => p.IsActive)\n//        //            .ToListAsync();\n//        //    }\n\n//        //    return userPermissions;\n//        //}\n       \n        \n       \n//    }\n//}\n\n\nusing System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Security.Claims;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.Features.AccessControl.Models;\nusing xbytechat.api.Repositories.Interfaces;\nusing System.Linq.Expressions;\n\n\nnamespace xbytechat.api.Features.AccessControl.Services\n{\n    public class AccessControlService : IAccessControlService\n    {\n        private readonly IGenericRepository<User> _userRepo;\n        private readonly IGenericRepository<RolePermission> _rolePermissionRepo;\n        private readonly IGenericRepository<UserPermission> _userPermissionRepo;\n        private readonly IGenericRepository<Permission> _permissionRepo;\n        private readonly AppDbContext _context;\n        public AccessControlService(\n            IGenericRepository<User> userRepo,\n            IGenericRepository<RolePermission> rolePermissionRepo,\n            IGenericRepository<UserPermission> userPermissionRepo,\n            IGenericRepository<Permission> permissionRepo, AppDbContext context\n        )\n        {\n            _userRepo = userRepo;\n            _rolePermissionRepo = rolePermissionRepo;\n            _userPermissionRepo = userPermissionRepo;\n            _permissionRepo = permissionRepo;\n            _context = context;\n        }\n\n        /// <summary>\n        /// ✅ Fetch all permissions (Role-based + User-specific) for a given user\n        /// </summary>\n        //public async Task<List<string>> GetPermissionsAsync(Guid userId)\n        //{\n        //    var user = await _userRepo.FindByIdAsync(userId);\n        //    if (user == null || user.RoleId == null)\n        //        return new List<string>();\n\n        //    // 🔐 Get Role-based permissions\n        //    var rolePerms = await _rolePermissionRepo\n        //        .WhereAsync(rp => rp.RoleId == user.RoleId && !rp.IsRevoked);\n\n        //    // 🔐 Get User-specific extra permissions\n        //    var userPerms = await _userPermissionRepo\n        //        .WhereAsync(up => up.UserId == userId && !up.IsRevoked);\n\n        //    // 🧠 Merge permission IDs\n        //    var permissionIds = rolePerms.Select(r => r.PermissionId)\n        //        .Union(userPerms.Select(u => u.PermissionId))\n        //        .Distinct()\n        //        .ToList();\n\n        //    // 🎯 Get full permission names from Permission table\n        //    var allPerms = await _permissionRepo\n        //        .WhereAsync(p => permissionIds.Contains(p.Id));\n\n        //    return allPerms.Select(p => p.Code).Distinct().ToList(); // Use Code (standard)\n        //}\n\n        public async Task<IEnumerable<Permission>> GetAllPermissionsAsync()\n        {\n            return await _permissionRepo.WhereAsync(p => p.IsActive);\n        }\n\n\n        public async Task<List<string>> GetPermissionsAsync(Guid userId)\n        {\n            var user = await _userRepo.FindByIdAsync(userId);\n\n            if (user == null || user.RoleId == null)\n                return new List<string>();\n\n            // 🚀 Bypass: SuperAdmin always gets full access\n            if (user.Role != null && user.Role.Name.Equals(\"superadmin\", StringComparison.OrdinalIgnoreCase))\n            {\n                var allPerms = await _permissionRepo.GetAllAsync();\n                return allPerms.Select(p => p.Code).Distinct().ToList();\n            }\n\n            // 🔐 Get Role-based permissions\n            var rolePerms = await _rolePermissionRepo\n                .WhereAsync(rp => rp.RoleId == user.RoleId && !rp.IsRevoked);\n\n            // 🔐 Get User-specific extra permissions\n            var userPerms = await _userPermissionRepo\n                .WhereAsync(up => up.UserId == userId && !up.IsRevoked);\n\n            // 🧠 Merge permission IDs\n            var permissionIds = rolePerms.Select(r => r.PermissionId)\n                .Union(userPerms.Select(u => u.PermissionId))\n                .Distinct()\n                .ToList();\n\n            // 🎯 Get full permission names from Permission table\n            var allAllowedPerms = await _permissionRepo\n                .WhereAsync(p => permissionIds.Contains(p.Id));\n\n            return allAllowedPerms.Select(p => p.Code).Distinct().ToList();\n        }\n\n        public bool HasPermission(ClaimsPrincipal user, string requiredPermission)\n        {\n            // 🚀 Bypass: SuperAdmin always passes\n            //var roleClaim = user.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Role)?.Value;\n            var roleClaim = user.Claims.FirstOrDefault(c =>\n                c.Type == ClaimTypes.Role || c.Type.Equals(\"role\", StringComparison.OrdinalIgnoreCase)\n            )?.Value;\n\n            if (!string.IsNullOrEmpty(roleClaim) && roleClaim.Equals(\"superadmin\", StringComparison.OrdinalIgnoreCase))\n                return true;\n\n            var perms = user.Claims\n                .Where(c => c.Type == \"permissions\")\n                .Select(c => c.Value)\n                .ToList();\n\n            return perms.Contains(requiredPermission);\n        }\n\n        /// <summary>\n        /// ✅ Runtime permission checker (for controller/middleware)\n        /// </summary>\n        //public bool HasPermission(ClaimsPrincipal user, string requiredPermission)\n        //{\n        //    var perms = user.Claims\n        //        .Where(c => c.Type == \"permissions\")\n        //        .Select(c => c.Value)\n        //        .ToList();\n\n        //    return perms.Contains(requiredPermission);\n        //}\n\n        public async Task<List<string>> GetPermissionsByPlanIdAsync(Guid? planId)\n        {\n            if (!planId.HasValue)\n                return new List<string>();\n\n            return await _context.PlanPermissions\n                .Where(pp => pp.PlanId == planId.Value && pp.IsActive)\n                .Select(pp => pp.Permission.Code)\n                .ToListAsync();\n        }\n\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccessControl/Services/IAccessControlService.cs",
      "sha256": "a7175ca2ec5d8ac4aae9b09095d675ab36d2c52dd6a62b3d23c6b6990de055e2",
      "language": "csharp",
      "size": 853,
      "content": "//using System.Collections.Generic;\n//using System.Threading.Tasks;\n//using xbytechat.api.Features.AccessControl.Models;\n\n//namespace xbytechat.api.Features.AccessControl.Services\n//{\n//    public interface IAccessControlService\n//    {\n//        Task<IEnumerable<Permission>> GetAllPermissionsAsync();\n//        Task<IEnumerable<Permission>> GetPermissionsAsync(Guid userId);\n\n//    }\n//}\n\n\nusing System.Security.Claims;\nusing xbytechat.api.Features.AccessControl.Models;\n\nnamespace xbytechat.api.Features.AccessControl.Services\n{\n    public interface IAccessControlService\n    {\n        Task<List<string>> GetPermissionsAsync(Guid userId);\n        bool HasPermission(ClaimsPrincipal user, string permission);\n        Task<IEnumerable<Permission>> GetAllPermissionsAsync();\n        Task<List<string>> GetPermissionsByPlanIdAsync(Guid? planId);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccessControl/Services/IPlanService.cs",
      "sha256": "7e943cbf0f9f97ecaac03b05ae94b28c8cf649813e1c6d4dd1e7246b3bdc0cf1",
      "language": "csharp",
      "size": 952,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.AccessControl.DTOs;\nusing xbytechat.api.Features.AccessControl.Models;\n\nnamespace xbytechat.api.Features.AccessControl.Services\n{\n    public interface IPlanService\n    {\n        Task<IEnumerable<PlanDto>> GetAllPlansAsync();\n        Task<IEnumerable<PermissionDto>> GetPermissionsForPlanAsync(Guid planId);\n       // Task UpdatePlanPermissionsAsync(Guid planId, List<Guid> permissionIds);\n        Task<Guid> CreatePlanAsync(CreatePlanDto dto);\n        Task<bool> DeletePlanAsync(Guid planId);\n        Task<bool> UpdatePlanAsync(Guid planId, UpdatePlanDto dto);\n\n        // New methods for permissions\n        Task<List<PermissionDto>> GetPlanPermissionsAsync(Guid planId);\n        Task UpdatePlanPermissionsAsync(Guid planId, List<Guid> permissionIds);\n\n        Task<PlanDto?> GetByIdAsync(Guid planId, CancellationToken ct = default);\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/AccessControl/Services/PermissionCacheService.cs",
      "sha256": "c268071425295dc74c3f7323b4ebcbc3f413d9eaea473b6b55ada75cc0117ea9",
      "language": "csharp",
      "size": 1696,
      "content": "using Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Caching.Memory;\nusing System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.AccessControl.Models;\n\nnamespace xbytechat.api.Features.AccessControl.Services\n{\n    public interface IPermissionCacheService\n    {\n        Task<List<Permission>> GetPlanPermissionsAsync(Guid planId);\n        void ClearPlanPermissionsCache(Guid planId);\n    }\n\n    public class PermissionCacheService : IPermissionCacheService\n    {\n        private readonly AppDbContext _context;\n        private readonly IMemoryCache _cache;\n        private const string CacheKeyPrefix = \"plan_permissions_\";\n\n        public PermissionCacheService(AppDbContext context, IMemoryCache cache)\n        {\n            _context = context;\n            _cache = cache;\n        }\n\n        public async Task<List<Permission>> GetPlanPermissionsAsync(Guid planId)\n        {\n            var cacheKey = $\"{CacheKeyPrefix}{planId}\";\n\n            // Try to get from cache\n            if (_cache.TryGetValue(cacheKey, out List<Permission> cachedPermissions))\n                return cachedPermissions;\n\n            // Fetch from DB\n            var permissions = await _context.PlanPermissions\n                .Where(pp => pp.PlanId == planId && pp.IsActive)\n                .Select(pp => pp.Permission)\n                .ToListAsync();\n\n            // Store in cache\n            _cache.Set(cacheKey, permissions, TimeSpan.FromHours(1));\n\n            return permissions;\n        }\n\n        public void ClearPlanPermissionsCache(Guid planId)\n        {\n            _cache.Remove($\"{CacheKeyPrefix}{planId}\");\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccessControl/Services/PlanService.cs",
      "sha256": "1b989e01aca4efc37b99ca089369e468ba7ba452768d72b3b85ea7bae8769f9b",
      "language": "csharp",
      "size": 9530,
      "content": "using Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\nusing System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.AccessControl.DTOs;\nusing xbytechat.api.Features.AccessControl.Models;\n\nnamespace xbytechat.api.Features.AccessControl.Services\n{\n    public class PlanService : IPlanService\n    {\n        private readonly AppDbContext _context;\n        private readonly ILogger<PlanService> _logger;\n        private readonly IPermissionCacheService _permissionCacheService;\n\n        public PlanService(AppDbContext context, ILogger<PlanService> logger, IPermissionCacheService permissionCacheService)\n        {\n            _context = context;\n            _logger = logger;\n            _permissionCacheService = permissionCacheService;\n        }\n\n        //public async Task<IEnumerable<Plan>> GetAllPlansAsync()\n        //{\n        //    _logger.LogInformation(\"Fetching all active plans...\");\n        //    try\n        //    {\n        //        return await _context.Plans\n        //            .AsNoTracking()\n        //            .Include(p => p.PlanPermissions)\n        //            .Where(p => p.IsActive)\n        //            .ToListAsync();\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        _logger.LogError(ex, \"Error fetching plans.\");\n        //        throw;\n        //    }\n        //}\n        public async Task<IEnumerable<PlanDto>> GetAllPlansAsync()\n        {\n            return await _context.Plans\n                .Where(p => p.IsActive)\n                .Select(p => new PlanDto\n                {\n                    Id = p.Id,\n                    Code = p.Code,\n                    Name = p.Name,\n                    Description = p.Description,\n                    IsActive = p.IsActive\n                })\n                .ToListAsync();\n        }\n        public async Task<IEnumerable<PermissionDto>> GetPermissionsForPlanAsync(Guid planId)\n        {\n            return await _context.PlanPermissions\n                .Where(pp => pp.PlanId == planId && pp.IsActive)\n                .Select(pp => new PermissionDto\n                {\n                    Id = pp.Permission.Id,\n                    Code = pp.Permission.Code,\n                    Name = pp.Permission.Name,\n                    Group = pp.Permission.Group,\n                    Description = pp.Permission.Description,\n                    IsActive = pp.Permission.IsActive\n                })\n                .ToListAsync();\n        }\n        public async Task<PlanDto?> GetByIdAsync(Guid planId, CancellationToken ct = default)\n        {\n            return await _context.Plans\n                .AsNoTracking()\n                .Where(p => p.Id == planId)\n                .Select(p => new PlanDto\n                {\n                    Id = p.Id,\n                    Code = p.Code,\n                    Name = p.Name,\n                    Description = p.Description,\n                    IsActive = p.IsActive\n                })\n                .FirstOrDefaultAsync(ct);\n        }\n\n        //public async Task<IEnumerable<Permission>> GetPermissionsForPlanAsync(Guid planId)\n        //{\n        //    _logger.LogInformation(\"Fetching permissions for plan {PlanId}\", planId);\n        //    try\n        //    {\n        //        return await _context.PlanPermissions\n        //            .Where(pp => pp.PlanId == planId && pp.IsActive)\n        //            .Include(pp => pp.Permission)\n        //            .Select(pp => pp.Permission)\n        //            .AsNoTracking()\n        //            .ToListAsync();\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        _logger.LogError(ex, \"Error fetching permissions for plan {PlanId}\", planId);\n        //        throw;\n        //    }\n        //}\n\n        //public async Task UpdatePlanPermissionsAsync(Guid planId, List<Guid> permissionIds)\n        //{\n        //    _logger.LogInformation(\"Updating permissions for plan {PlanId}\", planId);\n        //    try\n        //    {\n        //        // Remove all existing permissions for the plan\n        //        var existing = await _context.PlanPermissions\n        //            .Where(pp => pp.PlanId == planId)\n        //            .ToListAsync();\n\n        //        _context.PlanPermissions.RemoveRange(existing);\n\n        //        // Add new permissions\n        //        var newPlanPermissions = permissionIds.Select(pid => new PlanPermission\n        //        {\n        //            Id = Guid.NewGuid(),\n        //            PlanId = planId,\n        //            PermissionId = pid,\n        //            IsActive = true,\n        //            AssignedAt = DateTime.UtcNow,\n        //            AssignedBy = \"System\"\n        //        });\n\n        //        await _context.PlanPermissions.AddRangeAsync(newPlanPermissions);\n        //        await _context.SaveChangesAsync();\n        //        _logger.LogInformation(\"Permissions updated for plan {PlanId}\", planId);\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        _logger.LogError(ex, \"Error updating permissions for plan {PlanId}\", planId);\n        //        throw;\n        //    }\n        //}\n\n        public async Task<Guid> CreatePlanAsync(CreatePlanDto dto)\n        {\n            _logger.LogInformation(\"Creating new plan: {PlanName}\", dto.Name);\n            try\n            {\n                var plan = new Plan\n                {\n                    Id = Guid.NewGuid(),\n                    Code = dto.Code,\n                    Name = dto.Name,\n                    Description = dto.Description,\n                    IsActive = dto.IsActive\n                };\n\n                _context.Plans.Add(plan);\n                await _context.SaveChangesAsync();\n\n                _logger.LogInformation(\"Plan created with ID: {PlanId}\", plan.Id);\n                return plan.Id;\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"Error creating plan {PlanName}\", dto.Name);\n                throw;\n            }\n        }\n\n        public async Task<bool> DeletePlanAsync(Guid planId)\n        {\n            _logger.LogInformation(\"Deleting (soft) plan {PlanId}\", planId);\n            try\n            {\n                var plan = await _context.Plans.FirstOrDefaultAsync(p => p.Id == planId);\n                if (plan == null || !plan.IsActive)\n                {\n                    _logger.LogWarning(\"Plan not found or already inactive: {PlanId}\", planId);\n                    return false;\n                }\n\n                plan.IsActive = false;\n                _context.Plans.Update(plan);\n                await _context.SaveChangesAsync();\n\n                _logger.LogInformation(\"Plan {PlanId} soft deleted.\", planId);\n                return true;\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"Error deleting plan {PlanId}\", planId);\n                throw;\n            }\n        }\n\n        public async Task<bool> UpdatePlanAsync(Guid planId, UpdatePlanDto dto)\n        {\n            _logger.LogInformation(\"Updating plan {PlanId}\", planId);\n            try\n            {\n                var plan = await _context.Plans.FirstOrDefaultAsync(p => p.Id == planId);\n                if (plan == null)\n                {\n                    _logger.LogWarning(\"Plan not found: {PlanId}\", planId);\n                    return false;\n                }\n\n                plan.Code = dto.Code;\n                plan.Name = dto.Name;\n                plan.Description = dto.Description;\n                plan.IsActive = dto.IsActive;\n\n                _context.Plans.Update(plan);\n                await _context.SaveChangesAsync();\n\n                _logger.LogInformation(\"Plan {PlanId} updated successfully.\", planId);\n                return true;\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"Error updating plan {PlanId}\", planId);\n                throw;\n            }\n        }\n\n        public async Task UpdatePlanPermissionsAsync(Guid planId, List<Guid> permissionIds)\n        {\n            // Remove old mappings\n            var existing = await _context.PlanPermissions\n                .Where(pp => pp.PlanId == planId)\n                .ToListAsync();\n            _context.PlanPermissions.RemoveRange(existing);\n\n            // Add new mappings\n            var newMappings = permissionIds.Select(pid => new PlanPermission\n            {\n                PlanId = planId,\n                PermissionId = pid,\n                AssignedAt = DateTime.UtcNow,\n                AssignedBy = \"system\" // replace with logged-in admin\n            });\n\n            await _context.PlanPermissions.AddRangeAsync(newMappings);\n            await _context.SaveChangesAsync();\n            //// Clear cache\n            _permissionCacheService.ClearPlanPermissionsCache(planId);\n        }\n        public async Task<List<PermissionDto>> GetPlanPermissionsAsync(Guid planId)\n        {\n            return await _context.PlanPermissions\n                .Where(pp => pp.PlanId == planId && pp.IsActive)\n                .Select(pp => new PermissionDto\n                {\n                    Id = pp.Permission.Id,\n                    Code = pp.Permission.Code,\n                    Name = pp.Permission.Name,\n                    Group = pp.Permission.Group,\n                    Description = pp.Permission.Description\n                })\n                .ToListAsync();\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AuditTrail/DTOs/CreateAuditLogDto.cs",
      "sha256": "845322cca23fe6666ea3c5947bf45d55d34363c27d5bacec30375a04b24a73ef",
      "language": "csharp",
      "size": 471,
      "content": "namespace xbytechat.api.Features.AuditTrail.DTOs;\n\npublic class CreateAuditLogDto\n{\n    public string ActionType { get; set; }\n    public string Module { get; set; }\n    public string? RecordId { get; set; }\n\n    public string? OldValues { get; set; }\n    public string? NewValues { get; set; }\n    public string? Description { get; set; }\n\n    public string? IPAddress { get; set; }\n    public string? UserAgent { get; set; }\n    public string? Location { get; set; }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AuditTrail/Models/AuditLog.cs",
      "sha256": "91e4760f6e10564db50d99acec9f1c83de5fd0b8ca2e0d3bc5874d645ac93a45",
      "language": "csharp",
      "size": 1034,
      "content": "using System;\n\nnamespace xbytechat.api.Features.AuditTrail.Models\n{\n    public class AuditLog\n    {\n        public Guid Id { get; set; } = Guid.NewGuid();\n\n        // 📍 Business Context (Multi-Tenant)\n        public Guid BusinessId { get; set; }\n\n        // 🙋 Who performed the action\n        public Guid PerformedByUserId { get; set; }\n        public string? PerformedByUserName { get; set; } // Optional for display\n        public string? RoleAtTime { get; set; } // admin / business / agent\n\n        // 🔍 Action Details\n        public string ActionType { get; set; } = \"\"; // e.g., campaign.created, user.login\n        public string? Description { get; set; } // Free text for summary or custom note\n\n        // 🌐 Optional: Technical metadata\n        public string? IPAddress { get; set; }\n        public string? UserAgent { get; set; }\n        public string? Location { get; set; } // Optional for geo-capture later\n\n        // 🕒 Timestamp\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AuditTrail/Services/AuditLogService.cs",
      "sha256": "6b18d820c4191681a1bf26d6672f189bce0cadcfba3c8beb9e29dbed4ad4fdd9",
      "language": "csharp",
      "size": 536,
      "content": "using xbytechat.api.Features.AuditTrail.Models;\nusing xbytechat.api.Repositories;\nusing xbytechat.api.Repositories.Interfaces;\n\nnamespace xbytechat.api.Features.AuditTrail.Services\n{\n    public class AuditLogService : IAuditLogService\n    {\n        private readonly IGenericRepository<AuditLog> _repo;\n\n        public AuditLogService(IGenericRepository<AuditLog> repo)\n        {\n            _repo = repo;\n        }\n\n        public async Task SaveLogAsync(AuditLog log)\n        {\n            await _repo.AddAsync(log);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AuditTrail/Services/IAuditLogService.cs",
      "sha256": "65d811af2c7dc349002b7b1a340a765025625f9fe31c241dccc8f3eaeab15330",
      "language": "csharp",
      "size": 197,
      "content": "using xbytechat.api.Features.AuditTrail.Models;\n\nnamespace xbytechat.api.Features.AuditTrail.Services\n{\n    public interface IAuditLogService\n    {\n        Task SaveLogAsync(AuditLog log);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Automation/Config/ChoiceConfig.cs",
      "sha256": "0d09e0bc40325856d625ab31e93694e661b6df532e5de78f2a55254783e40c1c",
      "language": "csharp",
      "size": 354,
      "content": "namespace xbytechat.api.Features.Automation.Config\n{\n    public class ChoiceConfig\n    {\n        public List<ChoiceCondition> Conditions { get; set; } = new();\n        public string FallbackNodeId { get; set; }\n    }\n\n    public class ChoiceCondition\n    {\n        public string Match { get; set; }\n        public string NextNodeId { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Automation/Config/MessageConfig.cs",
      "sha256": "564fbd35e79d9ef3f8b48ed54e15d55a9d0226b7d6ea72315d81b562a7a4ecae",
      "language": "csharp",
      "size": 225,
      "content": "namespace xbytechat.api.Features.Automation.Models.Configs\n{\n    public class MessageConfig\n    {\n        public string Text { get; set; } = string.Empty;\n\n        // Future: Add support for media, buttons, templates\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Automation/Config/TagNodeConfig.cs",
      "sha256": "81144c1418ba70285c6af13bf7aee6346f8f6674416ffc9ab79614bceb3be4d0",
      "language": "csharp",
      "size": 197,
      "content": "using System.Collections.Generic;\n\nnamespace xbytechat.api.Features.Automation.Models.Configs\n{\n    public class TagNodeConfig\n    {\n        public List<string> Tags { get; set; } = new();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Automation/Config/WaitConfig.cs",
      "sha256": "d13667732f9e18370123b10c2881aa385e8d11a33bc01acaf0f7eb96f4903bd6",
      "language": "csharp",
      "size": 170,
      "content": "namespace xbytechat.api.Features.Automation.Models.Configs\n{\n    public class WaitConfig\n    {\n        public int Seconds { get; set; } = 2; // Default wait time\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Automation/Controllers/AutomationController.cs",
      "sha256": "3a2f3e472a351808592f6357f3e907d20c118e1e0f86f035a76e49697013e4ff",
      "language": "csharp",
      "size": 2144,
      "content": "using Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Features.Automation.DTOs;\nusing xbytechat.api.Features.Automation.Repositories;\nusing xbytechat.api.Features.Automation.Services;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.CRM.Interfaces;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.Automation.Controllers\n{\n    [ApiController]\n    [Route(\"api/automation\")]\n    [Authorize]\n    public class AutomationController : ControllerBase\n    {\n        private readonly IAutomationFlowRepository _automationRepository;\n        private readonly IAutomationRunner _automationRunner;\n        private readonly IContactService _contactService;\n\n        public AutomationController(\n            IAutomationFlowRepository automationRepository,\n            IAutomationRunner automationRunner,\n            IContactService contactService)\n        {\n            _automationRepository = automationRepository;\n            _automationRunner = automationRunner;\n            _contactService = contactService;\n        }\n\n        [HttpPost(\"trigger\")]\n        public async Task<IActionResult> TriggerByKeyword([FromBody] AutomationTriggerRequest request)\n        {\n            var businessId = User.GetBusinessId();\n            var userId = User.GetUserId();\n\n            if (string.IsNullOrWhiteSpace(request.Keyword) || string.IsNullOrWhiteSpace(request.Phone))\n                return BadRequest(\"Keyword and phone are required.\");\n\n            var flow = await _automationRepository.GetFlowByKeywordAsync(businessId, request.Keyword);\n            if (flow == null || !flow.IsActive)\n                return NotFound(\"⚠️ No matching active automation flow found.\");\n\n            var contact = await _contactService.FindOrCreateAsync(businessId, request.Phone);\n\n            var result = await _automationRunner.RunFlowAsync(\n                flow,\n                businessId,\n                contact.Id,\n                request.Phone,\n                request.SourceChannel ?? \"manual\",\n                request.IndustryTag ?? \"manual\"\n            );\n\n            return Ok(result);\n        }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Automation/DTOs/AutomationEdgeDto.cs",
      "sha256": "d9093a43a35fa0c12238f7c78daec3980190c4160320cfe73c6b93ff2d41c5ce",
      "language": "csharp",
      "size": 450,
      "content": "using System;\n\nnamespace xbytechat.api.Features.Automation.DTOs\n{\n    /// <summary>\n    /// Represents a connection (edge) between two automation nodes.\n    /// </summary>\n    public class AutomationEdgeDto\n    {\n        public Guid SourceNodeId { get; set; }\n\n        public Guid TargetNodeId { get; set; }\n\n        public string? Condition { get; set; }  // Optional: for future conditional routing (e.g., \"if clicked\", \"if not responded\")\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Automation/DTOs/AutomationTriggerRequest.cs",
      "sha256": "aeca572a0bab580b70dddd50cb6f4e1b282f17508311aaeb9beaefef34d8fa46",
      "language": "csharp",
      "size": 296,
      "content": "namespace xbytechat.api.Features.Automation.DTOs\n{\n    public class AutomationTriggerRequest\n    {\n        public string Keyword { get; set; }\n\n        public string Phone { get; set; }\n\n        public string? SourceChannel { get; set; }\n\n        public string? IndustryTag { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Automation/DTOs/MessageNodeConfig.cs",
      "sha256": "8fdadb2bb6457b35ed85d89655b1f6d1d9bc5028a0ec212d9dd7eaa70b1a8e0d",
      "language": "csharp",
      "size": 218,
      "content": "namespace xbytechat.api.Features.Automation.DTOs\n{\n    public class MessageNodeConfig\n    {\n        public string Text { get; set; } = string.Empty;\n\n        // Optional: Later you can add buttons, media, etc.\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Automation/DTOs/TagNodeConfig.cs",
      "sha256": "2feaf9902643a6bb0e59b019cfca34a41ada3abf9f66afffcac065c6bb545b6c",
      "language": "csharp",
      "size": 199,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.Features.Automation.DTOs\n{\n    public class TagNodeConfig\n    {\n        public List<Guid> Tags { get; set; } = new();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Automation/DTOs/WaitNodeConfig.cs",
      "sha256": "f520007158ae72db229b2a23f437666e64d34fcc96cdd728ad57a4320f152b75",
      "language": "csharp",
      "size": 143,
      "content": "namespace xbytechat.api.Features.Automation.DTOs\n{\n    public class WaitNodeConfig\n    {\n        public int Seconds { get; set; } = 3;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Automation/Models/AutomationFlow.cs",
      "sha256": "7dd5063615cfa824960a08fdd88d9fdf500a3c0461151b27e09fcaa7d97b45fe",
      "language": "csharp",
      "size": 803,
      "content": "using System;\nusing System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.Features.Automation.Models\n{\n    /// <summary>\n    /// Represents a saved automation flow with nodes and edges.\n    /// </summary>\n    public class AutomationFlow\n    {\n        [Key]\n        public Guid Id { get; set; }\n\n        public Guid BusinessId { get; set; }\n\n        public string Name { get; set; } = string.Empty;\n\n        public string TriggerKeyword { get; set; } = string.Empty; // ✅ Better naming\n\n        public string NodesJson { get; set; } = \"[]\";\n\n        public string EdgesJson { get; set; } = \"[]\";\n\n        public bool IsActive { get; set; } = true;\n\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n\n        public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Automation/Models/AutomationFlowEdge.cs",
      "sha256": "ad1f63ff8580807f996a658e2a95652c94370929e8dd75eac9f1fdc98c398105",
      "language": "csharp",
      "size": 280,
      "content": "namespace xbytechat.api.Features.Automation.Models\n{\n    public class AutomationFlowEdge\n    {\n        public string SourceNodeId { get; set; } = string.Empty;\n        public string TargetNodeId { get; set; } = string.Empty;\n        public string? Condition { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Automation/Models/AutomationFlowNode.cs",
      "sha256": "c18876f0d4c8fdf851da8df67ddff902fee66217b804a6765a9b533f8402e76d",
      "language": "csharp",
      "size": 354,
      "content": "using System;\n\nnamespace xbytechat.api.Features.Automation.Models\n{\n    public class AutomationFlowNode\n    {\n        public string Id { get; set; } = Guid.NewGuid().ToString(\"N\");\n        public string Label { get; set; } = string.Empty;\n        public NodeTypeEnum NodeType { get; set; }\n        public string ConfigJson { get; set; } = \"{}\";\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/Automation/Models/AutomationFlowRunResult.cs",
      "sha256": "61407553e4f66fbfdc8c0a51868372170e58411cd6c74e857e8e9cab13e27b6b",
      "language": "csharp",
      "size": 403,
      "content": "using System;\n\nnamespace xbytechat.api.Features.Automation.Models\n{\n    public class AutomationFlowRunResult\n    {\n        public bool NeedsAgent { get; set; } = false;\n\n        public Guid? HandoffNodeId { get; set; } = null;\n\n        public string? Notes { get; set; }  // Optional: track execution info (e.g., exit reason)\n\n        public DateTime ExecutedAt { get; set; } = DateTime.UtcNow;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Automation/Models/FlowExecutionContext.cs",
      "sha256": "aef2132567e314889ae4d98f06dd96c43873ab3513b6c02cd8553346e3e7ff57",
      "language": "csharp",
      "size": 523,
      "content": "using System;\n\nnamespace xbytechat.api.Features.Automation.Models\n{\n    /// <summary>\n    /// Context required to run an automation flow.\n    /// </summary>\n    public class FlowExecutionContext\n    {\n        public AutomationFlow Flow { get; set; }\n\n        public Guid BusinessId { get; set; }\n\n        public Guid ContactId { get; set; }\n\n        public string ContactPhone { get; set; }\n\n        public string SourceChannel { get; set; } = \"manual\";\n\n        public string IndustryTag { get; set; } = \"manual\";\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Automation/Models/FlowRunResult.cs",
      "sha256": "64baa95c50dc4528fa36e8ad36a12ac82a0528c8c640797d16b58e17455d6125",
      "language": "csharp",
      "size": 345,
      "content": "using System;\n\nnamespace xbytechat.api.Features.Automation.Models\n{\n    /// <summary>\n    /// Represents the result of running an automation flow.\n    /// </summary>\n    public class FlowRunResult\n    {\n        public bool NeedsAgent { get; set; } = false;\n\n        public Guid? HandoffNodeId { get; set; } // If agent handoff requested\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Automation/Models/NodeConfigs.cs",
      "sha256": "0e8b3fb72dd676ec59568e34b569e1302a621a35a6efca4553736f89b15b21c4",
      "language": "csharp",
      "size": 167,
      "content": "namespace xbytechat.api.Features.Automation.Models.NodeConfigs\n{\n    public class MessageConfig\n    {\n        public string Text { get; set; } = string.Empty;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Automation/Models/NodeTypeEnum.cs",
      "sha256": "ac2b60c1ffd633136ef56df710b0cf7f141496e92e30cd1c4bd42f201f4d85d3",
      "language": "csharp",
      "size": 223,
      "content": "namespace xbytechat.api.Features.Automation.Models\n{\n    public enum NodeTypeEnum\n    {\n        Message,\n        Wait,\n        Tag,\n        AgentHandoff,\n        Choice,\n        Condition,\n        Loop,\n        End\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Automation/Models/TagNodeConfig.cs",
      "sha256": "9cec10f188aea021e4b186075bf0f84e18cb4071046ade7098c2658d077559f5",
      "language": "csharp",
      "size": 201,
      "content": "using System.Collections.Generic;\n\nnamespace xbytechat.api.Features.Automation.Models.NodeConfigs\n{\n    public class TagNodeConfig\n    {\n        public List<string> Tags { get; set; } = new();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Automation/Models/WaitConfig.cs",
      "sha256": "641533b56ae811de7505263f827bc5f89cc405f67645b053fd06737f1e5fa621",
      "language": "csharp",
      "size": 153,
      "content": "namespace xbytechat.api.Features.Automation.Models.NodeConfigs\n{\n    public class WaitConfig\n    {\n        public int Seconds { get; set; } = 1;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Automation/Repositories/AutomationFlowRepository.cs",
      "sha256": "0e6a38673480db7c067e41901c2725f6c93683975ffaacfdcefb67bcfe90820e",
      "language": "csharp",
      "size": 3297,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.Automation.Models;\n\nnamespace xbytechat.api.Features.Automation.Repositories\n{\n    public class AutomationFlowRepository : IAutomationFlowRepository\n    {\n        private readonly AppDbContext _db;\n\n        public AutomationFlowRepository(AppDbContext db)\n        {\n            _db = db;\n        }\n\n        public async Task<AutomationFlow?> GetByIdAsync(Guid flowId, Guid businessId)\n        {\n            return await _db.AutomationFlows\n                .FirstOrDefaultAsync(f => f.Id == flowId && f.BusinessId == businessId && f.IsActive);\n        }\n\n        public async Task<AutomationFlow?> GetFlowByKeywordAsync(Guid businessId, string keyword)\n        {\n            return await _db.AutomationFlows\n                .FirstOrDefaultAsync(f =>\n                    f.BusinessId == businessId &&\n                    f.TriggerKeyword.ToLower() == keyword.ToLower() &&\n                    f.IsActive);\n        }\n\n        public async Task<IEnumerable<AutomationFlow>> GetAllByBusinessAsync(Guid businessId)\n        {\n            return await _db.AutomationFlows\n                .Where(f => f.BusinessId == businessId && f.IsActive)\n                .OrderBy(f => f.Name)\n                .ToListAsync();\n        }\n\n        public async Task<AutomationFlow> CreateAsync(AutomationFlow flow)\n        {\n            flow.Id = Guid.NewGuid();\n            flow.CreatedAt = DateTime.UtcNow;\n            flow.IsActive = true;\n\n            _db.AutomationFlows.Add(flow);\n            await _db.SaveChangesAsync();\n            return flow;\n        }\n\n        public async Task<AutomationFlow> UpdateAsync(AutomationFlow flow)\n        {\n            var existing = await _db.AutomationFlows\n                .FirstOrDefaultAsync(f => f.Id == flow.Id && f.BusinessId == flow.BusinessId && f.IsActive);\n\n            if (existing == null)\n                throw new KeyNotFoundException(\"Automation flow not found.\");\n\n            existing.Name = flow.Name;\n            existing.TriggerKeyword = flow.TriggerKeyword;\n            existing.NodesJson = flow.NodesJson;\n            existing.EdgesJson = flow.EdgesJson;\n            existing.UpdatedAt = DateTime.UtcNow;\n\n            _db.AutomationFlows.Update(existing);\n            await _db.SaveChangesAsync();\n\n            return existing;\n        }\n\n        public async Task<bool> DeleteAsync(Guid flowId, Guid businessId)\n        {\n            var flow = await _db.AutomationFlows\n                .FirstOrDefaultAsync(f => f.Id == flowId && f.BusinessId == businessId && f.IsActive);\n\n            if (flow == null)\n                return false;\n\n            flow.IsActive = false;\n            flow.UpdatedAt = DateTime.UtcNow;\n\n            _db.AutomationFlows.Update(flow);\n            await _db.SaveChangesAsync();\n            return true;\n        }\n        public async Task<AutomationFlow?> GetByKeywordAsync(Guid businessId, string keyword)\n        {\n            return await _db.AutomationFlows\n                .FirstOrDefaultAsync(f =>\n                f.BusinessId == businessId &&\n                EF.Functions.ILike(f.TriggerKeyword, keyword) &&\n                f.IsActive);\n        }\n\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Automation/Repositories/IAutomationFlowRepository.cs",
      "sha256": "3c0e87413a797f0b2cb7de16b419204f9f84555fd58a4435ca5bffc5f570b2fe",
      "language": "csharp",
      "size": 1022,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.Automation.Models;\n\nnamespace xbytechat.api.Features.Automation.Repositories\n{\n    public interface IAutomationFlowRepository\n    {\n        // 🔍 Get flow by unique FlowId + BusinessId (strict filtering)\n        Task<AutomationFlow?> GetByIdAsync(Guid flowId, Guid businessId);\n\n        // 🔍 Get flow by keyword for auto-trigger\n        Task<AutomationFlow?> GetFlowByKeywordAsync(Guid businessId, string keyword);\n\n        // 📋 List all flows for business\n        Task<IEnumerable<AutomationFlow>> GetAllByBusinessAsync(Guid businessId);\n\n        // ➕ Create flow\n        Task<AutomationFlow> CreateAsync(AutomationFlow flow);\n\n        // ✏️ Update flow\n        Task<AutomationFlow> UpdateAsync(AutomationFlow flow);\n\n        // ❌ Delete flow\n        Task<bool> DeleteAsync(Guid flowId, Guid businessId);\n        Task<AutomationFlow?> GetByKeywordAsync(Guid businessId, string keyword);\n\n\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/Automation/Services/AutomationRunner.cs",
      "sha256": "3f1cb7807540e05fcd7092da474d3784a3f5c6065fd4c98ca22abc2753b97765",
      "language": "csharp",
      "size": 12633,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing Microsoft.Extensions.Logging;\nusing Microsoft.EntityFrameworkCore;\nusing Newtonsoft.Json;\nusing xbytechat.api.CRM.Interfaces;\nusing xbytechat.api.Features.Automation.Models;\nusing xbytechat.api.Features.Automation.Models.Configs;\nusing xbytechat.api.Features.MessagesEngine.DTOs;\nusing xbytechat.api.Features.MessagesEngine.Services;\nusing xbytechat.api.Features.Inbox.Models;\nusing xbytechat.api.Features.Automation.Config;\n\nnamespace xbytechat.api.Features.Automation.Services\n{\n    public class AutomationRunner : IAutomationRunner\n    {\n        private readonly IMessageEngineService _messageService;\n        private readonly IContactService _contactService;\n        private readonly ILogger<AutomationRunner> _logger;\n        private readonly AppDbContext _appDbContext;\n        public AutomationRunner(\n            IMessageEngineService messageService,\n            IContactService contactService,\n            ILogger<AutomationRunner> logger, AppDbContext appDbContext)\n        {\n            _messageService = messageService;\n            _contactService = contactService;\n            _logger = logger;\n            _appDbContext = appDbContext;\n        }\n\n        public async Task<AutomationFlowRunResult> RunFlowAsync(\n            AutomationFlow flow,\n            Guid businessId,\n            Guid contactId,\n            string contactPhone,\n            string sourceChannel,\n            string industryTag)\n        {\n            var nodes = JsonConvert.DeserializeObject<List<AutomationFlowNode>>(flow.NodesJson);\n            var edges = JsonConvert.DeserializeObject<List<AutomationFlowEdge>>(flow.EdgesJson);\n\n            var result = new AutomationFlowRunResult();\n            var currentNode = nodes.FirstOrDefault(); // Start from first node\n\n            if (currentNode == null)\n            {\n                _logger.LogWarning(\"🚫 Flow has no start node.\");\n                result.NeedsAgent = true;\n                result.Notes = \"No start node found.\";\n                return result;\n            }\n\n            while (currentNode != null)\n            {\n                _logger.LogInformation(\"➡️ Running node: {NodeType} | {NodeId}\", currentNode.NodeType, currentNode.Id);\n\n                switch (currentNode.NodeType)\n                {\n                    case NodeTypeEnum.Message:\n                        var msgCfg = JsonConvert.DeserializeObject<MessageConfig>(currentNode.ConfigJson);\n                        var msgDto = new TextMessageSendDto\n                        {\n                            BusinessId = businessId,\n                            ContactId = contactId,\n                            RecipientNumber = contactPhone,\n                            TextContent = msgCfg.Text,\n                            Source = \"automation\"\n                        };\n                        _logger.LogInformation(\"📤 Sending message: {Text}\", msgCfg.Text);\n                        await _messageService.SendAutomationReply(msgDto);\n                        break;\n\n                    case NodeTypeEnum.Wait:\n                        var waitCfg = JsonConvert.DeserializeObject<WaitConfig>(currentNode.ConfigJson);\n                        _logger.LogInformation(\"⏳ Waiting {Seconds}s\", waitCfg.Seconds);\n                        await Task.Delay(waitCfg.Seconds * 1000);\n                        break;\n\n                    case NodeTypeEnum.Tag:\n                        var tagCfg = JsonConvert.DeserializeObject<TagNodeConfig>(currentNode.ConfigJson);\n                        _logger.LogInformation(\"🏷️ Assigning tags: {Tags}\", string.Join(\", \", tagCfg.Tags));\n                        await _contactService.AssignTagsAsync(businessId, contactPhone, tagCfg.Tags);\n                        break;\n\n                    case NodeTypeEnum.AgentHandoff:\n                        result.NeedsAgent = true;\n                        if (Guid.TryParse(currentNode.Id, out var parsedId))\n                        {\n                            result.HandoffNodeId = parsedId;\n                        }\n                        else\n                        {\n                            _logger.LogWarning(\"⚠️ Invalid node ID format for AgentHandoff node: {Id}\", currentNode.Id);\n                            result.HandoffNodeId = null;\n                        }\n                        result.Notes = \"Flow routed to human agent.\";\n                        return result;\n\n                    case NodeTypeEnum.End:\n                        _logger.LogInformation(\"✅ End node reached.\");\n                        currentNode = null;\n                        continue;\n\n                    case NodeTypeEnum.Choice:\n                        _logger.LogInformation(\"🧠 Reached Choice node. Saving session state to wait for user input...\");\n\n                        var session = await _appDbContext.ChatSessionStates.FirstOrDefaultAsync(s =>\n                            s.BusinessId == businessId && s.ContactId == contactId);\n\n                        if (session == null)\n                        {\n                            session = new ChatSessionState\n                            {\n                                Id = Guid.NewGuid(),\n                                BusinessId = businessId,\n                                ContactId = contactId\n                            };\n                            _appDbContext.ChatSessionStates.Add(session);\n                        }\n\n                        session.Mode = \"awaiting_choice\";\n                        session.UpdatedBy = currentNode.Id.ToString();\n                        session.LastUpdatedAt = DateTime.UtcNow;\n\n                        await _appDbContext.SaveChangesAsync();\n\n                        result.Notes = \"Choice node reached. Flow paused.\";\n                        return result;\n                }\n\n                var edge = edges.FirstOrDefault(e => e.SourceNodeId == currentNode.Id);\n                currentNode = edge == null ? null : nodes.FirstOrDefault(n => n.Id == edge.TargetNodeId);\n            }\n\n            result.Notes = \"Flow completed.\";\n            return result;\n        }\n        public async Task<AutomationFlowRunResult> ResumeFlowAsync(\n           Guid businessId,\n           Guid contactId,\n           string contactPhone,\n           string incomingMessage)\n        {\n            var session = await _appDbContext.ChatSessionStates\n                .FirstOrDefaultAsync(s => s.BusinessId == businessId && s.ContactId == contactId);\n\n            if (session == null || session.Mode != \"awaiting_choice\")\n            {\n                _logger.LogWarning(\"❌ No active automation session found or mode not awaiting_choice.\");\n                return new AutomationFlowRunResult { NeedsAgent = true, Notes = \"No active automation session.\" };\n            }\n\n            var flow = await _appDbContext.AutomationFlows\n                .Where(f => f.BusinessId == businessId && f.IsActive)\n                .OrderByDescending(f => f.UpdatedAt)\n                .FirstOrDefaultAsync();\n\n            if (flow == null)\n            {\n                _logger.LogWarning(\"❌ No active automation flow found for business.\");\n                return new AutomationFlowRunResult { NeedsAgent = true, Notes = \"No active flow found.\" };\n            }\n\n            var nodes = JsonConvert.DeserializeObject<List<AutomationFlowNode>>(flow.NodesJson);\n            var edges = JsonConvert.DeserializeObject<List<AutomationFlowEdge>>(flow.EdgesJson);\n\n            var choiceNode = nodes.FirstOrDefault(n => n.Id == session.UpdatedBy && n.NodeType == NodeTypeEnum.Choice);\n            if (choiceNode == null)\n            {\n                _logger.LogWarning(\"❌ Stored session node not found or not a Choice node.\");\n                return new AutomationFlowRunResult { NeedsAgent = true, Notes = \"Invalid Choice node in session.\" };\n            }\n\n            var cfg = JsonConvert.DeserializeObject<ChoiceConfig>(choiceNode.ConfigJson);\n            if (cfg?.Conditions == null)\n            {\n                _logger.LogWarning(\"❌ Choice config is null or empty.\");\n                return new AutomationFlowRunResult { NeedsAgent = true, Notes = \"Invalid Choice config.\" };\n            }\n\n            var match = cfg.Conditions.FirstOrDefault(c =>\n                string.Equals(c.Match.Trim(), incomingMessage.Trim(), StringComparison.OrdinalIgnoreCase));\n\n            string nextNodeId = match?.NextNodeId ?? cfg.FallbackNodeId;\n            if (match == null)\n            {\n                _logger.LogWarning(\"🔁 No matching condition found. Using fallback: {Fallback}\", nextNodeId);\n            }\n\n            var nextNode = nodes.FirstOrDefault(n => n.Id == nextNodeId);\n            if (nextNode == null)\n            {\n                _logger.LogWarning(\"❌ Next node after choice not found.\");\n                return new AutomationFlowRunResult { NeedsAgent = true, Notes = \"Next node not found.\" };\n            }\n\n            // ✅ Clear session after resume\n            _appDbContext.ChatSessionStates.Remove(session);\n            await _appDbContext.SaveChangesAsync();\n\n            // ✅ Resume from the matched node using shared loop\n            return await ExecuteNodeLoopAsync(flow, nextNode, nodes, edges, businessId, contactId, contactPhone);\n        }\n\n\n        private async Task<AutomationFlowRunResult> ExecuteNodeLoopAsync(\n    AutomationFlow flow,\n    AutomationFlowNode startNode,\n    List<AutomationFlowNode> nodes,\n    List<AutomationFlowEdge> edges,\n    Guid businessId,\n    Guid contactId,\n    string contactPhone)\n        {\n            var result = new AutomationFlowRunResult();\n            var currentNode = startNode;\n\n            while (currentNode != null)\n            {\n                _logger.LogInformation(\"➡️ Executing node: {NodeType} | {NodeId}\", currentNode.NodeType, currentNode.Id);\n\n                switch (currentNode.NodeType)\n                {\n                    case NodeTypeEnum.Message:\n                        var msgCfg = JsonConvert.DeserializeObject<MessageConfig>(currentNode.ConfigJson);\n                        var msgDto = new TextMessageSendDto\n                        {\n                            BusinessId = businessId,\n                            ContactId = contactId,\n                            RecipientNumber = contactPhone,\n                            TextContent = msgCfg.Text,\n                            Source = \"automation\"\n                        };\n                        await _messageService.SendAutomationReply(msgDto);\n                        break;\n\n                    case NodeTypeEnum.Tag:\n                        var tagCfg = JsonConvert.DeserializeObject<TagNodeConfig>(currentNode.ConfigJson);\n                        await _contactService.AssignTagsAsync(businessId, contactPhone, tagCfg.Tags);\n                        break;\n\n                    case NodeTypeEnum.Wait:\n                        var waitCfg = JsonConvert.DeserializeObject<WaitConfig>(currentNode.ConfigJson);\n                        await Task.Delay(waitCfg.Seconds * 1000);\n                        break;\n\n                    case NodeTypeEnum.End:\n                        return new AutomationFlowRunResult { Notes = \"✅ Flow ended.\" };\n\n                    case NodeTypeEnum.AgentHandoff:\n                        return new AutomationFlowRunResult\n                        {\n                            NeedsAgent = true,\n                            Notes = \"Routed to human agent.\"\n                        };\n\n                    case NodeTypeEnum.Choice:\n                        var session = new ChatSessionState\n                        {\n                            Id = Guid.NewGuid(),\n                            BusinessId = businessId,\n                            ContactId = contactId,\n                            Mode = \"awaiting_choice\",\n                            UpdatedBy = currentNode.Id.ToString(),\n                            LastUpdatedAt = DateTime.UtcNow\n                        };\n                        _appDbContext.ChatSessionStates.Add(session);\n                        await _appDbContext.SaveChangesAsync();\n\n                        return new AutomationFlowRunResult { Notes = \"Paused at Choice node.\" };\n                }\n\n                var edge = edges.FirstOrDefault(e => e.SourceNodeId == currentNode.Id);\n                currentNode = edge == null ? null : nodes.FirstOrDefault(n => n.Id == edge.TargetNodeId);\n            }\n\n            return new AutomationFlowRunResult { Notes = \"Flow completed.\" };\n        }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Automation/Services/AutomationService.cs",
      "sha256": "c42e37b6d7f110e3f94e15cae67213a79f8219feb763ecb1ba4ca86c636e423c",
      "language": "csharp",
      "size": 5101,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Http;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api.CRM.Interfaces;\nusing xbytechat.api.Features.Automation.Models;\nusing xbytechat.api.Features.Automation.Repositories;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.Automation.Services\n{\n    public class AutomationService : IAutomationService\n    {\n        private readonly IAutomationFlowRepository _flowRepository;\n        private readonly IAutomationRunner _runner;\n        private readonly IContactService _contactService;\n        private readonly ILogger<AutomationService> _logger;\n        private readonly IHttpContextAccessor _httpContextAccessor;\n\n        public AutomationService(\n            IAutomationFlowRepository flowRepository,\n            IAutomationRunner runner,\n            IContactService contactService,\n            ILogger<AutomationService> logger,\n            IHttpContextAccessor httpContextAccessor)\n        {\n            _flowRepository = flowRepository;\n            _runner = runner;\n            _contactService = contactService;\n            _logger = logger;\n            _httpContextAccessor = httpContextAccessor;\n        }\n\n        public async Task<AutomationFlow?> GetFlowByIdAsync(Guid flowId, Guid businessId)\n        {\n            return await _flowRepository.GetByIdAsync(flowId, businessId);\n        }\n\n        public async Task<AutomationFlow?> GetFlowByKeywordAsync(Guid businessId, string keyword)\n        {\n            return await _flowRepository.GetByKeywordAsync(businessId, keyword);\n        }\n\n        public async Task<AutomationFlowRunResult> RunFlowAsync(\n            AutomationFlow flow,\n            Guid businessId,\n            Guid contactId,\n            string phone,\n            string sourceChannel,\n            string industryTag)\n        {\n            return await _runner.RunFlowAsync(flow, businessId, contactId, phone, sourceChannel, industryTag);\n        }\n\n        public async Task<IEnumerable<AutomationFlow>> GetAllFlowsAsync(Guid businessId)\n        {\n            return await _flowRepository.GetAllByBusinessAsync(businessId);\n        }\n\n        public async Task<AutomationFlow> CreateFlowAsync(Guid businessId, AutomationFlow flow)\n        {\n            flow.BusinessId = businessId;\n            return await _flowRepository.CreateAsync(flow);\n        }\n\n        public async Task<bool> DeleteFlowAsync(Guid flowId, Guid businessId)\n        {\n            return await _flowRepository.DeleteAsync(flowId, businessId);\n        }\n\n        public async Task RunByKeywordAsync(string messageText, string phoneNumber, string sourceChannel = \"whatsapp\")\n        {\n            var businessId = _httpContextAccessor.HttpContext?.User?.GetBusinessId()\n                ?? throw new UnauthorizedAccessException(\"BusinessId could not be resolved from context.\");\n\n            var flow = await _flowRepository.GetByKeywordAsync(businessId, messageText);\n            if (flow == null)\n            {\n                _logger.LogInformation(\"No matching automation flow for keyword: {Keyword}\", messageText);\n                return;\n            }\n\n            var contact = await _contactService.FindOrCreateAsync(businessId, phoneNumber);\n            await _runner.RunFlowAsync(flow, businessId, contact.Id, contact.PhoneNumber, sourceChannel, industryTag: \"default\");\n        }\n\n        public async Task<bool> TryRunFlowByKeywordAsync(\n         Guid businessId,\n         string messageText,\n         string userPhone,\n         string sourceChannel,\n         string industryTag)\n        {\n            try\n            {\n                // 🔍 Normalize keyword\n                var normalizedKeyword = messageText.Trim().ToLower();\n\n                // ✅ Fetch flow by trigger keyword\n                var flow = await _flowRepository.GetByKeywordAsync(businessId, normalizedKeyword);\n                if (flow == null)\n                {\n                    _logger.LogInformation(\"TryRun: No matching automation flow found for keyword: '{Keyword}'\", normalizedKeyword);\n                    return false;\n                }\n\n                // 👤 Ensure contact exists\n                var contact = await _contactService.FindOrCreateAsync(businessId, userPhone);\n                if (contact == null)\n                {\n                    _logger.LogWarning(\"❌ TryRun: Failed to resolve or create contact for phone: {Phone}\", userPhone);\n                    return false;\n                }\n\n                // ▶️ Run automation flow\n                _logger.LogInformation(\"🚀 Running flow '{FlowName}' for keyword '{Keyword}'\", flow.Name, normalizedKeyword);\n                await _runner.RunFlowAsync(flow, businessId, contact.Id, contact.PhoneNumber, sourceChannel, industryTag);\n\n                return true;\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"❌ TryRun: Exception while executing flow for keyword '{Keyword}'\", messageText);\n                return false;\n            }\n        }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Automation/Services/IAutomationRunner.cs",
      "sha256": "0aa081c7006bb76ff84c8cee9da21e51a021a69c4e0b6d191ffdc1356b5e4001",
      "language": "csharp",
      "size": 453,
      "content": "using System;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.Automation.Models;\n\nnamespace xbytechat.api.Features.Automation.Services\n{\n    public interface IAutomationRunner\n    {\n        Task<AutomationFlowRunResult> RunFlowAsync(\n             AutomationFlow flow,\n             Guid businessId,\n             Guid contactId,\n             string contactPhone,\n             string sourceChannel,\n             string industryTag\n );\n\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/Automation/Services/IAutomationService.cs",
      "sha256": "fd32d83e0e970571048b14fb8805162a0b1139c917ed0bf99ad84b4a244ce609",
      "language": "csharp",
      "size": 1688,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.Automation.Models;\n\nnamespace xbytechat.api.Features.Automation.Services\n{\n    public interface IAutomationService\n    {\n        // 📌 Get flow by FlowId (for admin UI or debugging)\n        Task<AutomationFlow?> GetFlowByIdAsync(Guid flowId, Guid businessId);\n\n        // 📌 Get flow by keyword match (used for auto-triggering)\n        Task<AutomationFlow?> GetFlowByKeywordAsync(Guid businessId, string keyword);\n\n        // 🛠️ Execute a flow with contact and channel info\n        Task<AutomationFlowRunResult> RunFlowAsync(\n            AutomationFlow flow,\n            Guid businessId,\n            Guid contactId,\n            string phone,\n            string sourceChannel,\n            string industryTag\n        );\n\n        // 📋 List all flows (for admin or dashboard)\n        Task<IEnumerable<AutomationFlow>> GetAllFlowsAsync(Guid businessId);\n\n        // ➕ Create new flow\n        Task<AutomationFlow> CreateFlowAsync(Guid businessId, AutomationFlow flow);\n\n        // ❌ Delete existing flow\n        Task<bool> DeleteFlowAsync(Guid flowId, Guid businessId);\n\n        // ⚡ Runtime entry point – called when a message arrives\n        Task RunByKeywordAsync(\n            string messageText,\n            string phoneNumber,\n            string sourceChannel = \"whatsapp\"\n        );\n\n        // ✅ Returns true if flow matched and executed\n        Task<bool> TryRunFlowByKeywordAsync(\n            Guid businessId,\n            string messageText,\n            string userPhone,\n            string sourceChannel,\n            string industryTag\n        );\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Controllers/AutoReplyController.cs",
      "sha256": "c575c41a8f3145df1332211adef4017099c86609c2981442039fcfbd0823a6de",
      "language": "csharp",
      "size": 2591,
      "content": "using Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Features.AutoReplyBuilder.DTOs;\nusing xbytechat.api.Features.AutoReplyBuilder.Services;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.AutoReplyBuilder.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    [Authorize]\n    public class AutoReplyController : ControllerBase\n    {\n        private readonly IAutoReplyService _service;\n\n        public AutoReplyController(IAutoReplyService service)\n        {\n            _service = service;\n        }\n\n        [HttpPost]\n        public async Task<IActionResult> CreateRule([FromBody] AutoReplyRuleDto dto)\n        {\n            var businessId = ClaimsBusinessDetails.GetBusinessId(User);\n            var result = await _service.CreateRuleAsync(businessId, dto);\n            return Ok(result);\n        }\n\n        [HttpGet]\n        public async Task<IActionResult> GetAllRules()\n        {\n            var businessId = ClaimsBusinessDetails.GetBusinessId(User);\n            var rules = await _service.GetAllRulesAsync(businessId);\n            return Ok(rules);\n        }\n\n        [HttpGet(\"{id}\")]\n        public async Task<IActionResult> GetRuleById(Guid id)\n        {\n            var businessId = ClaimsBusinessDetails.GetBusinessId(User);\n            var rule = await _service.GetRuleByIdAsync(id, businessId);\n            return rule == null ? NotFound() : Ok(rule);\n        }\n\n        [HttpPut(\"{id}\")]\n        public async Task<IActionResult> UpdateRule(Guid id, [FromBody] AutoReplyRuleDto dto)\n        {\n            var businessId = ClaimsBusinessDetails.GetBusinessId(User);\n            dto.Id = id;\n            var success = await _service.UpdateRuleAsync(businessId, dto);\n            return success ? NoContent() : NotFound();\n        }\n\n        [HttpDelete(\"{id}\")]\n        public async Task<IActionResult> DeleteRule(Guid id)\n        {\n            var businessId = ClaimsBusinessDetails.GetBusinessId(User);\n            var success = await _service.DeleteRuleAsync(id, businessId);\n            return success ? NoContent() : NotFound();\n        }\n\n        // Optional — for debugging match logic (not exposed in prod)\n        [HttpGet(\"match\")]\n        public async Task<IActionResult> MatchByKeyword([FromQuery] string message)\n        {\n            var businessId = ClaimsBusinessDetails.GetBusinessId(User);\n            var matchedRule = await _service.MatchRuleByKeywordAsync(businessId, message);\n            return matchedRule == null ? NotFound(\"No match found.\") : Ok(matchedRule);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Controllers/AutoReplyFlowsController.cs",
      "sha256": "442d35032e1265a4ba687db6033f7cd70d21c92e30f63d3122e43e50540bb763",
      "language": "csharp",
      "size": 3075,
      "content": "using Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Features.AutoReplyBuilder.DTOs;\nusing xbytechat.api.Features.AutoReplyBuilder.Flows.DTOs;\nusing xbytechat.api.Features.AutoReplyBuilder.Flows.Services;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.AutoReplyBuilder.Flows.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    [Authorize]\n    public class AutoReplyFlowsController : ControllerBase\n    {\n        private readonly IAutoReplyFlowService _service;\n\n        public AutoReplyFlowsController(IAutoReplyFlowService service)\n        {\n            _service = service;\n        }\n\n        // [HttpPost(\"save\")]\n        //public async Task<IActionResult> SaveFlow([FromBody] SaveFlowDto dto)\n        //{\n        //    var id = await _service.SaveFlowAsync(dto);\n        //    return Ok(new { id });\n        //}\n        [HttpPost(\"save\")]\n        public async Task<IActionResult> SaveFlow([FromBody] SaveFlowDto dto)\n        {\n            Guid businessId;\n            try { businessId = User.GetBusinessId(); }\n            catch (UnauthorizedAccessException) { return Unauthorized(\"Missing or invalid business ID\"); }\n\n            var id = await _service.SaveFlowAsync(dto, businessId);\n            return Ok(new { id });\n        }\n\n        [HttpGet(\"business/{businessId}\")]\n        public async Task<IActionResult> GetFlowsByBusiness(Guid businessId)\n        {\n            var flows = await _service.GetFlowsByBusinessIdAsync(businessId);\n            return Ok(flows);\n        }\n\n        [HttpGet(\"{id}\")]\n        public async Task<IActionResult> GetFlowById(Guid id)\n        {\n            var businessId = ClaimsBusinessDetails.GetBusinessId(User);\n            var flow = await _service.GetFlowByIdAsync(id, businessId);\n            return flow == null ? NotFound() : Ok(flow);\n        }\n        [HttpGet(\"business/{businessId}/count\")]\n        public async Task<IActionResult> GetFlowCount(Guid businessId)\n        {\n            var count = await _service.GetFlowCountForBusinessAsync(businessId);\n            return Ok(count);\n        }\n        [HttpPut(\"{id}/rename\")]\n        public async Task<IActionResult> RenameFlow(Guid id, [FromBody] RenameFlowDto dto)\n        {\n            var result = await _service.RenameFlowAsync(id, dto.NewName);\n            if (!result) return NotFound();\n            return Ok();\n        }\n        [HttpDelete(\"{id}\")]\n        public async Task<IActionResult> DeleteFlow(Guid id)\n        {\n            Guid businessId;\n            try\n            {\n                businessId = User.GetBusinessId(); // ✅ Clean and secure\n            }\n            catch (UnauthorizedAccessException)\n            {\n                return Unauthorized(\"Missing or invalid business ID\");\n            }\n\n            var success = await _service.DeleteFlowAsync(id, businessId);\n            if (!success)\n                return NotFound(\"Flow not found or not owned by your business\");\n\n            return Ok(new { message = \"Flow deleted successfully\" });\n        }\n\n\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Controllers/AutoReplyRuntimeController.cs",
      "sha256": "a8f103874213b2129c6d59932b03582a9f21206d073f756ca97bfe08e0015e85",
      "language": "csharp",
      "size": 3135,
      "content": "using Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Features.AutoReplyBuilder.DTOs;\nusing xbytechat.api.Features.AutoReplyBuilder.Services;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.AutoReplyBuilder.Controllers\n{\n    [ApiController]\n    [Route(\"api/auto-reply-runtime\")]\n    [Authorize]\n    public class AutoReplyRuntimeController : ControllerBase\n    {\n        private readonly IAutoReplyRuntimeService _runtimeService;\n        private readonly ILogger<AutoReplyRuntimeController> _logger;\n\n        public AutoReplyRuntimeController(\n            IAutoReplyRuntimeService runtimeService,\n            ILogger<AutoReplyRuntimeController> logger)\n        {\n            _runtimeService = runtimeService;\n            _logger = logger;\n        }\n\n        // 🔁 Runtime button reply based on keyword (used in message click)\n        [HttpPost(\"button-click\")]\n        public async Task<IActionResult> HandleButtonClick([FromBody] AutoReplyButtonClickDto dto)\n        {\n            var businessId = ClaimsBusinessDetails.GetBusinessId(User);\n\n            _logger.LogInformation(\"🔘 Button clicked: BusinessId={BusinessId}, Phone={Phone}, Button={ButtonText}, RefMsg={RefMessageId}\",\n                businessId, dto.Phone, dto.ButtonText, dto.RefMessageId?.ToString() ?? \"null\");\n\n            await _runtimeService.TryRunAutoReplyFlowByButtonAsync(\n                businessId,\n                dto.Phone,\n                dto.ButtonText,\n                dto.RefMessageId\n            );\n\n            return Ok(new { success = true });\n        }\n\n        // 🧪 Manual test (canvas-based flow trigger)\n        [HttpPost(\"flow-by-button\")]\n        public async Task<IActionResult> TriggerFlowByButton([FromBody] AutoReplyButtonClickDto dto)\n        {\n            if (string.IsNullOrWhiteSpace(dto.Phone) || string.IsNullOrWhiteSpace(dto.ButtonText))\n                return BadRequest(\"Phone and ButtonText are required.\");\n\n            try\n            {\n                _logger.LogInformation(\"🚀 Triggering flow from button: FlowId={FlowId}, BusinessId={BusinessId}, ContactId={ContactId}, Phone={Phone}, ButtonText={ButtonText}\",\n                    dto.FlowId, dto.BusinessId, dto.ContactId, dto.Phone, dto.ButtonText);\n\n                await _runtimeService.RunFlowFromButtonAsync(\n                    dto.FlowId,\n                    dto.BusinessId,\n                    dto.ContactId,\n                    dto.Phone,\n                    dto.ButtonText.Trim()\n                );\n\n                return Ok(new\n                {\n                    success = true,\n                    flowId = dto.FlowId,\n                    contactId = dto.ContactId,\n                    triggeredAt = DateTime.UtcNow\n                });\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"❌ Failed to trigger flow from button click: FlowId={FlowId}, Phone={Phone}, Button={ButtonText}\",\n                    dto.FlowId, dto.Phone, dto.ButtonText);\n\n                return StatusCode(500, \"Internal server error\");\n            }\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Controllers/TemplatesController.cs",
      "sha256": "555d0e0c3deaa65e82290ddcf55e06bb4fa67bbcf43e5b9d56ea5109f7c236b8",
      "language": "csharp",
      "size": 995,
      "content": "using Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Features.TemplateMessages.DTOs;\n\nnamespace xbytechat.api.Features.TemplateMessages.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    public class TemplatesController : ControllerBase\n    {\n        private static readonly List<TemplateDto> MockTemplates = new()\n        {\n            new TemplateDto\n            {\n                Id = Guid.NewGuid(),\n                Name = \"Welcome Template\",\n                Placeholders = 2\n            },\n            new TemplateDto\n            {\n                Id = Guid.NewGuid(),\n                Name = \"Offer Reminder\",\n                Placeholders = 1\n            },\n            new TemplateDto\n            {\n                Id = Guid.NewGuid(),\n                Name = \"Follow Up\",\n                Placeholders = 3\n            }\n        };\n\n        [HttpGet]\n        public ActionResult<List<TemplateDto>> GetAll()\n        {\n            return Ok(MockTemplates);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/DTOs/AutoReplyButtonClickDto.cs",
      "sha256": "c33e345f9a02ff4d627ba42ba92505f5819a034035b07bde678784a244b9d6ac",
      "language": "csharp",
      "size": 412,
      "content": "namespace xbytechat.api.Features.AutoReplyBuilder.DTOs\n{\n    public class AutoReplyButtonClickDto\n    {\n        public Guid FlowId { get; set; }\n        public Guid BusinessId { get; set; }\n        public Guid ContactId { get; set; }\n        public string Phone { get; set; } = string.Empty;\n        public string ButtonText { get; set; } = string.Empty;\n        public Guid? RefMessageId { get; set; }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/DTOs/AutoReplyLogDto.cs",
      "sha256": "4674e27873c9ca6a52ab8c85ac1fb97864c6a1e653138b78096a19b3b230124e",
      "language": "csharp",
      "size": 596,
      "content": "using System;\n\nnamespace xbytechat.api.Features.AutoReplyBuilder.DTOs\n{\n    public class AutoReplyLogDto\n    {\n        public Guid Id { get; set; }\n        public Guid BusinessId { get; set; }\n        public Guid ContactId { get; set; }\n\n        public string TriggerType { get; set; } = \"rule\"; // or \"flow\"\n        public string TriggerKeyword { get; set; } = string.Empty;\n        public string ReplyContent { get; set; } = string.Empty;\n\n        public DateTime TriggeredAt { get; set; }\n\n        public string? FlowName { get; set; }\n\n        public Guid? MessageLogId { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/DTOs/AutoReplyRuleDto.cs",
      "sha256": "47945e41d0ce9fc41bf7949aea8b58a0caf3bb5083fae0bc6d4815ea846d23ab",
      "language": "csharp",
      "size": 783,
      "content": "using System;\n\nnamespace xbytechat.api.Features.AutoReplyBuilder.DTOs\n{\n    /// <summary>\n    /// DTO used to create or retrieve AutoReplyRule.\n    /// </summary>\n    public class AutoReplyRuleDto\n    {\n        public Guid? Id { get; set; } // Nullable to allow re-use for Create and Update\n        public string TriggerKeyword { get; set; } = string.Empty;\n        public string ReplyMessage { get; set; } = string.Empty;\n        public string? MediaUrl { get; set; } // Optional media\n        public int Priority { get; set; } = 0; // Lower = higher priority\n        public bool IsActive { get; set; } = true;\n\n        // Audit Fields (optional for now, useful for admin UI)\n        public DateTime? CreatedAt { get; set; }\n        public DateTime? UpdatedAt { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/DTOs/FlowNodeConfigs/ButtonChoiceNodeConfig.cs",
      "sha256": "a573ed18c3b3cce438f3f126b958408f9c6245ac01be98c3db1d0c4a92adbb18",
      "language": "csharp",
      "size": 577,
      "content": "namespace xbytechat.api.Features.AutoReplyBuilder.DTOs.FlowNodeConfigs\n{\n    public class ButtonChoiceNodeConfig\n    {\n        public string PromptText { get; set; } = \"Please choose an option:\";\n\n        public List<ButtonOption> Options { get; set; } = new();\n    }\n\n    public class ButtonOption\n    {\n        public string Label { get; set; } = string.Empty;\n        public string Value { get; set; } = string.Empty;\n\n        // Optional metadata to control button behavior\n        public string? NextStepHint { get; set; } // Can guide user or be used for logging\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/DTOs/FlowNodeConfigs/ConditionNodeConfig.cs",
      "sha256": "836736c40f25f700d3a84836ee147930568713f5f623bcdc1569b42ff5b4432e",
      "language": "csharp",
      "size": 306,
      "content": "using System.Collections.Generic;\nnamespace xbytechat.api.Features.AutoReplyBuilder.DTOs.FlowNodeConfigs\n{\n    public class ConditionNodeConfig\n    {\n    \n        public string InputKey { get; set; } = \"buttonText\";\n\n        public Dictionary<string, string> PathMap { get; set; } = new();\n       \n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/DTOs/FlowNodeConfigs/DecisionNodeConfig.cs",
      "sha256": "5575668b5865a5bb2847165208e60278c44386e8f710abb968606e22bb52fe70",
      "language": "csharp",
      "size": 418,
      "content": "namespace xbytechat.api.Features.AutoReplyBuilder.DTOs.FlowNodeConfigs\n{\n    public class DecisionNodeConfig\n    {\n        public string ConditionType { get; set; } = \"keyword\"; // or \"tag\", \"time\", \"plan\", etc.\n        public string Parameter { get; set; } = string.Empty;   // e.g. \"yes\", \"vip\", \"evening\"\n        public string SourceChannel { get; set; } = \"whatsapp\"; // Optional for multi-channel control\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/DTOs/FlowNodeConfigs/FormInputNodeConfig.cs",
      "sha256": "34b1ef9a54bc19dbb2163a80371edaf8d5bf75420e9924e90e82762fa4831216",
      "language": "csharp",
      "size": 596,
      "content": "namespace xbytechat.api.Features.AutoReplyBuilder.DTOs.FlowNodeConfigs\n{\n    public class FormInputNodeConfig\n    {\n        public string QuestionText { get; set; } = \"Please enter your response:\";\n\n        public string FieldKey { get; set; } = \"customer_name\";\n        // Used for storing user response under a label\n\n        public string? ValidationRegex { get; set; }\n        // Optional, e.g., @\"^[0-9]{10}$\" for phone numbers\n\n        public string? PlaceholderHint { get; set; }\n        // e.g., \"Full Name\", \"10-digit Phone\"\n\n        public bool IsRequired { get; set; } = true;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/DTOs/FlowNodeConfigs/FormNodeConfig.cs",
      "sha256": "f839475742eb0fc23ab0c6e58e1f23a0583e4b649301ac588feb0808dd1c243d",
      "language": "csharp",
      "size": 818,
      "content": "using System.Collections.Generic;\nnamespace xbytechat.api.Features.AutoReplyBuilder.DTOs.FlowNodeConfigs\n{\n    public class FormNodeConfig\n    {\n        public string Title { get; set; } = \"Please fill out this form\";\n\n        public List<FormFieldConfig> Fields { get; set; } = new();\n\n        public bool SaveToContact { get; set; } = true; // Whether to update contact info\n\n        public string? SubmitMessage { get; set; } = \"Thanks for submitting!\";\n    }\n\n    public class FormFieldConfig\n    {\n        public string Key { get; set; } = string.Empty;      // contactName, email, phone\n        public string Label { get; set; } = string.Empty;    // \"Your Name\"\n        public string Type { get; set; } = \"text\";           // text, number, email, etc.\n        public bool Required { get; set; } = true;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/DTOs/FlowNodeConfigs/ForwardToAgentNodeConfig.cs",
      "sha256": "486eab52256f3ee2bfea5f06ada3bf8fade4f055f1012e4a1291ac0e61c9f35c",
      "language": "csharp",
      "size": 268,
      "content": "namespace xbytechat.api.Features.AutoReplyBuilder.DTOs.FlowNodeConfigs\n{\n    public class ForwardToAgentNodeConfig\n    {\n        public string? NoteToAgent { get; set; } // Optional instruction for agent\n        public bool MarkAsUrgent { get; set; } = false;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/DTOs/FlowNodeConfigs/NodeIconMap.cs",
      "sha256": "e56ce9b9bdedf03682aaa6c56815fb85dd510ecd2ec1e4c82f53c0fa5c8f9401",
      "language": "csharp",
      "size": 591,
      "content": "namespace xbytechat.api.Features.AutoReplyBuilder.DTOs.FlowNodeConfigs\n{\n    public class NodeIconMap\n    {\n        public static readonly Dictionary<string, string> IconMap = new()\n        {\n            { NodeTypeEnum.Message, \"🗨️\" },\n            { NodeTypeEnum.Template, \"📄\" },\n            { NodeTypeEnum.Tag, \"🏷️\" },\n            { NodeTypeEnum.Wait, \"⏱️\" },\n            { NodeTypeEnum.ButtonChoice, \"🔘\" },\n            { NodeTypeEnum.Branch, \"🌿\" },\n            { NodeTypeEnum.AgentHandoff, \"👨‍💼\" },\n            { NodeTypeEnum.End, \"⛔\" }\n        };\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/DTOs/FlowNodeConfigs/NodeTypeEnum.cs",
      "sha256": "d21739b3b7651f2a026a4e412de76d45fe215ae50907b0c7ee025bee0c1ed189",
      "language": "csharp",
      "size": 572,
      "content": "namespace xbytechat.api.Features.AutoReplyBuilder.DTOs.FlowNodeConfigs\n{\n    public class NodeTypeEnum\n    {\n        public const string Message = \"message\";\n        public const string Template = \"template\";\n        public const string Tag = \"tag\";\n        public const string Wait = \"wait\";\n        public const string ButtonChoice = \"button_choice\";\n        public const string Branch = \"branch\";\n        public const string End = \"end\"; // Optional: Used for flow exit\n        public const string AgentHandoff = \"agent_handoff\"; // Optional: Transfer to human\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/DTOs/RenameFlowDto.cs",
      "sha256": "c2ad4577f121df77190a9463e0eb6528c20054bd0901e7bc9a355aedfb53031c",
      "language": "csharp",
      "size": 146,
      "content": "namespace xbytechat.api.Features.AutoReplyBuilder.DTOs\n{\n    public class RenameFlowDto\n    {\n        public string NewName { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/DTOs/SaveFlowDto.cs",
      "sha256": "b4b9d49533bad3114236c255a28ecc08bc82a01f1141b981146f320c76cc39f4",
      "language": "csharp",
      "size": 2315,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.Features.AutoReplyBuilder.Flows.DTOs\n{\n    public class SaveFlowDto\n    {\n        public Guid Id { get; set; }\n        public Guid BusinessId { get; set; }\n        public string Name { get; set; }\n        public string? TriggerKeyword { get; set; }\n        public List<NodeDto> Nodes { get; set; } = new();\n        public List<EdgeDto> Edges { get; set; } = new();\n        public DateTime CreatedAt { get; set; }\n\n        public string? IndustryTag { get; set; }     // e.g. \"restaurant\", \"clinic\", etc.\n        public string? UseCase { get; set; }         // e.g. \"Order Flow\", \"Appointment Flow\"\n        public bool IsDefaultTemplate { get; set; } = false; // Flag for prebuilt templates\n\n    }\n\n    public class NodeDto\n    {\n        public string Id { get; set; } = string.Empty;\n        public string Type { get; set; } = string.Empty;\n        public AutoPositionDto Position { get; set; } = new();\n        public NodeDataDto Data { get; set; } = new();\n    }\n\n    public class AutoPositionDto\n    {\n        public double X { get; set; }\n        public double Y { get; set; }\n    }\n\n    public class NodeDataDto\n    {\n        public string Label { get; set; } = string.Empty;\n        public object Config { get; set; } = new { };\n    }\n\n    public class EdgeDto\n    {\n        public string Id { get; set; } = string.Empty;\n        public string Source { get; set; } = string.Empty;\n        public string Target { get; set; } = string.Empty;\n        public string SourceNodeId { get; set; } = string.Empty;\n        public string TargetNodeId { get; set; } = string.Empty;\n        public string SourceHandle { get; set; } = string.Empty;\n        public string TargetHandle { get; set; } = string.Empty;\n    }\n}\n\n\n//using System;\n\n//namespace xbytechat.api.Features.AutoReplyBuilder.Flows.DTOs\n//{\n//    public class SaveFlowDto\n//    {\n//        public Guid Id { get; set; }\n//        public Guid BusinessId { get; set; }\n//        public string Name { get; set; } = string.Empty;\n//        public List<Dictionary<string, object>> Nodes { get; set; }\n\n//        public List<Dictionary<string, object>> Edges { get; set; }\n//        public DateTime CreatedAt { get; set; }\n//        public string? TriggerKeyword { get; set; }\n\n//    }\n//}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/DTOs/TemplateDto.cs",
      "sha256": "42ae32842447bb89f8178a8bae3c490d1fe646b526c27cbe72571e23536f7116",
      "language": "csharp",
      "size": 240,
      "content": "namespace xbytechat.api.Features.TemplateMessages.DTOs\n{\n    public class TemplateDto\n    {\n        public Guid Id { get; set; }\n        public string Name { get; set; } = string.Empty;\n        public int Placeholders { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Flows/DTOs/FlowNodeConfigs/AutoReplyEdgeDto.cs",
      "sha256": "5cbac1daff177794f7ae69aabf6b323f279f0b7132dc060e462a91226849f868",
      "language": "csharp",
      "size": 264,
      "content": "namespace xbytechat.api.Features.AutoReplyBuilder.Flows.DTOs.FlowNodeConfigs\n{\n    public class AutoReplyEdgeDto\n    {\n        public string Id { get; set; }\n        public string SourceNodeId { get; set; }\n        public string TargetNodeId { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Flows/DTOs/FlowNodeConfigs/MessageConfig.cs",
      "sha256": "6e7673134b9b3fabb432529dd4b510007ff1d934f016b3a2d831a4503d01c2c7",
      "language": "csharp",
      "size": 201,
      "content": "// MessageConfig.cs\nnamespace xbytechat.api.Features.AutoReplyBuilder.Flows.DTOs.FlowNodeConfigs\n{\n    public class MessageConfig\n    {\n        public string Text { get; set; } = string.Empty;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Flows/DTOs/FlowNodeConfigs/RuntimeConfigs.cs",
      "sha256": "280793d810ae7ce0f016f2671b3627cd52a4029b6ea574d0fee20e0c0e11e5ae",
      "language": "csharp",
      "size": 125,
      "content": "namespace xbytechat.api.Features.AutoReplyBuilder.Flows.DTOs.FlowNodeConfigs\n{\n    public class RuntimeConfigs\n    {\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Flows/DTOs/FlowNodeConfigs/TagNodeConfig.cs",
      "sha256": "d9fade9fca5845b7cb33279a01288a4dd94a90aaaed58d384a778209656b5ead",
      "language": "csharp",
      "size": 197,
      "content": "// TagConfig.cs\nnamespace xbytechat.api.Features.AutoReplyBuilder.Flows.DTOs.FlowNodeConfigs\n{\n    public class TagNodeConfig\n    {\n        public List<string> Tags { get; set; } = new();\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Flows/DTOs/FlowNodeConfigs/TemplateConfig.cs",
      "sha256": "5c7ea8f78b131705f6bccf1ced0e21a754dadf67bbd6420696995f565c07767a",
      "language": "csharp",
      "size": 682,
      "content": "namespace xbytechat.api.Features.AutoReplyBuilder.Flows.DTOs.FlowNodeConfigs\n{\n    public class TemplateConfig\n    {\n        public string TemplateName { get; set; } = string.Empty;\n        public List<string> Placeholders { get; set; } = new();\n        public string? Language { get; set; } = \"en_US\";\n        public string? ImageUrl { get; set; }\n        public List<TemplateButtonDto>? MultiButtons { get; set; } = new();\n    }\n\n    public class TemplateButtonDto\n    {\n        public string ButtonText { get; set; } = string.Empty;\n        public string ButtonType { get; set; } = \"url\"; // or \"quick_reply\"\n        public string TargetUrl { get; set; } = string.Empty;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Flows/DTOs/FlowNodeConfigs/WaitConfig.cs",
      "sha256": "afe336952d0d4959422bbbc499884b286291888fcbd64dd068f26013160261c6",
      "language": "csharp",
      "size": 179,
      "content": "// WaitConfig.cs\nnamespace xbytechat.api.Features.AutoReplyBuilder.Flows.DTOs.FlowNodeConfigs\n{\n    public class WaitConfig\n    {\n        public int Seconds { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Flows/Enum/NodeTypes.cs",
      "sha256": "94b210bd5bbbbce823c3a1beb8172eddf708305bfbb8b897d1e3c7ef10097b36",
      "language": "csharp",
      "size": 538,
      "content": "namespace xbytechat.api.Features.AutoReplyBuilder.Flows.Enum\n{\n    public class NodeTypes\n    {\n        public const string Start = \"start\";\n        public const string Message = \"message\";\n        public const string Template = \"template\";\n        public const string Wait = \"wait\";\n        public const string Tag = \"tag\";\n        public const string Agent = \"agent\";\n        public const string Condition = \"condition\"; // Coming soon\n        public const string Form = \"form\";           // For “Ask Name”, “Ask Email”\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Models/AutoReplyFlow.cs",
      "sha256": "2825905f983da1290a44badeda57c8ff26c8920d7fa13e7ebd85dd0da2e0aaca",
      "language": "csharp",
      "size": 1021,
      "content": "using System;\nusing System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.Features.AutoReplyBuilder.Flows.Models\n{\n    public class AutoReplyFlow\n    {\n        [Key]\n        public Guid Id { get; set; }\n\n        public Guid BusinessId { get; set; }\n\n        [Required]\n        public string Name { get; set; } = string.Empty;\n\n        [Required]\n        public string NodesJson { get; set; } = string.Empty;\n\n        [Required]\n        public string EdgesJson { get; set; } = string.Empty;\n\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n        public string? TriggerKeyword { get; set; }\n\n        public bool IsActive { get; set; } = true;\n\n        public string? IndustryTag { get; set; }    // e.g., \"restaurant\", \"clinic\", \"education\"\n        public string? UseCase { get; set; }        // e.g., \"Order Flow\", \"Booking Flow\"\n        public bool IsDefaultTemplate { get; set; } = false; // Flag to indicate system-provided template\n        public string? Keyword { get; set; }\n\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Models/AutoReplyFlowEdge.cs",
      "sha256": "7996bdb8fa1917943e90dad9ad4225984a34b6342eb153028849b30ca63abd7f",
      "language": "csharp",
      "size": 763,
      "content": "using System.ComponentModel.DataAnnotations.Schema;\nusing System.ComponentModel.DataAnnotations;\nusing xbytechat.api.Features.AutoReplyBuilder.Flows.Models;\n\nnamespace xbytechat.api.Features.AutoReplyBuilder.Models\n{\n    public class AutoReplyFlowEdge\n    {\n        [Key]\n        public Guid Id { get; set; }\n\n        [Required]\n        public Guid FlowId { get; set; }\n\n        [ForeignKey(\"FlowId\")]\n        public AutoReplyFlow Flow { get; set; }\n\n        public string SourceNodeId { get; set; } = string.Empty;\n        public string TargetNodeId { get; set; } = string.Empty;\n    \n        public string? SourceHandle { get; set; }\n        public string? TargetHandle { get; set; }\n\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n    }\n\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Models/AutoReplyFlowNode.cs",
      "sha256": "88a50d45fe3b72f6c3bc0593104b7ee549180c842628cb3d9048c5227a025871",
      "language": "csharp",
      "size": 1013,
      "content": "using System.ComponentModel.DataAnnotations;\nusing System.ComponentModel.DataAnnotations.Schema;\nusing xbytechat.api.Features.AutoReplyBuilder.Flows.Models;\n\nnamespace xbytechat.api.Features.AutoReplyBuilder.Models\n{\n    public class AutoReplyFlowNode\n    {\n        [Key]\n        public Guid Id { get; set; }\n\n        [Required]\n        public Guid FlowId { get; set; }\n\n        [ForeignKey(\"FlowId\")]\n        public AutoReplyFlow Flow { get; set; }\n\n        // 🔄 Use a constrained string or enum (recommended for future)\n        [Required]\n        public string NodeType { get; set; } = string.Empty;\n\n        public string Label { get; set; } = string.Empty;\n\n        public string? NodeName { get; set; } // 🆕 Optional internal label for debugging\n\n        [Required]\n        public string ConfigJson { get; set; } = string.Empty;\n\n        public Position Position { get; set; } = new();\n\n        public int Order { get; set; }\n\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Models/AutoReplyLog.cs",
      "sha256": "d2949264f0ac5b81395d2dee6578df20759d95d300da30d5f0f9003e0ed1c5eb",
      "language": "csharp",
      "size": 915,
      "content": "using System;\nusing System.ComponentModel.DataAnnotations;\nusing System.ComponentModel.DataAnnotations.Schema;\n\nnamespace xbytechat.api.Features.AutoReplyBuilder.Models\n{\n    [Table(\"AutoReplyLogs\")]\n    public class AutoReplyLog\n    {\n        [Key]\n        public Guid Id { get; set; }\n\n        public Guid BusinessId { get; set; }\n        public Guid ContactId { get; set; }\n\n        public string TriggerKeyword { get; set; } = string.Empty; // e.g., \"hi\", \"price\"\n        public string TriggerType { get; set; } = string.Empty;     // \"flow\" or \"rule\"\n\n        public string ReplyContent { get; set; } = string.Empty;    // Plaintext summary of what was sent\n        public string? FlowName { get; set; }                       // Nullable if rule-based\n\n        public Guid? MessageLogId { get; set; }                     // Optional link to MessageLog\n        public DateTime TriggeredAt { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Models/AutoReplyRule.cs",
      "sha256": "c3049863f7add2dfd09dd962dbdbc904585fa5db4e12ac189193077bfee08a78",
      "language": "csharp",
      "size": 1137,
      "content": "using System;\nusing System.ComponentModel.DataAnnotations;\nusing System.ComponentModel.DataAnnotations.Schema;\nusing xbytechat.api.Features.AutoReplyBuilder.Flows.Models;\n\nnamespace xbytechat.api.Features.AutoReplyBuilder.Models\n{\n    public class AutoReplyRule\n    {\n        [Key]\n        public Guid Id { get; set; }\n\n        public Guid BusinessId { get; set; }\n\n        public string TriggerKeyword { get; set; } = string.Empty;\n\n        public string ReplyMessage { get; set; } = string.Empty;\n\n        public string? MediaUrl { get; set; }\n\n        public int Priority { get; set; }\n\n        public bool IsActive { get; set; } = true;\n\n        public DateTime CreatedAt { get; set; }\n\n        public DateTime? UpdatedAt { get; set; }\n\n        public string? FlowName { get; set; }\n\n        // ✅ NEW: Link to the flow\n        public Guid? FlowId { get; set; }\n\n        [ForeignKey(\"FlowId\")]\n        public AutoReplyFlow? Flow { get; set; }\n\n        public string? IndustryTag { get; set; } // e.g., \"restaurant\", \"clinic\", \"real_estate\"\n        public string? SourceChannel { get; set; } // e.g., \"whatsapp\", \"instagram\"\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Models/FlowExecutionContext.cs",
      "sha256": "0d3e6415c151099db94a6f0f6dc8f695fd31492808dc09079919950efedf0776",
      "language": "csharp",
      "size": 494,
      "content": "using xbytechat.api.Features.AutoReplyBuilder.Flows.Models;\n\nnamespace xbytechat.api.Features.AutoReplyBuilder.Models\n{\n    public class FlowExecutionContext\n    {\n        public AutoReplyFlow Flow { get; set; } = null!;\n        public Guid BusinessId { get; set; }\n        public Guid ContactId { get; set; }\n        public string ContactPhone { get; set; } = null!;\n        public string SourceChannel { get; set; } = \"whatsapp\";\n        public string IndustryTag { get; set; } = \"\";\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Models/FlowNode.cs",
      "sha256": "8991ad6277d58a2785f6a93fd8b8ca815af4ce80351d38f30aaf47890909471f",
      "language": "csharp",
      "size": 318,
      "content": "namespace xbytechat.api.Features.AutoReplyBuilder.Models\n{\n    public class FlowNode\n    {\n        public string Id { get; set; }\n        public string Type { get; set; }\n        public Position Position { get; set; }\n        public Dictionary<string, object> Data { get; set; }  // This should capture config\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Models/FlowRunResult.cs",
      "sha256": "67982580319a635214c13b2ec05cc279d9afc21fdeb1224248a8060036e27f5c",
      "language": "csharp",
      "size": 463,
      "content": "// File: Features/AutoReplyBuilder/Models/FlowRunResult.cs\n\nusing System;\n\nnamespace xbytechat.api.Features.AutoReplyBuilder.Models\n{\n    /// <summary>\n    /// Encapsulates the result of running a visual flow, including agent handoff status.\n    /// </summary>\n    public class FlowRunResult\n    {\n        public bool NeedsAgent { get; set; } = false;\n\n\n        public Guid? HandoffNodeId { get; set; }\n\n        public string? ContextJson { get; set; }\n\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Models/Position.cs",
      "sha256": "0c352c43f4dfcebdc462622ca0acdcd8c1eaafa07a91a70804793d8c76724201",
      "language": "csharp",
      "size": 176,
      "content": "namespace xbytechat.api.Features.AutoReplyBuilder.Models\n{\n    public class Position\n    {\n        public double X { get; set; }\n        public double Y { get; set; }\n    }\n\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Repositories/AutoReplyFlowRepository.cs",
      "sha256": "d919b1d695c3c29ccc653b806d4884197b3d52fb9eb5f86c0f32f893eb198671",
      "language": "csharp",
      "size": 4350,
      "content": "using Microsoft.EntityFrameworkCore;\nusing xbytechat.api;\nusing xbytechat.api.Features.AutoReplyBuilder.Flows.Models;\nusing xbytechat.api.Features.AutoReplyBuilder.Flows.Repositories;\nusing xbytechat.api.Features.AutoReplyBuilder.Models;\n\npublic class AutoReplyFlowRepository : IAutoReplyFlowRepository\n{\n    private readonly AppDbContext _context;\n    private readonly ILogger<AutoReplyFlowRepository> _logger;\n\n    public AutoReplyFlowRepository(AppDbContext context, ILogger<AutoReplyFlowRepository> logger)\n    {\n        _context = context;\n        _logger = logger;\n    }\n\n    public async Task<AutoReplyFlow> SaveAsync(AutoReplyFlow flow)\n    {\n        _context.AutoReplyFlows.Add(flow);\n        try\n        {\n            await _context.SaveChangesAsync();\n        }\n        catch (DbUpdateException ex)\n        {\n            _logger.LogError(ex, \"❌ Save failed: {0}\", ex.InnerException?.Message);\n            throw;\n        }\n\n        return flow;\n    }\n\n    public async Task SaveNodesAndEdgesAsync(IEnumerable<AutoReplyFlowNode> nodes, IEnumerable<AutoReplyFlowEdge> edges)\n    {\n        _context.AutoReplyFlowNodes.AddRange(nodes);\n        _context.AutoReplyFlowEdges.AddRange(edges);\n        try\n        {\n            await _context.SaveChangesAsync();\n        }\n        catch (DbUpdateException ex)\n        {\n            _logger.LogError(ex, \"❌ Save failed: {0}\", ex.InnerException?.Message);\n            throw;\n        }\n\n    }\n\n    public async Task<List<AutoReplyFlow>> GetAllByBusinessIdAsync(Guid businessId)\n    {\n        return await _context.AutoReplyFlows\n            .Where(f => f.BusinessId == businessId)\n            .OrderByDescending(f => f.CreatedAt)\n            .ToListAsync();\n    }\n\n    public async Task<AutoReplyFlow?> GetByIdAsync(Guid flowId, Guid businessId)\n    {\n        return await _context.AutoReplyFlows\n            .FirstOrDefaultAsync(f => f.Id == flowId && f.BusinessId == businessId);\n    }\n\n    public async Task<int> GetFlowCountAsync(Guid businessId)\n    {\n        return await _context.AutoReplyFlows.CountAsync(f => f.BusinessId == businessId);\n    }\n\n    public async Task<bool> RenameFlowAsync(Guid id, string newName)\n    {\n        var flow = await _context.AutoReplyFlows.FindAsync(id);\n        if (flow == null) return false;\n\n        flow.Name = newName;\n        try\n        {\n            await _context.SaveChangesAsync();\n        }\n        catch (DbUpdateException ex)\n        {\n            _logger.LogError(ex, \"❌ Save failed: {0}\", ex.InnerException?.Message);\n            throw;\n        }\n\n        return true;\n    }\n\n    public async Task<bool> DeleteFlowAsync(Guid id, Guid businessId)\n    {\n        var flow = await _context.AutoReplyFlows\n            .FirstOrDefaultAsync(f => f.Id == id && f.BusinessId == businessId);\n\n        if (flow == null) return false;\n\n        _context.AutoReplyFlows.Remove(flow);\n        try\n        {\n            await _context.SaveChangesAsync();\n        }\n        catch (DbUpdateException ex)\n        {\n            _logger.LogError(ex, \"❌ Save failed: {0}\", ex.InnerException?.Message);\n            throw;\n        }\n\n        return true;\n    }\n    public async Task<List<AutoReplyFlowNode>> GetNodesByFlowIdAsync(Guid flowId)\n    {\n        return await _context.AutoReplyFlowNodes\n            .Where(n => n.FlowId == flowId)\n            .ToListAsync();\n    }\n\n    public async Task<List<AutoReplyFlowEdge>> GetEdgesByFlowIdAsync(Guid flowId)\n    {\n        return await _context.AutoReplyFlowEdges\n            .Where(e => e.FlowId == flowId)\n            .ToListAsync();\n    }\n    public async Task<AutoReplyFlow?> FindFlowByKeywordAsync(Guid businessId, string keyword)\n    {\n        return await _context.AutoReplyFlows\n            .Where(f => f.BusinessId == businessId && f.IsActive && f.TriggerKeyword == keyword)\n            .OrderByDescending(f => f.CreatedAt)\n            .FirstOrDefaultAsync();\n    }\n    public async Task<List<AutoReplyFlowNode>> GetStructuredNodesAsync(Guid flowId)\n    {\n        return await _context.AutoReplyFlowNodes\n            .Where(n => n.FlowId == flowId)\n            .ToListAsync();\n    }\n\n    public async Task<List<AutoReplyFlowEdge>> GetStructuredEdgesAsync(Guid flowId)\n    {\n        return await _context.AutoReplyFlowEdges\n            .Where(e => e.FlowId == flowId)\n            .ToListAsync();\n    }\n\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Repositories/AutoReplyLogRepository.cs",
      "sha256": "4a8777aecfb95fef141063dfa3475992a3848fdd582209819e66ab552d045f71",
      "language": "csharp",
      "size": 1569,
      "content": "using System.Threading.Tasks;\nusing xbytechat.api.Features.AutoReplyBuilder.DTOs;\nusing xbytechat.api.Models;\nusing xbytechat.api.Shared;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api.Features.AutoReplyBuilder.Models;\n\nnamespace xbytechat.api.Features.AutoReplyBuilder.Repositories\n{\n    public class AutoReplyLogRepository : IAutoReplyLogRepository\n    {\n        private readonly AppDbContext _context;\n        private readonly ILogger<AutoReplyLogRepository> _logger;\n\n        public AutoReplyLogRepository(AppDbContext context, ILogger<AutoReplyLogRepository> logger)\n        {\n            _context = context;\n            _logger = logger;\n        }\n\n        public async Task SaveAsync(AutoReplyLogDto dto)\n        {\n            try\n            {\n                var log = new AutoReplyLog\n                {\n                    Id = dto.Id,\n                    BusinessId = dto.BusinessId,\n                    ContactId = dto.ContactId,\n                    TriggerKeyword = dto.TriggerKeyword,\n                    TriggerType = dto.TriggerType,\n                    ReplyContent = dto.ReplyContent,\n                    TriggeredAt = dto.TriggeredAt,\n                    FlowName = dto.FlowName,\n                    MessageLogId = dto.MessageLogId\n                };\n\n                _context.AutoReplyLogs.Add(log);\n                await _context.SaveChangesAsync();\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"❌ Failed to save AutoReplyLog\");\n                throw;\n            }\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Repositories/AutoReplyRepository.cs",
      "sha256": "6339294423a06a5ebeacfa42db916a0e6fcac770f4082cb3db53569c2dd80483",
      "language": "csharp",
      "size": 4077,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.AutoReplyBuilder.Models;\n\nnamespace xbytechat.api.Features.AutoReplyBuilder.Repositories\n{\n    public class AutoReplyRepository : IAutoReplyRepository\n    {\n        private readonly AppDbContext _dbContext;\n\n        public AutoReplyRepository(AppDbContext dbContext)\n        {\n            _dbContext = dbContext;\n        }\n\n        public async Task<AutoReplyRule> AddAsync(AutoReplyRule rule)\n        {\n            _dbContext.AutoReplyRules.Add(rule);\n            await _dbContext.SaveChangesAsync();\n            return rule;\n        }\n\n        public async Task<IEnumerable<AutoReplyRule>> GetAllByBusinessIdAsync(Guid businessId)\n        {\n            return await _dbContext.AutoReplyRules\n                .Where(r => r.BusinessId == businessId && r.IsActive)\n                .OrderBy(r => r.Priority)\n                .ToListAsync();\n        }\n\n        public async Task<AutoReplyRule?> GetByIdAsync(Guid ruleId, Guid businessId)\n        {\n            return await _dbContext.AutoReplyRules\n                .FirstOrDefaultAsync(r => r.Id == ruleId && r.BusinessId == businessId);\n        }\n\n        public async Task<bool> UpdateAsync(AutoReplyRule rule)\n        {\n            _dbContext.AutoReplyRules.Update(rule);\n            return await _dbContext.SaveChangesAsync() > 0;\n        }\n\n        public async Task<bool> DeleteAsync(Guid ruleId, Guid businessId)\n        {\n            var rule = await GetByIdAsync(ruleId, businessId);\n            if (rule == null) return false;\n\n            _dbContext.AutoReplyRules.Remove(rule);\n            return await _dbContext.SaveChangesAsync() > 0;\n        }\n\n        public async Task<AutoReplyRule?> MatchByKeywordAsync(Guid businessId, string incomingMessage)\n        {\n            return await _dbContext.AutoReplyRules\n                .Where(r => r.BusinessId == businessId && r.IsActive)\n                .OrderBy(r => r.Priority)\n                .FirstOrDefaultAsync(r => incomingMessage.Contains(r.TriggerKeyword));\n        }\n\n        public async Task<bool> LinkFlowToRuleAsync(Guid businessId, string keyword, Guid flowId, string? flowName)\n        {\n            var rule = await _dbContext.AutoReplyRules\n                .FirstOrDefaultAsync(r => r.BusinessId == businessId && r.TriggerKeyword.ToLower() == keyword.ToLower());\n\n            if (rule == null) return false;\n\n            rule.FlowId = flowId;\n            rule.FlowName = flowName ?? \"\";\n            rule.UpdatedAt = DateTime.UtcNow;\n\n            await _dbContext.SaveChangesAsync();\n            return true;\n        }\n        public async Task<AutoReplyRule> UpsertRuleLinkedToFlowAsync(Guid businessId, string keyword, Guid flowId, string? flowName)\n        {\n            // Ensure keyword is normalized\n            var normalizedKeyword = keyword.ToLower().Trim();\n\n            var rule = await _dbContext.AutoReplyRules\n                .FirstOrDefaultAsync(r => r.BusinessId == businessId && r.TriggerKeyword.ToLower() == normalizedKeyword);\n\n            if (rule != null)\n            {\n                // Update existing rule\n                rule.FlowId = flowId;\n                rule.FlowName = flowName ?? \"\";\n                rule.UpdatedAt = DateTime.UtcNow;\n            }\n            else\n            {\n                // Create new rule\n                rule = new AutoReplyRule\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    TriggerKeyword = normalizedKeyword,\n                    FlowId = flowId,\n                    FlowName = flowName ?? \"\",\n                    CreatedAt = DateTime.UtcNow,\n                    IsActive = true,\n                    Priority = 1,\n                    ReplyMessage = \"\" // Fallback (optional)\n                };\n\n                _dbContext.AutoReplyRules.Add(rule);\n            }\n\n            await _dbContext.SaveChangesAsync();\n            return rule;\n        }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Repositories/FlowRepository.cs",
      "sha256": "215b4fc5005e126adf33375390d0ac254a146dbdae11aa8c98eb52aa9054551b",
      "language": "csharp",
      "size": 111,
      "content": "namespace xbytechat.api.Features.AutoReplyBuilder.Repositories\n{\n    public class FlowRepository\n    {\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Repositories/IAutoReplyFlowRepository.cs",
      "sha256": "f78ae431c2892c49cc0844c2f19e5df301598c964326722b3ca52aec7e9ba61d",
      "language": "csharp",
      "size": 1161,
      "content": "using System.Threading.Tasks;\nusing xbytechat.api.Features.AutoReplyBuilder.Flows.Models;\nusing xbytechat.api.Features.AutoReplyBuilder.Models;\n\nnamespace xbytechat.api.Features.AutoReplyBuilder.Flows.Repositories\n{\n    public interface IAutoReplyFlowRepository\n    {\n        Task<AutoReplyFlow> SaveAsync(AutoReplyFlow flow);\n        Task<AutoReplyFlow?> GetByIdAsync(Guid flowId, Guid businessId);\n        Task<List<AutoReplyFlow>> GetAllByBusinessIdAsync(Guid businessId);\n        Task<int> GetFlowCountAsync(Guid businessId);\n        Task<bool> RenameFlowAsync(Guid id, string newName);\n        Task<bool> DeleteFlowAsync(Guid id, Guid businessId);\n        Task SaveNodesAndEdgesAsync(IEnumerable<AutoReplyFlowNode> nodes, IEnumerable<AutoReplyFlowEdge> edges);\n        Task<List<AutoReplyFlowNode>> GetNodesByFlowIdAsync(Guid flowId);\n        Task<List<AutoReplyFlowEdge>> GetEdgesByFlowIdAsync(Guid flowId);\n        Task<AutoReplyFlow?> FindFlowByKeywordAsync(Guid businessId, string keyword);\n        Task<List<AutoReplyFlowNode>> GetStructuredNodesAsync(Guid flowId);\n        Task<List<AutoReplyFlowEdge>> GetStructuredEdgesAsync(Guid flowId);\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Repositories/IAutoReplyLogRepository.cs",
      "sha256": "49f1ecf8c4ab7bb6a0122d7d98e22eb4cb6e2b4b522c99c3963ca64d57889264",
      "language": "csharp",
      "size": 255,
      "content": "using System.Threading.Tasks;\nusing xbytechat.api.Features.AutoReplyBuilder.DTOs;\n\nnamespace xbytechat.api.Features.AutoReplyBuilder.Repositories\n{\n    public interface IAutoReplyLogRepository\n    {\n        Task SaveAsync(AutoReplyLogDto logDto);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Repositories/IAutoReplyRepository.cs",
      "sha256": "136fdda2ad552eadc942d50774dc0ba7cf0796c507e703b6aa20f4fd64fd40d5",
      "language": "csharp",
      "size": 939,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.AutoReplyBuilder.Models;\n\nnamespace xbytechat.api.Features.AutoReplyBuilder.Repositories\n{\n    public interface IAutoReplyRepository\n    {\n        Task<AutoReplyRule> AddAsync(AutoReplyRule rule);\n        Task<IEnumerable<AutoReplyRule>> GetAllByBusinessIdAsync(Guid businessId);\n        Task<AutoReplyRule?> GetByIdAsync(Guid ruleId, Guid businessId);\n        Task<bool> UpdateAsync(AutoReplyRule rule);\n        Task<bool> DeleteAsync(Guid ruleId, Guid businessId);\n\n        // Runtime keyword match logic\n        Task<AutoReplyRule?> MatchByKeywordAsync(Guid businessId, string incomingMessage);\n        Task<bool> LinkFlowToRuleAsync(Guid businessId, string keyword, Guid flowId, string? flowName);\n        Task<AutoReplyRule> UpsertRuleLinkedToFlowAsync(Guid businessId, string keyword, Guid flowId, string? flowName);\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Repositories/IFlowRepository.cs",
      "sha256": "dc4b9a1195add53536172098cfd18c52a19a3a5c767ba81f25e2bceb2a483e14",
      "language": "csharp",
      "size": 112,
      "content": "namespace xbytechat.api.Features.AutoReplyBuilder.Repositories\n{\n    public class IFlowRepository\n    {\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Services/AutoReplyFlowService.cs",
      "sha256": "60a2f344bc7993fa13dd56c9514c142e4a3bb6100c4e6f48056178d09d8d71b4",
      "language": "csharp",
      "size": 24746,
      "content": "using Microsoft.Extensions.Logging;\nusing Newtonsoft.Json;\nusing System.Numerics;\nusing System.Text.Json;\nusing xbytechat.api.CRM.Interfaces;\nusing xbytechat.api.Features.AutoReplyBuilder.Flows.DTOs;\nusing xbytechat.api.Features.AutoReplyBuilder.Flows.DTOs.FlowNodeConfigs;\nusing xbytechat.api.Features.AutoReplyBuilder.Flows.Models;\nusing xbytechat.api.Features.AutoReplyBuilder.Flows.Repositories;\nusing xbytechat.api.Features.AutoReplyBuilder.Models;\nusing xbytechat.api.Features.AutoReplyBuilder.Repositories;\nusing xbytechat.api.Features.MessagesEngine.DTOs;\nusing xbytechat.api.Features.MessagesEngine.Services;\n\nnamespace xbytechat.api.Features.AutoReplyBuilder.Flows.Services\n{\n    public class AutoReplyFlowService : IAutoReplyFlowService\n    {\n        private readonly IAutoReplyFlowRepository _flowRepository;\n        private readonly ILogger<AutoReplyFlowService> _logger;\n        private readonly IMessageEngineService _messageService;\n        private readonly ITagService _tagService;\n        private readonly IAutoReplyRepository _autoReplyRepository;\n        public AutoReplyFlowService(IAutoReplyFlowRepository flowrepository, ILogger<AutoReplyFlowService> logger,\n            IMessageEngineService messageService, ITagService tagService, IAutoReplyRepository autoReplyRepository)\n        {\n            _flowRepository = flowrepository;\n            _logger = logger;\n            _messageService = messageService;\n            _tagService = tagService;\n            _autoReplyRepository = autoReplyRepository;\n        }\n\n        //public async Task<Guid> SaveFlowAsync(SaveFlowDto dto)\n        //{\n        //    _logger.LogInformation(\"🔄 Starting flow save for business {BusinessId} with keyword '{Keyword}'\", dto.BusinessId, dto.TriggerKeyword);\n\n        //    var flow = new AutoReplyFlow\n        //    {\n        //        Id = Guid.NewGuid(),\n        //        BusinessId = dto.BusinessId,\n        //        Name = dto.Name,\n        //        NodesJson = JsonConvert.SerializeObject(dto.Nodes),\n        //        EdgesJson = JsonConvert.SerializeObject(dto.Edges),\n        //        TriggerKeyword = dto.TriggerKeyword?.Trim().ToLower(),\n        //        IsActive = true,\n        //        CreatedAt = DateTime.UtcNow\n        //    };\n\n        //    var saved = await _flowRepository.SaveAsync(flow);\n        //    _logger.LogInformation(\"✅ Flow saved: {FlowId}\", saved.Id);\n\n        //    // ✅ Save parsed nodes\n        //    var parsedNodes = new List<AutoReplyFlowNode>();\n        //    var nodes = dto.Nodes as List<Dictionary<string, object>>;\n\n        //    if (nodes != null)\n        //    {\n        //        foreach (var nodeDict in nodes)\n        //        {\n        //            if (!nodeDict.ContainsKey(\"type\") || !nodeDict.ContainsKey(\"data\") || !nodeDict.ContainsKey(\"position\"))\n        //            {\n        //                _logger.LogWarning(\"⚠️ Skipped malformed node during flow save: {Node}\", JsonConvert.SerializeObject(nodeDict));\n        //                continue;\n        //            }\n\n        //            var data = nodeDict[\"data\"] as Dictionary<string, object>;\n        //            var positionDict = nodeDict[\"position\"] as Dictionary<string, object>;\n\n        //            var position = new Position\n        //            {\n        //                X = Convert.ToDouble(positionDict?[\"x\"] ?? 0),\n        //                Y = Convert.ToDouble(positionDict?[\"y\"] ?? 0)\n        //            };\n\n        //            parsedNodes.Add(new AutoReplyFlowNode\n        //            {\n        //                Id = Guid.NewGuid(),\n        //                FlowId = saved.Id,\n        //                NodeType = nodeDict[\"type\"]?.ToString() ?? \"\",\n        //                Label = data?[\"label\"]?.ToString() ?? \"\",\n        //                ConfigJson = JsonConvert.SerializeObject(data?[\"config\"] ?? new { }),\n        //                Position = position // ✅ strongly typed\n        //            });\n        //        }\n        //    }\n\n        //    _logger.LogInformation(\"🧩 Parsed {NodeCount} nodes\", parsedNodes.Count);\n\n        //    // ✅ Save parsed edges\n        //    var parsedEdges = new List<AutoReplyFlowEdge>();\n        //    var edges = dto.Edges as List<Dictionary<string, object>>;\n\n        //    if (edges != null)\n        //    {\n        //        foreach (var edgeDict in edges)\n        //        {\n        //            if (!edgeDict.ContainsKey(\"source\") || !edgeDict.ContainsKey(\"target\"))\n        //            {\n        //                _logger.LogWarning(\"⚠️ Skipped malformed edge during flow save: {Edge}\", JsonConvert.SerializeObject(edgeDict));\n        //                continue;\n        //            }\n\n        //            parsedEdges.Add(new AutoReplyFlowEdge\n        //            {\n        //                Id = Guid.NewGuid(),\n        //                FlowId = saved.Id,\n        //                SourceNodeId = edgeDict[\"source\"]?.ToString() ?? \"\",\n        //                TargetNodeId = edgeDict[\"target\"]?.ToString() ?? \"\",\n        //                CreatedAt = DateTime.UtcNow\n        //            });\n        //        }\n        //    }\n\n        //    _logger.LogInformation(\"🔗 Parsed {EdgeCount} edges\", parsedEdges.Count);\n\n        //    await _flowRepository.SaveNodesAndEdgesAsync(parsedNodes, parsedEdges);\n\n        //    _logger.LogInformation(\"✅ Node + edge persistence complete for flow {FlowId}\", saved.Id);\n\n        //    return saved.Id;\n        //}\n\n        //public async Task<Guid> SaveFlowAsync(SaveFlowDto dto)\n        //{\n        //    _logger.LogInformation(\"🔄 Starting flow save for business {BusinessId} with keyword '{Keyword}'\", dto.BusinessId, dto.TriggerKeyword);\n\n        //    // ✅ Step 1: Save main flow\n        //    var flow = new AutoReplyFlow\n        //    {\n        //        Id = Guid.NewGuid(),\n        //        BusinessId = dto.BusinessId,\n        //        Name = dto.Name?.Trim() ?? \"\",\n        //        NodesJson = JsonConvert.SerializeObject(dto.Nodes),\n        //        EdgesJson = JsonConvert.SerializeObject(dto.Edges),\n        //        TriggerKeyword = dto.TriggerKeyword?.Trim().ToLower(),\n        //        IsActive = true,\n        //        CreatedAt = DateTime.UtcNow\n        //    };\n\n        //    var saved = await _flowRepository.SaveAsync(flow);\n        //    _logger.LogInformation(\"✅ Flow saved: {FlowId}\", saved.Id);\n\n        //    // ✅ Step 2: Build ID map and parse nodes\n        //    var nodeIdMap = new Dictionary<string, Guid>();\n        //    var parsedNodes = new List<AutoReplyFlowNode>();\n\n        //    foreach (var n in dto.Nodes)\n        //    {\n        //        if (string.IsNullOrWhiteSpace(n.Id))\n        //        {\n        //            _logger.LogWarning(\"⚠️ Skipped node with missing Id\");\n        //            continue;\n        //        }\n\n        //        var internalNodeId = Guid.NewGuid();\n        //        nodeIdMap[n.Id] = internalNodeId;\n\n        //        parsedNodes.Add(new AutoReplyFlowNode\n        //        {\n        //            Id = internalNodeId,\n        //            FlowId = saved.Id,\n        //            NodeType = n.Type,\n        //            Label = n.Data?.Label ?? \"\",\n        //            ConfigJson = JsonConvert.SerializeObject(n.Data?.Config ?? new { }),\n        //            Position = new Position\n        //            {\n        //                X = n.Position?.X ?? 0,\n        //                Y = n.Position?.Y ?? 0\n        //            },\n        //            CreatedAt = DateTime.UtcNow\n        //        });\n        //    }\n\n        //    _logger.LogInformation(\"🧩 Parsed {NodeCount} nodes\", parsedNodes.Count);\n\n        //    // ✅ Step 3: Map Source/TargetNodeId from external → internal GUIDs\n        //    var parsedEdges = new List<AutoReplyFlowEdge>();\n\n        //    foreach (var e in dto.Edges)\n        //    {\n        //        if (!nodeIdMap.TryGetValue(e.SourceNodeId ?? \"\", out var sourceId))\n        //        {\n        //            _logger.LogWarning(\"⚠️ Edge skipped: SourceNodeId '{Source}' not found\", e.SourceNodeId);\n        //            continue;\n        //        }\n\n        //        if (!nodeIdMap.TryGetValue(e.TargetNodeId ?? \"\", out var targetId))\n        //        {\n        //            _logger.LogWarning(\"⚠️ Edge skipped: TargetNodeId '{Target}' not found\", e.TargetNodeId);\n        //            continue;\n        //        }\n\n        //        parsedEdges.Add(new AutoReplyFlowEdge\n        //        {\n        //            Id = Guid.NewGuid(),\n        //            FlowId = saved.Id,\n        //            SourceNodeId = sourceId.ToString(),\n        //            TargetNodeId = targetId.ToString(),\n        //            CreatedAt = DateTime.UtcNow\n        //        });\n        //    }\n\n        //    _logger.LogInformation(\"🔗 Parsed {EdgeCount} edges\", parsedEdges.Count);\n\n        //    // ✅ Final Save\n        //    await _flowRepository.SaveNodesAndEdgesAsync(parsedNodes, parsedEdges);\n        //    _logger.LogInformation(\"✅ Node + edge persistence complete for flow {FlowId}\", saved.Id);\n\n        //    return saved.Id;\n        //}\n        //public async Task<Guid> SaveFlowAsync(SaveFlowDto dto)\n        //{\n        //    _logger.LogInformation(\"🔄 Starting flow save for business {BusinessId} with keyword '{Keyword}'\", dto?.BusinessId, dto?.TriggerKeyword);\n\n        //    if (dto == null) throw new ArgumentNullException(nameof(dto));\n        //    if (dto.BusinessId == Guid.Empty) throw new ArgumentException(\"BusinessId is required.\");\n        //    if (string.IsNullOrWhiteSpace(dto.TriggerKeyword)) throw new ArgumentException(\"TriggerKeyword is required.\");\n        //    if (dto.Nodes == null || !dto.Nodes.Any()) throw new ArgumentException(\"At least one node is required.\");\n\n        //    dto.Edges ??= new List<EdgeDto>();\n\n        //    // ✅ Step 1: Save Flow\n        //    var flow = new AutoReplyFlow\n        //    {\n        //        Id = Guid.NewGuid(),\n        //        BusinessId = dto.BusinessId,\n        //        Name = dto.Name?.Trim() ?? \"\",\n        //        NodesJson = JsonConvert.SerializeObject(dto.Nodes),\n        //        EdgesJson = JsonConvert.SerializeObject(dto.Edges),\n        //        TriggerKeyword = dto.TriggerKeyword?.Trim().ToLower(),\n        //        IsActive = true,\n        //        CreatedAt = DateTime.UtcNow\n        //    };\n\n        //    var savedFlow = await _flowRepository.SaveAsync(flow);\n        //    _logger.LogInformation(\"✅ Flow saved: {FlowId}\", savedFlow.Id);\n\n        //    // ✅ Step 2: Parse Nodes\n        //    var nodeIdMap = new Dictionary<string, Guid>();\n        //    var parsedNodes = new List<AutoReplyFlowNode>();\n\n        //    foreach (var n in dto.Nodes)\n        //    {\n        //        if (string.IsNullOrWhiteSpace(n.Id)) continue;\n\n        //        var internalNodeId = Guid.NewGuid();\n        //        nodeIdMap[n.Id] = internalNodeId;\n\n        //        string configJson = n.Data?.Config is JsonElement elem\n        //            ? elem.GetRawText()\n        //            : JsonConvert.SerializeObject(n.Data?.Config ?? new { });\n\n        //        parsedNodes.Add(new AutoReplyFlowNode\n        //        {\n        //            Id = internalNodeId,\n        //            FlowId = savedFlow.Id,\n        //            NodeType = n.Type,\n        //            Label = n.Data?.Label ?? \"\",\n        //            ConfigJson = configJson,\n        //            Position = new Position\n        //            {\n        //                X = n.Position?.X ?? 0,\n        //                Y = n.Position?.Y ?? 0\n        //            },\n        //            CreatedAt = DateTime.UtcNow\n        //        });\n        //    }\n\n        //    _logger.LogInformation(\"🧩 Parsed {NodeCount} nodes\", parsedNodes.Count);\n\n        //    // ✅ Step 3: Parse Edges\n        //    var parsedEdges = new List<AutoReplyFlowEdge>();\n\n        //    foreach (var e in dto.Edges)\n        //    {\n        //        if (!nodeIdMap.TryGetValue(e.SourceNodeId ?? \"\", out var sourceId)) continue;\n        //        if (!nodeIdMap.TryGetValue(e.TargetNodeId ?? \"\", out var targetId)) continue;\n\n        //        parsedEdges.Add(new AutoReplyFlowEdge\n        //        {\n        //            Id = Guid.NewGuid(),\n        //            FlowId = savedFlow.Id,\n        //            SourceNodeId = sourceId.ToString(),\n        //            TargetNodeId = targetId.ToString(),\n        //            SourceHandle = e.SourceHandle, \n        //            TargetHandle = e.TargetHandle, \n        //            CreatedAt = DateTime.UtcNow\n        //        });\n        //    }\n\n        //    _logger.LogInformation(\"🔗 Parsed {EdgeCount} edges\", parsedEdges.Count);\n\n        //    // ✅ Step 4: Save Nodes + Edges\n        //    await _flowRepository.SaveNodesAndEdgesAsync(parsedNodes, parsedEdges);\n        //    _logger.LogInformation(\"✅ Node + edge persistence complete for flow {FlowId}\", savedFlow.Id);\n\n        //    // ✅ Step 5: Link to Rule via Repository\n        //    var keyword = dto.TriggerKeyword.Trim().ToLower();\n        //    var rule = await _autoReplyRepository.UpsertRuleLinkedToFlowAsync(dto.BusinessId, keyword, savedFlow.Id, dto.Name);\n\n        //    _logger.LogInformation(\"🔁 Linked flow to auto-reply rule: {RuleId}\", rule.Id);\n\n        //    return savedFlow.Id;\n        //}\n        public async Task<Guid> SaveFlowAsync(SaveFlowDto dto, Guid businessId)\n        {\n            _logger.LogInformation(\"🔄 Starting flow save for business {BusinessId} with keyword '{Keyword}'\", businessId, dto?.TriggerKeyword);\n\n            if (dto == null) throw new ArgumentNullException(nameof(dto));\n            if (string.IsNullOrWhiteSpace(dto.TriggerKeyword)) throw new ArgumentException(\"TriggerKeyword is required.\");\n            if (dto.Nodes == null || !dto.Nodes.Any()) throw new ArgumentException(\"At least one node is required.\");\n\n            dto.Edges ??= new List<EdgeDto>();\n\n            // ✅ Step 1: Save Flow\n            var flow = new AutoReplyFlow\n            {\n                Id = Guid.NewGuid(),\n                BusinessId = businessId, // << Use parameter, not from dto!\n                Name = dto.Name?.Trim() ?? \"\",\n                NodesJson = JsonConvert.SerializeObject(dto.Nodes),\n                EdgesJson = JsonConvert.SerializeObject(dto.Edges),\n                TriggerKeyword = dto.TriggerKeyword?.Trim().ToLower(),\n                IsActive = true,\n                CreatedAt = DateTime.UtcNow\n            };\n\n            var savedFlow = await _flowRepository.SaveAsync(flow);\n            _logger.LogInformation(\"✅ Flow saved: {FlowId}\", savedFlow.Id);\n\n            // ... rest of code unchanged ...\n\n            // ✅ Step 5: Link to Rule via Repository\n            var keyword = dto.TriggerKeyword.Trim().ToLower();\n            var rule = await _autoReplyRepository.UpsertRuleLinkedToFlowAsync(\n                businessId, // << Use parameter, not from dto!\n                keyword, savedFlow.Id, dto.Name);\n\n            _logger.LogInformation(\"🔁 Linked flow to auto-reply rule: {RuleId}\", rule.Id);\n\n            return savedFlow.Id;\n        }\n\n        public async Task<List<SaveFlowDto>> GetFlowsByBusinessIdAsync(Guid businessId)\n        {\n            _logger.LogInformation(\"📥 Fetching auto-reply flows for business {BusinessId}\", businessId);\n\n            var flows = await _flowRepository.GetAllByBusinessIdAsync(businessId);\n\n            var results = flows.Select(f => new SaveFlowDto\n            {\n                Id = f.Id,\n                BusinessId = f.BusinessId,\n                Name = f.Name,\n                Nodes = string.IsNullOrEmpty(f.NodesJson)\n                    ? new()\n                    : JsonConvert.DeserializeObject<List<NodeDto>>(f.NodesJson),\n\n                Edges = string.IsNullOrEmpty(f.EdgesJson)\n                    ? new()\n                    : JsonConvert.DeserializeObject<List<EdgeDto>>(f.EdgesJson),\n\n\n                CreatedAt = f.CreatedAt\n            }).ToList();\n\n            _logger.LogInformation(\"📤 Returned {Count} auto-reply flows for business {BusinessId}\", results.Count, businessId);\n\n            return results;\n        }\n\n        public async Task<SaveFlowDto?> GetFlowByIdAsync(Guid flowId, Guid businessId)\n        {\n            var flow = await _flowRepository.GetByIdAsync(flowId, businessId);\n            if (flow == null)\n            {\n                _logger.LogWarning(\"❌ No flow found for FlowId {FlowId} and BusinessId {BusinessId}\", flowId, businessId);\n                return null;\n            }\n\n            var nodes = await _flowRepository.GetNodesByFlowIdAsync(flowId);\n            var edges = await _flowRepository.GetEdgesByFlowIdAsync(flowId);\n\n            var mappedNodes = nodes.Select(n => new Dictionary<string, object>\n            {\n                [\"id\"] = n.Id,\n                [\"type\"] = n.NodeType,\n                [\"position\"] = new Dictionary<string, object>\n                {\n                    [\"x\"] = n.Position?.X ?? 0,\n                    [\"y\"] = n.Position?.Y ?? 0\n                },\n                [\"data\"] = new Dictionary<string, object>\n                {\n                    [\"label\"] = n.Label,\n                    [\"config\"] = string.IsNullOrEmpty(n.ConfigJson)\n                        ? null\n                        : JsonConvert.DeserializeObject<object>(n.ConfigJson)\n                }\n            }).ToList();\n\n            var mappedEdges = edges.Select(e => new Dictionary<string, object>\n            {\n                [\"id\"] = e.Id,\n                [\"source\"] = e.SourceNodeId,\n                [\"target\"] = e.TargetNodeId\n            }).ToList();\n\n            _logger.LogInformation(\"📤 Returning flow {FlowId} with {NodeCount} nodes and {EdgeCount} edges\", flow.Id, mappedNodes.Count, mappedEdges.Count);\n\n            return new SaveFlowDto\n            {\n                Id = flow.Id,\n                BusinessId = flow.BusinessId,\n                Name = flow.Name,\n                Nodes = JsonConvert.DeserializeObject<List<NodeDto>>(JsonConvert.SerializeObject(mappedNodes)),\n                Edges = JsonConvert.DeserializeObject<List<EdgeDto>>(JsonConvert.SerializeObject(mappedEdges)),\n                CreatedAt = flow.CreatedAt\n            };\n\n        }\n\n        public async Task<int> GetFlowCountForBusinessAsync(Guid businessId)\n        {\n            return await _flowRepository.GetFlowCountAsync(businessId);\n        }\n\n        public async Task<bool> RenameFlowAsync(Guid id, string newName)\n        {\n            return await _flowRepository.RenameFlowAsync(id, newName);\n        }\n        public async Task<bool> DeleteFlowAsync(Guid id, Guid businessId)\n        {\n            return await _flowRepository.DeleteFlowAsync(id, businessId);\n        }\n        public async Task ExecuteFlowAsync(Guid businessId, string triggerKeyword, string customerPhone)\n        {\n            var flow = await _flowRepository.FindFlowByKeywordAsync(businessId, triggerKeyword);\n            if (flow == null) return;\n\n            var nodes = await _flowRepository.GetNodesByFlowIdAsync(flow.Id);\n            var edges = await _flowRepository.GetEdgesByFlowIdAsync(flow.Id);\n\n            var nodeMap = nodes.ToDictionary(n => n.Id, n => n);\n            var edgeMap = edges.GroupBy(e => e.SourceNodeId)\n                               .ToDictionary(g => g.Key, g => g.ToList());\n\n            var current = nodes.FirstOrDefault(n => n.NodeType == \"start\");\n            while (current != null)\n            {\n                switch (current.NodeType)\n                {\n                    case \"message\":\n                        var msgCfg = JsonConvert.DeserializeObject<MessageConfig>(current.ConfigJson);\n                        await _messageService.SendTextDirectAsync(new TextMessageSendDto\n                        {\n                            BusinessId = businessId,\n                            RecipientNumber = customerPhone,\n                            TextContent = msgCfg.Text\n                        });\n\n                        break;\n                    case \"template\":\n                        var tempCfg = JsonConvert.DeserializeObject<TemplateConfig>(current.ConfigJson);\n\n                        var dto = new SimpleTemplateMessageDto\n                        {\n                            RecipientNumber = customerPhone,\n                            TemplateName = tempCfg.TemplateName,\n                            TemplateParameters = tempCfg.Placeholders ?? new List<string>()\n                        };\n\n                        await _messageService.SendTemplateMessageSimpleAsync(businessId, dto);\n                        break;\n\n\n                    case \"wait\":\n                        var waitCfg = JsonConvert.DeserializeObject<WaitConfig>(current.ConfigJson);\n                        await Task.Delay(TimeSpan.FromSeconds(waitCfg.Seconds));\n                        break;\n\n                    case \"tag\":\n                        var tagCfg = JsonConvert.DeserializeObject<TagNodeConfig>(current.ConfigJson);\n                        await _tagService.AssignTagsAsync(businessId, customerPhone, tagCfg.Tags);\n                        break;\n                }\n\n                var nextEdge = edgeMap.ContainsKey(current.Id.ToString())\n                     ? edgeMap[current.Id.ToString()].FirstOrDefault()\n                        : null;\n\n                if (nextEdge == null) break;\n\n                current = nodeMap.ContainsKey(Guid.Parse(nextEdge.TargetNodeId))\n                    ? nodeMap[Guid.Parse(nextEdge.TargetNodeId)]\n                    : null;\n\n            }\n        }\n        public async Task TriggerAutoReplyAsync(Guid businessId, string incomingText, string phone)\n        {\n            // Step 1: Find flow matching keyword\n            var flow = await _flowRepository.FindFlowByKeywordAsync(businessId, incomingText.ToLower());\n            if (flow == null) return;\n\n            // Step 2: Load flow nodes + edges\n            var nodes = await _flowRepository.GetStructuredNodesAsync(flow.Id);\n            var edges = await _flowRepository.GetStructuredEdgesAsync(flow.Id);\n\n            // Step 3: Find start node\n            var startNode = nodes.FirstOrDefault(n => n.NodeType == \"start\");\n            if (startNode == null) return;\n\n            var visited = new HashSet<string>();\n            var currentNodeId = startNode.Id.ToString();\n\n            while (!string.IsNullOrEmpty(currentNodeId) && !visited.Contains(currentNodeId))\n            {\n                visited.Add(currentNodeId);\n\n                var currentNode = nodes.FirstOrDefault(n => n.Id.ToString() == currentNodeId);\n                if (currentNode == null) break;\n\n                // Step 4: Handle current node\n                switch (currentNode.NodeType)\n                {\n                    case \"message\":\n                        var config = JsonConvert.DeserializeObject<MessageConfig>(currentNode.ConfigJson);\n                        await _messageService.SendTextDirectAsync(new TextMessageSendDto\n                        {\n                            BusinessId = businessId,\n                            RecipientNumber = phone,\n                            TextContent = config.Text\n                        });\n                        break;\n\n                    case \"template\":\n                        var tpl = JsonConvert.DeserializeObject<TemplateConfig>(currentNode.ConfigJson);\n\n                        var dto = new SimpleTemplateMessageDto\n                        {\n                            RecipientNumber = phone,\n                            TemplateName = tpl.TemplateName,\n                            TemplateParameters = tpl.Placeholders ?? new List<string>()\n                        };\n\n                        await _messageService.SendTemplateMessageSimpleAsync(businessId, dto);\n                        break;\n\n\n                    case \"wait\":\n                        var waitConfig = JsonConvert.DeserializeObject<WaitConfig>(currentNode.ConfigJson);\n                        await Task.Delay(waitConfig.Seconds * 1000); // Can replace with async scheduling later\n                        break;\n\n                    case \"tag\":\n                        var tagConfig = JsonConvert.DeserializeObject<TagNodeConfig>(currentNode.ConfigJson);\n                        await _tagService.AssignTagsAsync(businessId,phone, tagConfig.Tags);\n                        break;\n\n                }\n\n                // Step 5: Find next node\n                var nextEdge = edges.FirstOrDefault(e => e.SourceNodeId == currentNodeId);\n                currentNodeId = nextEdge?.TargetNodeId;\n            }\n        }\n\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Services/AutoReplyRuntimeService.cs",
      "sha256": "f9e35069e50bbf3a57f0c5134ae99c32f604d94885000c29aacb8ddab0d00d94",
      "language": "csharp",
      "size": 26209,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Text.Json;\nusing System.Threading.Tasks;\nusing Microsoft.Extensions.Logging;\nusing Newtonsoft.Json;\nusing xbytechat.api.DTOs.Messages;\nusing xbytechat.api.Features.AutoReplyBuilder.Flows.DTOs.FlowNodeConfigs;\nusing xbytechat.api.Features.AutoReplyBuilder.Flows.Repositories;\nusing xbytechat.api.Features.AutoReplyBuilder.Models;\nusing xbytechat.api.Features.AutoReplyBuilder.Repositories;\nusing xbytechat.api.Features.MessagesEngine.DTOs;\nusing xbytechat.api.Features.MessagesEngine.Services;\nusing xbytechat.api.Services;\nusing xbytechat.api;\nusing xbytechat.api.CRM.Models;\nusing xbytechat.api.CRM.Interfaces;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.CampaignModule.Models;\n\nnamespace xbytechat.api.Features.AutoReplyBuilder.Services\n{\n    public class AutoReplyRuntimeService : IAutoReplyRuntimeService\n    {\n        private readonly IAutoReplyRepository _autoReplyRepo;\n        private readonly IAutoReplyFlowRepository _flowRepo;\n        private readonly IMessageEngineService _messageEngine;\n        private readonly AppDbContext _context;\n        private readonly ILogger<AutoReplyRuntimeService> _logger;\n        private readonly IContactService _contactService;\n        private readonly ITagService _tagService;\n        private readonly ITemplateMessageSender _templateSender;\n        public AutoReplyRuntimeService(\n            IAutoReplyRepository autoReplyRepo,\n            IAutoReplyFlowRepository flowRepo,\n            IMessageEngineService messageEngine,\n            AppDbContext context,\n            ILogger<AutoReplyRuntimeService> logger, IContactService contactService, ITagService tagService, ITemplateMessageSender templateSender)\n        {\n            _autoReplyRepo = autoReplyRepo;\n            _flowRepo = flowRepo;\n            _messageEngine = messageEngine;\n            _context = context;\n            _logger = logger;\n            _contactService = contactService;\n            _tagService = tagService;\n            _templateSender = templateSender;\n        }\n\n        public async Task<bool> TryRunAutoReplyFlowAsync(Guid businessId, string keyword, Guid contactId, string phone)\n        {\n            _logger.LogInformation(\"🔍 Auto-reply trigger: '{Keyword}' from {Phone}\", keyword, phone);\n\n            try\n            {\n                // 1️⃣ Try matching a flow by keyword\n                var flow = await _flowRepo.FindFlowByKeywordAsync(businessId, keyword);\n                if (flow != null)\n                {\n                    _logger.LogInformation(\"✅ Flow matched: {FlowName}\", flow.Name);\n                    await RunFlowAsync(flow.Id, businessId, contactId, phone, keyword, flow.Name);\n                    return true;\n                }\n\n                // 2️⃣ Fallback: Try matching auto-reply rule\n                var rule = await _autoReplyRepo.MatchByKeywordAsync(businessId, keyword);\n                if (rule != null)\n                {\n                    _logger.LogInformation(\"🔁 Fallback auto-reply triggered: {Rule}\", rule.TriggerKeyword);\n\n                    var messageDto = new TextMessageSendDto\n                    {\n                        BusinessId = businessId,\n                        RecipientNumber = phone,\n                        TextContent = rule.ReplyMessage\n                    };\n\n                    var result = await _messageEngine.SendTextDirectAsync(messageDto);\n\n                    await LogAutoReplyAsync(\n                        businessId,\n                        contactId,\n                        keyword,\n                        \"fallback\",\n                        rule.ReplyMessage,\n                        null,\n                        result?.LogId\n                    );\n\n                    return true;\n                }\n\n                _logger.LogWarning(\"❌ No flow or fallback rule matched for: {Keyword}\", keyword);\n                return false;\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"❌ Error in TryRunAutoReplyFlowAsync\");\n                return false;\n            }\n        }\n\n        public async Task RunFlowAsync(Guid flowId, Guid businessId, Guid contactId, string phone, string keyword, string flowName)\n        {\n            var nodes = await _flowRepo.GetNodesByFlowIdAsync(flowId);\n            var edges = await _flowRepo.GetEdgesByFlowIdAsync(flowId);\n\n            var nodeDict = nodes.ToDictionary(n => n.Id.ToString(), n => n);\n            var edgeLookup = edges.GroupBy(e => e.SourceNodeId)\n                                  .ToDictionary(g => g.Key, g => g.ToList());\n\n            var currentNodeId = nodes.FirstOrDefault(n => n.NodeType == \"start\")?.Id.ToString();\n            if (string.IsNullOrEmpty(currentNodeId)) return;\n\n            // ✅ Ensure contact exists\n            var contact = await _contactService.FindOrCreateAsync(businessId, phone);\n\n            while (!string.IsNullOrEmpty(currentNodeId))\n            {\n                if (!nodeDict.TryGetValue(currentNodeId, out var node)) break;\n\n                _logger.LogInformation(\"⚙️ Executing node {NodeId} [{NodeType}]\", node.Id, node.NodeType);\n\n                try\n                {\n                    switch (node.NodeType)\n                    {\n                        case \"start\":\n                            _logger.LogInformation(\"🚦 Start node reached: {NodeId}\", node.Id);\n\n                            // 🛑 If Start node contains buttons, STOP and wait for user interaction\n                            try\n                            {\n                                var config = JsonConvert.DeserializeObject<Dictionary<string, object>>(node.ConfigJson ?? \"{}\");\n                                if (config != null && config.TryGetValue(\"multiButtons\", out var rawButtons))\n                                {\n                                    var buttons = JsonConvert.DeserializeObject<List<object>>(rawButtons.ToString() ?? \"[]\");\n                                    if (buttons.Count > 0)\n                                    {\n                                        _logger.LogInformation(\"🛑 Start node has buttons – waiting for user interaction. Halting flow.\");\n                                        return;\n                                    }\n                                }\n                            }\n                            catch (Exception ex)\n                            {\n                                _logger.LogError(ex, \"❌ Failed to parse start node config for button detection.\");\n                            }\n                            break;\n\n                        case \"message\":\n                            await ExecuteMessageNodeAsync(node, businessId, contactId, phone, keyword, flowName);\n                            break;\n\n                        case \"template\":\n                            await ExecuteTemplateNodeAsync(node, businessId, contactId, phone, keyword, flowName);\n\n                          \n                                try\n                                {\n                                    var cfg = JsonConvert.DeserializeObject<TemplateConfig>(node.ConfigJson ?? \"{}\");\n                                    if (cfg?.MultiButtons?.Any(b => !string.IsNullOrWhiteSpace(b.ButtonText)) == true)\n                                    {\n                                        _logger.LogInformation(\"🛑 Template node has buttons – halting flow for user click.\");\n                                        return;\n                                    }\n                                }\n\n                            \n                            catch (Exception ex)\n                            {\n                                _logger.LogError(ex, \"❌ Failed to parse template config for button detection.\");\n                            }\n                            break;\n\n                        case \"tag\":\n                            await ExecuteTagNodeAsync(businessId, contactId, node);\n                            break;\n\n                        case \"wait\":\n                            try\n                            {\n                                var waitCfg = JsonConvert.DeserializeObject<WaitConfig>(node.ConfigJson ?? \"{}\");\n                                var delayMs = (waitCfg?.Seconds ?? 1) * 1000;\n                                _logger.LogInformation(\"⏳ Wait node delay: {Seconds}s\", waitCfg?.Seconds ?? 1);\n                                await Task.Delay(delayMs);\n                            }\n                            catch (Exception ex)\n                            {\n                                _logger.LogError(ex, \"❌ Failed to parse wait config for node {NodeId}\", node.Id);\n                            }\n                            break;\n                    }\n                }\n                catch (Exception ex)\n                {\n                    _logger.LogError(ex, \"❌ Error while executing node {NodeId} of type {NodeType}\", node.Id, node.NodeType);\n                }\n\n                currentNodeId = edgeLookup.TryGetValue(currentNodeId, out var next)\n                    ? next.FirstOrDefault()?.TargetNodeId\n                    : null;\n            }\n        }\n\n        private bool TryNodeHasButtons(string? configJson)\n        {\n            if (string.IsNullOrWhiteSpace(configJson)) return false;\n\n            try\n            {\n                var config = JsonConvert.DeserializeObject<Dictionary<string, object>>(configJson);\n                if (config != null && config.TryGetValue(\"multiButtons\", out var rawButtons))\n                {\n                    var buttons = JsonConvert.DeserializeObject<List<object>>(rawButtons.ToString() ?? \"[]\");\n                    return buttons.Count > 0;\n                }\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"⚠️ Failed to parse buttons from template config\");\n            }\n\n            return false;\n        }\n\n        private async Task LogAutoReplyAsync(Guid businessId, Guid contactId, string keyword, string type, string replyText, string? flowName, Guid? messageLogId)\n        {\n            var log = new AutoReplyLog\n            {\n                Id = Guid.NewGuid(),\n                BusinessId = businessId,\n                ContactId = contactId,\n                TriggerKeyword = keyword,\n                TriggerType = type,\n                ReplyContent = replyText,\n                FlowName = flowName,\n                MessageLogId = messageLogId,\n                TriggeredAt = DateTime.UtcNow\n            };\n\n            _context.AutoReplyLogs.Add(log);\n            await _context.SaveChangesAsync();\n        }\n\n\n        //    private async Task ExecuteTemplateNodeAsync(\n        //    AutoReplyFlowNode node,\n        //    Guid businessId,\n        //    Guid contactId,\n        //    string phone,\n        //    string keyword,\n        //    string? flowName)\n        //    {\n        //        _logger.LogInformation(\"🧠 Raw config JSON for template node: {Json}\", node.ConfigJson);\n\n        //        TemplateConfig? tmpl;\n        //        try\n        //        {\n        //            tmpl = JsonConvert.DeserializeObject<TemplateConfig>(node.ConfigJson ?? \"{}\");\n        //        }\n        //        catch (Exception ex)\n        //        {\n        //            _logger.LogError(ex, \"❌ Failed to deserialize TemplateConfig for node {NodeId}\", node.Id);\n        //            return;\n        //        }\n\n        //        if (tmpl == null || string.IsNullOrWhiteSpace(tmpl.TemplateName))\n        //        {\n        //            _logger.LogWarning(\"❌ Template node config is missing or invalid.\");\n        //            return;\n        //        }\n\n        //        var contact = await _context.Contacts\n        //            .FirstOrDefaultAsync(c => c.Id == contactId && c.BusinessId == businessId);\n\n        //        if (contact == null)\n        //        {\n        //            _logger.LogWarning(\"❌ Contact not found for AutoReply.\");\n        //            return;\n        //        }\n\n        //        //var buttons = tmpl.MultiButtons?.Select(b => new CampaignButton\n        //        //{\n        //        //    Title = b.ButtonText,\n        //        //    Type = b.ButtonType,\n        //        //    Value = b.TargetUrl\n        //        //}).ToList();\n        //        var buttons = tmpl.MultiButtons?\n        //.Where(b => !string.IsNullOrWhiteSpace(b.ButtonText)) // ✅ Avoid empty\n        //.Select((b, idx) => new\n        //{\n        //    type = \"button\",\n        //    sub_type = b.ButtonType.ToLowerInvariant(), // must be 'quick_reply' or 'url'\n        //    index = idx.ToString(),\n        //    parameters = new List<object>\n        //    {\n        //        new {\n        //            type = \"text\",\n        //            text = b.ButtonText\n        //        }\n        //    }\n        //}).ToList();\n\n        //        var response = await _templateSender.SendTemplateMessageToContactAsync(\n        //            businessId: businessId,\n        //            contact: contact,\n        //            templateName: tmpl.TemplateName,\n        //            templateParams: tmpl.Placeholders ?? new List<string>(),\n        //            imageUrl: tmpl.ImageUrl,\n        //            buttons: buttons,\n        //            source: \"auto_reply\",\n        //            refMessageId: null\n        //        );\n\n        //        await LogAutoReplyAsync(\n        //            businessId,\n        //            contactId,\n        //            keyword,\n        //            \"flow\",\n        //            $\"Template: {tmpl.TemplateName}\",\n        //            flowName,\n        //            response.LogId\n        //        );\n        //    }\n\n\n        private async Task ExecuteTemplateNodeAsync(\n    AutoReplyFlowNode node,\n    Guid businessId,\n    Guid contactId,\n    string phone,\n    string keyword,\n    string? flowName)\n        {\n            _logger.LogInformation(\"🧠 Raw config JSON for template node: {Json}\", node.ConfigJson);\n\n            TemplateConfig? tmpl;\n            try\n            {\n                tmpl = JsonConvert.DeserializeObject<TemplateConfig>(node.ConfigJson ?? \"{}\");\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"❌ Failed to deserialize TemplateConfig for node {NodeId}\", node.Id);\n                return;\n            }\n\n            if (tmpl == null || string.IsNullOrWhiteSpace(tmpl.TemplateName))\n            {\n                _logger.LogWarning(\"❌ Template node config is missing or invalid.\");\n                return;\n            }\n\n            var contact = await _context.Contacts\n                .FirstOrDefaultAsync(c => c.Id == contactId && c.BusinessId == businessId);\n\n            if (contact == null)\n            {\n                _logger.LogWarning(\"❌ Contact not found for AutoReply.\");\n                return;\n            }\n\n            var buttons = tmpl.MultiButtons?\n                .Where(b => !string.IsNullOrWhiteSpace(b.ButtonText))\n                .Select(b => new CampaignButton\n                {\n                    Title = b.ButtonText,\n                    Type = b.ButtonType,\n                    Value = b.TargetUrl\n                })\n                .ToList();\n\n            var response = await _templateSender.SendTemplateMessageToContactAsync(\n                businessId: businessId,\n                contact: contact,\n                templateName: tmpl.TemplateName,\n                templateParams: tmpl.Placeholders ?? new List<string>(),\n                imageUrl: tmpl.ImageUrl,\n                buttons: buttons,\n                source: \"auto_reply\",\n                refMessageId: null\n            );\n\n            await LogAutoReplyAsync(\n                businessId,\n                contactId,\n                keyword,\n                \"flow\",\n                $\"Template: {tmpl.TemplateName}\",\n                flowName,\n                response.LogId\n            );\n        }\n\n        private async Task ExecuteMessageNodeAsync( AutoReplyFlowNode node, Guid businessId, Guid contactId,string phone, string keyword, string? flowName)\n        {\n            _logger.LogInformation(\"🧠 Raw config JSON for message node: {Json}\", node.ConfigJson);\n\n            MessageConfig? config = null;\n            try\n            {\n                config = JsonConvert.DeserializeObject<MessageConfig>(node.ConfigJson ?? \"{}\");\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"❌ Failed to parse config for message node {NodeId}\", node.Id);\n                return;\n            }\n\n            if (config == null || string.IsNullOrWhiteSpace(config.Text))\n            {\n                _logger.LogWarning(\"⚠️ Message node config missing or empty.\");\n                return;\n            }\n\n            var result = await _messageEngine.SendTextDirectAsync(new TextMessageSendDto\n            {\n                BusinessId = businessId,\n                RecipientNumber = phone,\n                TextContent = config.Text\n            });\n\n            await LogAutoReplyAsync(\n                businessId,\n                contactId,\n                keyword,\n                \"flow\",\n                config.Text,\n                flowName,\n                result?.LogId\n            );\n        }\n        private async Task ExecuteTagNodeAsync(Guid businessId, Guid contactId, AutoReplyFlowNode node)\n        {\n            if (node == null || string.IsNullOrWhiteSpace(node.ConfigJson))\n                return;\n\n            try\n            {\n                var config = System.Text.Json.JsonSerializer.Deserialize<TagNodeConfig>(node.ConfigJson);\n\n                if (config?.Tags != null && config.Tags.Any())\n                {\n                    // ✅ Load contact from DB\n                    var contact = await _context.Contacts.FirstOrDefaultAsync(c => c.Id == contactId && c.BusinessId == businessId);\n                    if (contact == null)\n                    {\n                        _logger.LogWarning(\"⚠️ TagNode: Contact not found for {ContactId}\", contactId);\n                        return;\n                    }\n\n                    await _tagService.AssignTagsAsync(businessId, contact.PhoneNumber, config.Tags);\n                    _logger.LogInformation(\"✅ TagNode: Tags [{Tags}] assigned to contact {Phone}\", string.Join(\", \", config.Tags), contact.PhoneNumber);\n                }\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"❌ TagNode: Failed to execute for contact {ContactId}\", contactId);\n            }\n        }\n\n        public async Task TryRunAutoReplyFlowByButtonAsync(Guid businessId, string phone, string buttonText, Guid? refMessageId = null)\n        {\n            var contact = await _contactService.FindOrCreateAsync(businessId, phone);\n            if (contact == null)\n            {\n                _logger.LogWarning(\"❌ Contact not found or could not be created for phone: {Phone}\", phone);\n                return;\n            }\n\n            _logger.LogInformation(\"📩 Button clicked: '{ButtonText}' by {Phone}\", buttonText, phone);\n\n            var flows = await _flowRepo.GetAllByBusinessIdAsync(businessId);\n            if (flows == null || !flows.Any())\n            {\n                _logger.LogInformation(\"📭 No flows found for business {BusinessId}\", businessId);\n                return;\n            }\n\n            foreach (var flow in flows)\n            {\n                var nodes = await _flowRepo.GetNodesByFlowIdAsync(flow.Id);\n                var edges = await _flowRepo.GetEdgesByFlowIdAsync(flow.Id);\n\n                var matchedStartNode = nodes\n                    .Where(n => n.NodeType == \"start\")\n                    .FirstOrDefault(n =>\n                    {\n                        try\n                        {\n                            var config = JsonConvert.DeserializeObject<Dictionary<string, object>>(n.ConfigJson ?? \"{}\");\n\n                            if (config != null && config.TryGetValue(\"triggerKeywords\", out var raw))\n                            {\n                                var keywordArray = JsonConvert.DeserializeObject<List<string>>(raw.ToString() ?? \"[]\");\n\n                                return keywordArray.Any(k =>\n                                    string.Equals(k?.Trim(), buttonText.Trim(), StringComparison.OrdinalIgnoreCase));\n                            }\n\n                            return false;\n                        }\n                        catch\n                        {\n                            return false;\n                        }\n                    });\n\n                if (matchedStartNode != null)\n                {\n                    _logger.LogInformation(\"✅ Matched flow {FlowName} by button '{ButtonText}'\", flow.Name, buttonText);\n                   // await RunFlowAsync(flow.Id, businessId, contact.Id, phone, buttonText, flow.Name);\n                  await RunFlowFromButtonAsync(flow.Id, businessId, contact.Id, phone, buttonText);\n                    return;\n                }\n            }\n\n            _logger.LogInformation(\"❌ No flow matched for button: {ButtonText}\", buttonText);\n        }\n        public async Task RunFlowFromButtonAsync(Guid flowId, Guid businessId, Guid contactId, string phone, string buttonText)\n        {\n            var nodes = await _flowRepo.GetNodesByFlowIdAsync(flowId);\n            var edges = await _flowRepo.GetEdgesByFlowIdAsync(flowId);\n\n            var nodeMap = nodes.ToDictionary(n => n.Id.ToString(), n => n);\n            var edgeMap = edges.GroupBy(e => e.SourceNodeId)\n                               .ToDictionary(g => g.Key, g => g.ToList());\n\n            // 🟢 1. Find start node\n            var startNode = nodes.FirstOrDefault(n => n.NodeType == \"start\");\n            if (startNode == null)\n            {\n                _logger.LogWarning(\"❌ No start node found in flow {FlowId}\", flowId);\n                return;\n            }\n\n            // 🔍 2. Find button index from triggerKeywords\n            int matchedIndex = -1;\n            try\n            {\n                var config = JsonConvert.DeserializeObject<Dictionary<string, object>>(startNode.ConfigJson ?? \"{}\");\n\n                if (config != null && config.TryGetValue(\"triggerKeywords\", out var raw))\n                {\n                    var keywordList = JsonConvert.DeserializeObject<List<string>>(raw.ToString() ?? \"[]\");\n                    matchedIndex = keywordList.FindIndex(k =>\n                        string.Equals(k?.Trim(), buttonText.Trim(), StringComparison.OrdinalIgnoreCase));\n                }\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"❌ Failed to parse Start node config\");\n                return;\n            }\n\n            if (matchedIndex < 0)\n            {\n                _logger.LogWarning(\"❌ No trigger match for buttonText '{Button}'\", buttonText);\n                return;\n            }\n\n            // ✅ 3. Lookup edge from StartNode using SourceHandle = button-{index}\n            var nextNodeId = edgeMap.TryGetValue(startNode.Id.ToString(), out var list)\n                ? list.FirstOrDefault(e => e.SourceHandle == $\"button-{matchedIndex}\")?.TargetNodeId\n                : null;\n\n            if (string.IsNullOrEmpty(nextNodeId))\n            {\n                _logger.LogWarning(\"❌ No outgoing edge found for button index {Index}\", matchedIndex);\n                return;\n            }\n\n            var visited = new HashSet<string>();\n\n            while (!string.IsNullOrEmpty(nextNodeId) && !visited.Contains(nextNodeId))\n            {\n                visited.Add(nextNodeId);\n\n                if (!nodeMap.TryGetValue(nextNodeId, out var node))\n                    break;\n\n                _logger.LogInformation(\"⚙️ Executing node {NodeId} [{NodeType}]\", node.Id, node.NodeType);\n\n                try\n                {\n                    switch (node.NodeType)\n                    {\n                        case \"message\":\n                            await ExecuteMessageNodeAsync(node, businessId, contactId, phone, buttonText, null);\n                            break;\n\n                        case \"template\":\n                            await ExecuteTemplateNodeAsync(node, businessId, contactId, phone, buttonText, null);\n\n                            // ✅ Check buttons and halt if any button exists\n                            try\n                            {\n                                var cfg = JsonConvert.DeserializeObject<TemplateConfig>(node.ConfigJson ?? \"{}\");\n                                if (cfg?.MultiButtons?.Any(b => !string.IsNullOrWhiteSpace(b.ButtonText)) == true)\n                                {\n                                    _logger.LogInformation(\"🛑 Template node has buttons – halting flow for user click.\");\n                                    return;\n                                }\n                            }\n                            catch (Exception ex)\n                            {\n                                _logger.LogError(ex, \"❌ Failed to parse template config for button detection.\");\n                            }\n                            break;\n\n\n                        case \"tag\":\n                            await ExecuteTagNodeAsync(businessId, contactId, node);\n                            break;\n\n                        case \"wait\":\n                            var waitCfg = JsonConvert.DeserializeObject<WaitConfig>(node.ConfigJson ?? \"{}\");\n                            await Task.Delay((waitCfg?.Seconds ?? 1) * 1000);\n                            break;\n                    }\n                }\n                catch (Exception ex)\n                {\n                    _logger.LogError(ex, \"❌ Error executing node {NodeId}\", node.Id);\n                }\n\n                nextNodeId = edgeMap.TryGetValue(nextNodeId, out var nextList)\n                    ? nextList.FirstOrDefault()?.TargetNodeId\n                    : null;\n            }\n        }\n\n    }\n}\n\n\n\n\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Services/AutoReplyService.cs",
      "sha256": "df6edf428cebc4dc2d292bef7eb4e47f8cdcbe402b71d79ff9e6ae300502cf70",
      "language": "csharp",
      "size": 3226,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.AutoReplyBuilder.DTOs;\nusing xbytechat.api.Features.AutoReplyBuilder.Models;\nusing xbytechat.api.Features.AutoReplyBuilder.Repositories;\n\nnamespace xbytechat.api.Features.AutoReplyBuilder.Services\n{\n    public class AutoReplyService : IAutoReplyService\n    {\n        private readonly IAutoReplyRepository _repository;\n\n        public AutoReplyService(IAutoReplyRepository repository)\n        {\n            _repository = repository;\n        }\n\n        public async Task<AutoReplyRuleDto> CreateRuleAsync(Guid businessId, AutoReplyRuleDto dto)\n        {\n            var model = new AutoReplyRule\n            {\n                Id = Guid.NewGuid(),\n                BusinessId = businessId,\n                TriggerKeyword = dto.TriggerKeyword,\n                ReplyMessage = dto.ReplyMessage,\n                MediaUrl = dto.MediaUrl,\n                Priority = dto.Priority,\n                IsActive = dto.IsActive,\n                CreatedAt = DateTime.UtcNow\n            };\n\n            var saved = await _repository.AddAsync(model);\n\n            return ToDto(saved);\n        }\n\n        public async Task<IEnumerable<AutoReplyRuleDto>> GetAllRulesAsync(Guid businessId)\n        {\n            var rules = await _repository.GetAllByBusinessIdAsync(businessId);\n            return rules.Select(ToDto);\n        }\n\n        public async Task<AutoReplyRuleDto?> GetRuleByIdAsync(Guid ruleId, Guid businessId)\n        {\n            var rule = await _repository.GetByIdAsync(ruleId, businessId);\n            return rule == null ? null : ToDto(rule);\n        }\n\n        public async Task<bool> UpdateRuleAsync(Guid businessId, AutoReplyRuleDto dto)\n        {\n            var existing = await _repository.GetByIdAsync(dto.Id!.Value, businessId);\n            if (existing == null) return false;\n\n            existing.TriggerKeyword = dto.TriggerKeyword;\n            existing.ReplyMessage = dto.ReplyMessage;\n            existing.MediaUrl = dto.MediaUrl;\n            existing.Priority = dto.Priority;\n            existing.IsActive = dto.IsActive;\n            existing.UpdatedAt = DateTime.UtcNow;\n\n            return await _repository.UpdateAsync(existing);\n        }\n\n        public async Task<bool> DeleteRuleAsync(Guid ruleId, Guid businessId)\n        {\n            return await _repository.DeleteAsync(ruleId, businessId);\n        }\n\n        public async Task<AutoReplyRuleDto?> MatchRuleByKeywordAsync(Guid businessId, string incomingMessage)\n        {\n            var rule = await _repository.MatchByKeywordAsync(businessId, incomingMessage);\n            return rule == null ? null : ToDto(rule);\n        }\n\n        private AutoReplyRuleDto ToDto(AutoReplyRule rule)\n        {\n            return new AutoReplyRuleDto\n            {\n                Id = rule.Id,\n                TriggerKeyword = rule.TriggerKeyword,\n                ReplyMessage = rule.ReplyMessage,\n                MediaUrl = rule.MediaUrl,\n                Priority = rule.Priority,\n                IsActive = rule.IsActive,\n                CreatedAt = rule.CreatedAt,\n                UpdatedAt = rule.UpdatedAt\n            };\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Services/FlowRunner.cs",
      "sha256": "d8c0004b19eb4964915bcf51a0ecdadf6dc89cfe50220970befa0fe58a5d4307",
      "language": "csharp",
      "size": 103,
      "content": "namespace xbytechat.api.Features.AutoReplyBuilder.Services\n{\n    public class FlowRunner\n    {\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Services/IAutoReplyFlowService.cs",
      "sha256": "dfa67a436f77fb405478dfff58668d94aaed35d2e14d087bffd2fa6eb5b0112b",
      "language": "csharp",
      "size": 721,
      "content": "using System.Threading.Tasks;\nusing xbytechat.api.Features.AutoReplyBuilder.Flows.DTOs;\n\nnamespace xbytechat.api.Features.AutoReplyBuilder.Flows.Services\n{\n    public interface IAutoReplyFlowService\n    {\n        Task<Guid> SaveFlowAsync(SaveFlowDto dto, Guid businessId);\n        Task<List<SaveFlowDto>> GetFlowsByBusinessIdAsync(Guid businessId);\n        Task<SaveFlowDto?> GetFlowByIdAsync(Guid flowId, Guid businessId);\n        Task<int> GetFlowCountForBusinessAsync(Guid businessId);\n        Task<bool> RenameFlowAsync(Guid id, string newName);\n        Task<bool> DeleteFlowAsync(Guid id, Guid businessId);\n        Task ExecuteFlowAsync(Guid businessId, string triggerKeyword, string customerPhoneNumber);\n\n    }\n\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Services/IAutoReplyRuntimeService.cs",
      "sha256": "444b22549b3c870a3e8cef485bfbf318b5c82a42194255e035be52e27262d4e9",
      "language": "csharp",
      "size": 646,
      "content": "using System;\nusing System.Threading.Tasks;\n\nnamespace xbytechat.api.Features.AutoReplyBuilder.Services\n{\n    public interface IAutoReplyRuntimeService\n    {\n        Task<bool> TryRunAutoReplyFlowAsync(Guid businessId, string messageText, Guid contactId, string phoneNumber);\n        Task RunFlowAsync(Guid flowId, Guid businessId, Guid contactId, string phone, string keyword, string flowName);\n        Task TryRunAutoReplyFlowByButtonAsync(Guid businessId, string phone, string buttonText, Guid? refMessageId = null);\n        Task RunFlowFromButtonAsync(Guid flowId, Guid businessId, Guid contactId, string phone, string buttonText);\n\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Services/IAutoReplyService.cs",
      "sha256": "b2816300ae56acd5368c993c2bccc75ff481290ca8379e745ac361e2d27e620f",
      "language": "csharp",
      "size": 763,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.AutoReplyBuilder.DTOs;\n\nnamespace xbytechat.api.Features.AutoReplyBuilder.Services\n{\n    public interface IAutoReplyService\n    {\n        Task<AutoReplyRuleDto> CreateRuleAsync(Guid businessId, AutoReplyRuleDto dto);\n        Task<IEnumerable<AutoReplyRuleDto>> GetAllRulesAsync(Guid businessId);\n        Task<AutoReplyRuleDto?> GetRuleByIdAsync(Guid ruleId, Guid businessId);\n        Task<bool> UpdateRuleAsync(Guid businessId, AutoReplyRuleDto dto);\n        Task<bool> DeleteRuleAsync(Guid ruleId, Guid businessId);\n\n        // For runtime matching\n        Task<AutoReplyRuleDto?> MatchRuleByKeywordAsync(Guid businessId, string incomingMessage);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyBuilder/Services/IFlowRunner.cs",
      "sha256": "11438f4864857ba65f652f4ed62baf47119c77fcd6933106db70602675dce48b",
      "language": "csharp",
      "size": 104,
      "content": "namespace xbytechat.api.Features.AutoReplyBuilder.Services\n{\n    public class IFlowRunner\n    {\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AutoReplyTemplates/Restaurant/Configs/MenuNodeConfig.cs",
      "sha256": "f20da12fb12eed3191a2998cb2e7a7dbc65b03bfcb571cf1b6a413f52d78d42a",
      "language": "csharp",
      "size": 527,
      "content": "namespace xbytechat.api.Features.AutoReplyTemplates.Restaurant.Configs\n{\n    public class MenuNodeConfig\n    {\n        public string MenuTitle { get; set; } = string.Empty;         // e.g., \"Today's Specials\"\n        public string Description { get; set; } = string.Empty;       // e.g., \"Lunch combos starting at ₹199\"\n        public string MenuImageUrl { get; set; } = string.Empty;      // CDN or public link\n        public string MenuDownloadUrl { get; set; } = string.Empty;   // PDF link or product catalog URL\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/BusinessModule/Controllers/BusinessesController.cs",
      "sha256": "c52f56f9044f3f1ebffdd162a172dfba6ba4632df54e60016adab111f526940b",
      "language": "csharp",
      "size": 6018,
      "content": "using Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Helpers;\nusing Serilog;\nusing System.Security.Claims;\nusing xbytechat.api.Features.BusinessModule.DTOs;\nusing xbytechat.api.Features.BusinessModule.Models;\nusing xbytechat.api.Features.BusinessModule.Services;\nusing Microsoft.AspNetCore.Authorization;\n\nnamespace xbytechat.api.Features.BusinessModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    public class BusinessesController : ControllerBase\n    {\n        private readonly IBusinessService _businessService;\n\n        public BusinessesController(IBusinessService businessService)\n        {\n            _businessService = businessService;\n        }\n\n \n\n        [HttpGet(\"pending\")]\n        public async Task<IActionResult> GetPendingBusinesses()\n        {\n            try\n            {\n                var role = HttpContext.User.Claims\n                    .FirstOrDefault(c => c.Type == ClaimTypes.Role)?.Value;\n                var userId = HttpContext.User.Claims.FirstOrDefault(c => c.Type == \"id\")?.Value ?? \"\";\n\n                if (!new[] { \"admin\", \"superadmin\", \"partner\" }.Contains(role))\n                {\n                    return StatusCode(403, ResponseResult.ErrorInfo(\"⛔ Access denied: You are not authorized to view pending businesses.\"));\n                }\n\n                var result = await _businessService.GetPendingBusinessesAsync(role, userId);\n\n                return Ok(ResponseResult.SuccessInfo(\"✅ Pending businesses fetched successfully.\", result));\n            }\n            catch (Exception ex)\n            {\n                return StatusCode(500, ResponseResult.ErrorInfo(\"❌ Failed to fetch pending businesses. Please try again later.\"));\n            }\n        }\n\n\n        // ✅ Get business by ID (used for profile completion)\n\n        [HttpGet(\"{id}\")]\n        public async Task<IActionResult> GetBusinessById(Guid id)\n        {\n            try\n            {\n                var business = await _businessService.GetByIdAsync(id);\n                if (business == null)\n                    return NotFound(ResponseResult.ErrorInfo(\"❌ Business not found.\"));\n\n                return Ok(business);\n            }\n            catch (Exception ex)\n            {\n                return StatusCode(500, ResponseResult.ErrorInfo(\"🚨 Failed to fetch business. \" + ex.Message));\n            }\n        }\n\n        [HttpPut(\"assigned-to/{id}\")]\n        public async Task<IActionResult> UpdateBusiness(Guid id, [FromBody] Business business)\n        {\n            if (id != business.Id)\n            {\n                return BadRequest(new { message = \"❌ ID mismatch.\" });\n            }\n\n            var result = await _businessService.UpdateBusinessAsync(business);\n            if (!result.Success)\n            {\n                return BadRequest(result);\n            }\n\n            return Ok(result);\n        }\n\n\n        // 🟢 Approve a business\n        [HttpPost(\"approve/{id}\")]\n        public async Task<IActionResult> Approve(Guid id)\n        {\n            try\n            {\n                var result = await _businessService.ApproveBusinessAsync(id);\n\n                if (result.Success)\n                {\n                    // ✅ Optional Success Logging\n                    Log.Information(\"✅ Business approved successfully. BusinessId: {BusinessId}\", id);\n                    return Ok(result);\n                }\n                else\n                {\n                    // ✅ Optional Warning Logging\n                    Log.Warning(\"⚠️ Business approval failed. BusinessId: {BusinessId} - Message: {Message}\", id, result.Message);\n                    return BadRequest(result);\n                }\n            }\n            catch (Exception ex)\n            {\n                // ✅ Proper Error Logging\n                Log.Error(ex, \"❌ Exception occurred while approving business. BusinessId: {BusinessId}\", id);\n\n                return StatusCode(500, ResponseResult.ErrorInfo(\n                    \"❌ Something went wrong while approving business. Please try again later.\"\n                ));\n            }\n        }\n\n\n        // 🔴 Reject a business\n        [HttpPost(\"reject/{id}\")]\n        public async Task<IActionResult> Reject(Guid id)\n        {\n            try\n            {\n                var result = await _businessService.RejectBusinessAsync(id);\n                return result.Success ? Ok(result) : NotFound(result);\n            }\n            catch (Exception ex)\n            {\n                return StatusCode(500, ResponseResult.ErrorInfo(\"❌ Failed to reject business. \" + ex.Message));\n            }\n        }\n\n        // 🟡 Put a business on hold\n        [HttpPost(\"hold/{id}\")]\n        public async Task<IActionResult> Hold(Guid id)\n        {\n            try\n            {\n                var result = await _businessService.HoldBusinessAsync(id);\n                return result.Success ? Ok(result) : NotFound(result);\n            }\n            catch (Exception ex)\n            {\n                return StatusCode(500, ResponseResult.ErrorInfo(\"❌ Failed to hold business. \" + ex.Message));\n            }\n        }\n\n        // 🛠 Complete profile after signup\n        [HttpPost(\"profile-completion/{businessId}\")]\n        public async Task<IActionResult> CompleteProfile(Guid businessId, [FromBody] ProfileCompletionDto dto)\n        {\n            try\n            {\n                var result = await _businessService.CompleteProfileAsync(businessId, dto);\n                return result.Success ? Ok(result) : BadRequest(result);\n            }\n            catch (Exception ex)\n            {\n                return StatusCode(500, ResponseResult.ErrorInfo(\"❌ Failed to update profile. \" + ex.Message));\n            }\n        }\n\n        [HttpGet(\"approved\")]\n        [Authorize(Roles = \"SuperAdmin\")]\n        public async Task<IActionResult> GetApprovedBusinesses()\n        {\n            var result = await _businessService.GetApprovedBusinessesAsync();\n            return Ok(result);\n        }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/BusinessModule/DTOs/PendingBusinessDto.cs",
      "sha256": "262c7390254b692bef62525ec48c34eb502354e446d2e98e77586b32f640f2be",
      "language": "csharp",
      "size": 482,
      "content": "namespace xbytechat.api.Features.BusinessModule.DTOs\n{\n    public class PendingBusinessDto\n    {\n        public Guid BusinessId { get; set; }\n        public string CompanyName { get; set; }\n        public string BusinessEmail { get; set; }\n        public string? RepresentativeName { get; set; }\n        public string? Phone { get; set; }\n        public string Plan { get; set; }\n        public DateTime CreatedAt { get; set; }\n        public bool? IsApproved { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/BusinessModule/DTOs/ProfileCompletionDto.cs",
      "sha256": "cbd238cd045c0ee7bfc5061311058fa84005f29244727a11ef5b7a6eedbcf64f",
      "language": "csharp",
      "size": 489,
      "content": "namespace xbytechat.api.Features.BusinessModule.DTOs\n{\n    public class ProfileCompletionDto\n    {\n        public string? BusinessName { get; set; }\n        public string? ReperesentativeName { get; set; }\n        public string? CompanyPhone { get; set; }\n        public string? Phone { get; set; }\n        public string? Website { get; set; }\n        public string? Address { get; set; }\n        public string? Industry { get; set; }\n        public string? LogoUrl { get; set; }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/BusinessModule/DTOs/SignupBusinessDto.cs",
      "sha256": "daebace2d54e91a96825decc469c8acd57822d3e74bd5271ca80792e36cbb30e",
      "language": "csharp",
      "size": 717,
      "content": "using System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.Features.BusinessModule.DTOs\n{\n    public class SignupBusinessDto\n    {\n        [Required]\n        public string CompanyName { get; set; }\n\n        [Required]\n        [EmailAddress]\n        public string Email { get; set; }\n\n        [Required]\n        public string Password { get; set; }\n\n        public string? RepresentativeName { get; set; }\n\n        public string? Phone { get; set; }\n        public string RoleName { get; set; } = \"business\"; // Default to business role\n\n        // 🆕 NEW FIELD (Internal use only)\n        public Guid? CreatedByPartnerId { get; set; } // to assign the business to a specific user/agent/partner}\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/BusinessModule/Models/Business.cs",
      "sha256": "995f4839eaaa565942a45a28b5837718276c1fa8acf1b1b746de07dcd0d07ea5",
      "language": "csharp",
      "size": 2832,
      "content": "using System;\nusing System.Collections.Generic;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.Features.AccessControl.Models;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.Features.MessageManagement.DTOs;\nusing xbytechat.api.Models.BusinessModel;\nusing xbytechat_api.WhatsAppSettings.Models;\n\nnamespace xbytechat.api.Features.BusinessModule.Models\n{\n    public class Business\n    {\n        public Guid Id { get; set; }\n\n        // 🏢 Basic Info\n        public string? CompanyName { get; set; }\n        public string BusinessName { get; set; }\n        public string BusinessEmail { get; set; }  // Not used for login, just business contact\n        public string? RepresentativeName { get; set; }\n\n        public Guid? CreatedByPartnerId { get; set; }\n        public string? Phone { get; set; }\n        public string? CompanyPhone { get; set; }\n        public string? Website { get; set; }\n        public string? Address { get; set; }\n        public string? Industry { get; set; }\n        public string? LogoUrl { get; set; }\n\n        // 📦 SaaS Plan & Status using Enums\n        // public enum PlanType { Basic, Smart, Advanced } -- moved to bisinessinfo\n        // public PlanType Plan { get; set; } = PlanType.Basic;  // moved to bisinessinfo\n        public enum StatusType { Pending, Approved, Rejected }\n        public StatusType Status { get; set; } = StatusType.Pending;  // Default to Pending\n\n        // 📝 Metadata\n        public string? Tags { get; set; }\n        public string? Source { get; set; }\n        public string? Notes { get; set; }\n\n        // 📅 Timestamps\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n        public string? CreatedBy { get; set; }\n        public bool IsApproved { get; set; } = false;\n        public string? ApprovedBy { get; set; }\n        public DateTime? ApprovedAt { get; set; }\n        public DateTime? LastLoginAt { get; set; }\n\n        // 🗑 Soft Deletion\n        public bool IsDeleted { get; set; } = false;\n        public DateTime? DeletedAt { get; set; }\n        public string? DeletedBy { get; set; }\n\n        // 👥 Navigation Property - List of Users (nullable if no users)\n        public List<User> Users { get; set; } = new();\n\n\n        public ICollection<MessageStatusLog> MessageStatusLogs { get; set; }\n        public ICollection<Campaign> Campaigns { get; set; } = new List<Campaign>();\n        // 🔗 Plan Info linked\n\n        /// This is a one-to-one relationship with BusinessPlanInfo\n        public BusinessPlanInfo? BusinessPlanInfo { get; set; }\n\n        public Guid? PlanId { get; set; } // Nullable in case no plan is assigned yet\n        public Plan? Plan { get; set; }   // Navigation property to the Plan entity\n\n        public WhatsAppSettingEntity WhatsAppSettings { get; set; }\n\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/BusinessModule/Services/BusinessService.cs",
      "sha256": "a5ceba39eb2d4c79822b04180b564b268fc5ed58c58f9e85c968cbd5b5d7d5a0",
      "language": "csharp",
      "size": 14968,
      "content": "using Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing System.Security.Cryptography;\nusing System.Text;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.Features.AccessControl.Models;\nusing xbytechat.api.Features.AuditTrail.Models;\nusing xbytechat.api.Features.AuditTrail.Services;\nusing xbytechat.api.Features.BusinessModule.DTOs;\nusing xbytechat.api.Features.BusinessModule.Models;\nusing xbytechat.api.Features.PlanManagement.Models;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Models.BusinessModel;\nusing xbytechat.api.Repositories.Interfaces;\n\nnamespace xbytechat.api.Features.BusinessModule.Services\n{\n    public class BusinessService : IBusinessService\n    {\n        private readonly IGenericRepository<Business> _businessRepo;\n        private readonly IGenericRepository<User> _userRepo;\n        private readonly IGenericRepository<Role> _roleRepo;\n        private readonly IAuditLogService _auditLogService;\n        private readonly IHttpContextAccessor _httpContextAccessor;\n\n        public BusinessService(\n            IGenericRepository<Business> businessRepo,\n            IGenericRepository<User> userRepo,\n            IGenericRepository<Role> roleRepo,\n            IAuditLogService auditLogService,\n            IHttpContextAccessor httpContextAccessor)\n        {\n            _businessRepo = businessRepo;\n            _userRepo = userRepo;\n            _roleRepo = roleRepo;\n            _auditLogService = auditLogService;\n            _httpContextAccessor = httpContextAccessor;\n        }\n\n        public async Task<ResponseResult> SignupBusinessAsync(SignupBusinessDto dto)\n        {\n            var normalizedEmail = dto.Email.Trim().ToLower();\n            var existing = await _userRepo.FirstOrDefaultAsync(u => u.Email == normalizedEmail);\n            if (existing != null)\n                return ResponseResult.ErrorInfo(\"❌ Email already exists\");\n\n            var business = new Business\n            {\n                Id = Guid.NewGuid(),\n                CompanyName = dto.CompanyName,\n                BusinessName = dto.CompanyName,\n                BusinessEmail = normalizedEmail,\n                RepresentativeName = dto.RepresentativeName,\n                Phone = dto.Phone,\n                Status = Business.StatusType.Pending,\n                // Plan = PlanType.Basic,\n                IsApproved = false,\n                CreatedAt = DateTime.UtcNow\n            };\n            // STEP 2: Create Plan Info separately\n            var planInfo = new BusinessPlanInfo\n            {\n                BusinessId = business.Id,\n                Plan = PlanType.Basic,\n                TotalMonthlyQuota = 1000,\n                RemainingMessages = 1000,\n                QuotaResetDate = DateTime.UtcNow.AddMonths(1),\n                WalletBalance = 0\n            };\n            // STEP 3: Link them\n            business.BusinessPlanInfo = planInfo;\n            // STEP 4: Save both\n            await _businessRepo.AddAsync(business);\n            await _businessRepo.SaveAsync();\n\n            var role = await _roleRepo.FirstOrDefaultAsync(r => r.Name.ToLower() == dto.RoleName.Trim().ToLower());\n\n            if (role == null)\n                return ResponseResult.ErrorInfo(\"❌ Invalid role specified\");\n\n            var user = new User\n            {\n                Id = Guid.NewGuid(),\n                Name = dto.CompanyName,\n                Email = normalizedEmail,\n                PasswordHash = HashPassword(dto.Password),\n                Role = role,\n                Status = \"Pending\",\n                BusinessId = business.Id\n            };\n\n            await _userRepo.AddAsync(user);\n            await _userRepo.SaveAsync();\n\n            await _auditLogService.SaveLogAsync(new AuditLog\n            {\n                BusinessId = business.Id,\n                PerformedByUserId = user.Id,\n                PerformedByUserName = user.Name,\n                RoleAtTime = \"business\",\n                ActionType = \"business.signup\",\n                Description = $\"New business signup: {business.CompanyName}\",\n                IPAddress = _httpContextAccessor.HttpContext?.Connection?.RemoteIpAddress?.ToString(),\n                UserAgent = _httpContextAccessor.HttpContext?.Request?.Headers[\"User-Agent\"].ToString()\n            });\n\n            return ResponseResult.SuccessInfo(\"✅ Signup successful. Pending approval.\", new { BusinessId = business.Id });\n        }\n\n        public async Task<ResponseResult> UpdateBusinessAsync(Business business)\n        {\n            if (business == null)\n                return ResponseResult.ErrorInfo(\"❌ Invalid business object provided.\");\n\n            try\n            {\n                _businessRepo.Update(business);\n                await _businessRepo.SaveAsync();\n\n                return ResponseResult.SuccessInfo(\"✅ Business updated successfully.\");\n            }\n            catch (Exception ex)\n            {\n                // 🚨 Catch any unexpected error\n                return ResponseResult.ErrorInfo(\"❌ Failed to update business: \" + ex.Message);\n            }\n        }\n      \n        public async Task<List<PendingBusinessDto>> GetPendingBusinessesAsync(string role, string userId)\n        {\n            try\n            {\n                if (string.IsNullOrEmpty(userId) || string.IsNullOrEmpty(role))\n                {\n                    // 🔴 Invalid session or token\n                    return new List<PendingBusinessDto>();\n                }\n\n                if (!Guid.TryParse(userId, out var currentGuid))\n                {\n                    // 🔴 Bad ID format\n                    return new List<PendingBusinessDto>();\n                }\n\n                IQueryable<Business> query = _businessRepo.AsQueryable()\n                    .Where(b => b.Status == Business.StatusType.Pending && !b.IsDeleted);\n\n                if (role == \"partner\")\n                {\n                    query = query.Where(b => b.CreatedByPartnerId == currentGuid);\n                }\n\n                var pending = await query.ToListAsync();\n\n                return pending.Select(b => new PendingBusinessDto\n                {\n                    BusinessId = b.Id,\n                    CompanyName = b.CompanyName ?? \"\",\n                    BusinessEmail = b.BusinessEmail ?? \"\",\n                    RepresentativeName = b.RepresentativeName ?? \"\",\n                    Phone = b.Phone ?? \"\",\n                    //Plan = b.Plan.ToString(),\n                    Plan = b.BusinessPlanInfo?.Plan.ToString() ?? \"Unknown\",\n\n                    CreatedAt = b.CreatedAt,\n                    IsApproved = b.IsApproved\n                }).ToList();\n            }\n            catch (Exception ex)\n            {\n                return new List<PendingBusinessDto>();\n            }\n        }\n\n        public async Task<ResponseResult> ApproveBusinessAsync(Guid businessId)\n        {\n            var business = await _businessRepo\n                .AsQueryable()\n                .Include(b => b.Users)\n                .FirstOrDefaultAsync(b => b.Id == businessId);\n\n            if (business == null)\n                return ResponseResult.ErrorInfo(\"❌ Business not found.\");\n\n            // ✅ Current Logged-in User Details\n            var httpContext = _httpContextAccessor.HttpContext;\n            var currentUserId = httpContext?.User?.FindFirst(\"id\")?.Value;\n            var currentUserRole = httpContext?.User?.Claims\n    .FirstOrDefault(c => c.Type.Contains(\"role\"))?.Value;\n            //httpContext?.User?.FindFirst(\"role\")?.Value;\n\n            // var currentUserName = httpContext?.User?.FindFirst(\"name\")?.Value ?? \"Unknown\";\n            var currentUserName = httpContext?.User?.Claims\n    .FirstOrDefault(c => c.Type.Contains(\"name\"))?.Value ?? \"Unknown\";\n            if (string.IsNullOrEmpty(currentUserId) || string.IsNullOrEmpty(currentUserRole))\n                return ResponseResult.ErrorInfo(\"❌ Unauthorized access. Please login again.\");\n\n            var currentGuid = Guid.Parse(currentUserId);\n\n            // ✅ Authorization Logic\n            var isSuperAdmin = currentUserRole.Equals(\"admin\", StringComparison.OrdinalIgnoreCase) ||\n                               currentUserRole.Equals(\"superadmin\", StringComparison.OrdinalIgnoreCase);\n\n            var isAssignedPartner = business.CreatedByPartnerId.HasValue &&\n                                     business.CreatedByPartnerId.Value == currentGuid;\n\n            if (!isSuperAdmin && !isAssignedPartner)\n            {\n                return ResponseResult.ErrorInfo(\"⛔ You are not authorized to approve this business.\");\n            }\n\n            // ✅ Approve Business\n            business.IsApproved = true;\n            business.Status = Business.StatusType.Approved;\n            business.ApprovedAt = DateTime.UtcNow;\n            business.ApprovedBy = currentUserName;\n\n            _businessRepo.Update(business);\n\n            // ✅ Update all Users to \"ProfilePending\"\n            foreach (var user in business.Users)\n            {\n                user.Status = \"ProfilePending\";\n                _userRepo.Update(user);\n            }\n\n            await _businessRepo.SaveAsync();\n            await _userRepo.SaveAsync();\n\n            // ✅ Audit Log\n            await _auditLogService.SaveLogAsync(new AuditLog\n            {\n                BusinessId = business.Id,\n                PerformedByUserId = currentGuid,\n                PerformedByUserName = currentUserName,\n                RoleAtTime = currentUserRole,\n                ActionType = \"business.approved\",\n                Description = $\"Business approved: {business.CompanyName}\",\n                IPAddress = httpContext?.Connection?.RemoteIpAddress?.ToString(),\n                UserAgent = httpContext?.Request?.Headers[\"User-Agent\"].ToString()\n            });\n\n            return ResponseResult.SuccessInfo(\"✅ Business approved successfully.\");\n        }\n\n        public async Task<ResponseResult> RejectBusinessAsync(Guid businessId)\n        {\n            var business = await _businessRepo.FindByIdAsync(businessId);\n            if (business is null)\n                return ResponseResult.ErrorInfo(\"❌ Business not found\");\n\n            business.Status = Business.StatusType.Rejected;\n            business.IsDeleted = true;\n            business.DeletedAt = DateTime.UtcNow;\n\n            _businessRepo.Update(business);\n            await _businessRepo.SaveAsync();\n\n            await _auditLogService.SaveLogAsync(new AuditLog\n            {\n                BusinessId = business.Id,\n                PerformedByUserId = Guid.TryParse(_httpContextAccessor.HttpContext?.User?.FindFirst(\"id\")?.Value, out var userId) ? userId : Guid.Empty,\n                PerformedByUserName = _httpContextAccessor.HttpContext?.User?.FindFirst(\"email\")?.Value,\n                RoleAtTime = _httpContextAccessor.HttpContext?.User?.FindFirst(\"role\")?.Value,\n                ActionType = \"business.rejected\",\n                Description = $\"Business rejected: {business.CompanyName}\",\n                IPAddress = _httpContextAccessor.HttpContext?.Connection?.RemoteIpAddress?.ToString(),\n                UserAgent = _httpContextAccessor.HttpContext?.Request?.Headers[\"User-Agent\"].ToString()\n            });\n\n            return ResponseResult.SuccessInfo(\"✅ Business rejected and marked as deleted\");\n        }\n\n        public async Task<ResponseResult> HoldBusinessAsync(Guid businessId)\n        {\n            var business = await _businessRepo.FindByIdAsync(businessId);\n            if (business is null)\n                return ResponseResult.ErrorInfo(\"❌ Business not found\");\n\n            business.IsApproved = false;\n            business.Status = Business.StatusType.Pending;\n\n            _businessRepo.Update(business);\n            await _businessRepo.SaveAsync();\n\n            await _auditLogService.SaveLogAsync(new AuditLog\n            {\n                BusinessId = business.Id,\n                PerformedByUserId = Guid.TryParse(_httpContextAccessor.HttpContext?.User?.FindFirst(\"id\")?.Value, out var userId) ? userId : Guid.Empty,\n                PerformedByUserName = _httpContextAccessor.HttpContext?.User?.FindFirst(\"email\")?.Value,\n                RoleAtTime = _httpContextAccessor.HttpContext?.User?.FindFirst(\"role\")?.Value,\n                ActionType = \"business.hold\",\n                Description = $\"Business put on hold: {business.CompanyName}\",\n                IPAddress = _httpContextAccessor.HttpContext?.Connection?.RemoteIpAddress?.ToString(),\n                UserAgent = _httpContextAccessor.HttpContext?.Request?.Headers[\"User-Agent\"].ToString()\n            });\n\n            return ResponseResult.SuccessInfo(\"⏸ Business put on hold\");\n        }\n\n        public async Task<ResponseResult> CompleteProfileAsync(Guid businessId, ProfileCompletionDto dto)\n        {\n            var business = await _businessRepo.FindByIdAsync(businessId);\n            if (business is null)\n                return ResponseResult.ErrorInfo(\"❌ Business not found\");\n\n            if (!string.IsNullOrEmpty(dto.BusinessName)) business.BusinessName = dto.BusinessName;\n            if (!string.IsNullOrEmpty(dto.CompanyPhone)) business.CompanyPhone = dto.CompanyPhone;\n            if (!string.IsNullOrEmpty(dto.Website)) business.Website = dto.Website;\n            if (!string.IsNullOrEmpty(dto.Address)) business.Address = dto.Address;\n            if (!string.IsNullOrEmpty(dto.Industry)) business.Industry = dto.Industry;\n            if (!string.IsNullOrEmpty(dto.LogoUrl)) business.LogoUrl = dto.LogoUrl;\n            if (!string.IsNullOrEmpty(dto.ReperesentativeName)) business.RepresentativeName = dto.ReperesentativeName;\n            if (!string.IsNullOrEmpty(dto.Phone)) business.Phone = dto.Phone;\n            _businessRepo.Update(business);\n            await _businessRepo.SaveAsync();\n            return ResponseResult.SuccessInfo(\"✅ Profile updated successfully\");\n        }\n\n        public async Task<Business?> GetBusinessByEmailAsync(string email)\n        {\n            return await _businessRepo.FirstOrDefaultAsync(b => b.BusinessEmail.ToLower() == email.Trim().ToLower());\n        }\n\n        private string HashPassword(string password)\n        {\n            using var sha = SHA256.Create();\n            var bytes = Encoding.UTF8.GetBytes(password);\n            var hash = sha.ComputeHash(bytes);\n            return Convert.ToBase64String(hash);\n        }\n\n        public async Task<Business?> GetByIdAsync(Guid businessId)\n        {\n            return await _businessRepo.FindByIdAsync(businessId);\n        }\n\n        public async Task<List<Business>> GetApprovedBusinessesAsync()\n        {\n            return await _businessRepo.AsQueryable()\n               .Where(b => b.IsApproved && !b.IsDeleted)\n               .OrderBy(b => b.CompanyName)\n               .ToListAsync();\n        }\n        public IQueryable<Business> Query()\n        {\n            return _businessRepo.AsQueryable();\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/BusinessModule/Services/IBusinessService.cs",
      "sha256": "5205ee768b8669a55cd022a8bec1e88cabbc330f576d4532922b1e43378461ed",
      "language": "csharp",
      "size": 1180,
      "content": "using System.Runtime.CompilerServices;\nusing xbytechat.api.Features.BusinessModule.DTOs;\nusing xbytechat.api.Features.BusinessModule.Models;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Models;\nnamespace xbytechat.api.Features.BusinessModule.Services\n{\n\n    public interface IBusinessService\n    {\n        IQueryable<Business> Query();\n        Task<ResponseResult> SignupBusinessAsync(SignupBusinessDto dto); /// Signup + create admin user\n\n        Task<ResponseResult> ApproveBusinessAsync(Guid businessId);      // Admin action\n        Task<ResponseResult> RejectBusinessAsync(Guid businessId);       // Admin action\n        Task<ResponseResult> HoldBusinessAsync(Guid businessId);         // Admin action\n        Task<ResponseResult> CompleteProfileAsync(Guid businessId, ProfileCompletionDto dto); // Post-login completion\n        Task<Business?> GetBusinessByEmailAsync(string email);\n        Task<Business?> GetByIdAsync(Guid businessId);\n        Task<ResponseResult> UpdateBusinessAsync(Business business);\n        Task<List<PendingBusinessDto>> GetPendingBusinessesAsync(string role, string userId);\n        Task<List<Business>> GetApprovedBusinessesAsync();\n    }\n\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Controllers/CampaignController.cs",
      "sha256": "7c8049bda65a4bdfec05f78a7990ef02375d77b5b738d9763dd787f27474e7c0",
      "language": "csharp",
      "size": 13243,
      "content": "using Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing Serilog;\nusing System;\nusing System.Security.Claims;\nusing System.Threading.Tasks;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.Features.BusinessModule.Services;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Services;\nusing xbytechat.api.Features.MessagesEngine.Services;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Shared;\nusing static xbytechat.api.Features.MessagesEngine.Controllers.MessageEngineController;\n\nnamespace xbytechat.api.Features.CampaignModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    public class CampaignController : ControllerBase\n    {\n        private readonly ICampaignService _campaignService;\n        private readonly IBusinessService _businessService;\n        private readonly IMessageEngineService _messageService;\n        private readonly IHttpContextAccessor _httpContextAccessor;\n\n        public CampaignController(\n            ICampaignService campaignService,\n            IBusinessService businessService,\n            IMessageEngineService messageEngineService,\n            IHttpContextAccessor httpContextAccessor)\n        {\n            _campaignService = campaignService;\n            _businessService = businessService;\n            _messageService = messageEngineService;\n            _httpContextAccessor = httpContextAccessor;\n        }\n\n        [HttpGet(\"get-image-campaign\")]\n        public async Task<IActionResult> GetAll([FromQuery] string? type)\n        {\n            var user = HttpContext.User;\n            var businessIdClaim = user.FindFirst(\"businessId\");\n\n            if (businessIdClaim == null || !Guid.TryParse(businessIdClaim.Value, out var businessId))\n                return Unauthorized(new { message = \"🚫 Invalid or missing BusinessId claim.\" });\n\n            var result = await _campaignService.GetAllCampaignsAsync(businessId, type);\n            return Ok(result);\n        }\n\n        [HttpGet(\"paginated\")]\n        public async Task<IActionResult> GetPaginatedCampaigns([FromQuery] PaginatedRequest request)\n        {\n            var user = HttpContext.User;\n            var businessIdClaim = user.FindFirst(\"businessId\");\n\n            if (businessIdClaim == null || !Guid.TryParse(businessIdClaim.Value, out var businessId))\n                return Unauthorized(new { message = \"🚫 Invalid or missing BusinessId claim.\" });\n\n            var result = await _campaignService.GetPaginatedCampaignsAsync(businessId, request);\n            return Ok(result);\n        }\n\n        [HttpGet(\"debug-claims\")]\n        public IActionResult DebugClaims()\n        {\n            var user = HttpContext.User;\n            var businessId = user.FindFirst(\"businessId\")?.Value;\n\n            return Ok(new\n            {\n                name = user.Identity?.Name,\n                businessId\n            });\n        }\n\n        [HttpPost(\"create-text-campaign\")]\n        public async Task<IActionResult> CreateTextCampaign([FromBody] CampaignCreateDto dto)\n        {\n            try\n            {\n                var businessIdClaim = User.FindFirst(\"businessId\")?.Value;\n                if (!Guid.TryParse(businessIdClaim, out var businessId))\n                    return Unauthorized(new { message = \"🚫 Invalid or missing BusinessId claim.\" });\n\n                var createdBy = User.Identity?.Name ?? \"system\";\n\n                if (string.IsNullOrWhiteSpace(dto.Name))\n                    return BadRequest(new { message = \"🚫 Campaign name is required.\" });\n\n                if (string.IsNullOrWhiteSpace(dto.TemplateId))\n                    return BadRequest(new { message = \"🚫 TemplateId is required for template campaigns.\" });\n\n                if (string.IsNullOrWhiteSpace(dto.MessageTemplate))\n                    return BadRequest(new { message = \"🚫 Message template content is required.\" });\n\n                var campaignId = await _campaignService.CreateTextCampaignAsync(dto, businessId, createdBy);\n\n                return campaignId != null\n                    ? Ok(new\n                    {\n                        success = true,\n                        message = \"✅ Campaign created successfully\",\n                        campaignId = campaignId.Value\n                    })\n                    : BadRequest(new { success = false, message = \"❌ Failed to create campaign\" });\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"❌ Exception in CreateTextCampaign\");\n                return StatusCode(500, new { message = \"🚨 Internal server error\", error = ex.Message });\n            }\n        }\n\n        [HttpPost(\"create-image-campaign\")]\n        public async Task<IActionResult> CreateImageCampaign([FromBody] CampaignCreateDto dto)\n        {\n            try\n            {\n                var user = HttpContext.User;\n                var businessIdClaim = user.FindFirst(\"businessId\");\n\n                if (businessIdClaim == null || !Guid.TryParse(businessIdClaim.Value, out var businessId))\n                    return Unauthorized(new { message = \"🚫 Invalid or missing BusinessId claim.\" });\n\n                if (dto.MultiButtons != null && dto.MultiButtons.Any())\n                {\n                    var allowedTypes = new[] { \"url\", \"copy_code\", \"flow\", \"phone_number\", \"quick_reply\" };\n                    foreach (var button in dto.MultiButtons)\n                    {\n                        var type = button.ButtonType?.Trim().ToLower();\n\n                        if (!allowedTypes.Contains(type))\n                            return BadRequest(new { message = $\"❌ Invalid ButtonType: '{type}' is not supported.\" });\n\n                        var needsValue = new[] { \"url\", \"flow\", \"copy_code\", \"phone_number\" };\n                        if (needsValue.Contains(type) && string.IsNullOrWhiteSpace(button.TargetUrl))\n                            return BadRequest(new { message = $\"❌ Button '{button.ButtonText}' requires a valid TargetUrl or Value for type '{type}'.\" });\n\n                        if (button.TargetUrl?.ToLower() == \"unknown\")\n                            return BadRequest(new { message = $\"❌ Invalid value 'unknown' found in button '{button.ButtonText}'.\" });\n                    }\n                }\n\n                var createdBy = user.Identity?.Name ?? \"system\";\n                var campaignId = await _campaignService.CreateImageCampaignAsync(businessId, dto, createdBy);\n\n                return Ok(new\n                {\n                    success = true,\n                    message = \"✅ Campaign created successfully\",\n                    campaignId\n                });\n            }\n            catch (UnauthorizedAccessException ex)\n            {\n                return BadRequest(new { message = ex.Message });\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"❌ Exception in CreateImageCampaign\");\n                return StatusCode(500, new { message = \"🚨 Internal server error\", error = ex.Message });\n            }\n        }\n\n        // ✅ Moved above {id} routes\n        [HttpPost(\"{id}/assign-contacts\")]\n        public async Task<IActionResult> AssignContactsToCampaign(Guid id, [FromBody] AssignContactsDto request)\n        {\n            try\n            {\n                var businessId = GetBusinessId();\n                var success = await _campaignService.AssignContactsToCampaignAsync(id, businessId, request.ContactIds);\n\n                return success\n                    ? Ok(new { message = \"✅ Contacts assigned\" })\n                    : BadRequest(new { message = \"❌ Failed to assign contacts\" });\n            }\n            catch (Exception ex)\n            {\n                Console.WriteLine(\"❌ Error assigning contacts: \" + ex.Message);\n                return StatusCode(500, new { message = \"Internal error\", error = ex.Message });\n            }\n        }\n\n        [HttpDelete(\"{campaignId}/recipients/{contactId}\")]\n        public async Task<IActionResult> RemoveCampaignRecipient(Guid campaignId, Guid contactId)\n        {\n            try\n            {\n                var businessId = GetBusinessId();\n                var success = await _campaignService.RemoveRecipientAsync(businessId, campaignId, contactId);\n\n                if (!success)\n                    return NotFound(new { message = \"Recipient not found or not assigned\" });\n\n                return NoContent();\n            }\n            catch (Exception ex)\n            {\n                Console.WriteLine(\"❌ Remove recipient failed: \" + ex.Message);\n                return StatusCode(500, new { message = \"Error removing recipient\", detail = ex.Message });\n            }\n        }\n        \n        // Send campaign method (Core Method to send template message)\n        [HttpPost(\"send-campaign/{campaignId}\")] // use to send free text and Template campaigns\n        public async Task<IActionResult> SendTemplateCampaign(Guid campaignId)\n        {\n            try\n            {\n                var result = await _campaignService.SendTemplateCampaignWithTypeDetectionAsync(campaignId);\n                return result.Success ? Ok(result) : BadRequest(result);\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"❌ Exception while sending image template campaign\");\n                return StatusCode(500, ResponseResult.ErrorInfo(\"🚨 Server error while sending campaign\", ex.ToString()));\n            }\n        }\n\n        [HttpPost(\"send-template-campaign/{id}\")]\n        public async Task<IActionResult> SendImageCampaign(Guid id)\n        {\n            var result = await _campaignService.SendTemplateCampaignAsync(id);\n            return result.Success ? Ok(result) : BadRequest(result);\n        }\n\n        [HttpPost(\"send/{campaignId}\")]\n        public async Task<IActionResult> SendCampaign(Guid campaignId)\n        {\n            try\n            {\n                var ipAddress = HttpContext.Connection.RemoteIpAddress?.ToString() ?? \"unknown\";\n                var userAgent = Request.Headers[\"User-Agent\"].ToString() ?? \"unknown\";\n\n                var success = await _campaignService.SendCampaignAsync(campaignId, ipAddress, userAgent);\n\n                return success\n                    ? Ok(new { success = true, message = \"✅ Campaign sent successfully\" })\n                    : BadRequest(new { success = false, message = \"❌ Campaign sending failed\" });\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"❌ Exception in SendCampaign\");\n                return StatusCode(500, new { success = false, message = \"🚨 Internal Server Error\", error = ex.Message });\n            }\n        }\n\n        [HttpPut(\"{id}\")]\n        public async Task<IActionResult> UpdateCampaign(Guid id, [FromBody] CampaignCreateDto dto)\n        {\n            var result = await _campaignService.UpdateCampaignAsync(id, dto);\n            return result\n                ? Ok(new { message = \"✏️ Campaign updated successfully\" })\n                : BadRequest(new { message = \"❌ Update failed — only draft campaigns can be edited\" });\n        }\n\n        [HttpDelete(\"{id}\")]\n        public async Task<IActionResult> DeleteCampaign(Guid id)\n        {\n            var result = await _campaignService.DeleteCampaignAsync(id);\n            return result\n                ? Ok(new { message = \"🗑️ Campaign deleted successfully\" })\n                : BadRequest(new { message = \"❌ Delete failed — only draft campaigns can be deleted\" });\n        }\n\n        [HttpGet(\"recipients/{id}\")]\n        public async Task<IActionResult> GetCampaignRecipients(Guid id)\n        {\n            try\n            {\n                var businessId = GetBusinessId();\n                var recipients = await _campaignService.GetRecipientsByCampaignIdAsync(id, businessId);\n                return Ok(recipients);\n            }\n            catch (Exception ex)\n            {\n                Console.WriteLine(\"❌ Error fetching campaign recipients: \" + ex.Message);\n                return StatusCode(500, new { message = \"Error fetching recipients\", detail = ex.Message });\n            }\n        }\n\n        [HttpGet(\"{id}\")]\n        public async Task<ActionResult<CampaignDto>> GetCampaignById(Guid id)\n        {\n            var businessId = GetBusinessId();\n            var campaign = await _campaignService.GetCampaignByIdAsync(id, businessId);\n\n            if (campaign == null)\n                return NotFound();\n\n            return Ok(campaign);\n        }\n\n        private Guid GetBusinessId()\n        {\n            var claim = HttpContext.User.FindFirst(\"businessId\")?.Value;\n            if (string.IsNullOrEmpty(claim))\n                throw new UnauthorizedAccessException(\"BusinessId not found in token claims.\");\n\n            return Guid.Parse(claim);\n        }\n    \n        [HttpGet(\"list/{businessId:guid}\")]\n        public async Task<IActionResult> GetAvailableFlows(Guid businessId, [FromQuery] bool onlyPublished = true)\n        {\n            var items = await _campaignService.GetAvailableFlowsAsync(businessId, onlyPublished);\n            return Ok(new { success = true, items });\n        }\n\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Controllers/CampaignRecipientController.cs",
      "sha256": "247e52ea9259e04d5bc4fb6e22d3aa4791b77af05431022b0572a837bbf7e326",
      "language": "csharp",
      "size": 3341,
      "content": "using Microsoft.AspNetCore.Mvc;\nusing Serilog;\nusing System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Services;\n\nnamespace xbytechat.api.Features.CampaignModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    public class CampaignRecipientController : ControllerBase\n    {\n        private readonly ICampaignRecipientService _recipientService;\n\n        public CampaignRecipientController(ICampaignRecipientService recipientService)\n        {\n            _recipientService = recipientService;\n        }\n\n        // ✅ Get a single recipient by ID\n        [HttpGet(\"{id}\")]\n        public async Task<ActionResult<CampaignRecipientDto>> GetRecipientById(Guid id)\n        {\n            var recipient = await _recipientService.GetByIdAsync(id);\n            if (recipient == null)\n                return NotFound(new { message = \"Recipient not found\" });\n\n            return Ok(recipient);\n        }\n\n        // ✅ Get all recipients for a specific campaign\n        [HttpGet(\"/api/campaigns/{campaignId}/recipients\")]\n        public async Task<ActionResult> GetRecipientsForCampaign(Guid campaignId)\n        {\n            var recipients = await _recipientService.GetByCampaignIdAsync(campaignId);\n            return Ok(recipients);\n        }\n\n        // ✅ Update recipient status (e.g., from Pending → Sent)\n        [HttpPut(\"{recipientId}/status\")]\n        public async Task<ActionResult> UpdateStatus(Guid recipientId, [FromQuery] string newStatus)\n        {\n            var success = await _recipientService.UpdateStatusAsync(recipientId, newStatus);\n            if (!success)\n                return NotFound(new { message = \"Recipient not found or update failed\" });\n\n            return Ok(new { message = \"Status updated\" });\n        }\n\n        // ✅ Track a reply from customer\n        [HttpPut(\"{recipientId}/reply\")]\n        public async Task<ActionResult> TrackReply(Guid recipientId, [FromQuery] string replyText)\n        {\n            var success = await _recipientService.TrackReplyAsync(recipientId, replyText);\n            if (!success)\n                return NotFound(new { message = \"Recipient not found or tracking failed\" });\n\n            return Ok(new { message = \"Reply tracked\" });\n        }\n\n        // 🔍 Search recipients by optional filters (status, keyword)\n        [HttpGet(\"search\")]\n        public async Task<ActionResult<List<CampaignRecipientDto>>> SearchRecipients([FromQuery] string? status, [FromQuery] string? keyword)\n        {\n            var results = await _recipientService.SearchRecipientsAsync(status, keyword);\n            return Ok(results);\n        }\n\n        [HttpPost(\"{id}/assign-contacts\")]\n        public async Task<IActionResult> AssignContacts(Guid id, [FromBody] AssignContactsDto dto)\n        {\n            try\n            {\n                await _recipientService.AssignContactsToCampaignAsync(id, dto.ContactIds);\n                return Ok(new { message = \"Contacts assigned successfully\" });\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"Error assigning contacts to campaign\");\n                return StatusCode(500, new { message = \"Failed to assign contacts\" });\n            }\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/AssignContactsDto.cs",
      "sha256": "8f8b9b0da213111f833dd07dd7e5189ccc02984cef1b34deb5b1d93a5d40678e",
      "language": "csharp",
      "size": 156,
      "content": "namespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public class AssignContactsDto\n    {\n        public List<Guid> ContactIds { get; set; }\n    }\n\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/CampaignButtonDto.cs",
      "sha256": "21e757f8859c9ea36b40c0d3418d5211cce8a22a26b07b81af62b723f93dc2e5",
      "language": "csharp",
      "size": 379,
      "content": "namespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public class CampaignButtonDto\n    {\n        public string ButtonText { get; set; } = string.Empty; // 📍 e.g., \"Buy Now\"\n        public string ButtonType { get; set; } = \"url\";         // 🔘 url | quick_reply | call\n        public string TargetUrl { get; set; } = string.Empty;  // 🌐 or phone/call param\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/CampaignButtonParamFromMetaDto.cs",
      "sha256": "d218adbbc4e6418548f3dfe962c8b867fc7f364be490f6533d04fb5c61f17f30",
      "language": "csharp",
      "size": 391,
      "content": "namespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public class CampaignButtonParamFromMetaDto\n    {\n        public string Text { get; set; } = string.Empty;\n        public string Type { get; set; } = string.Empty;\n        public string SubType { get; set; } = string.Empty;\n        public string Value { get; set; } = string.Empty;\n        public int Position { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/CampaignCreateDto.cs",
      "sha256": "d5578bef04f767c0f82327a286191fca2953764b2185cb3f25a9d67d43418a5b",
      "language": "csharp",
      "size": 1521,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.ComponentModel.DataAnnotations.Schema;\nusing xbytechat.api.Features.CTAManagement.DTOs;\nusing xbytechat.api.Features.MessagesEngine.DTOs; // Required to reference CTAButtonDto\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public class CampaignCreateDto\n    {\n        public string Name { get; set; }\n\n        [Column(TypeName = \"text\")]\n        public string MessageTemplate { get; set; }\n\n        public string? TemplateId { get; set; } // ✅ Optional Meta template ID\n\n        public string? FollowUpTemplateId { get; set; } // 🔁 Auto-reply template after interest\n\n        public string? CampaignType { get; set; } //= \"template\"; // \"text\", \"template\", \"cta\"\n\n        public Guid? CtaId { get; set; } // 🔘 For legacy CTA support (optional)\n\n        public Guid? CTAFlowConfigId { get; set; }\n        public List<CampaignButtonDto> MultiButtons { get; set; } = new(); // ✅ New multi-button support\n        public DateTime? ScheduledAt { get; set; } // 📅 Optional future scheduling\n\n        //public List<Guid>? ContactIds { get; set; } // 👥 Target contact list\n\n        public string? ImageUrl { get; set; } // 🖼️ Optional image field\n\n        public string? ImageCaption { get; set; } // 📝 Optional caption\n\n        public List<Guid> ContactIds { get; set; } = new();\n\n        public List<string>? TemplateParameters { get; set; }\n        public List<CampaignButtonParamFromMetaDto>? ButtonParams { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/CampaignDto.cs",
      "sha256": "bf33c6aa688063d8efd2734082713e23890bb97409bae31a5bc9d18c00ccd001",
      "language": "csharp",
      "size": 1223,
      "content": "using System;\nusing System.Collections.Generic;\nusing xbytechat.api.Features.CampaignModule.DTOs;\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public class CampaignDto\n    {\n        public Guid Id { get; set; }\n\n        public string Name { get; set; }\n\n        public string MessageTemplate { get; set; }\n\n        public string? TemplateId { get; set; }\n        public string? MessageBody { get; set; }\n        public string? CampaignType { get; set; }\n\n        public string? Status { get; set; }\n\n        public string? ImageUrl { get; set; }\n\n        public string? ImageCaption { get; set; }\n\n        public DateTime CreatedAt { get; set; }\n\n        public DateTime? ScheduledAt { get; set; }\n\n        public Guid? CtaId { get; set; }\n\n        public CtaPreviewDto? Cta { get; set; }\n\n        public List<CampaignButtonDto> MultiButtons { get; set; } = new();\n\n        public Guid? CTAFlowConfigId { get; set; }\n        public string? CTAFlowName { get; set; }\n    }\n\n    // 📦 Embedded DTO for CTA preview (title + button text only)\n    public class CtaPreviewDto\n    {\n        public string Title { get; set; } = string.Empty;\n\n        public string ButtonText { get; set; } = string.Empty;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/CampaignRecipientDto.cs",
      "sha256": "7d59f3b2a92ff69f0425bf1c3541facd28da12efde822400d313e6beddc8ace5",
      "language": "csharp",
      "size": 755,
      "content": "using System;\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public class CampaignRecipientDto\n    {\n        public Guid Id { get; set; }\n\n        public Guid ContactId { get; set; }\n        public string ContactName { get; set; }\n        public string ContactPhone { get; set; }\n\n        public string Status { get; set; }\n        public DateTime? SentAt { get; set; }\n\n        // 🔁 Advanced Fields (for analytics & future automation)\n        public string? BotId { get; set; }\n        public string? MessagePreview { get; set; }\n        public string? ClickedCTA { get; set; }\n        public string? CategoryBrowsed { get; set; }\n        public string? ProductBrowsed { get; set; }\n        public bool IsAutoTagged { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/CampaignSummaryDto.cs",
      "sha256": "e425735df2c030aa13e5b046f7039f9796104b05b3ec998e039ab1d7eb40b0e0",
      "language": "csharp",
      "size": 687,
      "content": "namespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public class CampaignSummaryDto\n    {\n        public Guid Id { get; set; }\n        public string? Name { get; set; }\n        public string? Status { get; set; }\n        public DateTime? ScheduledAt { get; set; }\n        public DateTime CreatedAt { get; set; }\n        public int Delivered { get; set; }\n        public int Read { get; set; }\n\n        public string? ImageUrl { get; set; } // ✅ Add this\n        public string? ImageCaption { get; set; } // ✅ Add this\n        public string? CtaTitle { get; set; } // Optional: For CTA info\n        public int RecipientCount { get; set; } // Optional: To show 0/10 etc\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/FlowListItemDto.cs",
      "sha256": "3121c1e145f2d4fd8f1f4978f314782f0afa5d7be9ffe7be6709cfc04af7d068",
      "language": "csharp",
      "size": 246,
      "content": "namespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public class FlowListItemDto\n    {\n        public Guid Id { get; set; }\n        public string FlowName { get; set; } = string.Empty;\n        public bool IsPublished { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Models/Campaign.cs",
      "sha256": "0fc898a08b290dc0478ece8c4ac96b2feb1a36b6f3bd2b5b90d07697bec59f7a",
      "language": "csharp",
      "size": 5618,
      "content": "using System;\nusing System.Collections.Generic;\nusing xbytechat.api.CRM.Models;\nusing xbytechat.api.Features.CampaignTracking.Models;\nusing xbytechat.api.Features.CTAManagement.Models;\nusing System.ComponentModel.DataAnnotations.Schema;\nusing xbytechat.api.Features.MessageManagement.DTOs;\nusing xbytechat.api.Features.BusinessModule.Models;\nusing xbytechat.api.Features.CTAFlowBuilder.Models; // 🆕 Import for CTAFlowConfig\n\nnamespace xbytechat.api.Features.CampaignModule.Models\n{\n    public class Campaign\n    {\n        public Guid Id { get; set; }\n\n        // 🔗 Business info\n        public Guid BusinessId { get; set; }\n        public Business Business { get; set; }\n        public Guid? CampaignId { get; set; }\n        public Campaign? SourceCampaign { get; set; }\n\n        // 📋 Core campaign details\n        public string Name { get; set; }\n        public string MessageTemplate { get; set; }\n        public string? TemplateId { get; set; } // ✅ Meta-approved template ID\n\n        [Column(TypeName = \"text\")]\n        public string? MessageBody { get; set; } // ✅ Final resolved WhatsApp message body\n\n        public string? FollowUpTemplateId { get; set; }\n        public string? CampaignType { get; set; } // text, template, cta\n\n        // 🔘 CTA tracking (optional)\n        public Guid? CtaId { get; set; }\n        public CTADefinition? Cta { get; set; }\n\n        // 🆕 Link to Flow Config (optional)\n        public Guid? CTAFlowConfigId { get; set; }\n        [ForeignKey(nameof(CTAFlowConfigId))]\n        public CTAFlowConfig? CTAFlowConfig { get; set; }\n\n        public DateTime? ScheduledAt { get; set; }\n        public string Status { get; set; } = \"Draft\"; // Draft, Scheduled, Sent\n\n        // 👤 Metadata\n        public string? CreatedBy { get; set; }\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n        public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;\n\n        // 🗑️ Soft delete support\n        public bool IsDeleted { get; set; } = false;\n        public DateTime? DeletedAt { get; set; }\n        public string? DeletedBy { get; set; }\n\n        // 👥 Recipient relationship\n        public ICollection<CampaignRecipient> Recipients { get; set; }\n\n        // 📊 Logs\n        public ICollection<CampaignSendLog> SendLogs { get; set; } = new List<CampaignSendLog>();\n        public ICollection<MessageStatusLog> MessageStatusLogs { get; set; }\n\n        public string? ImageUrl { get; set; }\n        public string? ImageCaption { get; set; }\n        public string? TemplateParameters { get; set; }\n\n        public ICollection<CampaignButton> MultiButtons { get; set; } = new List<CampaignButton>();\n\n        public ICollection<MessageLog> MessageLogs { get; set; } = new List<MessageLog>();\n    }\n}\n\n\n//using System;\n//using System.Collections.Generic;\n//using xbytechat.api.CRM.Models;\n//using xbytechat.api.Features.CampaignTracking.Models;\n//using xbytechat.api.Features.CTAManagement.Models;\n//using System.ComponentModel.DataAnnotations.Schema;\n//using xbytechat.api.Features.MessageManagement.DTOs;\n//using xbytechat.api.Features.BusinessModule.Models;\n\n//namespace xbytechat.api.Features.CampaignModule.Models\n//{\n//    public class Campaign\n//    {\n//        public Guid Id { get; set; }\n\n//        // 🔗 Business info\n//        public Guid BusinessId { get; set; }\n//        public Business Business { get; set; }\n//        public Guid? CampaignId { get; set; }\n//        public Campaign? SourceCampaign { get; set; }\n\n//        // 📋 Core campaign details\n//        public string Name { get; set; }\n//        public string MessageTemplate { get; set; }\n//        public string? TemplateId { get; set; } // ✅ Meta-approved template ID\n\n//        [Column(TypeName = \"text\")]\n//        public string? MessageBody { get; set; } // ✅ Final resolved WhatsApp message body\n\n\n//        public string? FollowUpTemplateId { get; set; } // 🔁 For auto-reply follow-up after interest\n//        public string? CampaignType { get; set; } // = \"template\"; // text, template, cta\n\n//        // 🔘 CTA tracking (optional)\n//        public Guid? CtaId { get; set; }\n//        public CTADefinition? Cta { get; set; }\n\n\n//        public DateTime? ScheduledAt { get; set; }\n//        public string Status { get; set; } = \"Draft\"; // Draft, Scheduled, Sent\n\n//        // 👤 Metadata\n//        public string? CreatedBy { get; set; }\n//        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n//        public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;\n\n//        // 🗑️ Soft delete support\n//        public bool IsDeleted { get; set; } = false;\n//        public DateTime? DeletedAt { get; set; }\n//        public string? DeletedBy { get; set; }\n\n//        // 👥 Recipient relationship\n//        public ICollection<CampaignRecipient> Recipients { get; set; }\n\n//        // 📊 Logs\n//        public ICollection<CampaignSendLog> SendLogs { get; set; } = new List<CampaignSendLog>();\n//        public ICollection<MessageStatusLog> MessageStatusLogs { get; set; }\n\n//        //public ICollection<Campaign> Campaigns { get; set; } = new List<Campaign>();\n\n//        public string? ImageUrl { get; set; } // ✅ store image URL\n//        public string? ImageCaption { get; set; } // optional caption\n//        public string? TemplateParameters { get; set; } // ✅ stores [\"value1\", \"value2\", ...] as JSON string\n\n//        public ICollection<CampaignButton> MultiButtons { get; set; } = new List<CampaignButton>();\n\n//        public ICollection<MessageLog> MessageLogs { get; set; } = new List<MessageLog>();\n\n//    }\n//}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Models/CampaignButton.cs",
      "sha256": "bfca22e0aed3117f3be8b3712de4a7b229991bc3c4b02bdb1f17e43709991977",
      "language": "csharp",
      "size": 654,
      "content": "using System;\n\nnamespace xbytechat.api.Features.CampaignModule.Models\n{\n    public class CampaignButton\n    {\n        public Guid Id { get; set; }\n\n        public Guid CampaignId { get; set; } // 🔗 Foreign key\n        public Campaign Campaign { get; set; }\n\n        public string Title { get; set; } = string.Empty; // Button Text (e.g. Buy Now)\n        public string Type { get; set; } = \"url\"; // Type: url, quick_reply, call, etc.\n        public string Value { get; set; } = string.Empty; // Target URL or payload\n\n        public int Position { get; set; } // Button order (1–3)\n        public bool IsFromTemplate { get; set; } = false;\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Models/CampaignFlowOverride.cs",
      "sha256": "c4ee719e7601cfb0eb6d67fbba7e11cbd4a57ad5be58dd84f72beead08d88370",
      "language": "csharp",
      "size": 798,
      "content": "using System.ComponentModel.DataAnnotations.Schema;\nusing System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.Features.CampaignModule.Models\n{\n    public class CampaignFlowOverride\n    {\n        [Key]\n        public Guid Id { get; set; }\n\n        [Required]\n        public Guid CampaignId { get; set; }\n\n        [Required]\n        [MaxLength(100)]\n        public string TemplateName { get; set; } = string.Empty;\n\n        [Required]\n        [MaxLength(50)]\n        public string ButtonText { get; set; } = string.Empty;\n\n        public string? OverrideNextTemplate { get; set; }\n\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n        public string? CreatedBy { get; set; }\n\n        [ForeignKey(\"CampaignId\")]\n        public Campaign? Campaign { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Models/CampaignRecipient.cs",
      "sha256": "56577228e95ed7f6c8f49036a0f4a95c7536726ea3c45a0a6f3b60ea7fe33362",
      "language": "csharp",
      "size": 1497,
      "content": "using System;\nusing System.Collections.Generic;\nusing xbytechat.api.CRM.Models;\nusing xbytechat.api.Features.BusinessModule.Models;\nusing xbytechat.api.Features.CampaignTracking.Models;\n\nnamespace xbytechat.api.Features.CampaignModule.Models\n{\n    public class CampaignRecipient\n    {\n        public Guid Id { get; set; }\n\n        public Guid CampaignId { get; set; }\n        public Campaign Campaign { get; set; }\n\n        public Guid ContactId { get; set; }\n        public Contact Contact { get; set; }\n\n        public string Status { get; set; } = \"Pending\"; // Pending, Sent, Delivered, Failed, Replied\n        public DateTime? SentAt { get; set; }\n\n        public string? BotId { get; set; } // Multi-bot support\n        public string? MessagePreview { get; set; } // Final message sent\n        public string? ClickedCTA { get; set; } // Track CTA clicked like \"BuyNow\"\n        public string? CategoryBrowsed { get; set; } // e.g., Ads\n        public string? ProductBrowsed { get; set; } // e.g., Product name\n        public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;\n\n        public bool IsAutoTagged { get; set; } = false; // Flag for automation-based tagging\n\n        // ✅ NEW: One-to-many link to detailed logs (message attempts, delivery tracking)\n        public ICollection<CampaignSendLog> SendLogs { get; set; }\n\n        public Guid BusinessId { get; set; }  // ✅ Add this line\n        public Business Business { get; set; } = null!; // if navigation is needed\n\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Models/TempCampaignRecipient.cs",
      "sha256": "62b7c7ce62f02ff80d38fb3477ccb849580cb1f859396e2ab7b6ad857fcc22a2",
      "language": "csharp",
      "size": 617,
      "content": "// Features/CampaignModule/Models/TempCampaignRecipient.cs\nusing System;\n\nnamespace xbytechat.api.Features.CampaignModule.Models\n{\n    public class TempCampaignRecipient\n    {\n        public Guid Id { get; set; }\n\n        public Guid CampaignId { get; set; }\n        public Campaign Campaign { get; set; }\n\n        public string PhoneNumber { get; set; } = string.Empty;\n        public string? Name { get; set; }\n\n        public string Status { get; set; } = \"Pending\"; // Pending, Sent, Failed\n        public DateTime? SentAt { get; set; }\n\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/CampaignRecipientService.cs",
      "sha256": "9e537d67c7d3b811b4d26288fa63b38b0097f997fc84b8d0313877e3f77fe809",
      "language": "csharp",
      "size": 5435,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Models;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    public class CampaignRecipientService : ICampaignRecipientService\n    {\n        private readonly AppDbContext _context;\n\n        public CampaignRecipientService(AppDbContext context)\n        {\n            _context = context;\n        }\n\n        // 🔍 Get a single recipient by ID\n        public async Task<CampaignRecipientDto?> GetByIdAsync(Guid id)\n        {\n            return await _context.CampaignRecipients\n                .Include(r => r.Contact)\n                .Where(r => r.Id == id)\n                .Select(r => new CampaignRecipientDto\n                {\n                    Id = r.Id,\n                    ContactId = r.ContactId,\n                    ContactName = r.Contact.Name,\n                    ContactPhone = r.Contact.PhoneNumber,\n                    Status = r.Status,\n                    SentAt = r.SentAt\n                })\n                .FirstOrDefaultAsync();\n        }\n\n        // 📦 Get all recipients of a specific campaign\n        public async Task<List<CampaignRecipientDto>> GetByCampaignIdAsync(Guid campaignId)\n        {\n            return await _context.CampaignRecipients\n                .Include(r => r.Contact)\n                .Where(r => r.CampaignId == campaignId)\n                .Select(r => new CampaignRecipientDto\n                {\n                    Id = r.Id,\n                    ContactId = r.ContactId,\n                    ContactName = r.Contact.Name,\n                    ContactPhone = r.Contact.PhoneNumber,\n                    Status = r.Status,\n                    SentAt = r.SentAt\n                })\n                .ToListAsync();\n        }\n\n        // ✏️ Update status of a specific recipient\n        public async Task<bool> UpdateStatusAsync(Guid recipientId, string newStatus)\n        {\n            var recipient = await _context.CampaignRecipients.FindAsync(recipientId);\n            if (recipient == null) return false;\n\n            recipient.Status = newStatus;\n            recipient.UpdatedAt = DateTime.UtcNow;\n\n            await _context.SaveChangesAsync();\n            return true;\n        }\n\n        // 💬 Track customer reply or CTA\n        // 🗣️ Track customer reply on a recipient\n        public async Task<bool> TrackReplyAsync(Guid recipientId, string replyText)\n        {\n            var recipient = await _context.CampaignRecipients.FindAsync(recipientId);\n            if (recipient == null) return false;\n\n            recipient.ClickedCTA = replyText;\n            recipient.UpdatedAt = DateTime.UtcNow;\n\n            await _context.SaveChangesAsync();\n            return true;\n        }\n\n\n        // 🔎 Global recipient search across all campaigns\n        // 🔍 Search recipients by optional status or keyword\n        public async Task<List<CampaignRecipientDto>> SearchRecipientsAsync(string status = null, string keyword = null)\n        {\n            var query = _context.CampaignRecipients\n                .Include(r => r.Contact)\n                .AsQueryable();\n\n            if (!string.IsNullOrEmpty(status))\n                query = query.Where(r => r.Status == status);\n\n            if (!string.IsNullOrEmpty(keyword))\n                query = query.Where(r =>\n                    r.Contact.Name.Contains(keyword) ||\n                    r.Contact.PhoneNumber.Contains(keyword)\n                );\n\n            return await query\n                .Select(r => new CampaignRecipientDto\n                {\n                    Id = r.Id,\n                    ContactId = r.ContactId,\n                    ContactName = r.Contact.Name,\n                    ContactPhone = r.Contact.PhoneNumber,\n                    Status = r.Status,\n                    SentAt = r.SentAt\n                })\n                .ToListAsync();\n        }\n\n        public async Task AssignContactsToCampaignAsync(Guid campaignId, List<Guid> contactIds)\n        {\n            var campaign = await _context.Campaigns\n                .AsNoTracking()\n                .FirstOrDefaultAsync(c => c.Id == campaignId);\n\n            if (campaign == null)\n                throw new Exception(\"Campaign not found.\");\n\n            var businessId = campaign.BusinessId;\n\n            var existing = await _context.CampaignRecipients\n                .Where(r => r.CampaignId == campaignId && contactIds.Contains(r.ContactId))\n                .Select(r => r.ContactId)\n                .ToListAsync();\n\n            var newRecipients = contactIds\n                .Where(id => !existing.Contains(id))\n                .Select(contactId => new CampaignRecipient\n                {\n                    Id = Guid.NewGuid(),\n                    CampaignId = campaignId,\n                    ContactId = contactId,\n                    BusinessId = businessId, // ✅ required\n                    Status = \"Pending\",\n                    SentAt = DateTime.UtcNow,\n                    UpdatedAt = DateTime.UtcNow,\n                    IsAutoTagged = false\n                }).ToList();\n\n            if (newRecipients.Any())\n            {\n                await _context.CampaignRecipients.AddRangeAsync(newRecipients);\n                await _context.SaveChangesAsync();\n            }\n        }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/CampaignService.cs",
      "sha256": "159797c22265ad6bbd7cf080be0988bac206555404b296fd54786edbbf12ea4e",
      "language": "csharp",
      "size": 76075,
      "content": "using System;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing System.Collections.Generic;\nusing Microsoft.EntityFrameworkCore;\nusing Serilog;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.Shared;\nusing xbytechat.api.Features.CampaignTracking.Models;\nusing xbytechat.api.Services.Messages.Interfaces;\nusing Microsoft.Extensions.DependencyInjection;\nusing xbytechat.api.Features.xbTimeline.Services;\nusing xbytechat.api.Features.MessagesEngine.DTOs;\nusing xbytechat.api.Features.MessagesEngine.Services;\nusing xbytechat.api.CRM.Dtos;\nusing xbytechat.api.Helpers;\nusing xbytechat_api.WhatsAppSettings.Services;\nusing xbytechat.api.Shared.utility;\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat.api.CRM.Models;\nusing xbytechat.api.Features.Tracking.Services;\nusing xbytechat.api.Features.CTAFlowBuilder.Models;\nusing Newtonsoft.Json;\nusing System.Text;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    public class CampaignService : ICampaignService\n    {\n        private readonly AppDbContext _context;\n        private readonly IMessageService _messageService;\n        private readonly IServiceProvider _serviceProvider;\n        private readonly ILeadTimelineService _timelineService;\n        private readonly IMessageEngineService _messageEngineService;\n        private readonly IWhatsAppTemplateFetcherService _templateFetcherService;\n        private readonly IUrlBuilderService _urlBuilderService;\n        public CampaignService(AppDbContext context, IMessageService messageService,\n                               IServiceProvider serviceProvider,\n                               ILeadTimelineService timelineService,\n                               IMessageEngineService messageEngineService,\n                               IWhatsAppTemplateFetcherService templateFetcherService,\n                               IUrlBuilderService urlBuilderService)\n        {\n            _context = context;\n            _messageService = messageService;\n            _serviceProvider = serviceProvider;\n            _timelineService = timelineService; // ✅ new\n            _messageEngineService = messageEngineService;\n            _templateFetcherService = templateFetcherService;\n            _urlBuilderService = urlBuilderService;\n\n        }\n\n\n        #region Get All Types of Get and Update and Delete Methods\n\n        public async Task<List<CampaignSummaryDto>> GetAllCampaignsAsync(Guid businessId)\n        {\n            return await _context.Campaigns\n                .Where(c => c.BusinessId == businessId)\n                .OrderByDescending(c => c.CreatedAt)\n                .Select(c => new CampaignSummaryDto\n                {\n                    Id = c.Id,\n                    Name = c.Name,\n                    Status = c.Status,\n                    ScheduledAt = c.ScheduledAt,\n                    CreatedAt = c.CreatedAt,\n\n                })\n                .ToListAsync();\n        }\n        public async Task<CampaignDto?> GetCampaignByIdAsync(Guid campaignId, Guid businessId)\n        {\n            var campaign = await _context.Campaigns\n                .Include(c => c.Cta)\n                .Include(c => c.MultiButtons)\n                .Include(c => c.CTAFlowConfig)\n                .FirstOrDefaultAsync(c => c.Id == campaignId && c.BusinessId == businessId);\n\n            if (campaign == null) return null;\n\n            return new CampaignDto\n            {\n                Id = campaign.Id,\n                Name = campaign.Name,\n                MessageTemplate = campaign.MessageTemplate,\n                MessageBody = campaign.MessageBody,\n                TemplateId = campaign.TemplateId,\n                CampaignType = campaign.CampaignType,\n                Status = campaign.Status,\n                ImageUrl = campaign.ImageUrl,\n                ImageCaption = campaign.ImageCaption,\n                CreatedAt = campaign.CreatedAt,\n                ScheduledAt = campaign.ScheduledAt,\n                CtaId = campaign.CtaId,\n                Cta = campaign.Cta == null ? null : new CtaPreviewDto\n                {\n                    Title = campaign.Cta.Title,\n                    ButtonText = campaign.Cta.ButtonText\n                },\n                MultiButtons = campaign.MultiButtons?\n                    .Select(b => new CampaignButtonDto\n                    {\n                        ButtonText = b.Title,\n                        ButtonType = b.Type,\n                        TargetUrl = b.Value\n                    }).ToList() ?? new List<CampaignButtonDto>(),\n                // ✅ Flow surface to UI\n                CTAFlowConfigId = campaign.CTAFlowConfigId,\n                CTAFlowName = campaign.CTAFlowConfig?.FlowName\n            };\n        }\n        // Returns the entry step (no incoming links) and its template name.\n        // If flow is missing/invalid, returns (null, null) and caller should ignore.\n        private async Task<(Guid? entryStepId, string? entryTemplate)> ResolveFlowEntryAsync(Guid businessId, Guid? flowId)\n        {\n            if (!flowId.HasValue || flowId.Value == Guid.Empty) return (null, null);\n\n            var flow = await _context.CTAFlowConfigs\n                .Include(f => f.Steps)\n                    .ThenInclude(s => s.ButtonLinks)\n                .FirstOrDefaultAsync(f => f.Id == flowId.Value && f.BusinessId == businessId && f.IsActive);\n\n            if (flow == null || flow.Steps == null || flow.Steps.Count == 0) return (null, null);\n\n            var incoming = new HashSet<Guid>(\n                flow.Steps.SelectMany(s => s.ButtonLinks)\n                          .Where(l => l.NextStepId.HasValue)\n                          .Select(l => l.NextStepId!.Value)\n            );\n\n            var entry = flow.Steps\n                .OrderBy(s => s.StepOrder)\n                .FirstOrDefault(s => !incoming.Contains(s.Id));\n\n            return entry == null ? (null, null) : (entry.Id, entry.TemplateToSend);\n        }\n\n        public async Task<List<CampaignSummaryDto>> GetAllCampaignsAsync(Guid businessId, string? type = null)\n        {\n            var query = _context.Campaigns\n                .Where(c => c.BusinessId == businessId)\n                .AsQueryable();\n\n            if (!string.IsNullOrEmpty(type))\n                query = query.Where(c => c.CampaignType == type);\n\n            return await query\n                .OrderByDescending(c => c.CreatedAt)\n                .Select(c => new CampaignSummaryDto\n                {\n                    Id = c.Id,\n                    Name = c.Name,\n                    Status = c.Status,\n                    ScheduledAt = c.ScheduledAt,\n                    CreatedAt = c.CreatedAt,\n                    ImageUrl = c.ImageUrl,            // ✅ Now mapped\n                    ImageCaption = c.ImageCaption,    // ✅ Now mapped\n                    CtaTitle = c.Cta != null ? c.Cta.Title : null,  // optional\n                    RecipientCount = c.Recipients.Count()\n                })\n                .ToListAsync();\n        }\n\n        public async Task<List<ContactDto>> GetRecipientsByCampaignIdAsync(Guid campaignId, Guid businessId)\n        {\n            var recipients = await _context.CampaignRecipients\n                .Include(r => r.Contact)\n                .Where(r => r.CampaignId == campaignId && r.Contact.BusinessId == businessId)\n                .Select(r => new ContactDto\n                {\n                    Id = r.Contact.Id,\n                    Name = r.Contact.Name,\n                    PhoneNumber = r.Contact.PhoneNumber,\n                    Email = r.Contact.Email,\n                    LeadSource = r.Contact.LeadSource,\n                    CreatedAt = r.Contact.CreatedAt\n                })\n                .ToListAsync();\n\n            return recipients;\n        }\n\n        public async Task<PaginatedResponse<CampaignSummaryDto>> GetPaginatedCampaignsAsync(Guid businessId, PaginatedRequest request)\n        {\n            var query = _context.Campaigns\n                .Where(c => c.BusinessId == businessId)\n                .OrderByDescending(c => c.CreatedAt);\n\n            var total = await query.CountAsync();\n\n            var items = await query\n                .Skip((request.Page - 1) * request.PageSize)\n                .Take(request.PageSize)\n                .Select(c => new CampaignSummaryDto\n                {\n                    Id = c.Id,\n                    Name = c.Name,\n                    Status = c.Status,\n                    ScheduledAt = c.ScheduledAt,\n                    CreatedAt = c.CreatedAt\n                })\n                .ToListAsync();\n\n            return new PaginatedResponse<CampaignSummaryDto>\n            {\n                Items = items,\n                TotalCount = total,\n                Page = request.Page,\n                PageSize = request.PageSize\n            };\n        }\n        public async Task<bool> UpdateCampaignAsync(Guid id, CampaignCreateDto dto)\n        {\n            var campaign = await _context.Campaigns.FindAsync(id);\n            if (campaign == null || campaign.Status != \"Draft\")\n                return false;\n\n            // ✅ Extract BusinessId from current campaign\n            var businessId = campaign.BusinessId;\n\n            // ✅ Optional CTA ownership validation\n            if (dto.CtaId.HasValue)\n            {\n                var cta = await _context.CTADefinitions\n                    .FirstOrDefaultAsync(c => c.Id == dto.CtaId && c.BusinessId == businessId && c.IsActive);\n\n                if (cta == null)\n                    throw new UnauthorizedAccessException(\"❌ The selected CTA does not belong to your business or is inactive.\");\n            }\n\n            // ✏️ Update campaign fields\n            campaign.Name = dto.Name;\n            campaign.MessageTemplate = dto.MessageTemplate;\n            campaign.TemplateId = dto.TemplateId;\n            campaign.FollowUpTemplateId = dto.FollowUpTemplateId;\n            campaign.CampaignType = dto.CampaignType;\n            campaign.CtaId = dto.CtaId;\n            campaign.ImageUrl = dto.ImageUrl;\n            campaign.ImageCaption = dto.ImageCaption;\n            campaign.UpdatedAt = DateTime.UtcNow;\n\n            await _context.SaveChangesAsync();\n            return true;\n        }\n\n        public async Task<bool> DeleteCampaignAsync(Guid id)\n        {\n            var campaign = await _context.Campaigns\n                .Include(c => c.Recipients)\n                .FirstOrDefaultAsync(c => c.Id == id);\n\n            if (campaign == null || campaign.Status != \"Draft\")\n                return false;\n\n            _context.CampaignRecipients.RemoveRange(campaign.Recipients);\n            _context.Campaigns.Remove(campaign);\n\n            await _context.SaveChangesAsync();\n            Log.Information(\"🗑️ Campaign deleted: {Id}\", id);\n            return true;\n        }\n\n        #endregion\n\n        #region // 🆕 CreateCampaignAsync(Text/Image)\n\n        public async Task<Guid?> CreateTextCampaignAsync(CampaignCreateDto dto, Guid businessId, string createdBy)\n        {\n            try\n            {\n                var campaignId = Guid.NewGuid();\n\n                // 🔁 Parse/normalize template parameters once\n                var parsedParams = TemplateParameterHelper.ParseTemplateParams(\n                    JsonConvert.SerializeObject(dto.TemplateParameters ?? new List<string>())\n                );\n\n                // 🔄 Flow id from UI (null/empty => no flow). We will persist this as-is.\n                Guid? incomingFlowId = (dto.CTAFlowConfigId.HasValue && dto.CTAFlowConfigId.Value != Guid.Empty)\n                    ? dto.CTAFlowConfigId.Value\n                    : (Guid?)null;\n\n                // We will save this value regardless of validation outcome\n                Guid? savedFlowId = incomingFlowId;\n\n                // ============================================================\n                // 🧩 FLOW VALIDATION (only to align the starting template)\n                // ============================================================\n                string selectedTemplateName = dto.TemplateId ?? dto.MessageTemplate ?? string.Empty;\n\n                CTAFlowConfig? flow = null;\n                CTAFlowStep? entryStep = null;\n\n                if (incomingFlowId.HasValue)\n                {\n                    // load flow with steps+links and verify ownership\n                    flow = await _context.CTAFlowConfigs\n                        .Include(f => f.Steps).ThenInclude(s => s.ButtonLinks)\n                        .FirstOrDefaultAsync(f =>\n                            f.Id == incomingFlowId.Value &&\n                            f.BusinessId == businessId &&\n                            f.IsActive);\n\n                    if (flow == null)\n                    {\n                        Log.Warning(\"❌ Flow {FlowId} not found/active for business {Biz}. Will persist FlowId but not align template.\",\n                            incomingFlowId, businessId);\n                    }\n                    else\n                    {\n                        // compute entry step: step with NO incoming links\n                        var allIncoming = new HashSet<Guid>(flow.Steps\n                            .SelectMany(s => s.ButtonLinks)\n                            .Where(l => l.NextStepId.HasValue)\n                            .Select(l => l.NextStepId!.Value));\n\n                        entryStep = flow.Steps\n                            .OrderBy(s => s.StepOrder)\n                            .FirstOrDefault(s => !allIncoming.Contains(s.Id));\n\n                        if (entryStep == null)\n                        {\n                            Log.Warning(\"❌ Flow {FlowId} has no entry step. Persisting FlowId but not aligning template.\", flow.Id);\n                        }\n                        else if (!string.Equals(selectedTemplateName, entryStep.TemplateToSend, StringComparison.OrdinalIgnoreCase))\n                        {\n                            Log.Information(\"ℹ️ Aligning selected template '{Sel}' to flow entry '{Entry}'.\",\n                                selectedTemplateName, entryStep.TemplateToSend);\n                            selectedTemplateName = entryStep.TemplateToSend;\n                        }\n                    }\n                }\n                else\n                {\n                    Log.Information(\"ℹ️ No flow attached to campaign '{Name}'. Proceeding as plain template campaign.\", dto.Name);\n                }\n\n                // 🧠 Fetch template (for body + buttons) using the aligned/selected template name\n                var template = await _templateFetcherService.GetTemplateByNameAsync(\n                    businessId,\n                    selectedTemplateName,\n                    includeButtons: true\n                );\n\n                // 🧠 Resolve message body using template body (if available) else dto.MessageTemplate\n                var templateBody = template?.Body ?? dto.MessageTemplate ?? string.Empty;\n                var resolvedBody = TemplateParameterHelper.FillPlaceholders(templateBody, parsedParams);\n\n                // ✅ Step 1: Create campaign (CTAFlowConfigId now always = savedFlowId)\n                var campaign = new Campaign\n                {\n                    Id = campaignId,\n                    BusinessId = businessId,\n                    Name = dto.Name,\n\n                    // store the (possibly aligned) template name\n                    MessageTemplate = dto.MessageTemplate,      // keep original text for UI if you use it\n                    TemplateId = selectedTemplateName,          // ensure start template matches flow entry when available\n\n                    FollowUpTemplateId = dto.FollowUpTemplateId,\n                    CampaignType = dto.CampaignType ?? \"text\",\n                    CtaId = dto.CtaId,\n                    CTAFlowConfigId = savedFlowId,              // 👈 persist what UI sent (or null if no flow)\n\n                    ScheduledAt = dto.ScheduledAt,\n                    CreatedBy = createdBy,\n                    CreatedAt = DateTime.UtcNow,\n                    UpdatedAt = DateTime.UtcNow,\n                    Status = \"Draft\",\n                    ImageUrl = dto.ImageUrl,\n                    ImageCaption = dto.ImageCaption,\n                    TemplateParameters = JsonConvert.SerializeObject(dto.TemplateParameters ?? new List<string>()),\n                    MessageBody = resolvedBody\n                };\n\n                await _context.Campaigns.AddAsync(campaign);\n\n                // ✅ Step 2: Assign contacts (leave SentAt null until send)\n                if (dto.ContactIds != null && dto.ContactIds.Any())\n                {\n                    var recipients = dto.ContactIds.Select(contactId => new CampaignRecipient\n                    {\n                        Id = Guid.NewGuid(),\n                        CampaignId = campaignId,\n                        ContactId = contactId,\n                        BusinessId = businessId,\n                        Status = \"Pending\",\n                        SentAt = null,\n                        UpdatedAt = DateTime.UtcNow\n                    });\n\n                    await _context.CampaignRecipients.AddRangeAsync(recipients);\n                }\n\n                // ✅ Step 3a: Save manual buttons from frontend\n                if (dto.MultiButtons != null && dto.MultiButtons.Any())\n                {\n                    var buttons = dto.MultiButtons\n                        .Where(btn => !string.IsNullOrWhiteSpace(btn.ButtonText) && !string.IsNullOrWhiteSpace(btn.TargetUrl))\n                        .Take(3)\n                        .Select((btn, index) => new CampaignButton\n                        {\n                            Id = Guid.NewGuid(),\n                            CampaignId = campaignId,\n                            Title = btn.ButtonText,\n                            Type = btn.ButtonType ?? \"url\",\n                            Value = btn.TargetUrl,\n                            Position = index + 1,\n                            IsFromTemplate = false\n                        });\n\n                    await _context.CampaignButtons.AddRangeAsync(buttons);\n                }\n\n                // ======================== Dynamic buttons merge ========================\n                if (template != null && template.ButtonParams?.Count > 0)\n                {\n                    var buttonsToSave = new List<CampaignButton>();\n                    var userButtons = dto.ButtonParams ?? new List<CampaignButtonParamFromMetaDto>();\n\n                    var total = Math.Min(3, template.ButtonParams.Count);\n                    for (int i = 0; i < total; i++)\n                    {\n                        var tplBtn = template.ButtonParams[i];\n                        var isDynamic = (tplBtn.ParameterValue?.Contains(\"{{1}}\") ?? false);\n\n                        var userBtn = userButtons.FirstOrDefault(b => b.Position == i + 1);\n                        var valueToSave = (isDynamic && userBtn != null)\n                            ? userBtn.Value?.Trim()\n                            : tplBtn.ParameterValue;\n\n                        buttonsToSave.Add(new CampaignButton\n                        {\n                            Id = Guid.NewGuid(),\n                            CampaignId = campaignId,\n                            Title = tplBtn.Text,\n                            Type = tplBtn.Type,\n                            Value = valueToSave,\n                            Position = i + 1,\n                            IsFromTemplate = true\n                        });\n                    }\n\n                    await _context.CampaignButtons.AddRangeAsync(buttonsToSave);\n                }\n                // ======================================================================\n\n                await _context.SaveChangesAsync();\n\n                Log.Information(\"✅ Campaign '{Name}' created | FlowId: {Flow} | EntryTemplate: {Entry} | Recipients: {Contacts} | UserButtons: {ManualButtons} | TemplateButtons: {TemplateButtons} | Params: {Params}\",\n                    dto.Name,\n                    savedFlowId,\n                    entryStep?.TemplateToSend ?? selectedTemplateName,\n                    dto.ContactIds?.Count ?? 0,\n                    dto.MultiButtons?.Count ?? 0,\n                    template?.ButtonParams?.Count ?? 0,\n                    dto.TemplateParameters?.Count ?? 0\n                );\n\n                return campaignId;\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"❌ Failed to create campaign\");\n                return null;\n            }\n        }\n\n        public async Task<Guid> CreateImageCampaignAsync(Guid businessId, CampaignCreateDto dto, string createdBy)\n        {\n            var campaignId = Guid.NewGuid();\n\n            // 🔁 Parse/normalize template parameters once\n            var parsedParams = TemplateParameterHelper.ParseTemplateParams(\n                JsonConvert.SerializeObject(dto.TemplateParameters ?? new List<string>())\n            );\n\n            // 🔄 Flow id from UI (null/empty => no flow). We will persist this as-is.\n            Guid? incomingFlowId = (dto.CTAFlowConfigId.HasValue && dto.CTAFlowConfigId.Value != Guid.Empty)\n                ? dto.CTAFlowConfigId.Value\n                : (Guid?)null;\n\n            // We will save this value regardless of validation outcome\n            Guid? savedFlowId = incomingFlowId;\n\n            // ============================================================\n            // 🧩 FLOW VALIDATION (only to align the starting template)\n            // ============================================================\n            string selectedTemplateName = dto.TemplateId ?? dto.MessageTemplate ?? string.Empty;\n\n            CTAFlowConfig? flow = null;\n            CTAFlowStep? entryStep = null;\n\n            if (incomingFlowId.HasValue)\n            {\n                // load flow with steps+links and verify ownership\n                flow = await _context.CTAFlowConfigs\n                    .Include(f => f.Steps).ThenInclude(s => s.ButtonLinks)\n                    .FirstOrDefaultAsync(f =>\n                        f.Id == incomingFlowId.Value &&\n                        f.BusinessId == businessId &&\n                        f.IsActive);\n\n                if (flow == null)\n                {\n                    Log.Warning(\"❌ Flow {FlowId} not found/active for business {Biz}. Will persist FlowId but not align template.\",\n                        incomingFlowId, businessId);\n                }\n                else\n                {\n                    // compute entry step: step with NO incoming links\n                    var allIncoming = new HashSet<Guid>(flow.Steps\n                        .SelectMany(s => s.ButtonLinks)\n                        .Where(l => l.NextStepId.HasValue)\n                        .Select(l => l.NextStepId!.Value));\n\n                    entryStep = flow.Steps\n                        .OrderBy(s => s.StepOrder)\n                        .FirstOrDefault(s => !allIncoming.Contains(s.Id));\n\n                    if (entryStep == null)\n                    {\n                        Log.Warning(\"❌ Flow {FlowId} has no entry step. Persisting FlowId but not aligning template.\", flow.Id);\n                    }\n                    else if (!string.Equals(selectedTemplateName, entryStep.TemplateToSend, StringComparison.OrdinalIgnoreCase))\n                    {\n                        Log.Information(\"ℹ️ Aligning selected template '{Sel}' to flow entry '{Entry}'.\",\n                            selectedTemplateName, entryStep.TemplateToSend);\n                        selectedTemplateName = entryStep.TemplateToSend;\n                    }\n                }\n            }\n            else\n            {\n                Log.Information(\"ℹ️ No flow attached to image campaign '{Name}'. Proceeding as plain template campaign.\", dto.Name);\n            }\n\n            // 🧠 Fetch template (for body + buttons) using the aligned/selected template name\n            var template = await _templateFetcherService.GetTemplateByNameAsync(\n                businessId,\n                selectedTemplateName,\n                includeButtons: true\n            );\n\n            // 🧠 Resolve message body using template body (if available) else dto.MessageTemplate\n            var templateBody = template?.Body ?? dto.MessageTemplate ?? string.Empty;\n            var resolvedBody = TemplateParameterHelper.FillPlaceholders(templateBody, parsedParams);\n\n            // 🎯 Step 1: Create campaign (CTAFlowConfigId now always = savedFlowId)\n            var campaign = new Campaign\n            {\n                Id = campaignId,\n                BusinessId = businessId,\n                Name = dto.Name,\n\n                // store the (possibly aligned) template name\n                MessageTemplate = dto.MessageTemplate,      // keep original text for UI if you use it\n                TemplateId = selectedTemplateName,          // ensure start template matches flow entry when available\n\n                FollowUpTemplateId = dto.FollowUpTemplateId,\n                CampaignType = \"image\",\n                CtaId = dto.CtaId,\n                CTAFlowConfigId = savedFlowId,              // 👈 persist what UI sent (or null if no flow)\n\n                ScheduledAt = dto.ScheduledAt,\n                CreatedBy = createdBy,\n                CreatedAt = DateTime.UtcNow,\n                UpdatedAt = DateTime.UtcNow,\n                Status = \"Draft\",\n\n                // image-specific fields\n                ImageUrl = dto.ImageUrl,\n                ImageCaption = dto.ImageCaption,\n\n                // params/body snapshot (useful for previews & auditing)\n                TemplateParameters = JsonConvert.SerializeObject(dto.TemplateParameters ?? new List<string>()),\n                MessageBody = resolvedBody\n            };\n\n            await _context.Campaigns.AddAsync(campaign);\n\n            // ✅ Step 2: Assign contacts (leave SentAt null until send)\n            if (dto.ContactIds != null && dto.ContactIds.Any())\n            {\n                var recipients = dto.ContactIds.Select(contactId => new CampaignRecipient\n                {\n                    Id = Guid.NewGuid(),\n                    CampaignId = campaignId,\n                    ContactId = contactId,\n                    BusinessId = businessId,\n                    Status = \"Pending\",\n                    SentAt = null,\n                    UpdatedAt = DateTime.UtcNow\n                });\n\n                await _context.CampaignRecipients.AddRangeAsync(recipients);\n            }\n\n            // ✅ Step 3a: Save manual buttons from frontend\n            if (dto.MultiButtons != null && dto.MultiButtons.Any())\n            {\n                var buttons = dto.MultiButtons\n                    .Where(btn => !string.IsNullOrWhiteSpace(btn.ButtonText) && !string.IsNullOrWhiteSpace(btn.TargetUrl))\n                    .Take(3)\n                    .Select((btn, index) => new CampaignButton\n                    {\n                        Id = Guid.NewGuid(),\n                        CampaignId = campaignId,\n                        Title = btn.ButtonText,\n                        Type = btn.ButtonType ?? \"url\",\n                        Value = btn.TargetUrl,\n                        Position = index + 1,\n                        IsFromTemplate = false\n                    });\n\n                await _context.CampaignButtons.AddRangeAsync(buttons);\n            }\n\n            // ======================== Dynamic buttons merge ========================\n            // EXACTLY mirrors your text-creator pattern to avoid type issues with ButtonMetadataDto\n            if (template != null && template.ButtonParams?.Count > 0)\n            {\n                var buttonsToSave = new List<CampaignButton>();\n                var userButtons = dto.ButtonParams ?? new List<CampaignButtonParamFromMetaDto>();\n\n                var total = Math.Min(3, template.ButtonParams.Count);\n                for (int i = 0; i < total; i++)\n                {\n                    var tplBtn = template.ButtonParams[i];                         // ButtonMetadataDto: Text, Type, SubType, Index, ParameterValue\n                    var isDynamic = (tplBtn.ParameterValue?.Contains(\"{{1}}\") ?? false);\n\n                    var userBtn = userButtons.FirstOrDefault(b => b.Position == i + 1);\n                    var valueToSave = (isDynamic && userBtn != null)\n                        ? userBtn.Value?.Trim()                                    // user override for dynamic URL\n                        : tplBtn.ParameterValue;                                   // pattern or static value from meta\n\n                    buttonsToSave.Add(new CampaignButton\n                    {\n                        Id = Guid.NewGuid(),\n                        CampaignId = campaignId,\n                        Title = tplBtn.Text,                                       // from ButtonMetadataDto\n                        Type = tplBtn.Type,                                        // from ButtonMetadataDto\n                        Value = valueToSave,\n                        Position = i + 1,\n                        IsFromTemplate = true\n                    });\n                }\n\n                await _context.CampaignButtons.AddRangeAsync(buttonsToSave);\n            }\n            // ======================================================================\n\n            await _context.SaveChangesAsync();\n\n            Log.Information(\"✅ Image campaign '{Name}' created | FlowId: {Flow} | EntryTemplate: {Entry} | Recipients: {Contacts} | UserButtons: {ManualButtons} | TemplateButtons: {TemplateButtons} | Params: {Params}\",\n                dto.Name,\n                savedFlowId,\n                entryStep?.TemplateToSend ?? selectedTemplateName,\n                dto.ContactIds?.Count ?? 0,\n                dto.MultiButtons?.Count ?? 0,\n                template?.ButtonParams?.Count ?? 0,\n                dto.TemplateParameters?.Count ?? 0\n            );\n\n            return campaignId;\n        }\n        #endregion\n        public async Task<bool> SendCampaignAsync(Guid campaignId, string ipAddress, string userAgent)\n        {\n            var campaign = await _context.Campaigns\n                .Include(c => c.Recipients)\n                .ThenInclude(r => r.Contact)\n                .FirstOrDefaultAsync(c => c.Id == campaignId);\n\n            if (campaign == null || campaign.Recipients.Count == 0)\n            {\n                Log.Warning(\"🚫 Campaign not found or has no recipients\");\n                return false;\n            }\n\n            campaign.Status = \"Sending\";\n            campaign.UpdatedAt = DateTime.UtcNow;\n            await _context.SaveChangesAsync();\n\n            int throttleLimit = 5;\n\n            await Parallel.ForEachAsync(campaign.Recipients, new ParallelOptions { MaxDegreeOfParallelism = throttleLimit }, async (recipient, ct) =>\n            {\n                try\n                {\n                    using var scope = _serviceProvider.CreateScope();\n                    var scopedDb = scope.ServiceProvider.GetRequiredService<AppDbContext>();\n\n                    // 🟢 Use SimpleTemplateMessageDto instead of raw text\n                    var dto = new SimpleTemplateMessageDto\n                    {\n                        RecipientNumber = recipient.Contact.PhoneNumber,\n                        TemplateName = campaign.MessageTemplate,\n                        TemplateParameters = new List<string> { recipient.Contact.Name ?? \"Customer\" }\n                    };\n\n                    var result = await _messageEngineService.SendTemplateMessageSimpleAsync(campaign.BusinessId, dto);\n\n                    var sendLog = new CampaignSendLog\n                    {\n                        Id = Guid.NewGuid(),\n                        CampaignId = campaign.Id,\n                        ContactId = recipient.ContactId,\n                        RecipientId = recipient.Id,\n                        TemplateId = campaign.TemplateId,\n                        MessageBody = campaign.MessageTemplate,\n                        MessageId = null,\n                        SendStatus = result.Success ? \"Sent\" : \"Failed\",\n                        ErrorMessage = result.Message,\n                        SentAt = DateTime.UtcNow,\n                        CreatedAt = DateTime.UtcNow,\n                        SourceChannel = \"whatsapp\",\n                        IpAddress = ipAddress,\n                        DeviceInfo = userAgent\n                    };\n\n                    scopedDb.CampaignSendLogs.Add(sendLog);\n\n                    var recipientToUpdate = await scopedDb.CampaignRecipients.FirstOrDefaultAsync(r => r.Id == recipient.Id);\n                    if (recipientToUpdate != null)\n                    {\n                        recipientToUpdate.Status = result.Success ? \"Sent\" : \"Failed\";\n                        recipientToUpdate.MessagePreview = campaign.MessageTemplate;\n                        recipientToUpdate.SentAt = DateTime.UtcNow;\n                        recipientToUpdate.UpdatedAt = DateTime.UtcNow;\n                    }\n\n                    await scopedDb.SaveChangesAsync();\n                }\n                catch (Exception ex)\n                {\n                    Log.Error(ex, \"❌ Send failed for recipient: {RecipientId}\", recipient.Id);\n                }\n            });\n\n            campaign.Status = \"Sent\";\n            campaign.UpdatedAt = DateTime.UtcNow;\n            await _context.SaveChangesAsync();\n\n            Log.Information(\"📤 Campaign {CampaignId} sent via template to {Count} recipients\", campaign.Id, campaign.Recipients.Count);\n            return true;\n        }\n        public async Task<bool> SendCampaignInParallelAsync(Guid campaignId, string ipAddress, string userAgent)\n        {\n            var campaign = await _context.Campaigns\n                .Include(c => c.Recipients)\n                .ThenInclude(r => r.Contact)\n                .FirstOrDefaultAsync(c => c.Id == campaignId);\n\n            if (campaign == null || campaign.Recipients.Count == 0)\n            {\n                Log.Warning(\"🚫 Campaign not found or has no recipients\");\n                return false;\n            }\n\n            campaign.Status = \"Sending\";\n            campaign.UpdatedAt = DateTime.UtcNow;\n            await _context.SaveChangesAsync();\n\n            int maxParallelism = 5;\n\n#if NET6_0_OR_GREATER\n            await Parallel.ForEachAsync(campaign.Recipients, new ParallelOptions\n            {\n                MaxDegreeOfParallelism = maxParallelism\n            },\n            async (recipient, cancellationToken) =>\n            {\n                await SendToRecipientAsync(campaign, recipient, ipAddress, userAgent);\n            });\n#else\n    var tasks = campaign.Recipients.Select(recipient =>\n        SendToRecipientAsync(campaign, recipient, ipAddress, userAgent)\n    );\n    await Task.WhenAll(tasks);\n#endif\n\n            campaign.Status = \"Sent\";\n            campaign.UpdatedAt = DateTime.UtcNow;\n            await _context.SaveChangesAsync();\n\n            Log.Information(\"📤 Campaign {CampaignId} sent in parallel to {Count} recipients\", campaign.Id, campaign.Recipients.Count);\n            return true;\n        }\n        private async Task SendToRecipientAsync(Campaign campaign, CampaignRecipient recipient, string ip, string ua)\n        {\n            try\n            {\n                var dto = new SimpleTemplateMessageDto\n                {\n                    RecipientNumber = recipient.Contact.PhoneNumber,\n                    TemplateName = campaign.MessageTemplate,\n                    TemplateParameters = new List<string> { recipient.Contact.Name ?? \"Customer\" }\n                };\n\n                var result = await _messageEngineService.SendTemplateMessageSimpleAsync(campaign.BusinessId, dto);\n\n\n                var log = new CampaignSendLog\n                {\n                    Id = Guid.NewGuid(),\n                    CampaignId = campaign.Id,\n                    ContactId = recipient.ContactId,\n                    RecipientId = recipient.Id,\n                    TemplateId = campaign.TemplateId,\n                    MessageBody = campaign.MessageTemplate,\n                    MessageId = null,\n                    SendStatus = result.Success ? \"Sent\" : \"Failed\",\n                    ErrorMessage = result.Message,\n                    SentAt = DateTime.UtcNow,\n                    CreatedAt = DateTime.UtcNow,\n                    SourceChannel = \"whatsapp\",\n                    IpAddress = ip,\n                    DeviceInfo = ua\n                };\n\n                lock (_context)\n                {\n                    _context.CampaignSendLogs.Add(log);\n                    recipient.Status = result.Success ? \"Sent\" : \"Failed\";\n                    recipient.MessagePreview = campaign.MessageTemplate;\n                    recipient.SentAt = DateTime.UtcNow;\n                    recipient.UpdatedAt = DateTime.UtcNow;\n                }\n\n                await _context.SaveChangesAsync();\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"❌ Failed to send template to recipient: {RecipientId}\", recipient.Id);\n            }\n        }\n\n        public async Task<bool> RemoveRecipientAsync(Guid businessId, Guid campaignId, Guid contactId)\n        {\n            var entry = await _context.CampaignRecipients\n                .FirstOrDefaultAsync(r =>\n                    r.CampaignId == campaignId &&\n                    r.ContactId == contactId &&\n                    r.Campaign.BusinessId == businessId); // ✅ Filter by related Campaign.BusinessId\n\n            if (entry == null)\n                return false;\n\n            _context.CampaignRecipients.Remove(entry);\n            await _context.SaveChangesAsync();\n            return true;\n        }\n\n        public async Task<bool> AssignContactsToCampaignAsync(Guid campaignId, Guid businessId, List<Guid> contactIds)\n        {\n            var campaign = await _context.Campaigns\n                .Include(c => c.Recipients)\n                .FirstOrDefaultAsync(c => c.Id == campaignId && c.BusinessId == businessId);\n\n            if (campaign == null)\n                return false;\n\n            var newRecipients = contactIds.Select(id => new CampaignRecipient\n            {\n                Id = Guid.NewGuid(),\n                CampaignId = campaignId,\n                ContactId = id,\n                BusinessId = businessId,\n                Status = \"Pending\",\n                SentAt = DateTime.UtcNow,\n                UpdatedAt = DateTime.UtcNow\n            });\n\n            _context.CampaignRecipients.AddRange(newRecipients);\n            await _context.SaveChangesAsync();\n            return true;\n        }\n\n        // This is the Entry point to send Temaplte (Text Based and Image Based)\n        public async Task<ResponseResult> SendTemplateCampaignAsync(Guid campaignId)\n        {\n            try\n            {\n                var campaign = await _context.Campaigns\n                    .Include(c => c.Recipients)\n                        .ThenInclude(r => r.Contact) // 🧠 include contact details\n                    .Include(c => c.MultiButtons)\n                    .FirstOrDefaultAsync(c => c.Id == campaignId && !c.IsDeleted);\n\n                if (campaign == null)\n                    return ResponseResult.ErrorInfo(\"❌ Campaign not found.\");\n\n                if (campaign.Recipients == null || !campaign.Recipients.Any())\n                    return ResponseResult.ErrorInfo(\"❌ No recipients assigned to this campaign.\");\n\n                var templateName = campaign.MessageTemplate;\n                var templateId = campaign.TemplateId;\n                var language = \"en_US\"; // Optional: make dynamic later\n                var isImageTemplate = !string.IsNullOrEmpty(campaign.ImageUrl);\n\n                var templateParams = JsonConvert.DeserializeObject<List<string>>(campaign.TemplateParameters ?? \"[]\");\n\n                int success = 0, failed = 0;\n\n                foreach (var recipient in campaign.Recipients)\n                {\n                    var messageDto = new ImageTemplateMessageDto\n                    {\n                        // BusinessId = campaign.BusinessId,\n                        RecipientNumber = recipient.Contact.PhoneNumber,\n                        TemplateName = templateName,\n                        LanguageCode = language,\n                        HeaderImageUrl = isImageTemplate ? campaign.ImageUrl : null,\n                        TemplateParameters = templateParams,\n                        ButtonParameters = campaign.MultiButtons\n                            .OrderBy(b => b.Position)\n                            .Take(3)\n                            .Select(btn => new CampaignButtonDto\n                            {\n                                ButtonText = btn.Title,\n                                ButtonType = btn.Type,\n                                TargetUrl = btn.Value\n                            }).ToList()\n                    };\n\n                    // ✅ Call the image/template sender\n                    var sendResult = await _messageEngineService.SendImageTemplateMessageAsync(messageDto, campaign.BusinessId);\n                    var isSuccess = sendResult.ToString().ToLower().Contains(\"messages\");\n\n                    var log = new MessageLog\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = campaign.BusinessId,\n                        RecipientNumber = recipient.Contact.PhoneNumber,\n                        MessageContent = templateName,\n                        MediaUrl = campaign.ImageUrl,\n                        Status = isSuccess ? \"Sent\" : \"Failed\",\n                        ErrorMessage = isSuccess ? null : \"API Failure\",\n                        RawResponse = JsonConvert.SerializeObject(sendResult),\n                        CreatedAt = DateTime.UtcNow,\n                        SentAt = DateTime.UtcNow\n                    };\n\n                    await _context.MessageLogs.AddAsync(log);\n\n                    if (isSuccess) success++;\n                    else failed++;\n                }\n\n                await _context.SaveChangesAsync();\n                return ResponseResult.SuccessInfo($\"✅ Sent: {success}, ❌ Failed: {failed}\");\n            }\n            catch (Exception ex)\n            {\n                return ResponseResult.ErrorInfo(\"❌ Unexpected error during campaign send.\", ex.ToString());\n            }\n        }\n\n        #region  This region include all the code related to sending text and image based\n\n        public async Task<ResponseResult> SendTemplateCampaignWithTypeDetectionAsync(Guid campaignId)\n        {\n            var campaign = await _context.Campaigns\n                .Include(c => c.Recipients).ThenInclude(r => r.Contact)\n                .Include(c => c.MultiButtons)\n                .FirstOrDefaultAsync(c => c.Id == campaignId && !c.IsDeleted);\n\n            if (campaign == null)\n                return ResponseResult.ErrorInfo(\"❌ Campaign not found.\");\n\n            return campaign.CampaignType?.ToLower() switch\n            {\n                \"image\" => await SendImageTemplateCampaignAsync(campaign),\n                \"text\" => await SendTextTemplateCampaignAsync(campaign),\n                _ => ResponseResult.ErrorInfo(\"❌ Unsupported campaign type.\")\n            };\n        }\n        public async Task<ResponseResult> SendTextTemplateCampaignAsync(Campaign campaign)\n        {\n            try\n            {\n                if (campaign == null || campaign.IsDeleted)\n                    return ResponseResult.ErrorInfo(\"❌ Invalid campaign.\");\n\n                if (campaign.Recipients == null || campaign.Recipients.Count == 0)\n                    return ResponseResult.ErrorInfo(\"❌ No recipients to send.\");\n\n                var businessId = campaign.BusinessId;\n\n                // 🔑 Use Flow entry template if flow is attached; else fallback to campaign.TemplateId/MessageTemplate\n                var (_, entryTemplate) = await ResolveFlowEntryAsync(businessId, campaign.CTAFlowConfigId);\n                var templateName = !string.IsNullOrWhiteSpace(entryTemplate)\n                    ? entryTemplate!\n                    : (campaign.TemplateId ?? campaign.MessageTemplate ?? \"\");\n\n                // 🧠 Fetch template meta (+buttons if you need)\n                var templateMeta = await _templateFetcherService\n                    .GetTemplateByNameAsync(businessId, templateName, includeButtons: true);\n\n                if (templateMeta == null)\n                    return ResponseResult.ErrorInfo(\"❌ Template metadata not found.\");\n\n                // 🚫 Do not hardcode language; require provider meta language\n                var languageCode = (templateMeta.Language ?? \"\").Trim();\n                if (string.IsNullOrWhiteSpace(languageCode))\n                    return ResponseResult.ErrorInfo(\"❌ Template language not resolved from provider meta.\");\n\n                var templateParams = TemplateParameterHelper.ParseTemplateParams(campaign.TemplateParameters);\n\n                // Existing manual buttons (for dynamic URL values)\n                var buttons = campaign.MultiButtons?.OrderBy(b => b.Position).ToList();\n\n                // Provider detection (Meta vs anything else you support)\n                var setting = await _context.WhatsAppSettings\n                    .AsNoTracking()\n                    .FirstOrDefaultAsync(s => s.BusinessId == businessId && s.IsActive);\n\n                if (setting == null)\n                    return ResponseResult.ErrorInfo(\"❌ WhatsApp settings not found.\");\n\n                var providerKey = (setting.Provider ?? \"meta_cloud\").ToLowerInvariant();\n\n                // 🧭 Resolve entry step id (so we can persist context for click processing)\n                Guid? entryStepId = null;\n                if (campaign.CTAFlowConfigId.HasValue)\n                {\n                    entryStepId = await _context.CTAFlowSteps\n                        .Where(s => s.CTAFlowConfigId == campaign.CTAFlowConfigId.Value)\n                        .OrderBy(s => s.StepOrder)\n                        .Select(s => (Guid?)s.Id)\n                        .FirstOrDefaultAsync();\n                }\n\n                // 🧰 Build & freeze a \"button bundle\" (exact labels/positions user sees)\n                // IMPORTANT: store zero-based 'i' and label 't' to match ProcessClickAsync mapping.\n                string? buttonBundleJson = null;\n                if (templateMeta.ButtonParams != null && templateMeta.ButtonParams.Count > 0)\n                {\n                    var bundle = templateMeta.ButtonParams\n                        .Take(3)\n                        .Select((b, i) => new\n                        {\n                            i = i,                                  // zero-based index used by provider & mapper\n                            t = (b.Text ?? \"\").Trim(),              // label used for text matching\n                            position = i + 1,                       // redundant (for readability in tools)\n                            text = (b.Text ?? \"\").Trim(),\n                            type = b.Type,\n                            subType = b.SubType\n                        })\n                        .ToList();\n\n                    buttonBundleJson = JsonConvert.SerializeObject(bundle);\n                }\n\n                int successCount = 0, failureCount = 0;\n\n                foreach (var r in campaign.Recipients)\n                {\n                    if (r?.Contact == null) continue;\n\n                    // 🔑 New run per recipient send (prevents cross-run mixing in journey)\n                    var runId = Guid.NewGuid();\n\n                    // Build provider components (use your existing builders)\n                    var campaignSendLogId = Guid.NewGuid(); // used by tracked URLs\n                    List<object> components = providerKey == \"pinnacle\"\n                        ? BuildTextTemplateComponents_Pinnacle(templateParams, buttons, templateMeta, campaignSendLogId, r.Contact)\n                        : BuildTextTemplateComponents_Meta(templateParams, buttons, templateMeta, campaignSendLogId, r.Contact);\n\n                    var payload = new\n                    {\n                        messaging_product = \"whatsapp\",\n                        to = r.Contact.PhoneNumber,\n                        type = \"template\",\n                        template = new\n                        {\n                            name = templateName,\n                            language = new { code = languageCode }, // ✅ from provider meta\n                            components\n                        }\n                    };\n\n                    var result = await _messageEngineService.SendPayloadAsync(businessId, payload);\n\n                    // 📌 Persist logs WITH flow context, RunId, and frozen button bundle\n                    var logId = Guid.NewGuid();\n                    var log = new MessageLog\n                    {\n                        Id = logId,\n                        BusinessId = businessId,\n                        CampaignId = campaign.Id,\n                        ContactId = r.ContactId,\n                        RecipientNumber = r.Contact.PhoneNumber,\n                        MessageContent = templateName,                       // NOT NULL\n                        Status = result.Success ? \"Sent\" : \"Failed\",\n                        MessageId = result.MessageId,                        // join key (provider msg id)\n                        ErrorMessage = result.ErrorMessage,                  // single source\n                        RawResponse = result.RawResponse,\n                        CreatedAt = DateTime.UtcNow,\n                        SentAt = result.Success ? DateTime.UtcNow : (DateTime?)null, // only when sent\n                        Source = \"campaign\",\n                        CTAFlowConfigId = campaign.CTAFlowConfigId,\n                        CTAFlowStepId = entryStepId,\n                        ButtonBundleJson = buttonBundleJson,\n                        RunId = runId                                        // ✅ journey key\n                    };\n                    _context.MessageLogs.Add(log);\n\n                    await _context.CampaignSendLogs.AddAsync(new CampaignSendLog\n                    {\n                        Id = campaignSendLogId,\n                        CampaignId = campaign.Id,\n                        BusinessId = businessId,\n                        ContactId = r.ContactId,\n                        RecipientId = r.Id,\n                        MessageBody = campaign.MessageBody ?? templateName,\n                        TemplateId = templateName,\n                        SendStatus = result.Success ? \"Sent\" : \"Failed\",\n                        MessageLogId = log.Id,\n                        MessageId = result.MessageId,                        // join key (provider msg id)\n                        ErrorMessage = result.ErrorMessage,                  // ✅ same source as MessageLog\n                        CreatedAt = DateTime.UtcNow,\n                        SentAt = result.Success ? DateTime.UtcNow : (DateTime?)null, // ✅ guard SentAt\n                        CreatedBy = campaign.CreatedBy,\n                        CTAFlowConfigId = campaign.CTAFlowConfigId,\n                        CTAFlowStepId = entryStepId,\n                        ButtonBundleJson = buttonBundleJson,\n                        RunId = runId                                        // ✅ journey key\n                    });\n\n                    if (result.Success) successCount++; else failureCount++;\n                }\n\n                await _context.SaveChangesAsync();\n                return ResponseResult.SuccessInfo($\"📤 Sent to {successCount} contacts. ❌ Failed for {failureCount}.\");\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"Error while sending text template campaign\");\n                return ResponseResult.ErrorInfo(\"🚨 Unexpected error while sending campaign.\", ex.ToString());\n            }\n        }\n\n\n        #region Text Component Builders\n        private string BuildTokenParam(Guid campaignSendLogId, int buttonIndex, string? buttonTitle, string destinationUrlAbsolute)\n        {\n            var full = _urlBuilderService.BuildTrackedButtonUrl(campaignSendLogId, buttonIndex, buttonTitle, destinationUrlAbsolute);\n            var pos = full.LastIndexOf(\"/r/\", StringComparison.OrdinalIgnoreCase);\n            return (pos >= 0) ? full.Substring(pos + 3) : full; // fallback: if not found, return full (rare)\n        }\n\n        //private static string CleanForUri(string s)\n        //{\n        //    if (s is null) return string.Empty;\n        //    var t = s.Trim();\n        //    return new string(Array.FindAll(t.ToCharArray(), c => !char.IsControl(c)));\n        //}\n\n        private static string NormalizeAbsoluteUrlOrThrowForButton(string input, string buttonTitle, int buttonIndex)\n        {\n            if (string.IsNullOrWhiteSpace(input))\n                throw new ArgumentException($\"Destination is required for button '{buttonTitle}' (index {buttonIndex}).\");\n\n            // Trim + strip control chars\n            var cleaned = new string(input.Trim().Where(c => !char.IsControl(c)).ToArray());\n            if (cleaned.Length == 0)\n                throw new ArgumentException($\"Destination is required for button '{buttonTitle}' (index {buttonIndex}).\");\n\n            // ✅ Allow tel: and WhatsApp deep links\n            if (cleaned.StartsWith(\"tel:\", StringComparison.OrdinalIgnoreCase) ||\n                cleaned.StartsWith(\"wa:\", StringComparison.OrdinalIgnoreCase) ||\n                cleaned.StartsWith(\"https://wa.me/\", StringComparison.OrdinalIgnoreCase))\n            {\n                return cleaned; // Accept as-is\n            }\n\n            // ✅ Still allow normal web links\n            if (Uri.TryCreate(cleaned, UriKind.Absolute, out var uri) &&\n                (uri.Scheme.Equals(Uri.UriSchemeHttp, StringComparison.OrdinalIgnoreCase) ||\n                 uri.Scheme.Equals(Uri.UriSchemeHttps, StringComparison.OrdinalIgnoreCase)))\n            {\n                return uri.ToString();\n            }\n\n            // ❌ Anything else is rejected\n            throw new ArgumentException(\n                $\"Destination must be an absolute http/https/tel/wa URL for button '{buttonTitle}' (index {buttonIndex}). Got: '{input}'\");\n        }\n        private static bool LooksLikeAbsoluteBaseUrlWithPlaceholder(string? templateUrl)\n        {\n            if (string.IsNullOrWhiteSpace(templateUrl)) return false;\n            var s = templateUrl.Trim();\n            if (!s.Contains(\"{{\")) return false;\n            var probe = s.Replace(\"{{1}}\", \"x\").Replace(\"{{0}}\", \"x\");\n            return Uri.TryCreate(probe, UriKind.Absolute, out var abs) &&\n                   (abs.Scheme.Equals(Uri.UriSchemeHttp, StringComparison.OrdinalIgnoreCase) ||\n                    abs.Scheme.Equals(Uri.UriSchemeHttps, StringComparison.OrdinalIgnoreCase));\n        }\n\n        private static object[] BuildBodyParameters(List<string>? templateParams, int requiredCount)\n        {\n            if (requiredCount <= 0) return Array.Empty<object>();\n\n            var src = templateParams ?? new List<string>();\n            // Trim if more were provided than required\n            if (src.Count > requiredCount) src = src.Take(requiredCount).ToList();\n            // Pad with empty strings if fewer were provided\n            while (src.Count < requiredCount) src.Add(string.Empty);\n\n            // Return in the shape Meta/Pinnacle expect\n            return src.Select(p => (object)new { type = \"text\", text = p ?? string.Empty }).ToArray();\n        }\n        private List<object> BuildTextTemplateComponents_Meta(\n            List<string> templateParams,\n            List<CampaignButton>? buttonList,\n            TemplateMetadataDto templateMeta,\n            Guid campaignSendLogId,\n            Contact contact)\n        {\n            var components = new List<object>();\n\n            // BODY: send exactly PlaceholderCount\n            if (templateMeta.PlaceholderCount > 0)\n            {\n                var bodyParams = BuildBodyParameters(templateParams, templateMeta.PlaceholderCount);\n                components.Add(new { type = \"body\", parameters = bodyParams });\n            }\n\n            // No buttons or template has no button params\n            if (buttonList == null || buttonList.Count == 0 ||\n                templateMeta.ButtonParams == null || templateMeta.ButtonParams.Count == 0)\n                return components;\n\n            // ✅ Ensure index alignment with the template by ordering by Position (then original index)\n            var orderedButtons = buttonList\n                .Select((b, idx) => new { Btn = b, idx })\n                .OrderBy(x => (int?)x.Btn.Position ?? int.MaxValue)\n                .ThenBy(x => x.idx)\n                .Select(x => x.Btn)\n                .ToList();\n\n            var total = Math.Min(3, Math.Min(orderedButtons.Count, templateMeta.ButtonParams.Count));\n\n            for (int i = 0; i < total; i++)\n            {\n                var meta = templateMeta.ButtonParams[i];\n                var subType = (meta.SubType ?? \"url\").ToLowerInvariant();\n                var metaParam = meta.ParameterValue?.Trim();\n\n                // Meta needs parameters ONLY for dynamic URL buttons\n                if (!string.Equals(subType, \"url\", StringComparison.OrdinalIgnoreCase))\n                    continue;\n\n                var isDynamic = !string.IsNullOrWhiteSpace(metaParam) && metaParam.Contains(\"{{\");\n                if (!isDynamic)\n                    continue;\n\n                var btn = orderedButtons[i];\n                var btnType = (btn?.Type ?? \"URL\").ToUpperInvariant();\n                if (!string.Equals(btnType, \"URL\", StringComparison.OrdinalIgnoreCase))\n                {\n                    // If template expects dynamic URL at this index and your campaign button isn't URL, skip to avoid 131008\n                    continue;\n                }\n\n                var valueRaw = btn.Value?.Trim();\n                if (string.IsNullOrWhiteSpace(valueRaw))\n                {\n                    throw new InvalidOperationException(\n                        $\"Template requires a dynamic URL at button index {i}, but campaign button value is empty.\");\n                }\n\n                // Optional phone substitution in destination\n                var phone = string.IsNullOrWhiteSpace(contact?.PhoneNumber)\n                    ? \"\"\n                    : (contact.PhoneNumber.StartsWith(\"+\") ? contact.PhoneNumber : \"+\" + contact.PhoneNumber);\n                var encodedPhone = Uri.EscapeDataString(phone);\n\n                var resolvedDestination = valueRaw.Contains(\"{{1}}\")\n                    ? valueRaw.Replace(\"{{1}}\", encodedPhone)\n                    : valueRaw;\n\n                resolvedDestination = NormalizeAbsoluteUrlOrThrowForButton(resolvedDestination, btn.Title, i);\n\n                // Build both; choose which to send based on template base style\n                var fullTrackedUrl = _urlBuilderService.BuildTrackedButtonUrl(\n                    campaignSendLogId, i, btn.Title, resolvedDestination);\n\n                var tokenParam = BuildTokenParam(campaignSendLogId, i, btn.Title, resolvedDestination);\n\n                var templateHasAbsoluteBase = LooksLikeAbsoluteBaseUrlWithPlaceholder(metaParam);\n                var valueToSend = templateHasAbsoluteBase ? tokenParam : fullTrackedUrl;\n\n                components.Add(new Dictionary<string, object>\n                {\n                    [\"type\"] = \"button\",\n                    [\"sub_type\"] = \"url\",\n                    [\"index\"] = i.ToString(), // \"0\"/\"1\"/\"2\"\n                    [\"parameters\"] = new[] {\n                new Dictionary<string, object> { [\"type\"] = \"text\", [\"text\"] = valueToSend }\n            }\n                });\n            }\n\n            return components;\n        }\n        private List<object> BuildTextTemplateComponents_Pinnacle(\n            List<string> templateParams,\n            List<CampaignButton>? buttonList,\n            TemplateMetadataDto templateMeta,\n            Guid campaignSendLogId,\n            Contact contact)\n        {\n            var components = new List<object>();\n\n            // BODY: Pinnacle is strict → always send exactly PlaceholderCount\n            if (templateMeta.PlaceholderCount > 0)\n            {\n                var bodyParams = BuildBodyParameters(templateParams, templateMeta.PlaceholderCount);\n                components.Add(new { type = \"body\", parameters = bodyParams });\n            }\n\n            // No buttons to map → return body-only\n            if (buttonList == null || buttonList.Count == 0 ||\n                templateMeta.ButtonParams == null || templateMeta.ButtonParams.Count == 0)\n                return components;\n\n            // ✅ Ensure index alignment with the template by ordering by Position (then original index)\n            var orderedButtons = buttonList\n                .Select((b, idx) => new { Btn = b, idx })\n                .OrderBy(x => (int?)x.Btn.Position ?? int.MaxValue)\n                .ThenBy(x => x.idx)\n                .Select(x => x.Btn)\n                .ToList();\n\n            var total = Math.Min(3, Math.Min(orderedButtons.Count, templateMeta.ButtonParams.Count));\n\n            for (int i = 0; i < total; i++)\n            {\n                var meta = templateMeta.ButtonParams[i];\n                var subType = (meta.SubType ?? \"url\").ToLowerInvariant();\n                var metaParam = meta.ParameterValue?.Trim();\n\n                // Pinnacle path currently supports dynamic URL params only\n                if (!string.Equals(subType, \"url\", StringComparison.OrdinalIgnoreCase))\n                    continue;\n\n                var isDynamic = !string.IsNullOrWhiteSpace(metaParam) && metaParam.Contains(\"{{\");\n                if (!isDynamic)\n                    continue;\n\n                var btn = orderedButtons[i];\n                var btnType = (btn?.Type ?? \"URL\").ToUpperInvariant();\n                if (!string.Equals(btnType, \"URL\", StringComparison.OrdinalIgnoreCase))\n                {\n                    throw new InvalidOperationException(\n                        $\"Template expects a dynamic URL at button index {i}, but campaign button type is '{btn?.Type}'.\");\n                }\n\n                var valueRaw = btn?.Value?.Trim();\n                if (string.IsNullOrWhiteSpace(valueRaw))\n                {\n                    throw new InvalidOperationException(\n                        $\"Template requires a dynamic URL at button index {i}, but campaign button value is empty.\");\n                }\n\n                // Optional phone substitution\n                var phone = string.IsNullOrWhiteSpace(contact?.PhoneNumber)\n                    ? \"\"\n                    : (contact.PhoneNumber.StartsWith(\"+\") ? contact.PhoneNumber : \"+\" + contact.PhoneNumber);\n                var encodedPhone = Uri.EscapeDataString(phone);\n\n                var resolvedDestination = valueRaw.Contains(\"{{1}}\")\n                    ? valueRaw.Replace(\"{{1}}\", encodedPhone)\n                    : valueRaw;\n\n                // Validate + normalize absolute URL\n                resolvedDestination = NormalizeAbsoluteUrlOrThrowForButton(resolvedDestination, btn!.Title, i);\n\n                // Build both options: full tracked URL vs token param (for absolute-base placeholders)\n                var fullTrackedUrl = _urlBuilderService.BuildTrackedButtonUrl(\n                    campaignSendLogId, i, btn.Title, resolvedDestination);\n\n                var tokenParam = BuildTokenParam(campaignSendLogId, i, btn.Title, resolvedDestination);\n\n                var templateHasAbsoluteBase = LooksLikeAbsoluteBaseUrlWithPlaceholder(metaParam);\n                var valueToSend = templateHasAbsoluteBase ? tokenParam : fullTrackedUrl;\n\n                // Pinnacle payload shape (aligned with Meta)\n                components.Add(new Dictionary<string, object>\n                {\n                    [\"type\"] = \"button\",\n                    [\"sub_type\"] = \"url\",\n                    [\"index\"] = i.ToString(),\n                    [\"parameters\"] = new[] {\n                new Dictionary<string, object> { [\"type\"] = \"text\", [\"text\"] = valueToSend }\n            }\n                });\n            }\n\n            return components;\n        }\n\n        #endregion\n        #region SendImagetemplate\n\n        public async Task<ResponseResult> SendImageTemplateCampaignAsync(Campaign campaign)\n        {\n            try\n            {\n                if (campaign == null || campaign.IsDeleted)\n                    return ResponseResult.ErrorInfo(\"❌ Invalid campaign.\");\n                if (campaign.Recipients == null || !campaign.Recipients.Any())\n                    return ResponseResult.ErrorInfo(\"❌ No recipients to send.\");\n\n                var businessId = campaign.BusinessId;\n\n                // 🔑 Flow entry → template name\n                var (_, entryTemplate) = await ResolveFlowEntryAsync(businessId, campaign.CTAFlowConfigId);\n                var templateName = !string.IsNullOrWhiteSpace(entryTemplate)\n                    ? entryTemplate!\n                    : (campaign.TemplateId ?? campaign.MessageTemplate ?? \"\");\n\n                var language = \"en_US\";\n                var templateParams = JsonConvert.DeserializeObject<List<string>>(campaign.TemplateParameters ?? \"[]\");\n\n                int success = 0, failed = 0;\n\n                foreach (var r in campaign.Recipients)\n                {\n                    var dto = new ImageTemplateMessageDto\n                    {\n                        RecipientNumber = r.Contact.PhoneNumber,\n                        TemplateName = templateName,\n                        LanguageCode = language,\n                        HeaderImageUrl = campaign.ImageUrl,\n                        TemplateParameters = templateParams,\n                        ButtonParameters = campaign.MultiButtons\n                            .OrderBy(b => b.Position)\n                            .Take(3)\n                            .Select(b => new CampaignButtonDto\n                            {\n                                ButtonText = b.Title,\n                                ButtonType = b.Type,\n                                TargetUrl = b.Value\n                            }).ToList()\n                    };\n\n                    var res = await _messageEngineService.SendImageTemplateMessageAsync(dto, businessId);\n                    var ok = res.ToString().ToLower().Contains(\"messages\");\n\n                    _context.MessageLogs.Add(new MessageLog\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = businessId,\n                        CampaignId = campaign.Id,\n                        ContactId = r.ContactId,\n                        RecipientNumber = r.Contact.PhoneNumber,\n                        MessageContent = templateName,\n                        MediaUrl = campaign.ImageUrl,\n                        Status = ok ? \"Sent\" : \"Failed\",\n                        ErrorMessage = ok ? null : \"API Failure\",\n                        RawResponse = JsonConvert.SerializeObject(res),\n                        CreatedAt = DateTime.UtcNow,\n                        SentAt = DateTime.UtcNow,\n                        Source = \"campaign\"\n                    });\n\n                    if (ok) success++; else failed++;\n                }\n\n                await _context.SaveChangesAsync();\n                return ResponseResult.SuccessInfo($\"✅ Sent: {success}, ❌ Failed: {failed}\");\n            }\n            catch (Exception ex)\n            {\n                return ResponseResult.ErrorInfo(\"❌ Unexpected error during campaign send.\", ex.ToString());\n            }\n        }\n\n\n        private List<object> BuildImageTemplateComponents_Pinnacle(\n                            string? imageUrl,\n                            List<string> templateParams,\n                            List<CampaignButton>? buttonList,\n                            TemplateMetadataDto templateMeta,\n                            Guid campaignSendLogId,\n                            Contact contact)\n        {\n            var components = new List<object>();\n\n            // Header (image header only if template supports it)\n            if (!string.IsNullOrWhiteSpace(imageUrl) && templateMeta.HasImageHeader)\n            {\n                components.Add(new\n                {\n                    type = \"header\",\n                    parameters = new object[]\n                    {\n                                new { type = \"image\", image = new { link = imageUrl } }\n                    }\n                });\n            }\n\n            // Body\n            if (templateParams != null && templateParams.Count > 0 && templateMeta.PlaceholderCount > 0)\n            {\n                components.Add(new\n                {\n                    type = \"body\",\n                    parameters = templateParams.Select(p => new { type = \"text\", text = p }).ToArray()\n                });\n            }\n\n            // Buttons\n            if (buttonList == null || buttonList.Count == 0 ||\n                templateMeta.ButtonParams == null || templateMeta.ButtonParams.Count == 0)\n                return components;\n\n            var total = Math.Min(3, Math.Min(buttonList.Count, templateMeta.ButtonParams.Count));\n\n            for (int i = 0; i < total; i++)\n            {\n                var btn = buttonList[i];\n                var meta = templateMeta.ButtonParams[i];\n                var subtype = (meta.SubType ?? \"url\").ToLowerInvariant();\n                var metaParam = meta.ParameterValue?.Trim() ?? string.Empty;   // expects /r/{{1}} in template\n                var btnValue = btn.Value?.Trim();\n                var isDynamic = metaParam.Contains(\"{{\");\n\n                // Non-dynamic → no parameters\n                if (!isDynamic)\n                {\n                    components.Add(new Dictionary<string, object>\n                    {\n                        [\"type\"] = \"button\",\n                        [\"sub_type\"] = subtype,\n                        [\"index\"] = i  // Pinnacle accepts numeric\n                    });\n                    continue;\n                }\n\n                if (string.IsNullOrWhiteSpace(btnValue)) continue;\n\n                // Normalize phone and resolve inside destination if needed\n                var phone = string.IsNullOrWhiteSpace(contact?.PhoneNumber)\n                    ? \"\"\n                    : (contact.PhoneNumber.StartsWith(\"+\") ? contact.PhoneNumber : \"+\" + contact.PhoneNumber);\n                var encodedPhone = Uri.EscapeDataString(phone);\n\n                var resolvedDestination = btnValue.Contains(\"{{1}}\")\n                    ? btnValue.Replace(\"{{1}}\", encodedPhone)\n                    : btnValue;\n\n                // Build full tracked URL then extract token for {{1}}\n                var tokenParam = BuildTokenParam(campaignSendLogId, i, btn.Title, resolvedDestination);\n\n                var param = new Dictionary<string, object> { [\"type\"] = \"text\", [\"text\"] = tokenParam };\n\n                components.Add(new Dictionary<string, object>\n                {\n                    [\"type\"] = \"button\",\n                    [\"sub_type\"] = subtype,\n                    [\"index\"] = i,\n                    [\"parameters\"] = new[] { param }\n                });\n            }\n\n            return components;\n        }\n        private List<object> BuildImageTemplateComponents_Meta(\n                            string? imageUrl,\n                            List<string> templateParams,\n                            List<CampaignButton>? buttonList,\n                            TemplateMetadataDto templateMeta,\n                            Guid campaignSendLogId,\n                            Contact contact)\n        {\n            var components = new List<object>();\n\n            // Header (image)\n            if (!string.IsNullOrWhiteSpace(imageUrl) && templateMeta.HasImageHeader)\n            {\n                components.Add(new\n                {\n                    type = \"header\",\n                    parameters = new[]\n                    {\n                new { type = \"image\", image = new { link = imageUrl } }\n            }\n                });\n            }\n\n            // Body\n            if (templateParams != null && templateParams.Count > 0 && templateMeta.PlaceholderCount > 0)\n            {\n                components.Add(new\n                {\n                    type = \"body\",\n                    parameters = templateParams.Select(p => new { type = \"text\", text = p }).ToArray()\n                });\n            }\n\n            // Buttons (Meta sends params only for dynamic ones)\n            if (buttonList != null && buttonList.Count > 0 &&\n                templateMeta.ButtonParams != null && templateMeta.ButtonParams.Count > 0)\n            {\n                var total = Math.Min(3, Math.Min(buttonList.Count, templateMeta.ButtonParams.Count));\n\n                for (int i = 0; i < total; i++)\n                {\n                    var meta = templateMeta.ButtonParams[i];\n                    var metaParam = meta.ParameterValue?.Trim();\n                    bool isDynamic = !string.IsNullOrWhiteSpace(metaParam) && metaParam.Contains(\"{{\");\n\n                    if (!isDynamic) continue;\n\n                    var btn = buttonList[i];\n                    var value = btn.Value?.Trim();\n                    if (string.IsNullOrWhiteSpace(value)) continue;\n\n                    var subtype = (meta.SubType ?? \"url\").ToLowerInvariant();\n\n                    // Normalize phone and resolve inside destination if needed\n                    var phone = string.IsNullOrWhiteSpace(contact?.PhoneNumber)\n                        ? \"\"\n                        : (contact.PhoneNumber.StartsWith(\"+\") ? contact.PhoneNumber : \"+\" + contact.PhoneNumber);\n                    var encodedPhone = Uri.EscapeDataString(phone);\n\n                    var resolvedDestination = value.Contains(\"{{1}}\")\n                        ? value.Replace(\"{{1}}\", encodedPhone)\n                        : value;\n\n                    // Build full tracked URL then extract token for {{1}}\n                    var tokenParam = BuildTokenParam(campaignSendLogId, i, btn.Title, resolvedDestination);\n\n                    var param = new Dictionary<string, object> { [\"type\"] = \"text\", [\"text\"] = tokenParam };\n\n                    components.Add(new Dictionary<string, object>\n                    {\n                        [\"type\"] = \"button\",\n                        [\"sub_type\"] = subtype,       // \"url\"\n                        [\"index\"] = i.ToString(),     // Meta uses \"0\"/\"1\"/\"2\"\n                        [\"parameters\"] = new[] { param }\n                    });\n                }\n            }\n\n            return components;\n        }\n\n\n        private static string NormalizePhoneForTel(string? raw)\n        {\n            if (string.IsNullOrWhiteSpace(raw)) return \"\";\n            var p = raw.Trim();\n            if (!p.StartsWith(\"+\")) p = \"+\" + new string(p.Where(char.IsDigit).ToArray());\n            return p;\n        }\n        #endregion\n\n        #endregion\n\n        public async Task<List<FlowListItemDto>> GetAvailableFlowsAsync(Guid businessId, bool onlyPublished = true)\n        {\n            return await _context.CTAFlowConfigs\n                .AsNoTracking()\n                .Where(f => f.BusinessId == businessId && f.IsActive && (!onlyPublished || f.IsPublished))\n                .OrderByDescending(f => f.UpdatedAt)\n                .Select(f => new FlowListItemDto\n                {\n                    Id = f.Id,\n                    FlowName = f.FlowName,\n                    IsPublished = f.IsPublished\n                })\n                .ToListAsync();\n        }\n    }\n\n\n}\n\n\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/ICampaignRecipientService.cs",
      "sha256": "a2bb5bdb9f8a87dc2436bac017a79dc02ec48bdc1fd425cb6c701807234d4dd3",
      "language": "csharp",
      "size": 729,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.CampaignModule.DTOs;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    public interface ICampaignRecipientService\n    {\n        Task<CampaignRecipientDto> GetByIdAsync(Guid id);\n        Task<List<CampaignRecipientDto>> GetByCampaignIdAsync(Guid campaignId);\n\n        Task<bool> UpdateStatusAsync(Guid recipientId, string newStatus);\n        Task<bool> TrackReplyAsync(Guid recipientId, string replyText);\n        Task<List<CampaignRecipientDto>> SearchRecipientsAsync(string status = null, string keyword = null);\n\n        Task AssignContactsToCampaignAsync(Guid campaignId, List<Guid> contactIds);\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/ICampaignService.cs",
      "sha256": "27a1625658b4fc646689618fbece2ae4a0d373cbcfa833b9acb82ff5ac718ef4",
      "language": "csharp",
      "size": 2241,
      "content": "using System;\nusing System.Threading.Tasks;\nusing System.Collections.Generic;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Shared;\nusing xbytechat.api.CRM.Dtos;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Features.CampaignModule.Models;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    public interface ICampaignService\n    {\n        /// 🆕 Create a new campaign with recipients\n        Task<Guid?> CreateTextCampaignAsync(CampaignCreateDto dto, Guid businessId, string createdBy);\n\n        /// ✏️ Update an existing draft campaign\n        Task<bool> UpdateCampaignAsync(Guid id, CampaignCreateDto dto);\n\n        /// 🗑️ Soft-delete a draft campaign\n        Task<bool> DeleteCampaignAsync(Guid id);\n\n        /// 📋 Get all campaigns for the business\n        Task<List<CampaignSummaryDto>> GetAllCampaignsAsync(Guid businessId);\n\n        /// 📄 Get paginated campaigns\n        Task<PaginatedResponse<CampaignSummaryDto>> GetPaginatedCampaignsAsync(Guid businessId, PaginatedRequest request);\n        /// 🚀 Trigger campaign send flow (template message to all recipients)\n        Task<bool> SendCampaignAsync(Guid campaignId, string ipAddress, string userAgent);\n        Task<Guid> CreateImageCampaignAsync(Guid businessId, CampaignCreateDto dto, string createdBy);\n        Task<List<CampaignSummaryDto>> GetAllCampaignsAsync(Guid businessId, string? type = null);\n        Task<List<ContactDto>> GetRecipientsByCampaignIdAsync(Guid campaignId, Guid businessId);\n        Task<bool> RemoveRecipientAsync(Guid businessId, Guid campaignId, Guid contactId);\n        Task<CampaignDto?> GetCampaignByIdAsync(Guid campaignId, Guid businessId);\n        Task<bool> AssignContactsToCampaignAsync(Guid campaignId, Guid businessId, List<Guid> contactIds);\n\n        Task<ResponseResult> SendTemplateCampaignAsync(Guid campaignId);\n\n        Task<ResponseResult> SendTemplateCampaignWithTypeDetectionAsync(Guid campaignId);\n\n        Task<ResponseResult> SendTextTemplateCampaignAsync(Campaign campaign);\n        Task<ResponseResult> SendImageTemplateCampaignAsync(Campaign campaign);\n\n        Task<List<FlowListItemDto>> GetAvailableFlowsAsync(Guid businessId, bool onlyPublished = true);\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/Config/TrackingOptions.cs",
      "sha256": "76b42450eeb28f2d73ad6fc86ec956bc6e278f17ee17f5e517e0689e8a247483",
      "language": "csharp",
      "size": 337,
      "content": "// 📄 Features/CampaignTracking/Config/TrackingOptions.cs\nnamespace xbytechat.api.Features.CampaignTracking.Config\n{\n    public class TrackingOptions\n    {\n        public string BaseUrl { get; set; } = \"\";\n        public string Secret { get; set; } = \"\";\n        public TimeSpan TokenTtl { get; set; } = TimeSpan.FromDays(30);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/Controllers/CampaignAnalyticsController.cs",
      "sha256": "7542c47e6bbe6d8117004542788bb0f078570eeae04c8045b385fc3b7eb5dde4",
      "language": "csharp",
      "size": 2494,
      "content": "using Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Features.CampaignTracking.Services;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.CampaignTracking.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    [Authorize]\n    public class CampaignAnalyticsController : BusinessControllerBase\n    {\n        private readonly ICampaignAnalyticsService _campaignAnalyticsService;\n        public CampaignAnalyticsController(ICampaignAnalyticsService svc) => _campaignAnalyticsService = svc;\n\n        [HttpGet(\"top-campaigns\")]\n        public async Task<IActionResult> GetTopCampaigns([FromQuery] int count = 5)\n            => Ok(await _campaignAnalyticsService.GetTopCampaignsAsync(BusinessId, count));\n    }\n}\n\n\n//using Microsoft.AspNetCore.Authorization;\n//using Microsoft.AspNetCore.Mvc;\n//using System.Security.Claims;\n//using xbytechat.api.Features.CampaignTracking.Services;\n\n//namespace xbytechat.api.Features.CampaignTracking.Controllers\n//{\n//    [ApiController]\n//    [Route(\"api/[controller]\")]\n//    [Authorize]\n//    public class CampaignAnalyticsController : ControllerBase\n//    {\n//        private readonly ICampaignAnalyticsService _campaignAnalyticsService;\n\n//        public CampaignAnalyticsController(ICampaignAnalyticsService campaignAnalyticsService)\n//        {\n//            _campaignAnalyticsService = campaignAnalyticsService;\n//        }\n\n//        [HttpGet(\"status-dashboard\")]\n//        //public async Task<IActionResult> GetStatusDashboard()\n//        //{\n//        //    var businessIdString = User.FindFirstValue(\"BusinessId\");\n//        //    if (!Guid.TryParse(businessIdString, out var businessId))\n//        //    {\n//        //        return Unauthorized(\"Invalid business identifier.\");\n//        //    }\n//        //    var result = await _campaignAnalyticsService.GetStatusDashboardAsync(businessId);\n//        //    return Ok(result);\n//        //}\n\n//        [HttpGet(\"top-campaigns\")]\n//        public async Task<IActionResult> GetTopCampaigns([FromQuery] int count = 5)\n//        {\n//            var businessIdString = User.FindFirstValue(\"BusinessId\");\n//            if (!Guid.TryParse(businessIdString, out var businessId))\n//            {\n//                return Unauthorized(\"Invalid business identifier.\");\n//            }\n//            var result = await _campaignAnalyticsService.GetTopCampaignsAsync(businessId, count);\n//            return Ok(result);\n//        }\n//    }\n//}"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/Controllers/CampaignRetryController.cs",
      "sha256": "655bf809f7169050f0db9d15a805dec886b9f99faf3bb9690dc1296021297787",
      "language": "csharp",
      "size": 1225,
      "content": "using Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing System;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.CampaignTracking.Services;\n\nnamespace xbytechat.api.Features.CampaignTracking.Controllers\n{\n    [ApiController]\n    [Authorize] // ✅ add this\n    [Route(\"api/campaign-retry\")]\n    public class CampaignRetryController : ControllerBase\n    {\n        private readonly ICampaignRetryService _retryService;\n\n        public CampaignRetryController(ICampaignRetryService retryService)\n        {\n            _retryService = retryService;\n        }\n\n        [HttpPost(\"{logId}/retry\")]\n        public async Task<IActionResult> RetrySingle(Guid logId)\n        {\n            var success = await _retryService.RetrySingleAsync(logId);\n            if (!success) return BadRequest(new { message = \"Retry failed or not allowed for this log.\" });\n            return Ok(new { success = true, message = \"Retry completed.\" });\n        }\n\n        [HttpPost(\"campaign/{campaignId}/retry-all\")]\n        public async Task<IActionResult> RetryAllInCampaign(Guid campaignId)\n            => Ok(new { success = true, retriedCount = await _retryService.RetryFailedInCampaignAsync(campaignId) });\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/Controllers/CampaignSendLogController.cs",
      "sha256": "c867627845ced8dd135c31a3d5e37e8eada1a68184cd22c2bde39a8cc3aff529",
      "language": "csharp",
      "size": 4483,
      "content": "using Microsoft.AspNetCore.Mvc;\nusing System;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.CampaignTracking.DTOs;\nusing xbytechat.api.Features.CampaignTracking.Services;\n\nnamespace xbytechat.api.Features.CampaignTracking.Controllers\n{\n    [ApiController]\n    [Route(\"api/campaign-logs\")]\n    public class CampaignSendLogController : ControllerBase\n    {\n        private readonly ICampaignSendLogService _logService;\n        private readonly ICampaignRetryService _retryService;\n\n        public CampaignSendLogController(\n            ICampaignSendLogService logService,\n            ICampaignRetryService retryService\n        )\n        {\n            _logService = logService;\n            _retryService = retryService;\n        }\n\n        //[HttpGet(\"campaign/{campaignId}\")]\n        //public async Task<IActionResult> GetLogsByCampaign(Guid campaignId)\n        //{\n        //    var logs = await _logService.GetLogsByCampaignIdAsync(campaignId);\n        //    return Ok(logs);\n        //}\n        [HttpGet(\"campaign/{campaignId}\")]\n        public async Task<IActionResult> GetLogsByCampaign(\n         Guid campaignId,\n         [FromQuery] string? status,\n         [FromQuery] string? search,\n         [FromQuery] int page = 1,\n         [FromQuery] int pageSize = 10)\n        {\n            var result = await _logService.GetLogsByCampaignIdAsync(campaignId, status, search, page, pageSize);\n            return Ok(result);\n        }\n        [HttpGet(\"campaign/{campaignId}/contact/{contactId}\")]\n        public async Task<IActionResult> GetLogsForContact(Guid campaignId, Guid contactId)\n        {\n            var logs = await _logService.GetLogsForContactAsync(campaignId, contactId);\n            return Ok(logs);\n        }\n\n        [HttpPost]\n        public async Task<IActionResult> AddSendLog([FromBody] CampaignSendLogDto dto)\n        {\n            var ipAddress = HttpContext.Connection.RemoteIpAddress?.ToString() ?? \"unknown\";\n            var userAgent = Request.Headers[\"User-Agent\"].ToString() ?? \"unknown\";\n\n            var result = await _logService.AddSendLogAsync(dto, ipAddress, userAgent);\n            if (!result)\n                return BadRequest(new { message = \"Failed to add send log\" });\n\n            return Ok(new { success = true });\n        }\n\n        [HttpPut(\"{logId}/status\")]\n        public async Task<IActionResult> UpdateDeliveryStatus(Guid logId, [FromBody] DeliveryStatusUpdateDto dto)\n        {\n            var result = await _logService.UpdateDeliveryStatusAsync(logId, dto.Status, dto.DeliveredAt, dto.ReadAt);\n            if (!result)\n                return NotFound(new { message = \"Log not found\" });\n\n            return Ok(new { success = true });\n        }\n\n        [HttpPut(\"{logId}/track-click\")]\n        public async Task<IActionResult> TrackClick(Guid logId, [FromBody] ClickTrackDto dto)\n        {\n            var result = await _logService.TrackClickAsync(logId, dto.ClickType);\n            if (!result)\n                return NotFound(new { message = \"Log not found\" });\n\n            return Ok(new { success = true });\n        }\n\n        // ✅ FIXED: Retry a single log using correct interface method\n        [HttpPost(\"{logId}/retry\")]\n        public async Task<IActionResult> RetrySingle(Guid logId)\n        {\n            var result = await _retryService.RetrySingleAsync(logId);\n            if (!result)\n                return BadRequest(new { message = \"Retry failed\" });\n\n            return Ok(new { success = true });\n        }\n\n        // ✅ FIXED: Retry all failed logs using correct interface method\n        [HttpPost(\"campaign/{campaignId}/retry-all\")]\n        public async Task<IActionResult> RetryAll(Guid campaignId)\n        {\n            var result = await _retryService.RetryFailedInCampaignAsync(campaignId);\n            return Ok(new { success = true, retried = result });\n        }\n        // ✅ FIXED: Get summary of campaign logs as per Campaign ID\n        [HttpGet(\"campaign/{campaignId}/summary\")]\n        public async Task<IActionResult> GetCampaignSummary(Guid campaignId)\n        {\n            var summary = await _logService.GetCampaignSummaryAsync(campaignId);\n            return Ok(summary);\n        }\n\n    }\n\n    public class DeliveryStatusUpdateDto\n    {\n        public string Status { get; set; }\n        public DateTime? DeliveredAt { get; set; }\n        public DateTime? ReadAt { get; set; }\n    }\n\n    public class ClickTrackDto\n    {\n        public string ClickType { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/Controllers/CampaignTrackingController.cs",
      "sha256": "38f08ea7c2c87daf258e01a9cf4b0171600e80f0b166e710daf825b67292cc0b",
      "language": "csharp",
      "size": 20074,
      "content": "// 📄 Features/CampaignTracking/Controllers/CampaignTrackingController.cs\nusing System.Text.Encodings.Web;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api;\nusing xbytechat.api.Features.CampaignTracking.Services;\nusing xbytechat.api.Features.CampaignTracking.Worker;\n\nnamespace xbytechat.api.Features.CampaignTracking.Controllers\n{\n    [ApiController]\n    [Route(\"r\")] // /r/{token}\n    public class CampaignTrackingController : ControllerBase\n    {\n        private static readonly HtmlEncoder HtmlEnc = HtmlEncoder.Default;\n\n        private readonly ILogger<CampaignTrackingController> _log;\n        private readonly IClickTokenService _token;\n        private readonly IClickEventQueue _queue;\n        private readonly AppDbContext _db;\n\n        public CampaignTrackingController(\n            ILogger<CampaignTrackingController> log,\n            IClickTokenService token,\n            IClickEventQueue queue,\n            AppDbContext db)\n        {\n            _log = log;\n            _token = token;\n            _queue = queue;\n            _db = db;\n        }\n\n        //[HttpGet(\"{token}\")]\n        //[AllowAnonymous]\n        //public async Task<IActionResult> RedirectByToken([FromRoute] string token, CancellationToken ct)\n        //{\n        //    // 1) Validate token\n        //    if (!_token.TryValidate(token, out var p, out var reason))\n        //    {\n        //        _log.LogWarning(\"Tracking token rejected. reason={Reason}\", reason);\n        //        return BadRequest(\"Invalid token.\");\n        //    }\n\n        //    // 2) Normalize + classify destination\n        //    if (!TryNormalizeAllowedDestination(p!.to, out var safeDest, out var scheme))\n        //    {\n        //        _log.LogWarning(\"Rejected destination for cid {Cid}: {Dest}\", p.cid, p.to);\n        //        return BadRequest(\"Invalid destination.\");\n        //    }\n\n        //    // 3) Capture client info\n        //    var ip = HttpContext.Connection.RemoteIpAddress?.ToString() ?? \"0.0.0.0\";\n        //    var ua = Request.Headers.UserAgent.ToString();\n        //    var now = DateTime.UtcNow;\n\n        //    // 4) Determine click type (web | call | whatsapp)\n        //    var clickType = ClassifyClickType(safeDest, scheme);\n\n        //    // 4.1) Fetch related ids from the send log (for ContactId & CampaignId)\n        //    Guid? contactId = null;\n        //    Guid campaignId = Guid.Empty;\n        //    try\n        //    {\n        //        var sendLog = await _db.CampaignSendLogs\n        //            .AsNoTracking()\n        //            .Where(x => x.Id == p.cid)\n        //            .Select(x => new { x.ContactId, x.CampaignId })\n        //            .FirstOrDefaultAsync(ct);\n\n        //        if (sendLog is not null)\n        //        {\n        //            contactId = sendLog.ContactId;\n        //            campaignId = sendLog.CampaignId;\n        //        }\n        //        else\n        //        {\n        //            _log.LogWarning(\"SendLog not found for click cid={Cid}\", p.cid);\n        //        }\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        _log.LogError(ex, \"Failed to fetch ContactId/CampaignId for cid={Cid}\", p.cid);\n        //    }\n\n        //    // 5) Write-through (guaranteed persistence)\n        //    try\n        //    {\n        //        await _db.CampaignClickLogs.AddAsync(new CampaignClickLog\n        //        {\n        //            Id = Guid.NewGuid(),\n        //            CampaignSendLogId = p.cid,\n        //            CampaignId = campaignId,        // <-- populated if available (else Guid.Empty)\n        //            ContactId = contactId,          // <-- populated if available (nullable)\n        //            ButtonIndex = p.bi,\n        //            ButtonTitle = p.bt,\n        //            Destination = safeDest,\n        //            ClickedAt = now,\n        //            Ip = ip,\n        //            UserAgent = ua,\n        //            ClickType = clickType,\n        //            RunId = csl?.RunId\n        //        }, ct);\n\n        //        await _db.SaveChangesAsync(ct);\n\n        //        _log.LogInformation(\n        //            \"CLICK WRITE-THROUGH cid={Cid} idx={Idx} type={Type} dest={Dest}\",\n        //            p.cid, p.bi, clickType, safeDest);\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        _log.LogError(ex, \"Write-through insert failed. cid={Cid}\", p.cid);\n        //    }\n\n        //    // 6) Enqueue for async worker (best effort) — keeps existing ClickEvent signature\n        //    try\n        //    {\n        //        var enq = _queue.TryWrite(new ClickEvent(\n        //            CampaignSendLogId: p.cid,\n        //            ButtonIndex: p.bi,\n        //            ButtonTitle: p.bt,\n        //            Destination: safeDest,\n        //            ClickedAtUtc: now,\n        //            Ip: ip,\n        //            UserAgent: ua,\n        //            ClickType: clickType\n        //        ));\n        //        _log.LogInformation(\"CLICK ENQUEUE cid={Cid} idx={Idx} enqueued={Enqueued}\", p.cid, p.bi, enq);\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        _log.LogError(ex, \"Queue write threw. cid={Cid}\", p.cid);\n        //    }\n\n        //    // 7) First-click fast path\n        //    try\n        //    {\n        //        await _db.Database.ExecuteSqlRawAsync(\n        //            @\"update \"\"CampaignSendLogs\"\"\n        //                set \"\"IsClicked\"\"=TRUE, \"\"ClickedAt\"\"=NOW() at time zone 'utc'\n        //              where \"\"Id\"\"={0} and \"\"IsClicked\"\"=FALSE;\",\n        //            p.cid);\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        _log.LogDebug(ex, \"First-click update skipped.\");\n        //    }\n\n        //    // 8) Redirect handling\n        //    if (clickType is \"call\" or \"whatsapp\")\n        //    {\n        //        // Deep link → return an HTML/JS shim to trigger immediately, with a safe fallback link.\n        //        var destHtml = HtmlEnc.Encode(safeDest);\n        //        var destJs = JsEscape(safeDest);\n\n        //        var html = $@\"<!doctype html>\n        //        <html lang=\"\"en\"\">\n        //        <head>\n        //          <meta charset=\"\"utf-8\"\">\n        //          <meta http-equiv=\"\"x-ua-compatible\"\" content=\"\"ie=edge\"\">\n        //          <meta name=\"\"viewport\"\" content=\"\"width=device-width, initial-scale=1\"\">\n        //          <meta http-equiv=\"\"refresh\"\" content=\"\"0;url={destHtml}\"\">\n        //          <title>Redirecting…</title>\n        //          <style>\n        //            body{{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding:24px;}}\n        //            a{{color:#2563eb;text-decoration:underline;}}\n        //          </style>\n        //          <script>\n        //            // Trigger deep link immediately; reveal fallback if blocked by the browser.\n        //            window.addEventListener('load', function() {{\n        //              try {{ window.location.replace('{destJs}'); }} catch (e) {{}}\n        //              setTimeout(function() {{\n        //                var f = document.getElementById('fallback');\n        //                if (f) f.style.display = 'inline';\n        //              }}, 1200);\n        //            }});\n        //          </script>\n        //        </head>\n        //        <body>\n        //          <p>Redirecting… If you are not redirected automatically, <a id=\"\"fallback\"\" style=\"\"display:none\"\" href=\"\"{destHtml}\"\">tap here</a>.</p>\n        //        </body>\n        //        </html>\";\n\n        //        Response.Headers[\"Cache-Control\"] = \"no-store, max-age=0\";\n        //        Response.Headers[\"Pragma\"] = \"no-cache\";\n        //        Response.Headers[\"X-Content-Type-Options\"] = \"nosniff\";\n        //        Response.Headers[\"Referrer-Policy\"] = \"no-referrer\";\n        //        Response.Headers[\"X-Frame-Options\"] = \"DENY\";\n        //        Response.Headers[\"Permissions-Policy\"] = \"geolocation=(), microphone=(), camera=()\";\n        //        Response.Headers[\"Content-Security-Policy\"] =\n        //            \"default-src 'none'; script-src 'unsafe-inline'; style-src 'unsafe-inline'; base-uri 'none'; frame-ancestors 'none'\";\n\n        //        return new ContentResult\n        //        {\n        //            Content = html,\n        //            ContentType = \"text/html; charset=utf-8\",\n        //            StatusCode = 200\n        //        };\n        //    }\n\n        //    // Regular web links → normal 302\n        //    return Redirect(safeDest);\n        //}\n\n        // --- helpers ---\n\n\n        //[HttpGet(\"{token}\")]\n        //[AllowAnonymous]\n\n\n        //[HttpGet(\"{token}\")]\n        //[AllowAnonymous]\n\n        [HttpGet(\"{token}\")]\n        [AllowAnonymous]\n        public async Task<IActionResult> RedirectByToken([FromRoute] string token, CancellationToken ct)\n        {\n            // 1) Validate token\n            if (!_token.TryValidate(token, out var p, out var reason))\n            {\n                _log.LogWarning(\"Tracking token rejected. reason={Reason}\", reason);\n                return BadRequest(\"Invalid token.\");\n            }\n\n            // 2) Normalize + classify destination\n            if (!TryNormalizeAllowedDestination(p!.to, out var safeDest, out var scheme))\n            {\n                _log.LogWarning(\"Rejected destination for cid {Cid}: {Dest}\", p.cid, p.to);\n                return BadRequest(\"Invalid destination.\");\n            }\n\n            // 3) Capture client info\n            var ip = HttpContext.Connection.RemoteIpAddress?.ToString() ?? \"0.0.0.0\";\n            var ua = Request.Headers.UserAgent.ToString();\n            var now = DateTime.UtcNow;\n\n            // 4) Determine click type (web | call | whatsapp)\n            var clickType = ClassifyClickType(safeDest, scheme);\n\n            // 4.1) Fetch related ids from the send log (ContactId, CampaignId, **RunId**)\n            Guid? contactId = null;\n            Guid campaignId = Guid.Empty;\n            Guid? runId = null; // 👈 NEW\n\n            try\n            {\n                var sendLog = await _db.CampaignSendLogs\n                    .AsNoTracking()\n                    .Where(x => x.Id == p.cid)\n                    .Select(x => new { x.ContactId, x.CampaignId, x.RunId })\n                    .FirstOrDefaultAsync(ct);\n\n                if (sendLog is not null)\n                {\n                    contactId = sendLog.ContactId;\n                    campaignId = sendLog.CampaignId;\n                    runId = sendLog.RunId; // 👈 carry through to click log\n                }\n                else\n                {\n                    _log.LogWarning(\"SendLog not found for click cid={Cid}\", p.cid);\n                }\n            }\n            catch (Exception ex)\n            {\n                _log.LogError(ex, \"Failed to fetch ContactId/CampaignId/RunId for cid={Cid}\", p.cid);\n            }\n\n            // 5) Write-through (guaranteed persistence)\n            try\n            {\n                await _db.CampaignClickLogs.AddAsync(new CampaignClickLog\n                {\n                    Id = Guid.NewGuid(),\n                    CampaignSendLogId = p.cid,\n                    CampaignId = campaignId,   // populated if available (else Guid.Empty)\n                    ContactId = contactId,     // nullable\n                    ButtonIndex = p.bi,\n                    ButtonTitle = p.bt,\n                    Destination = safeDest,\n                    ClickedAt = now,\n                    Ip = ip,\n                    UserAgent = ua,\n                    ClickType = clickType,\n                    RunId = runId              // 👈 bind click to the same run/session\n                }, ct);\n\n                await _db.SaveChangesAsync(ct);\n\n                _log.LogInformation(\n                    \"CLICK WRITE-THROUGH cid={Cid} idx={Idx} type={Type} dest={Dest}\",\n                    p.cid, p.bi, clickType, safeDest);\n            }\n            catch (Exception ex)\n            {\n                _log.LogError(ex, \"Write-through insert failed. cid={Cid}\", p.cid);\n            }\n\n            // 6) Enqueue for async worker (best effort) — keeps existing ClickEvent signature\n            try\n            {\n                var enq = _queue.TryWrite(new ClickEvent(\n                    CampaignSendLogId: p.cid,\n                    ButtonIndex: p.bi,\n                    ButtonTitle: p.bt,\n                    Destination: safeDest,\n                    ClickedAtUtc: now,\n                    Ip: ip,\n                    UserAgent: ua,\n                    ClickType: clickType\n                ));\n                _log.LogInformation(\"CLICK ENQUEUE cid={Cid} idx={Idx} enqueued={Enqueued}\", p.cid, p.bi, enq);\n            }\n            catch (Exception ex)\n            {\n                _log.LogError(ex, \"Queue write threw. cid={Cid}\", p.cid);\n            }\n\n            // 7) First-click fast path (also writes ClickType)\n            try\n            {\n                await _db.Database.ExecuteSqlRawAsync(\n                    @\"update \"\"CampaignSendLogs\"\"\n                set \"\"IsClicked\"\"=TRUE,\n                    \"\"ClickedAt\"\"=NOW() at time zone 'utc',\n                    \"\"ClickType\"\"={1}\n              where \"\"Id\"\"={0} and \"\"IsClicked\"\"=FALSE;\",\n                    p.cid, clickType);\n            }\n            catch (Exception ex)\n            {\n                _log.LogDebug(ex, \"First-click update skipped.\");\n            }\n\n            // 8) Redirect handling\n            if (clickType is \"call\" or \"whatsapp\")\n            {\n                // Deep link → return an HTML/JS shim to trigger immediately, with a safe fallback link.\n                var destHtml = HtmlEnc.Encode(safeDest);\n                var destJs = JsEscape(safeDest);\n\n                var html = $@\"<!doctype html>\n                        <html lang=\"\"en\"\">\n                        <head>\n                          <meta charset=\"\"utf-8\"\">\n                          <meta http-equiv=\"\"x-ua-compatible\"\" content=\"\"ie=edge\"\">\n                          <meta name=\"\"viewport\"\" content=\"\"width=device-width, initial-scale=1\"\">\n                          <meta http-equiv=\"\"refresh\"\" content=\"\"0;url={destHtml}\"\">\n                          <title>Redirecting…</title>\n                          <style>\n                            body{{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding:24px;}}\n                            a{{color:#2563eb;text-decoration:underline;}}\n                          </style>\n                          <script>\n                            // Trigger deep link immediately; reveal fallback if blocked by the browser.\n                            window.addEventListener('load', function() {{\n                              try {{ window.location.replace('{destJs}'); }} catch (e) {{}}\n                              setTimeout(function() {{\n                                var f = document.getElementById('fallback');\n                                if (f) f.style.display = 'inline';\n                              }}, 1200);\n                            }});\n                          </script>\n                        </head>\n                        <body>\n                          <p>Redirecting… If you are not redirected automatically, <a id=\"\"fallback\"\" style=\"\"display:none\"\" href=\"\"{destHtml}\"\">tap here</a>.</p>\n                        </body>\n                        </html>\";\n\n                Response.Headers[\"Cache-Control\"] = \"no-store, max-age=0\";\n                Response.Headers[\"Pragma\"] = \"no-cache\";\n                Response.Headers[\"X-Content-Type-Options\"] = \"nosniff\";\n                Response.Headers[\"Referrer-Policy\"] = \"no-referrer\";\n                Response.Headers[\"X-Frame-Options\"] = \"DENY\";\n                Response.Headers[\"Permissions-Policy\"] = \"geolocation=(), microphone=(), camera=()\";\n                Response.Headers[\"Content-Security-Policy\"] =\n                    \"default-src 'none'; script-src 'unsafe-inline'; style-src 'unsafe-inline'; base-uri 'none'; frame-ancestors 'none'\";\n\n                return new ContentResult\n                {\n                    Content = html,\n                    ContentType = \"text/html; charset=utf-8\",\n                    StatusCode = 200\n                };\n            }\n\n            // Regular web links → normal 302\n            return Redirect(safeDest);\n        }\n\n\n        private static string ClassifyClickType(string normalizedDest, string scheme)\n        {\n            // scheme is pre-normalized by TryNormalizeAllowedDestination\n            if (string.Equals(scheme, \"tel\", StringComparison.OrdinalIgnoreCase)) return \"call\";\n            if (string.Equals(scheme, \"wa\", StringComparison.OrdinalIgnoreCase)) return \"whatsapp\";\n            if (string.Equals(scheme, \"whatsapp\", StringComparison.OrdinalIgnoreCase)) return \"whatsapp\";\n\n            // http/https → still treat WhatsApp hosts as whatsapp\n            if (normalizedDest.StartsWith(\"https://wa.me/\", StringComparison.OrdinalIgnoreCase)) return \"whatsapp\";\n            if (normalizedDest.StartsWith(\"https://api.whatsapp.com/\", StringComparison.OrdinalIgnoreCase)) return \"whatsapp\";\n\n            return \"web\";\n        }\n\n        private static string JsEscape(string s) =>\n            s.Replace(\"\\\\\", \"\\\\\\\\\").Replace(\"'\", \"\\\\'\").Replace(\"\\r\", \"\").Replace(\"\\n\", \"\");\n\n        /// <summary>\n        /// Accepts: http/https/tel/wa/whatsapp, plus shorthand wa.me/... and api.whatsapp.com/...\n        /// Returns normalized absolute string and a normalized scheme hint (\"http\",\"https\",\"tel\",\"wa\",\"whatsapp\").\n        /// </summary>\n        private static bool TryNormalizeAllowedDestination(string? input, out string normalized, out string scheme)\n        {\n            normalized = string.Empty;\n            scheme = string.Empty;\n            if (string.IsNullOrWhiteSpace(input)) return false;\n\n            var cleaned = new string(input.Trim().Where(c => !char.IsControl(c)).ToArray());\n\n            // Shorthand WhatsApp hosts without scheme → prefix https://\n            if (!cleaned.Contains(\"://\", StringComparison.Ordinal))\n            {\n                if (cleaned.StartsWith(\"wa.me/\", StringComparison.OrdinalIgnoreCase) ||\n                    cleaned.StartsWith(\"api.whatsapp.com/\", StringComparison.OrdinalIgnoreCase))\n                {\n                    var guess = \"https://\" + cleaned;\n                    if (Uri.TryCreate(guess, UriKind.Absolute, out var waAbs))\n                    {\n                        normalized = waAbs.AbsoluteUri;\n                        scheme = \"https\";\n                        return true;\n                    }\n                }\n            }\n\n            // WhatsApp custom schemes (wa:, whatsapp:)\n            if (cleaned.StartsWith(\"wa:\", StringComparison.OrdinalIgnoreCase))\n            {\n                normalized = cleaned; scheme = \"wa\"; return true;\n            }\n            if (cleaned.StartsWith(\"whatsapp:\", StringComparison.OrdinalIgnoreCase))\n            {\n                normalized = cleaned; scheme = \"whatsapp\"; return true;\n            }\n\n            // Absolute URIs\n            if (Uri.TryCreate(cleaned, UriKind.Absolute, out var uri))\n            {\n                // tel:\n                if (uri.Scheme.Equals(\"tel\", StringComparison.OrdinalIgnoreCase))\n                {\n                    normalized = uri.ToString(); scheme = \"tel\"; return true;\n                }\n\n                // http/https (including WhatsApp hosts)\n                if (uri.Scheme.Equals(Uri.UriSchemeHttp, StringComparison.OrdinalIgnoreCase) ||\n                    uri.Scheme.Equals(Uri.UriSchemeHttps, StringComparison.OrdinalIgnoreCase))\n                {\n                    normalized = uri.AbsoluteUri;\n                    scheme = uri.Scheme; // \"http\" or \"https\"\n                    return true;\n                }\n            }\n\n            return false;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/DTOs/CampaignLogSummaryDto.cs",
      "sha256": "57aa29e375f6dda32b73602de1a84e9d5e89e3f8bf103914b21bfa14f0b786a9",
      "language": "csharp",
      "size": 415,
      "content": "namespace xbytechat.api.Features.CampaignTracking.DTOs\n{\n    public class CampaignLogSummaryDto\n    {\n        public int TotalSent { get; set; }\n        public int FailedCount { get; set; }\n        public int ClickedCount { get; set; }\n        public DateTime? LastSentAt { get; set; }\n\n        public int Delivered { get; set; }\n        public int Read { get; set; }\n        public int Sent { get; set; }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/DTOs/CampaignSendLogDto.cs",
      "sha256": "42c34ffaad27eea7cfade390bdbd9220b2abbf7095b92a61d1d3d52e57226306",
      "language": "csharp",
      "size": 1676,
      "content": "using System;\n\nnamespace xbytechat.api.Features.CampaignTracking.DTOs\n{\n    public class CampaignSendLogDto\n    {\n        public Guid Id { get; set; }\n\n        // 🔗 Relationships\n        public Guid CampaignId { get; set; }\n        public Guid ContactId { get; set; }\n        public string ContactName { get; set; }\n        public string ContactPhone { get; set; }\n\n        // 📤 Message Info\n        public Guid RecipientId { get; set; }\n        public string MessageBody { get; set; }\n        public string? TemplateId { get; set; }\n        public string? SendStatus { get; set; }\n        public string? ErrorMessage { get; set; }\n\n        // 🕒 Timestamps\n        public DateTime CreatedAt { get; set; }\n        public DateTime? SentAt { get; set; }\n        public DateTime? DeliveredAt { get; set; }\n        public DateTime? ReadAt { get; set; }\n\n        // 🌐 Metadata\n        public string? SourceChannel { get; set; }\n        public string? IpAddress { get; set; }\n        public string? DeviceInfo { get; set; }\n        public string? MacAddress { get; set; }\n\n        // ✅ Enriched metadata\n        public string? DeviceType { get; set; }\n        public string? Browser { get; set; }\n        public string? Country { get; set; }\n        public string? City { get; set; }\n\n        // 📈 Click Tracking\n        public bool IsClicked { get; set; }\n        public DateTime? ClickedAt { get; set; }\n        public string? ClickType { get; set; }\n\n        // 🔁 Retry Info\n        public string? RetryStatus { get; set; }     // Pending, Retried, Skipped\n        public int RetryCount { get; set; }\n        public DateTime? LastRetryAt { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/DTOs/CampaignStatusDashboardDto.cs",
      "sha256": "21979b3b1de98ab2567e6485c9c0e4684b848735d36743226caaca66504e9b7b",
      "language": "csharp",
      "size": 1038,
      "content": "namespace xbytechat.api.Features.CampaignTracking.DTOs\n{\n    public class CampaignStatusDashboardDto\n    {\n        public Guid CampaignId { get; set; }\n\n        // 📊 Overall Stats\n        public int TotalRecipients { get; set; }\n        public int SentCount { get; set; }\n        public int DeliveredCount { get; set; }\n        public int ReadCount { get; set; }\n        public int FailedCount { get; set; }\n\n        // 🕒 Delivery Timing (optional but insightful)\n        public DateTime? FirstSentAt { get; set; }\n        public DateTime? LastSentAt { get; set; }\n        public DateTime? FirstReadAt { get; set; }\n        public DateTime? LastReadAt { get; set; }\n\n        // 📉 Delivery Rates\n        public double DeliveryRate => TotalRecipients == 0 ? 0 : (double)DeliveredCount / TotalRecipients * 100;\n        public double ReadRate => TotalRecipients == 0 ? 0 : (double)ReadCount / TotalRecipients * 100;\n        public double FailureRate => TotalRecipients == 0 ? 0 : (double)FailedCount / TotalRecipients * 100;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/DTOs/TopCampaignDto.cs",
      "sha256": "deebf224725de4a79f8363405623b0761fed9b776ec86cc8d6a9b05c5f79940e",
      "language": "csharp",
      "size": 295,
      "content": "namespace xbytechat.api.Features.CampaignTracking.DTOs\n{\n    public class TopCampaignDto\n    {\n        public Guid CampaignId { get; set; }\n        public string CampaignName { get; set; }\n        public double ReadRate { get; set; }\n        public double ClickThroughRate { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/Models/CampaignClickDailyAgg.cs",
      "sha256": "f73f8e07824860d62b98ba1112933870fd6c223a3a75ca759bccf5899d9e9ffd",
      "language": "csharp",
      "size": 571,
      "content": "// 📄 Features/CampaignTracking/Models/CampaignClickDailyAgg.cs\nusing System.ComponentModel.DataAnnotations;\nusing System.ComponentModel.DataAnnotations.Schema;\n\nnamespace xbytechat.api.Features.CampaignTracking.Worker\n{\n    [Table(\"CampaignClickDailyAgg\")]\n    public class CampaignClickDailyAgg\n    {\n        [Key] public Guid Id { get; set; }\n        public Guid CampaignId { get; set; }\n        public DateTime Day { get; set; } // date-only (store as date in migration)\n        public int ButtonIndex { get; set; }\n        public long Clicks { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/Models/CampaignClickLog.cs",
      "sha256": "c955c29fed1ef4d960a247c80426a21493ab53a3b657a4a21083d2f617d309cb",
      "language": "csharp",
      "size": 1205,
      "content": "// 📄 Features/CampaignTracking/Models/CampaignClickLog.cs\nusing System.ComponentModel.DataAnnotations;\nusing System.ComponentModel.DataAnnotations.Schema;\n\nnamespace xbytechat.api.Features.CampaignTracking.Worker\n{\n    [Table(\"CampaignClickLogs\")]\n    public class CampaignClickLog\n    {\n        [Key] public Guid Id { get; set; }\n\n        public Guid? RunId { get; set; }\n        // FK through CampaignSendLog to CampaignId & ContactId\n        public Guid CampaignSendLogId { get; set; }\n\n        public Guid CampaignId { get; set; }      // denormalized for fast filtering\n        public Guid? ContactId { get; set; }      // denormalized if available\n\n        public int ButtonIndex { get; set; }\n\n        [MaxLength(120)]\n        public string ButtonTitle { get; set; } = \"\";\n\n        // NEW: \"web\" | \"call\" | \"whatsapp\" (lowercase)\n        [MaxLength(16)]\n        public string ClickType { get; set; } = \"web\";\n\n        [MaxLength(2048)]\n        public string Destination { get; set; } = \"\";\n\n        [MaxLength(64)]\n        public string Ip { get; set; } = \"\";\n\n        [MaxLength(512)]\n        public string UserAgent { get; set; } = \"\";\n\n        public DateTime ClickedAt { get; set; }\n    }\n}\n"
    }
  ]
}
